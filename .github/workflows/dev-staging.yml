name: Deploy to Dev/Staging

on:
  push:
    branches:
      - dev
    paths:
      # Only trigger on application code changes
      - 'SM_MentalHealthApp.Server/**'
      - 'SM_MentalHealthApp.Client/**'
      - 'SM_MentalHealthApp.Shared/**'
      - 'MentalHealthMobileClean/**'
      - '.github/workflows/**' # Workflow changes should trigger
  workflow_dispatch: # Allow manual trigger

env:
  SSH_USER: root
  APP_DIR: /opt/mental-health-app
  ENVIRONMENT: Staging

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate branch and load STAGING server IP
        run: |
          if [ "${{ github.ref_name }}" != "dev" ]; then
            echo "‚ùå ERROR: This workflow should only run on 'dev' branch!"
            echo "   Current branch: ${{ github.ref_name }}"
            echo "   This is a STAGING deployment workflow."
            exit 1
          fi
          
          if [ ! -f "deploy/DROPLET_IP_STAGING" ]; then
            echo "‚ùå ERROR: deploy/DROPLET_IP_STAGING file not found!"
            exit 1
          fi
          
          SSH_HOST_STG=$(cat deploy/DROPLET_IP_STAGING | tr -d '[:space:]' | grep -v '^#' | head -1)
          
          if [ -z "$SSH_HOST_STG" ]; then
            echo "‚ùå ERROR: STAGING IP address is empty!"
            exit 1
          fi
          
          echo "SSH_HOST_STG=$SSH_HOST_STG" >> $GITHUB_ENV
          echo "‚úÖ STAGING Environment"
          echo "üåê Staging Server IP: $SSH_HOST_STG"
          echo "üì¶ Branch: ${{ github.ref_name }}"
          echo "‚ö†Ô∏è  Deploying to STAGING - this is safe"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      
      - name: Restore dependencies
        run: |
          dotnet restore SM_MentalHealthApp.Server/SM_MentalHealthApp.Server.csproj
          dotnet restore SM_MentalHealthApp.Client/SM_MentalHealthApp.Client.csproj
      
      - name: Build Server
        run: |
          dotnet build SM_MentalHealthApp.Server/SM_MentalHealthApp.Server.csproj \
            --configuration Release \
            --no-restore
      
      - name: Build Client
        run: |
          dotnet build SM_MentalHealthApp.Client/SM_MentalHealthApp.Client.csproj \
            --configuration Release \
            --no-restore
      
      - name: Publish Server
        run: |
          dotnet publish SM_MentalHealthApp.Server/SM_MentalHealthApp.Server.csproj \
            --configuration Release \
            --output ./publish/server \
            --no-build
      
      - name: Publish Client
        run: |
          dotnet publish SM_MentalHealthApp.Client/SM_MentalHealthApp.Client.csproj \
            --configuration Release \
            --output ./publish/client \
            --no-build
      
      - name: Run Tests (if any)
        run: |
          # Uncomment if you have test projects
          # dotnet test --no-build --verbosity normal
          echo "Skipping tests for now"
        continue-on-error: true
      
      - name: Validate SSH secret
        run: |
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "‚ùå ERROR: SSH_PRIVATE_KEY secret is not configured!"
            echo ""
            echo "To fix this:"
            echo "1. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: SSH_PRIVATE_KEY"
            echo "4. Value: Your SSH private key (cat ~/.ssh/id_rsa)"
            echo "5. Click 'Add secret'"
            echo ""
            echo "The key should include the BEGIN and END lines:"
            echo "-----BEGIN OPENSSH PRIVATE KEY-----"
            echo "..."
            echo "-----END OPENSSH PRIVATE KEY-----"
            exit 1
          fi
          echo "‚úÖ SSH_PRIVATE_KEY secret is configured"
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ env.SSH_HOST_STG }} >> ~/.ssh/known_hosts
      
      - name: Create deployment directory
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.SSH_USER }}@${{ env.SSH_HOST_STG }} \
            "mkdir -p ${{ env.APP_DIR }}/server ${{ env.APP_DIR }}/client"
      
      - name: Copy server files
        run: |
          rsync -avz --delete \
            --exclude 'appsettings.Staging.json' \
            --exclude 'appsettings.Production.json' \
            --exclude 'appsettings.json' \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./publish/server/ \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST_STG }}:${{ env.APP_DIR }}/server/
      
      - name: Copy client files
        run: |
          rsync -avz --delete \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./publish/client/wwwroot/ \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST_STG }}:${{ env.APP_DIR }}/client/wwwroot/
      
      - name: Set permissions
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.SSH_USER }}@${{ env.SSH_HOST_STG }} \
            "chown -R appuser:appuser ${{ env.APP_DIR }} && \
             chmod +x ${{ env.APP_DIR }}/server/SM_MentalHealthApp.Server.dll"
      
      - name: Update systemd service for Staging environment
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.SSH_USER }}@${{ env.SSH_HOST_STG }} \
            "sed -i 's/Environment=ASPNETCORE_ENVIRONMENT=Production/Environment=ASPNETCORE_ENVIRONMENT=Staging/' /etc/systemd/system/mental-health-app.service && \
             systemctl daemon-reload && \
             echo '‚úÖ Updated systemd service to use Staging environment'"
        continue-on-error: true
      
      - name: Run database migrations
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.SSH_USER }}@${{ env.SSH_HOST_STG }} \
            "cd ${{ env.APP_DIR }}/server && \
             dotnet ef database update --no-build --project . || echo 'Migrations skipped'"
        continue-on-error: true
      
      - name: Restart application
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.SSH_USER }}@${{ env.SSH_HOST_STG }} \
            "systemctl restart mental-health-app && \
             sleep 3 && \
             systemctl status mental-health-app --no-pager | head -10"
      
      - name: Health check
        run: |
          sleep 5
          curl -k -f https://${{ env.SSH_HOST_STG }}/api/health || exit 1
      
      - name: Deployment summary
        run: |
          echo "‚úÖ Deployment to ${{ env.ENVIRONMENT }} completed successfully!"
          echo "üåê Server: https://${{ env.SSH_HOST_STG }}"
          echo "üì¶ Branch: ${{ github.ref_name }}"
          echo "üî® Commit: ${{ github.sha }}"

