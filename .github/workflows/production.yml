name: Deploy to Production

on:
  push:
    branches:
      - main
    paths:
      # Only trigger on application code changes
      - 'SM_MentalHealthApp.Server/**'
      - 'SM_MentalHealthApp.Client/**'
      - 'SM_MentalHealthApp.Shared/**'
      - 'MentalHealthMobileClean/**'
      - '.github/workflows/**' # Workflow changes should trigger
  workflow_dispatch: # Allow manual trigger

env:
  SSH_USER: root
  APP_DIR: /opt/mental-health-app
  ENVIRONMENT: Production

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production # Requires approval for production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate branch and load PRODUCTION server IP
        run: |
          if [ "${{ github.ref_name }}" != "main" ]; then
            echo "‚ùå ERROR: This workflow should only run on 'main' branch!"
            echo "   Current branch: ${{ github.ref_name }}"
            echo "   This is a PRODUCTION deployment workflow."
            exit 1
          fi
          
          if [ ! -f "deploy/DROPLET_IP_PRODUCTION" ]; then
            echo "‚ùå ERROR: deploy/DROPLET_IP_PRODUCTION file not found!"
            exit 1
          fi
          
          SSH_HOST_PROD=$(cat deploy/DROPLET_IP_PRODUCTION | tr -d '[:space:]' | grep -v '^#' | head -1)
          
          if [ -z "$SSH_HOST_PROD" ]; then
            echo "‚ùå ERROR: PRODUCTION IP address is empty!"
            exit 1
          fi
          
          echo "SSH_HOST_PROD=$SSH_HOST_PROD" >> $GITHUB_ENV
          echo "üö® PRODUCTION Environment"
          echo "üåê Production Server IP: $SSH_HOST_PROD"
          echo "üì¶ Branch: ${{ github.ref_name }}"
          echo "‚ö†Ô∏è  WARNING: Deploying to PRODUCTION!"
          echo "   This requires manual approval (GitHub environment protection)"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      
      - name: Restore dependencies
        run: |
          dotnet restore SM_MentalHealthApp.Server/SM_MentalHealthApp.Server.csproj
          dotnet restore SM_MentalHealthApp.Client/SM_MentalHealthApp.Client.csproj
      
      - name: Build Server
        run: |
          dotnet build SM_MentalHealthApp.Server/SM_MentalHealthApp.Server.csproj \
            --configuration Release \
            --no-restore
      
      - name: Build Client
        run: |
          dotnet build SM_MentalHealthApp.Client/SM_MentalHealthApp.Client.csproj \
            --configuration Release \
            --no-restore
      
      - name: Run Tests
        run: |
          # Add your test projects here
          # dotnet test --no-build --verbosity normal
          echo "Running tests..."
        continue-on-error: true
      
      - name: Publish Server
        run: |
          dotnet publish SM_MentalHealthApp.Server/SM_MentalHealthApp.Server.csproj \
            --configuration Release \
            --output ./publish/server \
            --no-build
      
      - name: Publish Client
        run: |
          dotnet publish SM_MentalHealthApp.Client/SM_MentalHealthApp.Client.csproj \
            --configuration Release \
            --output ./publish/client \
            --no-build
      
      - name: Validate SSH secret
        run: |
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "‚ùå ERROR: SSH_PRIVATE_KEY secret is not configured!"
            echo ""
            echo "To fix this:"
            echo "1. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: SSH_PRIVATE_KEY"
            echo "4. Value: Your SSH private key (cat ~/.ssh/id_rsa)"
            echo "5. Click 'Add secret'"
            echo ""
            echo "The key should include the BEGIN and END lines:"
            echo "-----BEGIN OPENSSH PRIVATE KEY-----"
            echo "..."
            echo "-----END OPENSSH PRIVATE KEY-----"
            exit 1
          fi
          echo "‚úÖ SSH_PRIVATE_KEY secret is configured"
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ env.SSH_HOST_PROD }} >> ~/.ssh/known_hosts
      
      - name: Backup current deployment
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.SSH_USER }}@${{ env.SSH_HOST_PROD }} \
            "mkdir -p ${{ env.APP_DIR }}/backup && \
             tar -czf ${{ env.APP_DIR }}/backup/backup-$(date +%Y%m%d-%H%M%S).tar.gz \
             ${{ env.APP_DIR }}/server ${{ env.APP_DIR }}/client 2>/dev/null || true"
      
      - name: Create deployment directory
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.SSH_USER }}@${{ env.SSH_HOST_PROD }} \
            "mkdir -p ${{ env.APP_DIR }}/server ${{ env.APP_DIR }}/client"
      
      - name: Copy server files
        run: |
          rsync -avz --delete \
            --exclude 'appsettings.Staging.json' \
            --exclude 'appsettings.Production.json' \
            --exclude 'appsettings.json' \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./publish/server/ \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST_PROD }}:${{ env.APP_DIR }}/server/
      
      - name: Copy client files
        run: |
          rsync -avz --delete \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./publish/client/wwwroot/ \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST_PROD }}:${{ env.APP_DIR }}/client/wwwroot/
      
      - name: Set permissions
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.SSH_USER }}@${{ env.SSH_HOST_PROD }} \
            "chown -R appuser:appuser ${{ env.APP_DIR }} && \
             chmod +x ${{ env.APP_DIR }}/server/SM_MentalHealthApp.Server.dll"
      
      - name: Run database migrations
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.SSH_USER }}@${{ env.SSH_HOST_PROD }} \
            "cd ${{ env.APP_DIR }}/server && \
             dotnet ef database update --no-build --project . || echo 'Migrations skipped'"
        continue-on-error: true
      
      - name: Restart application
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.SSH_USER }}@${{ env.SSH_HOST_PROD }} \
            "systemctl restart mental-health-app && \
             sleep 5 && \
             systemctl status mental-health-app --no-pager | head -15"
      
      - name: Health check
        run: |
          echo "Waiting for application to start..."
          sleep 10
          for i in {1..5}; do
            if curl -k -f https://${{ env.SSH_HOST_PROD }}/api/health; then
              echo "‚úÖ Health check passed!"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 5
          done
          echo "‚ùå Health check failed after 5 attempts"
          exit 1
      
      - name: Rollback on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed, rolling back..."
          ssh -o StrictHostKeyChecking=no ${{ env.SSH_USER }}@${{ env.SSH_HOST_PROD }} \
            "LATEST_BACKUP=\$(ls -t ${{ env.APP_DIR }}/backup/*.tar.gz | head -1) && \
             if [ -n \"\$LATEST_BACKUP\" ]; then
               tar -xzf \$LATEST_BACKUP -C / && \
               systemctl restart mental-health-app && \
               echo '‚úÖ Rollback completed'
             else
               echo '‚ö†Ô∏è No backup found for rollback'
             fi"
        continue-on-error: true
      
      - name: Deployment summary
        if: success()
        run: |
          echo "‚úÖ Deployment to ${{ env.ENVIRONMENT }} completed successfully!"
          echo "üåê Server: https://${{ env.SSH_HOST_PROD }}"
          echo "üì¶ Branch: ${{ github.ref_name }}"
          echo "üî® Commit: ${{ github.sha }}"
          echo "üë§ Deployed by: ${{ github.actor }}"

