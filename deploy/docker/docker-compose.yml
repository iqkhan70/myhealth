services:
  api:
    image: ${API_IMAGE}
    expose:
      - "5262"
    depends_on:
      - redis
      - ollama
      - mysql
    environment:
      ASPNETCORE_ENVIRONMENT: "${ASPNETCORE_ENVIRONMENT}"
      ASPNETCORE_URLS: "http://0.0.0.0:5262"

      # DB connection
      # Use MYSQL_CONN from .env file (ConnectionStrings__MySQL in .env is just for reference)
      ConnectionStrings__MySQL: "${MYSQL_CONN}"

      # Redis
      Redis__ConnectionString: "redis:6379"

      # Ollama
      Ollama__BaseUrl: "http://ollama:11434"

      # OpenAI
      OpenAI__ApiKey: "${OPENAI_API_KEY}"

      # JWT
      Jwt__Key: "${JWT_KEY}"
      Jwt__Issuer: "SM_MentalHealthApp"
      Jwt__Audience: "SM_MentalHealthApp_Users"

      # Spaces
      S3__AccessKey: "${S3_ACCESS_KEY}"
      S3__SecretKey: "${S3_SECRET_KEY}"
      S3__BucketName: "${S3_BUCKET}"
      S3__Region: "${S3_REGION}"
      S3__ServiceUrl: "${S3_SERVICE_URL}"
      S3__Folder: "${S3_FOLDER}"

      # Vonage
      Vonage__Enabled: "${VONAGE_ENABLED}"
      Vonage__ApiKey: "${VONAGE_API_KEY}"
      Vonage__ApiSecret: "${VONAGE_API_SECRET}"
      Vonage__FromNumber: "${VONAGE_FROM_NUMBER}"

      # Agora
      Agora__AppId: "${AGORA_APP_ID}"
      Agora__UseTokens: "${AGORA_USE_TOKENS}"
      Agora__AppCertificate: "${AGORA_APP_CERT}"

      # Email
      Email__SmtpHost: "${EMAIL_SMTPHOST}"
      Email__SmtpPort: 587
      Email__SmtpUsername: "${EMAIL_SMTPUSERNAME}"
      Email__SmtpPassword: "${EMAIL_SMTPPASSWORD}"
      Email__FromEmail: "${EMAIL_FROMEMAIL}"
      Email__FromName: "Customer Support App"
      Email__EnableSsl: "true"

    networks:
      - internal
    restart: always

  web:
    image: ${WEB_IMAGE}
    container_name: mental-health-web
    depends_on:
      - api
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /opt/mental-health-app/certs:/etc/nginx/ssl:ro
    networks:
      - internal
    restart: always

  mysql:
    image: mysql:8.0
    container_name: mental-health-mysql
    environment:
      MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD}"
      MYSQL_DATABASE: "${MYSQL_DB}"
      MYSQL_USER: "${MYSQL_USER}"
      MYSQL_PASSWORD: "${MYSQL_PASSWORD}"
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - internal
    restart: always

  redis:
    image: redis:7
    container_name: mental-health-redis
    networks:
      - internal
    restart: always

  ollama:
    image: ollama/ollama:latest
    container_name: mental-health-ollama
    environment:
      OLLAMA_HOST: "0.0.0.0:11434"
      OLLAMA_ORIGINS: "*"
      OLLAMA_KEEP_ALIVE: "5m"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - internal
    restart: always

networks:
  internal:

volumes:
  mysql_data:
  ollama_data:
