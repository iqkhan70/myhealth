@using SM_MentalHealthApp.Shared
@using SM_MentalHealthApp.Client.Services
@using SM_MentalHealthApp.Client.Components
@inject IServiceRequestService ServiceRequestService
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject IAuthService AuthService

<div class="edit-service-request-dialog">
    <RadzenForm Data="@updateRequest" Submit="@OnSubmit" class="dialog-form">
        <div class="row">
            <div class="col-12 mb-3">
                <RadzenFormField Text="Title" class="w-100">
                    <RadzenTextBox @bind-Value="@updateRequest.Title" Placeholder="Enter service request title..." Style="width: 100%" MaxLength="200" />
                    <RadzenFormFieldValidator Component="Title" Text="Title is required" />
                </RadzenFormField>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <RadzenFormField Text="Type" class="w-100">
                    <RadzenDropDown @bind-Value="@updateRequest.Type" 
                                   Data="@typeOptions" 
                                   Placeholder="Select type..."
                                   Style="width: 100%"
                                   TValue="string" />
                </RadzenFormField>
            </div>
            <div class="col-md-6 mb-3">
                <RadzenFormField Text="Status" class="w-100">
                    <RadzenDropDown @bind-Value="@updateRequest.Status" 
                                   Data="@statusOptions" 
                                   Placeholder="Select status..."
                                   Style="width: 100%"
                                   TValue="string" />
                </RadzenFormField>
            </div>
        </div>

        <div class="row">
            <div class="col-12 mb-3">
                <RadzenFormField Text="Description" class="w-100">
                    <RadzenTextArea @bind-Value="@updateRequest.Description" 
                                   Placeholder="Enter description (optional)..." 
                                   Style="width: 100%; min-height: 100px;"
                                   MaxLength="1000" />
                </RadzenFormField>
            </div>
        </div>

        @if (AuthService.CurrentUser?.RoleId != 1) // Only coordinators/admins can set expertise
        {
            <div class="row">
                <div class="col-12 mb-3">
                    <ExpertiseMultiSelect Label="Expertise Categories"
                                         Placeholder="Type to search and select expertise..."
                                         HelpText="Select one or more expertise categories for this service request"
                                         @bind-SelectedExpertiseIds="selectedExpertiseIds" />
                </div>
            </div>
        }

        <div class="row mt-4">
            <div class="col-12">
                <div class="d-flex justify-content-end gap-2">
                    <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@(() => DialogService.Close(false))" />
                    <RadzenButton Text="Save" ButtonStyle="ButtonStyle.Success" IsBusy="@isSubmitting" 
                        Disabled="@isSubmitting" Click="@HandleSaveClick" />
                </div>
            </div>
        </div>
    </RadzenForm>
</div>

<style>
    .edit-service-request-dialog {
        padding: 0;
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
        height: 100%;
        min-height: 100%;
    }
    
    .edit-service-request-dialog .dialog-form {
        display: flex;
        flex-direction: column;
        height: 100%;
        min-height: 100%;
    }
    
    .edit-service-request-dialog .dialog-form > .row:not(:last-child) {
        flex: 0 0 auto;
        padding: 0 20px;
        margin-bottom: 0;
    }
    
    .edit-service-request-dialog .dialog-form > .row:last-child {
        margin-top: auto;
        margin-bottom: 0;
        padding: 20px;
        border-top: 1px solid #dee2e6;
        background-color: #f8f9fa;
        flex-shrink: 0;
        align-self: flex-end;
        width: 100%;
    }
    
    /* Ensure dialog body is scrollable */
    :global(.rz-dialog-body) {
        overflow-y: auto !important;
        overflow-x: hidden !important;
        padding: 0 !important;
        display: flex !important;
        flex-direction: column !important;
        height: 100% !important;
    }
    
    /* Prevent horizontal scroll on form elements */
    .edit-service-request-dialog .row,
    .edit-service-request-dialog .col-12,
    .edit-service-request-dialog .col-md-6 {
        overflow-x: hidden;
    }
    
    /* Ensure expertise dropdown can expand */
    .edit-service-request-dialog .expertise-multi-select {
        position: relative;
        z-index: 1;
    }
</style>

@code {
    [Parameter] public ServiceRequestDto ServiceRequest { get; set; } = null!;

    private UpdateServiceRequestRequest updateRequest = new();
    private bool isSubmitting = false;
    private List<int> selectedExpertiseIds = new();

    private List<string> typeOptions = new()
    {
        "General",
        "Medical",
        "Legal",
        "Therapy",
        "Consultation",
        "Follow-up",
        "Emergency"
    };

    private List<string> statusOptions = new()
    {
        "Active",
        "Pending",
        "Completed",
        "Archived",
        "OnHold",
        "Cancelled"
    };

    protected override void OnInitialized()
    {
        // Initialize with current values
        updateRequest.Title = ServiceRequest.Title;
        updateRequest.Type = ServiceRequest.Type;
        updateRequest.Status = ServiceRequest.Status;
        updateRequest.Description = ServiceRequest.Description;

        // Load current expertise IDs
        if (ServiceRequest.ExpertiseIds != null)
        {
            selectedExpertiseIds = new List<int>(ServiceRequest.ExpertiseIds);
        }
    }

    private async Task HandleSaveClick()
    {
        await SaveServiceRequest();
    }

    private async Task OnSubmit(UpdateServiceRequestRequest model)
    {
        await SaveServiceRequest();
    }

    private async Task SaveServiceRequest()
    {
        if (string.IsNullOrWhiteSpace(updateRequest.Title))
        {
            NotificationService.Notify(NotificationSeverity.Error, "Validation Error", "Please enter a title");
            return;
        }

        if (isSubmitting) return;

        isSubmitting = true;
        StateHasChanged();
        
        try
        {
            // Set expertise IDs if selected
            if (AuthService.CurrentUser?.RoleId != 1 && selectedExpertiseIds.Any())
            {
                updateRequest.ExpertiseIds = selectedExpertiseIds;
            }
            else if (AuthService.CurrentUser?.RoleId != 1)
            {
                // Clear expertise if none selected
                updateRequest.ExpertiseIds = new List<int>();
            }

            var updated = await ServiceRequestService.UpdateServiceRequestAsync(ServiceRequest.Id, updateRequest);
            
            if (updated != null)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", $"Service request '{updated.Title}' updated successfully");
                await Task.Delay(100);
                DialogService.Close(true);
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to update service request");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to update service request: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }
}

