@using SM_MentalHealthApp.Shared
@using SM_MentalHealthApp.Client.Services
@using SM_MentalHealthApp.Client.Components
@inject IServiceRequestService ServiceRequestService
@inject IExpertiseService ExpertiseService
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject IAuthService AuthService

<div class="create-service-request-dialog">
    <RadzenForm Data="@request" Submit="@OnSubmit" class="dialog-form">
        @if (AuthService.CurrentUser?.RoleId != 1) // Not a Patient
        {
            <div class="row">
                <div class="col-12 mb-3">
                    <RadzenFormField Text="Client" class="w-100">
                        <RadzenDropDown @bind-Value="@request.ClientId" 
                                       @bind-Value:after="OnClientSelected"
                                       Data="@Clients" 
                                       ValueProperty="Id" 
                                       TextProperty="FullName"
                                       Placeholder="Select a client..."
                                       AllowFiltering="true"
                                       FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                       Style="width: 100%"
                                       TValue="int">
                            <EmptyMessageTemplate>
                                No clients found
                            </EmptyMessageTemplate>
                        </RadzenDropDown>
                        <RadzenFormFieldValidator Component="ClientId" Text="Client is required" />
                    </RadzenFormField>
                </div>
            </div>
        }

        <div class="row">
            <div class="col-12 mb-3">
                <RadzenFormField Text="Title" class="w-100">
                    <RadzenTextBox @bind-Value="@request.Title" Placeholder="Enter service request title..." Style="width: 100%" MaxLength="200" />
                    <RadzenFormFieldValidator Component="Title" Text="Title is required" />
                </RadzenFormField>
            </div>
        </div>

        <div class="row">
            <div class="@(AuthService.CurrentUser?.RoleId == 1 ? "col-12" : "col-md-6") mb-3">
                <RadzenFormField Text="Type" class="w-100">
                    <RadzenDropDown @bind-Value="@request.Type" 
                                   Data="@typeOptions" 
                                   Placeholder="Select type..."
                                   Style="width: 100%"
                                   TValue="string" />
                </RadzenFormField>
            </div>
            @if (AuthService.CurrentUser?.RoleId != 1) // Not a Patient - only coordinators/admins can assign SMEs
            {
                <div class="col-md-6 mb-3">
                    <RadzenFormField Text="Initial SME (Optional)" class="w-100">
                        <RadzenDropDown @bind-Value="@initialSmeUserId" 
                                       Data="@SMEs" 
                                       ValueProperty="Id" 
                                       TextProperty="FullName"
                                       Placeholder="Select an SME to assign..."
                                       AllowFiltering="true"
                                       FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                       AllowClear="true"
                                       Style="width: 100%"
                                       TValue="int?" />
                    </RadzenFormField>
                </div>
            }
        </div>

        <div class="row">
            <div class="col-12 mb-3">
                <RadzenFormField Text="Description" class="w-100">
                    <RadzenTextArea @bind-Value="@request.Description" 
                                   Placeholder="Enter description (optional)..." 
                                   Style="width: 100%; min-height: 100px;"
                                   MaxLength="1000" />
                </RadzenFormField>
            </div>
        </div>

        @if (AuthService.CurrentUser?.RoleId != 1) // Only coordinators/admins can set expertise
        {
            <div class="row">
                <div class="col-12 mb-3">
                    <ExpertiseMultiSelect Label="Expertise Categories"
                                         Placeholder="Type to search and select expertise..."
                                         HelpText="Select one or more expertise categories for this service request"
                                         SelectedExpertiseIds="selectedExpertiseIds"
                                         SelectedExpertiseIdsChanged="@OnExpertiseIdsChanged" />
                </div>
            </div>
            @if (selectedExpertiseIds.Any())
            {
                <div class="row">
                    <div class="col-12 mb-3">
                        <RadzenFormField Text="Primary Expertise (for Billing)" class="w-100">
                            <RadzenDropDown @bind-Value="@request.PrimaryExpertiseId" 
                                           Data="@availablePrimaryExpertises" 
                                           ValueProperty="Id" 
                                           TextProperty="Name"
                                           Placeholder="Select primary expertise for billing..."
                                           AllowFiltering="true"
                                           FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                           Style="width: 100%"
                                           TValue="int?">
                                <EmptyMessageTemplate>
                                    No expertise selected
                                </EmptyMessageTemplate>
                            </RadzenDropDown>
                            <RadzenFormFieldHint Text="Select the primary expertise that will be used for billing purposes" />
                        </RadzenFormField>
                    </div>
                </div>
            }
        }

        <div class="row">
            <div class="col-md-6 mb-3">
                <RadzenFormField Text="Service Location ZIP Code" class="w-100">
                    <RadzenTextBox @bind-Value="@request.ServiceZipCode" 
                                   Placeholder="Enter ZIP code (defaults to client ZIP)..." 
                                   Style="width: 100%" 
                                   MaxLength="10" />
                    <RadzenFormFieldHint Text="Leave empty to use client's ZIP code" />
                </RadzenFormField>
            </div>
            <div class="col-md-6 mb-3">
                <RadzenFormField Text="Max Search Distance (miles)" class="w-100">
                    <RadzenDropDown @bind-Value="@maxDistanceMiles" 
                                   Data="@distanceOptions" 
                                   Placeholder="Select max distance..."
                                   Style="width: 100%"
                                   TValue="int" />
                    <RadzenFormFieldHint Text="Maximum distance to search for SMEs" />
                </RadzenFormField>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="d-flex justify-content-end gap-2">
                    <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@(() => DialogService.Close(false))" />
                    <RadzenButton Text="Create" ButtonStyle="ButtonStyle.Success" IsBusy="@isSubmitting" 
                        Disabled="@isSubmitting" Click="@HandleCreateClick" />
                </div>
            </div>
        </div>
    </RadzenForm>
</div>

<style>
    .create-service-request-dialog {
        padding: 0;
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
        height: 100%;
        min-height: 100%;
    }
    
    .create-service-request-dialog .dialog-form {
        display: flex;
        flex-direction: column;
        height: 100%;
        min-height: 100%;
    }
    
    .create-service-request-dialog .dialog-form > .row:not(:last-child) {
        flex: 0 0 auto;
        padding: 0 20px;
        margin-bottom: 0;
    }
    
    .create-service-request-dialog .dialog-form > .row:last-child {
        margin-top: auto;
        margin-bottom: 0;
        padding: 20px;
        border-top: 1px solid #dee2e6;
        background-color: #f8f9fa;
        flex-shrink: 0;
        align-self: flex-end;
        width: 100%;
    }
    
    /* Ensure dialog body is scrollable */
    :global(.rz-dialog-body) {
        overflow-y: auto !important;
        overflow-x: hidden !important;
        padding: 0 !important;
        display: flex !important;
        flex-direction: column !important;
        height: 100% !important;
    }
    
    /* Prevent horizontal scroll on form elements */
    .create-service-request-dialog .row,
    .create-service-request-dialog .col-12,
    .create-service-request-dialog .col-md-6 {
        overflow-x: hidden;
    }
    
    /* Ensure expertise dropdown can expand */
    .create-service-request-dialog .expertise-multi-select {
        position: relative;
        z-index: 1;
    }
</style>

@code {
    [Parameter] public List<User> Clients { get; set; } = new();
    [Parameter] public List<User> SMEs { get; set; } = new();

    private CreateServiceRequestRequest request = new();
    private int? initialSmeUserId;
    private bool isSubmitting = false;
    private List<int> selectedExpertiseIds = new();
    private List<Expertise> allExpertises = new();
    private List<Expertise> availablePrimaryExpertises = new();
    private int maxDistanceMiles = 50;

    private List<string> typeOptions = new()
    {
        "General",
        "Medical",
        "Legal",
        "Therapy",
        "Consultation",
        "Follow-up",
        "Emergency"
    };

    private List<int> distanceOptions = new()
    {
        25,
        50,
        100,
        200
    };

    private async Task HandleCreateClick()
    {
        await CreateServiceRequest();
    }

    private async Task OnSubmit(CreateServiceRequestRequest model)
    {
        await CreateServiceRequest();
    }

    protected override async Task OnInitializedAsync()
    {
        // Auto-set ClientId for patients
        if (AuthService.CurrentUser?.RoleId == 1 && AuthService.CurrentUser?.Id > 0)
        {
            request.ClientId = AuthService.CurrentUser.Id;
            // Note: ServiceZipCode will default to client's ZIP code on the backend if not provided
        }

        // Load expertises for primary expertise dropdown
        if (AuthService.CurrentUser?.RoleId != 1)
        {
            await LoadExpertises();
        }
    }

    private async Task LoadExpertises()
    {
        try
        {
            allExpertises = await ExpertiseService.GetAllExpertisesAsync(activeOnly: true);
            UpdateAvailablePrimaryExpertises();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading expertises: {ex.Message}");
        }
    }

    private void OnExpertiseIdsChanged()
    {
        UpdateAvailablePrimaryExpertises();
        
        // Auto-select PrimaryExpertiseId if only one expertise is selected
        if (selectedExpertiseIds.Count == 1)
        {
            request.PrimaryExpertiseId = selectedExpertiseIds.First();
        }
        else if (selectedExpertiseIds.Count == 0)
        {
            request.PrimaryExpertiseId = null;
        }
        // If multiple expertise selected and PrimaryExpertiseId is not in the list, clear it
        else if (request.PrimaryExpertiseId.HasValue && !selectedExpertiseIds.Contains(request.PrimaryExpertiseId.Value))
        {
            request.PrimaryExpertiseId = null;
        }
        
        StateHasChanged();
    }

    private void UpdateAvailablePrimaryExpertises()
    {
        if (selectedExpertiseIds.Any())
        {
            availablePrimaryExpertises = allExpertises
                .Where(e => selectedExpertiseIds.Contains(e.Id))
                .ToList();
        }
        else
        {
            availablePrimaryExpertises = new List<Expertise>();
        }
    }

    private void OnClientSelected()
    {
        // When client is selected, default ServiceZipCode to client's ZIP
        if (request.ClientId > 0)
        {
            var selectedClient = Clients.FirstOrDefault(c => c.Id == request.ClientId);
            if (selectedClient != null && !string.IsNullOrEmpty(selectedClient.ZipCode))
            {
                request.ServiceZipCode = selectedClient.ZipCode;
                StateHasChanged();
            }
        }
    }

    private async Task CreateServiceRequest()
    {
        Console.WriteLine("CreateServiceRequest called!");
        NotificationService.Notify(NotificationSeverity.Info, "Debug", "Create button clicked!");
        
        // Validate
        if (request.ClientId <= 0)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Validation Error", "Please select a client");
            return;
        }

        if (string.IsNullOrWhiteSpace(request.Title))
        {
            NotificationService.Notify(NotificationSeverity.Error, "Validation Error", "Please enter a title");
            return;
        }

        if (isSubmitting) return; // Prevent double submission

        isSubmitting = true;
        StateHasChanged();
        
        try
        {
            Console.WriteLine($"Creating service request: ClientId={request.ClientId}, Title={request.Title}");
            
            // Set the SmeUserId if an initial SME was selected (only for non-patients)
            if (AuthService.CurrentUser?.RoleId != 1 && initialSmeUserId.HasValue)
            {
                request.SmeUserId = initialSmeUserId.Value;
            }
            else
            {
                // Patients cannot assign SMEs
                request.SmeUserId = null;
            }

            // Set expertise IDs if selected
            if (AuthService.CurrentUser?.RoleId != 1 && selectedExpertiseIds.Any())
            {
                request.ExpertiseIds = selectedExpertiseIds;
                
                // Set PrimaryExpertiseId if not set but only one expertise selected
                if (!request.PrimaryExpertiseId.HasValue && selectedExpertiseIds.Count == 1)
                {
                    request.PrimaryExpertiseId = selectedExpertiseIds.First();
                }
            }

            // Set location fields
            request.MaxDistanceMiles = maxDistanceMiles;
            // ServiceZipCode is already bound to request.ServiceZipCode

            var created = await ServiceRequestService.CreateServiceRequestAsync(request);
            Console.WriteLine($"Service request created successfully: {created.Id}");
            
            NotificationService.Notify(NotificationSeverity.Success, "Success", $"Service request '{created.Title}' created successfully");
            
            // Small delay to ensure notification is shown
            await Task.Delay(100);
            
            // Close the dialog
            DialogService.Close(true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error creating service request: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to create service request: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }
}

