@using SM_MentalHealthApp.Shared
@using Radzen
@using Radzen.Blazor

<div class="p-3">
    <RadzenFieldset Text="Ready to Bill Assignments">
        @{
            // SIMPLIFIED: One invoice per Service Request
            var assignmentsBySr = Assignments.GroupBy(a => a.ServiceRequestId).ToList();
            var invoiceCount = assignmentsBySr.Count;
        }
        <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle"></i>
            <strong>@Assignments.Count</strong> assignment(s) will generate <strong>@invoiceCount</strong> invoice(s).
            <br />
            <small>
                <strong>Billing Rules:</strong>
                <ul class="mb-0 mt-1">
                    <li>One invoice per Service Request</li>
                    <li>All assignments for a Service Request will be included in one invoice</li>
                </ul>
            </small>
        </div>

        @foreach (var srGroup in assignmentsBySr)
        {
            var firstAssignment = srGroup.First();
            
            <div class="mb-4">
                <h6 class="mb-2">
                    <i class="fas fa-file-invoice"></i> Invoice for SR #@srGroup.Key: @firstAssignment.ServiceRequestTitle
                    <span class="badge bg-primary ms-2">@srGroup.Count() assignment(s)</span>
                </h6>
                <RadzenDataGrid Data="@srGroup.ToList()" TItem="BillableAssignmentDto" 
                    AllowPaging="false" AllowSorting="false" Style="margin-bottom: 20px;">
                    <Columns>
                        <RadzenDataGridColumn TItem="BillableAssignmentDto" Property="ServiceRequestId" Title="SR ID" Width="80px" />
                        <RadzenDataGridColumn TItem="BillableAssignmentDto" Property="ServiceRequestTitle" Title="Service Request" Width="200px" />
                        <RadzenDataGridColumn TItem="BillableAssignmentDto" Property="SmeUserName" Title="SME" Width="150px" />
                        <RadzenDataGridColumn TItem="BillableAssignmentDto" Property="ClientName" Title="Client" Width="150px" />
                        <RadzenDataGridColumn TItem="BillableAssignmentDto" Property="Status" Title="Status" Width="100px">
                            <Template Context="assignment">
                                <span class="badge @GetStatusClass(assignment.Status)">@assignment.Status</span>
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="BillableAssignmentDto" Property="StartedAt" Title="Started" Width="120px">
                            <Template Context="assignment">
                                @(assignment.StartedAt?.ToString("MM/dd/yyyy") ?? "N/A")
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="BillableAssignmentDto" Property="CompletedAt" Title="Completed" Width="120px">
                            <Template Context="assignment">
                                @(assignment.CompletedAt?.ToString("MM/dd/yyyy") ?? "-")
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="BillableAssignmentDto" Property="DaysToComplete" Title="Days" Width="80px">
                            <Template Context="assignment">
                                @if (assignment.DaysToComplete.HasValue)
                                {
                                    <span>@assignment.DaysToComplete.Value</span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
            </div>
        }
    </RadzenFieldset>

    <div class="d-flex justify-content-end gap-2 mt-3">
        <RadzenButton Text="Close" ButtonStyle="ButtonStyle.Light" Click="@(() => DialogService.Close())" />
    </div>
</div>

@code {
    [Parameter] public List<BillableAssignmentDto> Assignments { get; set; } = new();

    [Inject] private DialogService DialogService { get; set; } = null!;

    private string GetStatusClass(string status)
    {
        return status?.ToLower() switch
        {
            "inprogress" => "bg-warning",
            "completed" => "bg-success",
            _ => "bg-secondary"
        };
    }
}

