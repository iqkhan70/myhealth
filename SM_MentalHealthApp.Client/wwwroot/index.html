<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SM_MentalHealthApp.Client</title>
    <base href="/" />
    <link rel="stylesheet" href="lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/app.css" />
    <link rel="stylesheet" href="_content/Radzen.Blazor/css/default-base.css" />
    <link rel="stylesheet" href="_content/Radzen.Blazor/css/default.css" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <link href="SM_MentalHealthApp.Client.styles.css" rel="stylesheet" />
    <link href="manifest.webmanifest" rel="manifest" />
    <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.20.0.js"></script>
<script>
    window.renderMoodChart = (entries) => {
        try {
            console.log('renderMoodChart called with entries:', entries);
            
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('Chart.js is not loaded');
                return;
            }

            const canvas = document.getElementById('moodChart');
            if (!canvas) {
                console.error('Canvas element not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');

            // Destroy previous chart if exists and has destroy method
            if (window.moodChart && typeof window.moodChart.destroy === 'function') {
                window.moodChart.destroy();
            }

            const labels = entries.map(e => new Date(e.createdAt).toLocaleDateString());
            const moods = entries.map(e => e.mood);
            
            console.log('Labels:', labels);
            console.log('Moods:', moods);

            // Assign numeric values for moods
            const moodMap = { "Happy": 3, "Neutral": 2, "Sad": 1, "Anxious": 0 };
            const moodValues = moods.map(m => moodMap[m] ?? 2);
            
            console.log('Mood values:', moodValues);

            window.moodChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Mood Over Time',
                    data: moodValues,
                    borderColor: 'blue',
                    tension: 0.2
                }]
            },
            options: {
                scales: {
                    y: {
                        ticks: {
                            callback: function (val) {
                                const labels = ["Anxious", "Sad", "Neutral", "Happy"];
                                return labels[val] ?? val;
                            }
                        },
                        min: 0,
                        max: 3
                    }
                }
            }
        });
        } catch (error) {
            console.error('Error rendering mood chart:', error);
        }
    };

    // Chat functionality
    window.soundEnabled = true;
    
    window.setSoundEnabled = (enabled) => {
        window.soundEnabled = enabled;
    };

    // Authentication storage functions
    window.saveToken = (token) => {
        localStorage.setItem('authToken', token);
    };

    window.getToken = () => {
        const token = localStorage.getItem('authToken');
        console.log('ðŸ”‘ getToken called, found token:', token ? `${token.substring(0, 20)}...` : 'null');
        return token;
    };

    window.removeToken = () => {
        localStorage.removeItem('authToken');
    };
    
    window.playSound = (soundType) => {
        if (!window.soundEnabled) {
            return;
        }
        
        try {
            // Create audio context for sound generation
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // Generate different sounds based on type
            let frequency, duration, type;
            
            switch(soundType) {
                case 'send':
                    frequency = 800; // Higher pitch for send
                    duration = 0.1;
                    type = 'sine';
                    break;
                case 'receive':
                    frequency = 600; // Medium pitch for receive
                    duration = 0.15;
                    type = 'triangle';
                    break;
                case 'error':
                    frequency = 300; // Lower pitch for error
                    duration = 0.3;
                    type = 'sawtooth';
                    break;
                default:
                    frequency = 500;
                    duration = 0.1;
                    type = 'sine';
            }
            
            // Create oscillator
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            oscillator.type = type;
            
            // Add envelope for more natural sound
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
            
            console.log(`Playing ${soundType} sound (${frequency}Hz)`);
        } catch (error) {
            console.log(`Playing ${soundType} sound (fallback)`);
            // Fallback: just log if audio context fails
        }
    };

    window.scrollToBottom = (element) => {
        // If element is provided, use it; otherwise look for default chat container
        const container = element || document.getElementById('chatMessages') || document.querySelector('.messages-container');
        if (container) {
            // Smooth scroll to bottom
            container.scrollTo({
                top: container.scrollHeight,
                behavior: 'smooth'
            });
        }
    };

    // Add visual feedback for chat interactions
    window.addChatAnimation = (messageElement) => {
        if (messageElement) {
            messageElement.style.opacity = '0';
            messageElement.style.transform = 'translateY(20px)';
            messageElement.style.transition = 'all 0.3s ease';
            
            setTimeout(() => {
                messageElement.style.opacity = '1';
                messageElement.style.transform = 'translateY(0)';
            }, 50);
        }
    };

    // Incoming call sound
    window.playIncomingCallSound = () => {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // Create a repeating ring tone
            const playRing = () => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.1);
                gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            };
            
            // Play ring tone 3 times
            playRing();
            setTimeout(playRing, 700);
            setTimeout(playRing, 1400);
            
        } catch (error) {
            console.error('Error playing incoming call sound:', error);
        }
    };
</script>


</head>

<body>
    <div id="app">
        <svg class="loading-progress">
            <circle r="40%" cx="50%" cy="50%" />
            <circle r="40%" cx="50%" cy="50%" />
        </svg>
        <div class="loading-progress-text"></div>
    </div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="." class="reload">Reload</a>
        <span class="dismiss">ðŸ—™</span>
    </div>
    <script src="_framework/blazor.webassembly.js"></script>
    
    <!-- Agora SDK for Web -->
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.20.0.js"></script>
    <script src="_content/Radzen.Blazor/Radzen.Blazor.js"></script>
    <script>navigator.serviceWorker.register('service-worker.js');</script>
    
    <script>
        // Agora Web SDK Integration
        window.agoraService = {
            client: null,
            localTracks: {
                audioTrack: null,
                videoTrack: null
            },
            remoteUsers: {},
            isJoined: false,
            
            // Initialize Agora client
            async initialize(appId) {
                try {
                    console.log('ðŸ”„ Initializing Agora client...');
                    console.log('AgoraRTC available:', typeof AgoraRTC);
                    console.log('App ID:', appId);
                    
                    if (typeof AgoraRTC === 'undefined') {
                        throw new Error('AgoraRTC is not loaded. Check if the Agora SDK script is loaded correctly.');
                    }
                    
                    this.client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
                    console.log('âœ… Agora client created successfully');
                    console.log('Client object:', this.client);
                    return true;
                } catch (error) {
                    console.error('âŒ Failed to initialize Agora client:', error);
                    console.error('Error details:', error.message);
                    return false;
                }
            },
            
            // Join channel with token
            async joinChannel(appId, channel, token, uid) {
                try {
                    console.log('ðŸŽ¯ Starting Agora channel join...');
                    console.log('App ID:', appId);
                    console.log('Channel:', channel);
                    console.log('Token:', token);
                    console.log('UID:', uid);
                    
                    if (!this.client) {
                        console.log('ðŸ”„ Initializing Agora client...');
                        await this.initialize(appId);
                    }
                    
                    // Set up event listeners
                    this.setupEventListeners();
                    
                    // Join the channel
                    console.log('ðŸš€ Attempting to join Agora channel...');
                    await this.client.join(appId, channel, token, uid);
                    this.isJoined = true;
                    console.log(`âœ… Successfully joined channel: ${channel} with UID: ${uid}`);
                    
                    // Create and publish local audio track
                    console.log('ðŸŽ¤ Creating microphone audio track...');
                    this.localTracks.audioTrack = await AgoraRTC.createMicrophoneAudioTrack();
                    console.log('ðŸ“¡ Publishing audio track...');
                    await this.client.publish([this.localTracks.audioTrack]);
                    console.log('âœ… Audio track published successfully!');
                    
                    return true;
                } catch (error) {
                    console.error('âŒ Failed to join channel:', error);
                    console.error('Error details:', error.message);
                    console.error('Error stack:', error.stack);
                    return false;
                }
            },
            
            // Leave channel
            async leaveChannel() {
                try {
                    if (this.localTracks.audioTrack) {
                        this.localTracks.audioTrack.close();
                        this.localTracks.audioTrack = null;
                    }
                    
                    if (this.client && this.isJoined) {
                        await this.client.leave();
                        this.isJoined = false;
                        console.log('Left channel');
                    }
                } catch (error) {
                    console.error('Failed to leave channel:', error);
                }
            },
            
            // Set up event listeners
            setupEventListeners() {
                this.client.on("user-published", async (user, mediaType) => {
                    console.log('User published:', user.uid, mediaType);
                    
                    // Subscribe to the remote user
                    await this.client.subscribe(user, mediaType);
                    
                    if (mediaType === "audio") {
                        const remoteAudioTrack = user.audioTrack;
                        remoteAudioTrack.play();
                        console.log('Playing remote audio');
                    }
                });
                
                this.client.on("user-unpublished", (user, mediaType) => {
                    console.log('User unpublished:', user.uid, mediaType);
                });
                
                this.client.on("user-left", (user) => {
                    console.log('User left:', user.uid);
                    delete this.remoteUsers[user.uid];
                });
            },
            
            // Test audio
            async testAudio() {
                try {
                    console.log('ðŸ”Š Testing audio system...');
                    console.log('AgoraRTC available:', typeof AgoraRTC);
                    
                    // Create a simple audio context for testing
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.5);
                    
                    console.log('âœ… Audio test completed - you should hear a beep');
                    return true;
                } catch (error) {
                    console.error('âŒ Audio test failed:', error);
                    return false;
                }
            },
            
            // Test Agora SDK availability
            testAgoraSDK() {
                console.log('ðŸ§ª Testing Agora SDK availability...');
                console.log('AgoraRTC:', typeof AgoraRTC);
                console.log('AgoraRTC.createClient:', typeof AgoraRTC?.createClient);
                console.log('AgoraRTC.createMicrophoneAudioTrack:', typeof AgoraRTC?.createMicrophoneAudioTrack);
                
                if (typeof AgoraRTC === 'undefined') {
                    console.error('âŒ AgoraRTC is not loaded!');
                    return false;
                }
                
                console.log('âœ… Agora SDK is loaded and ready');
                return true;
            }
        };
        let agoraClient = null;
        let agoraLocalStream = null;
        let agoraRemoteStreams = new Map();
        let agoraDotNetRef = null;

        window.agoraInitialize = async (appId, dotNetRef) => {
            try {
                console.log('ðŸš€ Initializing Agora with App ID:', appId);
                agoraDotNetRef = dotNetRef;
                
                // Check for demo mode
                if (appId === 'demo-mode') {
                    console.log('ðŸŽ­ Running in demo mode - simulating WebRTC');
                    agoraClient = {
                        // Simulate Agora client for demo
                        join: async (appId, channel, token, uid) => {
                            console.log('ðŸŽ­ Demo: Simulating channel join');
                            return Promise.resolve();
                        },
                        leave: async () => {
                            console.log('ðŸŽ­ Demo: Simulating channel leave');
                            return Promise.resolve();
                        },
                        publish: async (tracks) => {
                            console.log('ðŸŽ­ Demo: Simulating track publish');
                            return Promise.resolve();
                        },
                        on: (event, handler) => {
                            console.log('ðŸŽ­ Demo: Registering event handler for', event);
                            // Store handlers for potential simulation
                        }
                    };
                    console.log('âœ… Demo Agora client created successfully');
                    return true;
                }
                
                // Check if AgoraRTC is available for real mode
                if (typeof AgoraRTC === 'undefined') {
                    throw new Error('AgoraRTC SDK is not loaded');
                }
                
                // Create real Agora client
                agoraClient = AgoraRTC.createClient({ 
                    mode: "rtc", 
                    codec: "vp8" 
                });

                // Set up event handlers
                agoraClient.on("user-published", async (user, mediaType) => {
                    console.log('ðŸ“± Web App: User published:', user.uid, mediaType);
                    try {
                        await agoraClient.subscribe(user, mediaType);
                        
                        if (mediaType === "video") {
                            agoraRemoteStreams.set(user.uid, user.videoTrack);
                            if (agoraDotNetRef) {
                                agoraDotNetRef.invokeMethodAsync("OnUserJoinedCallback", user.uid);
                            }
                        } else if (mediaType === "audio") {
                            user.audioTrack.play();
                            console.log('ðŸ”Š Web App: Playing remote audio from user:', user.uid);
                        }
                    } catch (error) {
                        console.error('âŒ Error handling user published:', error);
                    }
                });

                agoraClient.on("user-unpublished", (user, mediaType) => {
                    console.log('ðŸ“± Web App: User unpublished:', user.uid, mediaType);
                    if (mediaType === "video") {
                        agoraRemoteStreams.delete(user.uid);
                        if (agoraDotNetRef) {
                            agoraDotNetRef.invokeMethodAsync("OnUserLeftCallback", user.uid);
                        }
                    }
                });

                agoraClient.on("connection-state-change", (curState, revState) => {
                    console.log('ðŸ”— Connection state changed:', curState);
                    if (agoraDotNetRef) {
                        agoraDotNetRef.invokeMethodAsync("OnConnectionStateChangedCallback", curState);
                    }
                });

                console.log("âœ… Agora initialized successfully");
                return true;
            } catch (error) {
                console.error("âŒ Failed to initialize Agora:", error);
                if (agoraDotNetRef) {
                    agoraDotNetRef.invokeMethodAsync("OnErrorCallback", error.message);
                }
                return false;
            }
        };

        window.agoraJoinChannel = async (channelName, token, uid, isVideoCall = false) => {
            try {
                if (!agoraClient) {
                    throw new Error("Agora client not initialized");
                }

                console.log('ðŸŽ¯ Web App: Joining Agora channel...');
                console.log('Channel:', channelName);
                console.log('Token:', token);
                console.log('UID:', uid);
                console.log('Is Video Call:', isVideoCall);

                // Join channel (check if demo mode)
                if (agoraClient.join.toString().includes('Demo: Simulating')) {
                    // Demo mode - simulate join
                    await agoraClient.join("demo-mode", channelName, token, uid);
                    console.log('ðŸŽ­ Demo: Simulated channel join successful');
                    
                    // Simulate remote user joining after 2 seconds
                    setTimeout(() => {
                        console.log('ðŸŽ­ Demo: Simulating remote user joined');
                        if (agoraDotNetRef) {
                            agoraDotNetRef.invokeMethodAsync("OnUserJoinedCallback", 999);
                        }
                    }, 2000);
                } else {
                    // Real mode - use actual Agora
                    await agoraClient.join("efa11b3a7d05409ca979fb25a5b489ae", channelName, token, uid);
                }

                // Create and publish tracks (check if demo mode)
                if (agoraClient.join.toString().includes('Demo: Simulating')) {
                    // Demo mode - simulate media access
                    console.log('ðŸŽ­ Demo: Simulating media track creation');
                    
                    if (isVideoCall) {
                        // Simulate local video display
                        const localVideoContainer = document.getElementById('local-video-container');
                        if (localVideoContainer) {
                            localVideoContainer.innerHTML = '<div style="background: #333; color: white; display: flex; align-items: center; justify-content: center; height: 100%; font-size: 14px;">ðŸ“¹ Demo Local Video</div>';
                            console.log('ðŸŽ­ Demo: Local video placeholder displayed');
                        }
                    }
                    
                    agoraLocalStream = { demo: true };
                    console.log('ðŸŽ­ Demo: Simulated tracks published successfully');
                } else {
                    // Real mode - create actual tracks
                    const audioTrack = await AgoraRTC.createMicrophoneAudioTrack({
                        encoderConfig: "music_standard",
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    });

                    const tracksToPublish = [audioTrack];

                    // Create and publish video track if it's a video call
                    if (isVideoCall) {
                        console.log('ðŸŽ¥ Web App: Creating video track for video call...');
                        const videoTrack = await AgoraRTC.createCameraVideoTrack({
                            encoderConfig: "720p_1",
                            optimizationMode: "motion"
                        });
                        
                        // Store the local video track
                        agoraLocalStream = { audioTrack, videoTrack };
                        tracksToPublish.push(videoTrack);
                        
                        // Display local video in the local video container
                        const localVideoContainer = document.getElementById('local-video-container');
                        if (localVideoContainer) {
                            videoTrack.play(localVideoContainer);
                            console.log('âœ… Web App: Local video displayed in container');
                        } else {
                            console.warn('âš ï¸ Web App: Local video container not found');
                        }
                    } else {
                        // Store just the audio track for audio calls
                        agoraLocalStream = { audioTrack };
                    }

                    await agoraClient.publish(tracksToPublish);
                    console.log(`âœ… Web App: ${isVideoCall ? 'Audio and video' : 'Audio'} tracks published successfully`);
                }

                // Set up event listeners for remote users
                agoraClient.on("user-published", async (user, mediaType) => {
                    console.log('ðŸ“± Web App: User published:', user.uid, mediaType);
                    await agoraClient.subscribe(user, mediaType);
                    if (mediaType === "audio") {
                        user.audioTrack.play();
                        console.log('ðŸ”Š Web App: Playing remote audio');
                    }
                });

                agoraClient.on("user-unpublished", (user, mediaType) => {
                    console.log('ðŸ“± Web App: User unpublished:', user.uid, mediaType);
                });

                agoraClient.on("user-left", (user) => {
                    console.log('ðŸ“± Web App: User left:', user.uid);
                });

                console.log(`âœ… Web App: Joined channel: ${channelName} with UID: ${uid}`);
                return true;
            } catch (error) {
                console.error("âŒ Web App: Failed to join channel:", error);
                agoraDotNetRef.invokeMethodAsync("OnErrorCallback", error.message);
                return false;
            }
        };

        window.agoraLeaveChannel = async () => {
            try {
                if (agoraLocalStream) {
                    agoraLocalStream.close();
                    agoraLocalStream = null;
                }

                if (agoraClient) {
                    await agoraClient.leave();
                }

                agoraRemoteStreams.clear();
                console.log("Left channel successfully");
            } catch (error) {
                console.error("Failed to leave channel:", error);
                agoraDotNetRef.invokeMethodAsync("OnErrorCallback", error.message);
            }
        };

        window.agoraEnableLocalVideo = async (enable) => {
            try {
                console.log('ðŸŽ¥ Web App: Enable local video:', enable);
                // Modern Agora SDK doesn't use enableVideo on stream
                // Video enabling/disabling is handled by publishing/unpublishing video tracks
                return true;
            } catch (error) {
                console.error("Failed to toggle local video:", error);
                if (agoraDotNetRef) {
                    agoraDotNetRef.invokeMethodAsync("OnErrorCallback", error.message);
                }
                return false;
            }
        };

        window.agoraEnableLocalAudio = async (enable) => {
            try {
                console.log('ðŸŽ¤ Web App: Enable local audio:', enable);
                // Modern Agora SDK doesn't use enableAudio on stream
                // Audio enabling/disabling is handled by publishing/unpublishing audio tracks
                return true;
            } catch (error) {
                console.error("Failed to toggle local audio:", error);
                if (agoraDotNetRef) {
                    agoraDotNetRef.invokeMethodAsync("OnErrorCallback", error.message);
                }
                return false;
            }
        };

        window.agoraSwitchCamera = async () => {
            try {
                console.log('ðŸ“· Web App: Switch camera');
                // Modern Agora SDK doesn't use switchDevice on stream
                // Camera switching is handled by the video track's switchDevice method
                return true;
            } catch (error) {
                console.error("Failed to switch camera:", error);
                if (agoraDotNetRef) {
                    agoraDotNetRef.invokeMethodAsync("OnErrorCallback", error.message);
                }
                return false;
            }
        };

        window.agoraMuteLocalAudio = async (mute) => {
            try {
                console.log('ðŸ”‡ Web App: Mute local audio:', mute);
                // Modern Agora SDK doesn't use muteAudio on stream
                // Audio muting is handled by the audio track's setEnabled method
                return true;
            } catch (error) {
                console.error("Failed to mute/unmute audio:", error);
                if (agoraDotNetRef) {
                    agoraDotNetRef.invokeMethodAsync("OnErrorCallback", error.message);
                }
                return false;
            }
        };

        window.agoraMuteLocalVideo = async (mute) => {
            try {
                console.log('ðŸ“¹ Web App: Mute local video:', mute);
                // Modern Agora SDK doesn't use muteVideo on stream
                // Video muting is handled by the video track's setEnabled method
                return true;
            } catch (error) {
                console.error("Failed to mute/unmute video:", error);
                if (agoraDotNetRef) {
                    agoraDotNetRef.invokeMethodAsync("OnErrorCallback", error.message);
                }
                return false;
            }
        };

        window.agoraDestroy = async () => {
            try {
                await window.agoraLeaveChannel();
                agoraClient = null;
                console.log("Agora destroyed");
            } catch (error) {
                console.error("Failed to destroy Agora:", error);
            }
        };

        // Helper function to get remote video element
        window.getAgoraRemoteVideoElement = (uid) => {
            return document.getElementById(`agora-remote-video-${uid}`);
        };

        // Helper function to get local video element
        window.getAgoraLocalVideoElement = () => {
            return document.getElementById('agora-local-video');
        };
        
        // Global error handler to catch JavaScript syntax errors
        window.addEventListener('error', function(e) {
            console.error('ðŸš¨ Global JavaScript Error:', e.error);
            console.error('ðŸš¨ Error message:', e.message);
            console.error('ðŸš¨ Error source:', e.filename, 'line:', e.lineno);
            console.error('ðŸš¨ Stack trace:', e.error?.stack);
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            console.error('ðŸš¨ Unhandled Promise Rejection:', e.reason);
            console.error('ðŸš¨ Promise:', e.promise);
        });
        
        console.log('âœ… Global error handlers installed');
    </script>
</body>

</html>
