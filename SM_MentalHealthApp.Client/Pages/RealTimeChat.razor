@page "/real-time-chat"
@using SM_MentalHealthApp.Client.Services
@using SM_MentalHealthApp.Shared
@using System.Text.Json
@using ChatMsg = SM_MentalHealthApp.Client.Services.ChatMessage
@inject IAuthService AuthService
@inject IRealtimeService RealtimeService
@inject ISignalRService SignalRService
@inject IAgoraService AgoraService
@inject HttpClient Http
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject IJSRuntime JS
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Real-Time Chat</PageTitle>

<div class="chat-container">
    <!-- Header -->
    <div class="chat-header">
        <div class="header-left">
            <h3>
                @if (AuthService.CurrentUser?.RoleId == 2)
                {
                    <text>üí¨ Patient Chat</text>
                }
                else
                {
                    <text>üí¨ Doctor Chat</text>
                }
            </h3>
        </div>
        <div class="header-actions">
            <div class="connection-indicator">
                <div class="connection-dot @(RealtimeService.IsConnected ? "connected" : "disconnected")"></div>
                <span>@(RealtimeService.IsConnected ? "Connected" : "Disconnected")</span>
                @if (!RealtimeService.IsConnected)
                {
                    <button class="retry-btn" @onclick="RetryConnection" title="Retry Connection">
                        <i class="fas fa-refresh"></i>
                    </button>
                }
                <button class="test-call-btn" @onclick="TestIncomingCall" title="Test Incoming Call">
                    <i class="fas fa-phone"></i>
                </button>
                <button class="test-audio-btn" @onclick="TestAudio" title="Test Audio System">
                    <i class="fas fa-volume-up"></i>
                </button>
                <button class="test-agora-btn" @onclick="TestAgoraSDK" title="Test Agora SDK">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Active Call Banner (for caller) -->
    @if (activeCall != null)
    {
        <div class="active-call-banner">
            <div class="call-banner-content">
                <div class="call-banner-info">
                    <i class="fas fa-phone-alt"></i>
                    <span>
                        <strong>@(activeCall.CallType == "video" ? "Video" : "Audio") Call</strong> with @activeCall.TargetUserName
                    </span>
                </div>
                <button class="btn btn-danger btn-sm" @onclick="EndActiveCall">
                    <i class="fas fa-phone-slash"></i> End Call
                </button>
            </div>
        </div>
    }

    <!-- Incoming Call Modal -->
    @if (incomingCall != null)
    {
        <div class="incoming-call-modal">
            <div class="incoming-call-content">
                <div class="caller-info">
                    <div class="caller-avatar">
                        @incomingCall.CallerName?.Substring(0, 1).ToUpper()
                    </div>
                    <div class="caller-details">
                        <h3>@incomingCall.CallerName</h3>
                        <p>@(incomingCall.CallType == "video" ? "Video Call" : "Audio Call")</p>
                    </div>
                </div>
                <div class="call-actions">
                    <button class="btn btn-success btn-lg" @onclick="AcceptCall">
                        <i class="fas fa-phone"></i> Accept
                    </button>
                    <button class="btn btn-danger btn-lg" @onclick="RejectCall">
                        <i class="fas fa-phone-slash"></i> Decline
                    </button>
                </div>
            </div>
        </div>
    }

    <div class="chat-main">
        <!-- Sidebar with users -->
        <div class="chat-sidebar">
            <div class="sidebar-header">
                <h4>
                    @if (AuthService.CurrentUser?.RoleId == 2)
                    {
                        <text>My Patients</text>
                    }
                    else
                    {
                        <text>My Doctors</text>
                    }
                </h4>
                <button class="refresh-btn" @onclick="LoadUsers" disabled="@isLoadingUsers">
                    <i class="fas fa-refresh @(isLoadingUsers ? "spinning" : "")"></i>
                </button>
            </div>

            <div class="user-list">
                @if (isLoadingUsers)
                {
                    <div class="loading-item">
                        <div class="loading-spinner"></div>
                        <span>Loading...</span>
                    </div>
                }
                else if (users.Any())
                {
                    @foreach (var user in users)
                    {
                        <div class="user-item @(selectedUser?.Id == user.Id ? "selected" : "")"
                            @onclick="async () => await SelectUser(user)">
                            <div class="user-info">
                                <div class="user-name">@user.FirstName @user.LastName</div>
                                <div class="user-status">
                                    @if (AuthService.CurrentUser?.RoleId == 1)
                                    {
                                        <span class="user-specialization">@(user.Specialization ?? "Doctor")</span>
                                    }
                                </div>
                            </div>
                            <div class="user-actions">
                                <button class="action-btn video-btn" @onclick:stopPropagation="true"
                                    @onclick="() => InitiateVideoCall(user)" title="Start Video Call">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path
                                            d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z" />
                                    </svg>
                                </button>
                                <button class="action-btn audio-btn" @onclick:stopPropagation="true"
                                    @onclick="() => InitiateAudioCall(user)" title="Start Audio Call">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path
                                            d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <p>
                            @if (AuthService.CurrentUser?.RoleId == 2)
                            {
                                <text>No patients assigned</text>
                            }
                            else
                            {
                                <text>No doctors assigned</text>
                            }
                        </p>
                    </div>
                }
            </div>
        </div>

        <!-- Chat area -->
        <div class="chat-area">
            @if (selectedUser != null)
            {
                <div class="chat-header-selected">
                    <div class="selected-user-info">
                        <div class="selected-user-avatar">
                            @selectedUser.FirstName?.Substring(0, 1).ToUpper()
                        </div>
                        <div class="user-details">
                            <div class="selected-user-name">@selectedUser.FirstName @selectedUser.LastName</div>
                            @if (!string.IsNullOrEmpty(selectedUser.Email))
                            {
                                <div class="selected-user-email">
                                    <i class="fas fa-envelope" style="margin-right: 6px; font-size: 11px;"></i>
                                    @selectedUser.Email
                                </div>
                            }
                            <div class="selected-user-role">
                                @if (AuthService.CurrentUser?.RoleId == 2)
                                {
                                    <text>Patient</text>
                                }
                                else
                                {
                                    <text>Doctor - @selectedUser.Specialization</text>
                                }
                            </div>
                        </div>
                        <div class="call-buttons">
                            <button class="btn btn-outline-primary btn-sm" @onclick="() => StartVideoCall(selectedUser.Id)"
                                title="Start Video Call">
                                <i class="fas fa-video"></i>
                            </button>
                            <button class="btn btn-outline-success btn-sm" @onclick="() => StartAudioCall(selectedUser.Id)"
                                title="Start Audio Call">
                                <i class="fas fa-phone"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="messages-container" @ref="messagesContainer">
                    @if (isLoadingHistory)
                    {
                        <div class="loading-messages">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading chat history...</p>
                        </div>
                    }
                    else if (messages.Any())
                    {
                        @foreach (var message in messages)
                        {
                            <div class="message @(message.SenderId == AuthService.CurrentUser?.Id ? "sent" : "received")">
                                <div class="message-content">
                                    <div class="message-text">@message.Message</div>
                                    <div class="message-time" title="@message.Timestamp.ToString("yyyy-MM-dd HH:mm:ss.fff UTC")">@message.Timestamp.ToString("HH:mm")</div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="no-messages">
                            <i class="fas fa-comments"></i>
                            <p>Start a conversation with @selectedUser.FirstName</p>
                        </div>
                    }
                </div>

                <div class="message-input-area">
                    <div class="input-container">
                        <input type="text" @bind="newMessage" @bind:event="oninput" @onkeydown="HandleKeyDown"
                            placeholder="Type a message... (Press Enter to send)" class="message-input"
                            disabled="@(!RealtimeService.IsConnected)" />
                        <button class="send-btn" @onclick="SendMessage"
                            disabled="@(string.IsNullOrWhiteSpace(newMessage) || !RealtimeService.IsConnected)">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            }
            else
            {
                <div class="no-selection">
                    <i class="fas fa-comment-dots"></i>
                    <h4>Select a conversation</h4>
                    <p>
                        @if (AuthService.CurrentUser?.RoleId == 2)
                        {
                            <text>Choose a patient from the sidebar to start chatting</text>
                        }
                        else
                        {
                            <text>Choose a doctor from the sidebar to start chatting</text>
                        }
                    </p>
                </div>
            }
        </div>
    </div>
</div>


<style>
    .chat-container {
        height: calc(100vh - 120px);
        display: flex;
        flex-direction: column;
        background: #f5f5f5;
    }

    .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: relative;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .chat-header h3 {
        margin: 0;
        color: white;
        font-size: 24px;
        font-weight: 600;
    }

    .connection-indicator {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.9);
        background: rgba(255, 255, 255, 0.1);
        padding: 4px 8px;
        border-radius: 12px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .header-actions {
        display: flex;
        gap: 10px;
    }

    .connection-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #f44336;
    }

    .connection-dot.connected {
        background: #4CAF50;
    }

    .retry-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        margin-left: 8px;
        font-size: 12px;
        transition: all 0.3s ease;
    }

    .retry-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.05);
    }

    .chat-main {
        flex: 1;
        display: flex;
        overflow: hidden;
    }

    .chat-sidebar {
        width: 350px;
        background: white;
        border-right: 1px solid #e0e0e0;
        display: flex;
        flex-direction: column;
    }

    .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .sidebar-header h4 {
        margin: 0;
        color: #333;
    }

    .refresh-btn {
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        padding: 8px;
        border-radius: 4px;
        transition: all 0.2s;
    }

    .refresh-btn:hover {
        background: #f0f0f0;
        color: #333;
    }

    .spinning {
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    .user-list {
        flex: 1;
        overflow-y: auto;
    }

    .user-item {
        padding: 12px 16px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 12px;
        border-radius: 8px;
        margin: 2px 8px;
    }

    .user-item:hover {
        background: #f8f9fa;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .user-item.selected {
        background: #e3f2fd;
        border: 2px solid #2196F3;
        box-shadow: 0 4px 12px rgba(33, 150, 243, 0.2);
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #2196F3;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 16px;
    }

    .user-info {
        flex: 1;
    }

    .user-name {
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
    }

    .user-role,
    .user-specialization {
        font-size: 12px;
        color: #666;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .user-actions {
        display: flex;
        gap: 8px;
    }

    .action-btn {
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    }

    .action-btn svg {
        width: 24px !important;
        height: 24px !important;
        fill: currentColor !important;
        color: white;
    }

    .action-btn i {
        font-size: 15px;
    }

    .action-btn:hover {
        opacity: 0.95;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25);
    }

    .action-btn:active {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .test-call-btn {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        font-size: 14px;
        background: rgba(76, 175, 80, 0.2);
        color: #4CAF50;
        margin-left: 8px;
    }

    .test-call-btn:hover {
        background: rgba(76, 175, 80, 0.3);
        transform: scale(1.1);
    }

    .test-audio-btn {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        font-size: 14px;
        background: rgba(33, 150, 243, 0.2);
        color: #2196F3;
        margin-left: 8px;
    }

    .test-audio-btn:hover {
        background: rgba(33, 150, 243, 0.3);
        transform: scale(1.1);
    }

    .test-agora-btn {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        font-size: 14px;
        background: rgba(255, 152, 0, 0.2);
        color: #FF9800;
        margin-left: 8px;
    }

    .test-agora-btn:hover {
        background: rgba(255, 152, 0, 0.3);
        transform: scale(1.1);
    }

    .video-btn {
        background: #4CAF50;
        color: white;
    }

    .video-btn:hover {
        background: #45a049;
    }

    .audio-btn {
        background: #FF9800;
        color: white;
    }

    .audio-btn:hover {
        background: #f57c00;
    }

    .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: white;
    }

    .chat-header-selected {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        background: #fafafa;
    }

    .selected-user-info {
        display: flex;
        align-items: center;
        gap: 12px;
        justify-content: space-between;
    }

    .user-details {
        flex: 1;
    }

    .call-buttons {
        display: flex;
        gap: 8px;
    }

    .call-buttons .btn {
        width: 40px;
        height: 40px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }

    .selected-user-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #2196F3;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 18px;
    }

    .selected-user-name {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
    }

    .selected-user-email {
        font-size: 12px;
        color: #666;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
    }

    .selected-user-role {
        font-size: 14px;
        color: #666;
    }

    .messages-container {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .message {
        display: flex;
    }

    .message.sent {
        justify-content: flex-end;
    }

    .message.received {
        justify-content: flex-start;
    }

    .message-content {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 18px;
        position: relative;
    }

    .message.sent .message-content {
        background: #2196F3;
        color: white;
    }

    .message.received .message-content {
        background: #f0f0f0;
        color: #333;
    }

    .message-text {
        margin-bottom: 4px;
    }

    .message-time {
        font-size: 11px;
        opacity: 0.7;
    }

    .message-input-area {
        padding: 20px;
        border-top: 1px solid #e0e0e0;
        background: #fafafa;
    }

    .input-container {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .message-input {
        flex: 1;
        padding: 12px 16px;
        border: 1px solid #ddd;
        border-radius: 25px;
        outline: none;
        font-size: 14px;
    }

    .message-input:focus {
        border-color: #2196F3;
        outline: none;
        box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
    }

    .message-input:disabled {
        background-color: #f5f5f5;
        cursor: not-allowed;
    }

    .send-btn {
        width: 45px;
        height: 45px;
        border: none;
        border-radius: 50%;
        background: #2196F3;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .send-btn:hover:not(:disabled) {
        background: #1976D2;
    }

    .send-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .no-selection,
    .no-messages,
    .empty-state,
    .loading-item,
    .loading-messages {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #666;
        text-align: center;
    }

    .no-selection i,
    .no-messages i,
    .empty-state i {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .loading-messages i {
        font-size: 24px;
        margin-bottom: 12px;
        color: #2196F3;
    }

    .loading-messages p {
        margin: 0;
        font-size: 14px;
    }

    .loading-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #2196F3;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 8px;
    }

    /* Incoming Call Modal */
    .incoming-call-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        opacity: 1;
        transition: opacity 0.3s ease-in;
    }

    .incoming-call-content {
        background: white;
        border-radius: 20px;
        padding: 40px;
        text-align: center;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        max-width: 400px;
        width: 90%;
        transform: scale(1);
        transition: transform 0.3s ease-out;
    }

    .caller-info {
        margin-bottom: 30px;
    }

    .caller-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        font-size: 32px;
        font-weight: bold;
        color: white;
    }

    .caller-details h3 {
        margin: 0 0 10px 0;
        color: #333;
        font-size: 24px;
    }

    .caller-details p {
        margin: 0;
        color: #666;
        font-size: 16px;
    }

    .call-actions {
        display: flex;
        gap: 20px;
        justify-content: center;
    }

    .call-actions .btn {
        padding: 15px 30px;
        font-size: 16px;
        border-radius: 50px;
        min-width: 120px;
    }

    .call-actions .btn-success {
        background: #28a745;
        border-color: #28a745;
    }

    .call-actions .btn-danger {
        background: #dc3545;
        border-color: #dc3545;
    }

    .call-actions .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    /* Active Call Banner */
    .active-call-banner {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 12px 20px;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        position: relative;
    }

    .call-banner-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        max-width: 1200px;
    }

    .call-banner-info {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
    }

    .call-banner-info i {
        font-size: 18px;
    }

    .call-banner-info strong {
        font-weight: 600;
    }

    .active-call-banner .btn-danger {
        background: #dc3545;
        border-color: #dc3545;
        color: white;
        padding: 6px 16px;
        font-size: 13px;
    }

    .active-call-banner .btn-danger:hover {
        background: #c82333;
        border-color: #bd2130;
        transform: translateY(-1px);
    }
</style>

<script>
    window.setupPageVisibilityListener = (dotNetRef) => {
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                dotNetRef.invokeMethodAsync('OnPageVisible');
            }
        });
    };

    window.scrollToBottom = (element) => {
        if (element && element.scrollTop !== undefined) {
            element.scrollTop = element.scrollHeight;
        }
    };
</script>

@code {
    private List<User> users = new();
    private User? selectedUser;
    private List<ChatMsg> _messages = new();
    private string newMessage = string.Empty;
    private bool isLoadingUsers = false;
    private bool isLoadingHistory = false;
    private bool isHistoryLoaded = false;
    private ElementReference messagesContainer;
    private Timer? autoRefreshTimer;
    private bool isAutoRefreshing = false;

    private IncomingCall? incomingCall = null;
    private ActiveCall? activeCall = null;
    private int lastMessageCount = 0;
    private DateTime lastScrollTime = DateTime.MinValue;
    
    // ‚úÖ Helper method to ensure messages are always sorted
    private void SortMessages()
    {
        // ‚úÖ Sort by full DateTime (including date and time) - ascending (oldest first, newest last)
        _messages = _messages.OrderBy(m => m.Timestamp.Ticks) // Use Ticks for precise ordering
                           .ThenBy(m => m.Id)
                           .ToList();
        
        // ‚úÖ Debug: Log first and last message timestamps
        if (_messages.Count > 0)
        {
            var first = _messages.First();
            var last = _messages.Last();
            Console.WriteLine($"üîÑ Sorted {_messages.Count} messages. First: {first.Timestamp:yyyy-MM-dd HH:mm:ss.fff} ({first.Message}), Last: {last.Timestamp:yyyy-MM-dd HH:mm:ss.fff} ({last.Message})");
        }
    }
    
    // ‚úÖ Computed property that always returns messages sorted by timestamp (most recent at bottom)
    private List<ChatMsg> messages
    {
        get
        {
            // Always sort by timestamp Ticks (ascending - oldest first, newest last)
            // Use ThenBy with Id as secondary sort for consistent ordering when timestamps are identical
            return _messages.OrderBy(m => m.Timestamp.Ticks)
                           .ThenBy(m => m.Id)
                           .ToList();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        RealtimeService.OnNewMessage += HandleNewMessage;
        RealtimeService.OnIncomingCall += HandleIncomingCall;

        await LoadUsers();

        if (selectedUser != null && RealtimeService.IsConnected)
            await LoadChatHistory();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (!RealtimeService.IsConnected)
                await RealtimeService.StartAsync();

            await JS.InvokeVoidAsync("setupPageVisibilityListener", DotNetObjectReference.Create(this));
            StartAutoRefresh();
        }

        // ‚úÖ Use _messages.Count for comparison (computed property might have different count due to sorting)
        if (_messages.Count > lastMessageCount && !isAutoRefreshing &&
        (DateTime.Now - lastScrollTime).TotalMilliseconds > 500)
        {
            lastMessageCount = _messages.Count;
            lastScrollTime = DateTime.Now;
            await Task.Delay(100);
            await ScrollToBottom();
        }
    }

    private async Task LoadUsers()
    {
        isLoadingUsers = true;
        StateHasChanged();

        try
        {
            string endpoint = AuthService.CurrentUser?.RoleId == 2
            ? "/api/mobile/doctor/patients"
            : "/api/mobile/patient/doctors";

            var response = await Http.GetAsync(endpoint);
            if (response.IsSuccessStatusCode)
                users = await response.Content.ReadFromJsonAsync<List<User>>() ?? new();
        }
        finally
        {
            isLoadingUsers = false;
            StateHasChanged();
        }
    }

    private async Task LoadChatHistory()
    {
        if (selectedUser == null || !RealtimeService.IsConnected || isLoadingHistory || isHistoryLoaded)
            return;

        isLoadingHistory = true;
        StateHasChanged();

        try
        {
            var request = new
            {
                connectionId = RealtimeService.ConnectionId,
                otherUserId = selectedUser.Id
            };

            var response = await Http.PostAsJsonAsync("/api/realtime/get-message-history", request);
            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadFromJsonAsync<JsonElement>();
                if (json.TryGetProperty("messages", out var msgs))
                {
                    // ‚úÖ Load messages and store in _messages
                    _messages = msgs.EnumerateArray().Select(m =>
                    {
                        var timestampStr = m.GetProperty("timestamp").GetString() ?? "";
                        // ‚úÖ Parse timestamp - try UTC first, then local, then fallback to UtcNow
                        DateTime timestamp;
                        if (DateTime.TryParse(timestampStr, null, System.Globalization.DateTimeStyles.RoundtripKind, out var parsed))
                        {
                            // If parsed as Unspecified, assume it's UTC
                            timestamp = parsed.Kind == DateTimeKind.Unspecified ? DateTime.SpecifyKind(parsed, DateTimeKind.Utc) : parsed;
                            if (timestamp.Kind == DateTimeKind.Local)
                            {
                                timestamp = timestamp.ToUniversalTime();
                            }
                        }
                        else
                        {
                            timestamp = DateTime.UtcNow;
                            Console.WriteLine($"‚ö†Ô∏è Failed to parse timestamp: {timestampStr}, using UtcNow");
                        }
                        
                        return new ChatMsg
                        {
                            Id = m.GetProperty("id").GetInt32().ToString(),
                            SenderId = m.GetProperty("senderId").GetInt32(),
                            TargetUserId = m.GetProperty("receiverId").GetInt32(),
                            Message = m.GetProperty("message").GetString() ?? "",
                            SenderName = m.GetProperty("senderName").GetString() ?? "",
                            Timestamp = timestamp
                        };
                    }).ToList();
                    
                    // ‚úÖ Log all timestamps before sorting for debugging
                    Console.WriteLine($"üì® Loaded {_messages.Count} messages. Timestamps:");
                    foreach (var msg in _messages)
                    {
                        Console.WriteLine($"   [{msg.Timestamp:yyyy-MM-dd HH:mm:ss.fff} UTC] {msg.Message}");
                    }
                    
                    // ‚úÖ Sort immediately after loading
                    SortMessages();
                    
                    Console.WriteLine($"üì® After sorting. First: {messages.FirstOrDefault()?.Timestamp:yyyy-MM-dd HH:mm:ss.fff}, Last: {messages.LastOrDefault()?.Timestamp:yyyy-MM-dd HH:mm:ss.fff}");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading history: {ex.Message}");
        }
        finally
        {
            isLoadingHistory = false;
            isHistoryLoaded = true;
            StateHasChanged();
        }
    }

    private async Task SelectUser(User user)
    {
        selectedUser = user;
        _messages.Clear();
        isHistoryLoaded = false;
        lastMessageCount = 0;

        if (!RealtimeService.IsConnected)
            await Task.Delay(1000);

        await LoadChatHistory();
        StartAutoRefresh();
        StateHasChanged();
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(newMessage) || selectedUser == null || !RealtimeService.IsConnected)
            return;

        var messageText = newMessage;
        await RealtimeService.SendMessageAsync(selectedUser.Id, messageText);

        // ‚úÖ Add message with precise timestamp (including milliseconds)
        // This is a temporary local message that will be replaced by the server message when received
        var localMessageId = $"local_{Guid.NewGuid()}";
        var newMsg = new ChatMsg
        {
            Id = localMessageId,
            SenderId = AuthService.CurrentUser?.Id ?? 0,
            TargetUserId = selectedUser.Id,
            Message = messageText,
            SenderName = $"{AuthService.CurrentUser?.FirstName} {AuthService.CurrentUser?.LastName}",
            Timestamp = DateTime.UtcNow // This includes milliseconds
        };
        
        _messages.Add(newMsg);
        SortMessages(); // ‚úÖ Sort immediately after adding
        Console.WriteLine($"üì§ Sent message at {newMsg.Timestamp:HH:mm:ss.fff} - Total messages: {_messages.Count}");
        
        newMessage = string.Empty;
        lastMessageCount = _messages.Count;
        StateHasChanged();
        await Task.Delay(100);
        await ScrollToBottom();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if ((e.Key == "Enter" || e.Key == "NumpadEnter") &&
        !string.IsNullOrWhiteSpace(newMessage) && RealtimeService.IsConnected)
        {
            await SendMessage();
        }
    }

    private async void HandleNewMessage(ChatMsg message)
    {
        if (selectedUser == null) return;

        if ((message.SenderId == selectedUser.Id && message.TargetUserId == AuthService.CurrentUser?.Id) ||
        (message.SenderId == AuthService.CurrentUser?.Id && message.TargetUserId == selectedUser.Id))
        {
            // ‚úÖ Check if this is a server response for a local message we just sent
            // Match by content, sender, and target (within 5 seconds) to replace local message with server message
            var isLocalMessage = message.SenderId == AuthService.CurrentUser?.Id;
            if (isLocalMessage)
            {
                var localMessage = _messages.FirstOrDefault(m => 
                    m.Id.StartsWith("local_") &&
                    m.Message == message.Message &&
                    m.SenderId == message.SenderId &&
                    m.TargetUserId == message.TargetUserId &&
                    Math.Abs((m.Timestamp - message.Timestamp).TotalSeconds) < 5
                );
                
                if (localMessage != null)
                {
                    // ‚úÖ Replace local message with server message (has correct timestamp and ID)
                    var index = _messages.IndexOf(localMessage);
                    _messages[index] = message;
                    Console.WriteLine($"üîÑ Replaced local message with server message: {message.Message} (ID: {message.Id}) at {message.Timestamp:HH:mm:ss.fff}");
                }
                else if (!_messages.Any(m => m.Id == message.Id))
                {
                    // ‚úÖ Server message but no matching local message - add it
                    _messages.Add(message);
                    Console.WriteLine($"üì• Received server message at {message.Timestamp:HH:mm:ss.fff}");
                }
                else
                {
                    Console.WriteLine($"‚ö†Ô∏è Duplicate server message ignored: {message.Id} at {message.Timestamp:HH:mm:ss.fff}");
                }
            }
            else
            {
                // ‚úÖ Message from other user - check if already exists
                if (!_messages.Any(m => m.Id == message.Id))
                {
                    _messages.Add(message);
                    Console.WriteLine($"üì• Received message from {message.SenderName} at {message.Timestamp:HH:mm:ss.fff}");
                }
                else
                {
                    Console.WriteLine($"‚ö†Ô∏è Duplicate message ignored: {message.Id} at {message.Timestamp:HH:mm:ss.fff}");
                }
            }

            // ‚úÖ Always sort after any modification
            SortMessages();
            
            // ‚úÖ Force UI update
            await InvokeAsync(() =>
            {
                StateHasChanged();
                // Scroll to bottom after a short delay to ensure DOM is updated
                _ = Task.Run(async () =>
                {
                    await Task.Delay(50);
                    await InvokeAsync(ScrollToBottom);
                });
            });
        }
    }

    private async Task RetryConnection()
    {
        await RealtimeService.StopAsync();
        await Task.Delay(1000);
        await RealtimeService.StartAsync();
    }

    private async Task InitiateVideoCall(User user)
    {
        try
        {
            Console.WriteLine($"üìû RealTimeChat: Initiating video call to user {user.Id} ({user.FirstName} {user.LastName})");
            
            // ‚úÖ Generate channel name
            var channelName = GenerateChannelName(user.Id);
            Console.WriteLine($"üìû RealTimeChat: Channel name: {channelName}");
            
            // ‚úÖ Send SignalR call notification to receiver
            await RealtimeService.InitiateCallAsync(user.Id, "video");
            
            // ‚úÖ Track active call for caller (for the banner)
            activeCall = new ActiveCall
            {
                CallType = "video",
                TargetUserId = user.Id,
                TargetUserName = $"{user.FirstName} {user.LastName}",
                ChannelName = channelName
            };
            
            // ‚úÖ Navigate to VideoCall page - this will automatically join the channel
            var callUrl = $"/video-call/{user.Id}?channel={Uri.EscapeDataString(channelName)}";
            Console.WriteLine($"üìû RealTimeChat: Navigating caller to: {callUrl}");
            Navigation.NavigateTo(callUrl);
            
            NotificationService.Notify(NotificationSeverity.Info, "Video Call", $"Connecting to {user.FirstName}...");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå RealTimeChat: Error initiating video call: {ex.Message}");
            NotificationService.Notify(NotificationSeverity.Error, "Call Error", $"Failed to start call: {ex.Message}");
        }
    }

    private async Task InitiateAudioCall(User user)
    {
        try
        {
            Console.WriteLine($"üìû RealTimeChat: Initiating audio call to user {user.Id} ({user.FirstName} {user.LastName})");
            
            // ‚úÖ Generate channel name
            var channelName = GenerateChannelName(user.Id);
            Console.WriteLine($"üìû RealTimeChat: Channel name: {channelName}");
            
            // ‚úÖ Send SignalR call notification to receiver
            await RealtimeService.InitiateCallAsync(user.Id, "audio");
            
            // ‚úÖ Track active call for caller (for the banner)
            activeCall = new ActiveCall
            {
                CallType = "audio",
                TargetUserId = user.Id,
                TargetUserName = $"{user.FirstName} {user.LastName}",
                ChannelName = channelName
            };
            
            // ‚úÖ Navigate to AudioCall page - this will automatically join the channel
            var callUrl = $"/audio-call/{user.Id}?channel={Uri.EscapeDataString(channelName)}";
            Console.WriteLine($"üìû RealTimeChat: Navigating caller to: {callUrl}");
            Navigation.NavigateTo(callUrl);
            
            NotificationService.Notify(NotificationSeverity.Info, "Audio Call", $"Connecting to {user.FirstName}...");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå RealTimeChat: Error initiating audio call: {ex.Message}");
            NotificationService.Notify(NotificationSeverity.Error, "Call Error", $"Failed to start call: {ex.Message}");
        }
    }

    private string GenerateChannelName(int targetUserId)
    {
        var callerId = AuthService.CurrentUser?.Id ?? 0;
        if (callerId == 0 || targetUserId == 0) return "";
        
        var smallerId = Math.Min(callerId, targetUserId);
        var largerId = Math.Max(callerId, targetUserId);
        return $"call_{smallerId}_{largerId}";
    }

    private async Task EndActiveCall()
    {
        if (activeCall == null) return;
        
        try
        {
            // ‚úÖ Notify server via SignalR that call is ending (this will notify the receiver)
            await SignalRService.EndCallAsync(activeCall.ChannelName);
            
            // ‚úÖ Leave Agora channel if we're in a call
            await AgoraService.LeaveChannelAsync();
            
            NotificationService.Notify(NotificationSeverity.Info, "Call Ended", 
                $"Ended {activeCall.CallType} call with {activeCall.TargetUserName}");
            
            activeCall = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error ending call: {ex.Message}");
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to end call: {ex.Message}");
        }
    }

    private async Task ScrollToBottom()
    {
        try { await JS.InvokeVoidAsync("scrollToBottom", messagesContainer); } catch { }
    }

    [JSInvokable]
    public async Task OnPageVisible()
    {
        if (selectedUser != null && RealtimeService.IsConnected)
        {
            await LoadChatHistory();
            StateHasChanged();
        }
    }

    private async void HandleIncomingCall(CallInvitation call)
    {
        incomingCall = new IncomingCall
        {
            CallerName = call.CallerName,
            CallType = call.CallType,
            CallerId = call.CallerId,
            CallId = call.CallId,
            CallTime = call.Timestamp
        };
        
        // ‚úÖ Play incoming call ringtone
        try
        {
            await JS.InvokeVoidAsync("playIncomingCallSound");
            Console.WriteLine("üîî RealTimeChat: Started playing incoming call ringtone");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ö†Ô∏è RealTimeChat: Error playing ringtone: {ex.Message}");
        }
        
        StateHasChanged();
    }

    private void StartAutoRefresh()
    {
        autoRefreshTimer?.Dispose();
        autoRefreshTimer = new Timer(async _ => await AutoRefreshMessages(), null, TimeSpan.Zero, TimeSpan.FromSeconds(5));
    }

    private async Task AutoRefreshMessages()
    {
        if (isAutoRefreshing || selectedUser == null || !RealtimeService.IsConnected)
            return;

        try
        {
            isAutoRefreshing = true;
            await LoadChatHistory();
        }
        finally
        {
            isAutoRefreshing = false;
        }
    }

    private void StartVideoCall(int userId)
    {
        NotificationService.Notify(NotificationSeverity.Info, "Video Call",
        $"Starting video call with user {userId}");
    }

    private void StartAudioCall(int userId)
    {
        NotificationService.Notify(NotificationSeverity.Info, "Audio Call",
        $"Starting audio call with user {userId}");
    }

    private async Task AcceptCall()
    {
        if (incomingCall == null) return;

        try
        {
            // ‚úÖ Stop the ringtone
            try
            {
                await JS.InvokeVoidAsync("stopIncomingCallSound");
                Console.WriteLine("üîï RealTimeChat: Stopped ringtone (call accepted)");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ö†Ô∏è RealTimeChat: Error stopping ringtone: {ex.Message}");
            }
            
            // ‚úÖ Get channel name from CallId
            var channelName = incomingCall.CallId ?? "";
            
            // ‚úÖ Validate channel name - if empty, generate one based on caller and current user
            if (string.IsNullOrWhiteSpace(channelName))
            {
                var currentUserId = AuthService.CurrentUser?.Id ?? 0;
                var callerId = incomingCall.CallerId;
                if (currentUserId > 0 && callerId > 0)
                {
                    var smallerId = Math.Min(currentUserId, callerId);
                    var largerId = Math.Max(currentUserId, callerId);
                    channelName = $"call_{smallerId}_{largerId}";
                    Console.WriteLine($"‚ö†Ô∏è RealTimeChat: Channel was empty, generated: {channelName}");
                }
                else
                {
                    Console.WriteLine($"‚ùå RealTimeChat: Cannot generate channel - currentUserId: {currentUserId}, callerId: {callerId}");
                    NotificationService.Notify(NotificationSeverity.Error, "Call Error",
                    "Cannot join call: missing channel information");
                    return;
                }
            }
            
            Console.WriteLine($"üéØ RealTimeChat: Accepting {incomingCall.CallType} call from {incomingCall.CallerName}");
            Console.WriteLine($"üìû RealTimeChat: Channel name: {channelName}");
            Console.WriteLine($"üìû RealTimeChat: CallId from incomingCall: {incomingCall.CallId}");

            NotificationService.Notify(NotificationSeverity.Success, "Call Accepted",
            $"Accepting {incomingCall.CallType} call from {incomingCall.CallerName}");

            // Navigate to the appropriate call page based on call type
            // Pass the channel name as a query parameter so the call page can auto-join
            var callUrl = incomingCall.CallType?.ToLower() == "video"
            ? $"/video-call/{incomingCall.CallerId}?channel={Uri.EscapeDataString(channelName)}&mobile_call=true"
            : $"/audio-call/{incomingCall.CallerId}?channel={Uri.EscapeDataString(channelName)}&mobile_call=true";
            
            Console.WriteLine($"üéØ RealTimeChat: Navigating to: {callUrl}");
            Navigation.NavigateTo(callUrl);

            incomingCall = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå RealTimeChat: Error accepting call: {ex.Message}");
            Console.WriteLine($"‚ùå RealTimeChat: Stack trace: {ex.StackTrace}");
            NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
        }
    }

    private async Task RejectCall()
    {
        if (incomingCall == null) return;
        
        var callId = incomingCall.CallId;
        var callType = incomingCall.CallType;
        var callerName = incomingCall.CallerName;
        
        // ‚úÖ Stop the ringtone
        try
        {
            await JS.InvokeVoidAsync("stopIncomingCallSound");
            Console.WriteLine("üîï RealTimeChat: Stopped ringtone (call rejected)");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ö†Ô∏è RealTimeChat: Error stopping ringtone: {ex.Message}");
        }
        
        // ‚úÖ Check if receiver is on the call page (AudioCall/VideoCall) - if so, leave Agora and navigate back
        var currentUri = Navigation.Uri;
        var isOnAudioCallPage = currentUri.Contains("/audio-call/");
        var isOnVideoCallPage = currentUri.Contains("/video-call/");
        
        if (isOnAudioCallPage || isOnVideoCallPage)
        {
            Console.WriteLine($"üìû RealTimeChat: Receiver is on call page, leaving Agora and navigating back...");
            try
            {
                // Leave Agora channel if connected
                if (AgoraService.IsInCall)
                {
                    await AgoraService.LeaveChannelAsync();
                    Console.WriteLine("‚úÖ RealTimeChat: Left Agora channel");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ö†Ô∏è RealTimeChat: Error leaving Agora channel: {ex.Message}");
            }
            
            // Navigate back to chat
            await Task.Delay(300); // Small delay for cleanup
            Navigation.NavigateTo("/real-time-chat");
        }
        
        // ‚úÖ Notify the caller that call was rejected
        // Use SignalRService instead of RealtimeService (RealtimeService uses HTTP which doesn't have reject endpoint)
        try
        {
            await SignalRService.RejectCallAsync(callId);
            Console.WriteLine($"‚úÖ RealTimeChat: Sent rejection via SignalR for call: {callId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ö†Ô∏è RealTimeChat: Error rejecting call via SignalR: {ex.Message}");
            // Fallback to RealtimeService (though it will fail, at least we tried)
            try
            {
                await RealtimeService.RejectCallAsync(callId);
            }
            catch (Exception ex2)
            {
                Console.WriteLine($"‚ö†Ô∏è RealTimeChat: Fallback rejection also failed: {ex2.Message}");
            }
        }
        
        NotificationService.Notify(NotificationSeverity.Warning, "Call Declined",
        $"Declined {callType} call from {callerName}");
        incomingCall = null;
        StateHasChanged();
    }

    private void TestIncomingCall()
    {
        incomingCall = new IncomingCall
        {
            CallerName = "Test User",
            CallType = "video",
            CallerId = 999,
            CallId = $"test_call_{DateTime.UtcNow.Ticks}"
        };
        StateHasChanged();
    }

    private async void TestAudio()
    {
        try
        {
            NotificationService.Notify(NotificationSeverity.Info, "Testing Audio", "Testing audio system...");
            var result = await JS.InvokeAsync<bool>("agoraService.testAudio");
            NotificationService.Notify(result ? NotificationSeverity.Success : NotificationSeverity.Warning,
            "Audio Test", result ? "Audio system works!" : "Audio configured but silent.");
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Audio Test Failed", ex.Message);
        }
    }

    private async void TestAgoraSDK()
    {
        try
        {
            NotificationService.Notify(NotificationSeverity.Info, "Testing Agora SDK", "Checking SDK...");
            var result = await JS.InvokeAsync<bool>("agoraService.testAgoraSDK");
            NotificationService.Notify(result ? NotificationSeverity.Success : NotificationSeverity.Error,
            "Agora SDK", result ? "SDK loaded and ready!" : "SDK not loaded!");
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Agora SDK Test Failed", ex.Message);
        }
    }

    [JSInvokable]
    public void OnUserJoinedCallback(int uid) =>
    NotificationService.Notify(NotificationSeverity.Info, "User Joined", $"User {uid} joined");

    [JSInvokable]
    public void OnUserLeftCallback(int uid) =>
    NotificationService.Notify(NotificationSeverity.Info, "User Left", $"User {uid} left");

    [JSInvokable]
    public void OnConnectionStateChangedCallback(string state) =>
    NotificationService.Notify(NotificationSeverity.Info, "Connection State", $"State: {state}");

    [JSInvokable]
    public void OnErrorCallback(string error) =>
    NotificationService.Notify(NotificationSeverity.Error, "Agora Error", error);

    public void Dispose()
    {
        RealtimeService.OnNewMessage -= HandleNewMessage;
        RealtimeService.OnIncomingCall -= HandleIncomingCall;
        autoRefreshTimer?.Dispose();
    }

    public class IncomingCall
    {
        public string CallerName { get; set; } = string.Empty;
        public string CallType { get; set; } = string.Empty;
        public int CallerId { get; set; }
        public string CallId { get; set; } = string.Empty;
        public DateTime CallTime { get; set; } = DateTime.UtcNow;
    }

    public class ActiveCall
    {
        public string CallType { get; set; } = string.Empty;
        public int TargetUserId { get; set; }
        public string TargetUserName { get; set; } = string.Empty;
        public string ChannelName { get; set; } = string.Empty;
    }
}
