@page "/content"
@inject HttpClient Http
@inject NotificationService NotificationService
@inject IAuthService AuthService
@inject IJSRuntime JSRuntime
@inject ODataService ODataService
@using Microsoft.JSInterop
@using SM_MentalHealthApp.Shared
@using SM_MentalHealthApp.Client.Services
@using SM_MentalHealthApp.Client.Components.Grid
@using SM_MentalHealthApp.Client.Components.Common
@using SM_MentalHealthApp.Client.Helpers
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components
@using Radzen
@using Radzen.Blazor
@using SM_MentalHealthApp.Client.Components

<div class="content-page">
    <div class="content-header">
        @if (AuthService.CurrentUser?.RoleId == 1) // Patient
        {
            <h2>My Content</h2>
            <p>Manage your personal content and documents.</p>
        }
        else if (AuthService.CurrentUser?.RoleId == 2) // Doctor
        {
            <h2>Client Content</h2>
            <p>View and manage content for your assigned patients.</p>
        }
        else if (AuthService.CurrentUser?.RoleId == 3) // Admin
        {
            <h2>All Content</h2>
            <p>Manage all content across the platform.</p>
        }
        else if (AuthService.CurrentUser?.RoleId == 4) // Coordinator
        {
            <h2>Client Content</h2>
            <p>View client content and documents.</p>
        }
        else if (AuthService.CurrentUser?.RoleId == 5) // Attorney
        {
            <h2>Client Content</h2>
            <p>View client content and documents.</p>
        }
        else
        {
            <h2>Access Denied</h2>
            <p>You don't have permission to view this page.</p>
        }
    </div>

    @if (AuthService.CurrentUser?.RoleId == 1 || AuthService.CurrentUser?.RoleId == 2 || AuthService.CurrentUser?.RoleId
        == 3 || AuthService.CurrentUser?.RoleId == 4 || AuthService.CurrentUser?.RoleId == 5)
    {
        <!-- Service Request Selector (for SMEs) -->
        @if (AuthService.CurrentUser?.RoleId == 2 || AuthService.CurrentUser?.RoleId == 5 || AuthService.CurrentUser?.RoleId == 4)
        {
            <ServiceRequestSelector ClientId="@selectedPatientId" ServiceRequestIdChanged="@OnServiceRequestChanged" />
        }

        <!-- Add Content Button (hidden for Coordinator and Attorney) -->
        @if (AuthService.CurrentUser?.RoleId != 4 && AuthService.CurrentUser?.RoleId != 5)
        {
            <div class="add-content-section">
                <RadzenButton Text="Add New Content" ButtonStyle="ButtonStyle.Primary" Icon="add" Click="@ShowAddContentForm" />
            </div>
        }

        <!-- Content Grid -->
        <div class="content-grid">
            @if (_columns.Any())
            {
                <SMDataGrid TItem="ContentItemDto" Columns="_columns" Actions="_actions" ActionsWidth="200px"
                    LoadItemsPaged="LoadContentItemsPagedAsync" PageSize="10" @ref="_grid" AutoLoad="true"
                    AllowPaging="true" AllowFiltering="true" FilterMode="FilterMode.Advanced" ShowPagingSummary="true" />
            }
        </div>
    }
</div>

<!-- Add/Edit Content Modal -->
@if (showContentForm)
{
    <SMModal IsVisible="@showContentForm" 
             Title="@GetFormTitle()" 
             OnClose="CloseContentForm"
             Size="Medium">
    <Body>
        <form @onsubmit="@SaveContent" @onsubmit:preventDefault="true">
            @if (AuthService.CurrentUser?.RoleId == 2 || AuthService.CurrentUser?.RoleId == 3)
            {
                <div class="form-group">
                    <label class="form-label @GetPatientLabelClass()">Select Client: <span class="required-asterisk">*</span></label>
                    <RadzenDropDown Data="@patients" TextProperty="FullName" ValueProperty="Id"
                        @bind-Value="contentForm.PatientId" AllowFiltering="true"
                        FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" Placeholder="Choose a client..."
                        Style="width: 100%" 
                        @onchange="@(() => { showPatientError = false; StateHasChanged(); })" />
                </div>
            }
            else if (AuthService.CurrentUser?.RoleId == 1)
            {
                <div class="form-group">
                    <div class="patient-info-display">
                        <i class="fas fa-user"></i>
                        <span>Uploading content for: <strong>@(AuthService.CurrentUser?.FirstName) @(AuthService.CurrentUser?.LastName)</strong></span>
                    </div>
                </div>
            }

            <div class="form-group">
                <label class="form-label @GetTitleLabelClass()">Title: <span class="required-asterisk">*</span></label>
                <RadzenTextBox @bind-Value="contentForm.Title" Placeholder="Enter content title..."
                    Style="width: 100%" 
                    @onchange="@(() => { showTitleError = false; StateHasChanged(); })" />
            </div>

            <div class="form-group">
                <label class="form-label">Description: <span class="optional-text">(Optional)</span></label>
                <div class="description-container">
                    <RadzenTextArea @bind-Value="contentForm.Description" Placeholder="Enter content description (optional)... You can leave this empty or clear it anytime."
                        Style="width: 100%; height: 80px;" />
                    @if (!string.IsNullOrWhiteSpace(contentForm.Description))
                    {
                        <button type="button" class="clear-description-btn" @onclick="ClearDescription" title="Clear description">
                            <i class="fas fa-times"></i>
                        </button>
                    }
                </div>
            </div>

            @if (editingContent == null)
            {
                <div class="form-group">
                    <label class="form-label @GetFileLabelClass()">File: <span class="required-asterisk">*</span></label>
                    <div class="file-selection-container">
                        <InputFile OnChange="@OnFileSelected" accept="*/*" class="@GetFileInputClass()" />
                        @if (selectedFile != null)
                        {
                            <button type="button" class="clear-file-btn" @onclick="ClearSelectedFile" title="Clear selected file">
                                <i class="fas fa-times"></i>
                            </button>
                        }
                    </div>
                    @if (selectedFile == null)
                    {
                        <div class="file-input-hint">
                            <i class="fas fa-info-circle"></i>
                            Please select a file to upload
                        </div>
                    }
                    else
                    {
                        <div class="file-selected-info">
                            <i class="fas fa-check-circle text-success"></i>
                            Selected: @selectedFile.Name (@(selectedFile.Size / 1024) KB)
                        </div>
                    }
                </div>
            }
        </form>
    </Body>
    <Footer>
        <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@CloseContentForm" />
        <RadzenButton Text="@(editingContent == null ? "Upload" : "Save")" ButtonStyle="ButtonStyle.Primary"
            ButtonType="ButtonType.Submit" Disabled="@isSaving" Click="@SaveContent" />
    </Footer>
    </SMModal>
}

@code {
    private SMDataGrid<ContentItemDto>? _grid;
    private List<User> patients = new();
    private bool showContentForm = false;
    private bool isSaving = false;
    private ContentItem? editingContent = null;
    private ContentForm contentForm = new();
    private IBrowserFile? selectedFile = null;
    
    // Validation state tracking
    private bool showPatientError = false;
    private bool showTitleError = false;
    private bool showFileError = false;

    private List<SMDataGridColumn<ContentItemDto>> _columns = new();
    private readonly List<SMDataGridActionButton<ContentItemDto>> _actions = [];
    private int? selectedServiceRequestId;
    private int? selectedPatientId; // For ServiceRequest selector

    protected override async Task OnInitializedAsync()
    {
        await AuthService.InitializeAsync();
        await LoadPatients();
        InitializeColumns();
        InitializeActions();
    }

    private async Task OnServiceRequestChanged(int? serviceRequestId)
    {
        selectedServiceRequestId = serviceRequestId;
        if (_grid != null)
        {
            await _grid.RefreshAsync();
        }
    }

    private async Task LoadPatients()
    {
        try
        {
            // Load patients based on user role
            if (AuthService.CurrentUser?.RoleId == 2) // Doctor - only assigned patients
            {
                var patientsResponse = await
                Http.GetFromJsonAsync<List<User>>($"api/admin/doctor/{AuthService.CurrentUser.Id}/patients");
                patients = patientsResponse ?? new();
            }
            else if (AuthService.CurrentUser?.RoleId == 4) // Coordinator - only assigned patients
            {
                var patientsResponse = await
                Http.GetFromJsonAsync<List<User>>($"api/admin/doctor/{AuthService.CurrentUser.Id}/patients");
                patients = patientsResponse ?? new();
            }
            else if (AuthService.CurrentUser?.RoleId == 5) // Attorney - only assigned patients
            {
                var patientsResponse = await
                Http.GetFromJsonAsync<List<User>>($"api/admin/doctor/{AuthService.CurrentUser.Id}/patients");
                patients = patientsResponse ?? new();
            }
            else if (AuthService.CurrentUser?.RoleId == 3) // Admin - all patients
            {
                var patientsResponse = await Http.GetFromJsonAsync<List<User>>("api/admin/patients");
                patients = patientsResponse ?? new();
            }
            else
            {
                patients = new();
            }
        }
        catch (Exception ex)
        {
            // Don't show error for empty results - just set to empty list
            // Only show error for actual failures (401, 403, etc.)
            if (ex.Message.Contains("401") || ex.Message.Contains("403") || ex.Message.Contains("Unauthorized"))
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load patients: " + ex.Message);
            }
            patients = new(); // Set to empty list on error
        }
    }

    private async Task<PagedResult<ContentItemDto>> LoadContentItemsPagedAsync(
        int skip, 
        int take, 
        string? orderBy, 
        string? filter, 
        CancellationToken ct)
    {
        try
        {
            // Decode URL-encoded filter from Radzen
            var decodedFilter = filter != null ? System.Net.WebUtility.UrlDecode(filter) : null;
            
            // Handle PatientName and AddedByName filters (DTO-only properties, need special handling)
            var hasPatientName = !string.IsNullOrEmpty(decodedFilter) && decodedFilter.Contains("PatientName", StringComparison.OrdinalIgnoreCase);
            var hasAddedByName = !string.IsNullOrEmpty(decodedFilter) && decodedFilter.Contains("AddedByName", StringComparison.OrdinalIgnoreCase);
            string? odataFilter = null;
            
            if (hasPatientName)
            {
                var patientNameFilter = ExtractNameFilter(decodedFilter!, "PatientName");
                if (!string.IsNullOrEmpty(patientNameFilter))
                {
                    // Find matching patient IDs
                    var patientIds = await FindUserIdsByName(patientNameFilter, 1, ct); // RoleId 1 = Patient
                    if (patientIds.Any())
                    {
                        var patientIdFilter = string.Join(" or ", patientIds.Select(id => $"PatientId eq {id}"));
                        if (!string.IsNullOrEmpty(odataFilter))
                            odataFilter = $"{odataFilter} and ({patientIdFilter})";
                        else
                            odataFilter = $"({patientIdFilter})";
                    }
                    else
                    {
                        // No matching patients, return empty result
                        return new PagedResult<ContentItemDto>
                        {
                            Items = new List<ContentItemDto>(),
                            TotalCount = 0,
                            PageNumber = (skip / take) + 1,
                            PageSize = take
                        };
                    }
                    // Remove PatientName filter from the rest
                    decodedFilter = RemoveNameFilter(decodedFilter!, "PatientName");
                }
                else
                {
                    // Extraction failed, but filter contains PatientName - remove it
                    decodedFilter = RemoveNameFilter(decodedFilter!, "PatientName");
                }
            }
            
            if (hasAddedByName)
            {
                var addedByNameFilter = ExtractNameFilter(decodedFilter!, "AddedByName");
                if (!string.IsNullOrEmpty(addedByNameFilter))
                {
                    // Find matching user IDs (can be any role - doctor, admin, coordinator, etc.)
                    // Search across all roles since AddedByUserId can be any user
                    var userIds = await FindUserIdsByName(addedByNameFilter, null, ct); // null = all roles
                    if (userIds.Any())
                    {
                        var userIdFilter = string.Join(" or ", userIds.Select(id => $"AddedByUserId eq {id}"));
                        if (!string.IsNullOrEmpty(odataFilter))
                            odataFilter = $"{odataFilter} and ({userIdFilter})";
                        else
                            odataFilter = $"({userIdFilter})";
                    }
                    else
                    {
                        // No matching users, return empty result
                        return new PagedResult<ContentItemDto>
                        {
                            Items = new List<ContentItemDto>(),
                            TotalCount = 0,
                            PageNumber = (skip / take) + 1,
                            PageSize = take
                        };
                    }
                    // Remove AddedByName filter from the rest
                    decodedFilter = RemoveNameFilter(decodedFilter!, "AddedByName");
                }
                else
                {
                    // Extraction failed, but filter contains AddedByName - remove it
                    decodedFilter = RemoveNameFilter(decodedFilter!, "AddedByName");
                }
            }
            
            // Transform remaining filter from Radzen C# syntax to OData syntax
            if (!string.IsNullOrEmpty(decodedFilter))
            {
                decodedFilter = CleanupFilterOperators(decodedFilter);
                
                if (!string.IsNullOrWhiteSpace(decodedFilter) && !IsOnlyOperators(decodedFilter))
                {
                    var transformedFilter = ODataFilterHelper.TransformToOData(decodedFilter);
                    
                    if (!string.IsNullOrEmpty(transformedFilter))
                    {
                        if (!string.IsNullOrEmpty(odataFilter))
                            odataFilter = $"{odataFilter} and ({transformedFilter})";
                        else
                            odataFilter = transformedFilter;
                    }
                }
            }
            
            // Transform orderBy to use entity properties instead of DTO properties
            string? transformedOrderBy = null;
            if (!string.IsNullOrEmpty(orderBy))
            {
                transformedOrderBy = TransformOrderBy(orderBy);
            }
            
            // Query OData endpoint
            var result = await ODataService.QueryAsync<ContentItem>("Contents", skip, take, transformedOrderBy, odataFilter, ct);
            
            // Fetch users for all content items to populate PatientName and AddedByName
            var contentPatientIds = result.Items.Select(c => c.PatientId).Distinct().ToList();
            var contentAddedByUserIds = result.Items.Where(c => c.AddedByUserId.HasValue).Select(c => c.AddedByUserId!.Value).Distinct().ToList();
            var allUserIds = contentPatientIds.Concat(contentAddedByUserIds).Distinct().ToList();
            
            var userCache = new Dictionary<int, Shared.User>();
            if (allUserIds.Any())
            {
                try
                {
                    var userIdFilters = allUserIds.Select(id => $"Id eq {id}");
                    var userFilter = string.Join(" or ", userIdFilters);
                    
                    var userRequest = new HttpRequestMessage(HttpMethod.Get, $"odata/Users?$filter={Uri.EscapeDataString(userFilter)}");
                    var token = AuthService.Token;
                    if (!string.IsNullOrEmpty(token))
                    {
                        userRequest.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
                    }
                    
                    var userResponse = await Http.SendAsync(userRequest, ct);
                    if (userResponse.IsSuccessStatusCode)
                    {
                        var userJson = await userResponse.Content.ReadAsStringAsync(ct);
                        var userDoc = System.Text.Json.JsonDocument.Parse(userJson);
                        if (userDoc.RootElement.TryGetProperty("value", out var userArray) && userArray.ValueKind == System.Text.Json.JsonValueKind.Array)
                        {
                            var users = System.Text.Json.JsonSerializer.Deserialize<List<Shared.User>>(userArray.GetRawText(), new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true }) ?? new List<Shared.User>();
                            foreach (var user in users)
                            {
                                userCache[user.Id] = user;
                            }
                        }
                    }
                }
                catch (Exception ex)
                {
                }
            }
            
            // Map ContentItem to ContentItemDto with PatientName and AddedByName
            var items = result.Items.Select(c => MapContentToDto(c, userCache)).ToList();
            
            // If we sorted by PatientName or AddedByName, we need to sort the results client-side
            // because OData can't sort by computed DTO properties
            if (!string.IsNullOrEmpty(orderBy) && (orderBy.Contains("PatientName", StringComparison.OrdinalIgnoreCase) || 
                                                     orderBy.Contains("AddedByName", StringComparison.OrdinalIgnoreCase)))
            {
                items = SortContentResultsByComputedProperty(items, orderBy);
            }
            
            return new PagedResult<ContentItemDto>
            {
                Items = items,
                TotalCount = result.TotalCount,
                PageNumber = result.PageNumber,
                PageSize = result.PageSize
            };
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to load content: {ex.Message}");
            return new PagedResult<ContentItemDto>
            {
                Items = new List<ContentItemDto>(),
                TotalCount = 0,
                PageNumber = (skip / take) + 1,
                PageSize = take
            };
        }
    }
    
    private string? ExtractNameFilter(string filter, string propertyName)
    {
        // Extract search term from Radzen-generated filters like:
        // (PatientName == null ? "" : PatientName).ToLower().Contains("john".ToLower())
        // contains(PatientName, 'john')
        // PatientName contains 'john'
        var patterns = new[]
        {
            // Radzen C#-style: (PatientName == null ? "" : PatientName).ToLower().Contains("value".ToLower())
            $@"\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\(\)\.Contains\(""([^""]+)""\.ToLower\(\)\)",
            // Radzen C#-style with single quotes
            $@"\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\(\)\.Contains\('([^']+)'\.ToLower\(\)\)",
            // OData-style: contains(PatientName, 'john')
            $@"contains\({propertyName},\s*'([^']+)'\)",
            // OData-style: PatientName contains 'john'
            $@"{propertyName}\s+contains\s+'([^']+)'",
            // OData-style with tolower
            $@"contains\(tolower\({propertyName}\),\s*tolower\('([^']+)'\)\)",
            $@"tolower\({propertyName}\)\s+contains\s+'([^']+)'"
        };
        
        foreach (var pattern in patterns)
        {
            var match = System.Text.RegularExpressions.Regex.Match(filter, pattern, System.Text.RegularExpressions.RegexOptions.IgnoreCase);
            if (match.Success && match.Groups.Count > 1)
            {
                return match.Groups[1].Value;
            }
        }
        
        return null;
    }
    
    private string RemoveNameFilter(string filter, string propertyName)
    {
        // Remove the filter clause for the given property name
        // Handle Radzen C#-style filters: (PatientName == null ? "" : PatientName).ToLower().Contains("value".ToLower())
        var patterns = new[]
        {
            // Radzen C#-style with double quotes
            $@"\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\(\)\.Contains\(""[^""]+""\.ToLower\(\)\)",
            // Radzen C#-style with single quotes
            $@"\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\(\)\.Contains\('[^']+'\.ToLower\(\)\)",
            // OData-style patterns
            $@"contains\({propertyName},\s*'[^']+'\)",
            $@"{propertyName}\s+contains\s+'[^']+'",
            $@"contains\(tolower\({propertyName}\),\s*tolower\('[^']+'\)\)",
            $@"tolower\({propertyName}\)\s+contains\s+'[^']+'",
            // With "and" operators
            $@"and\s+\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\(\)\.Contains\(""[^""]+""\.ToLower\(\)\)",
            $@"and\s+\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\(\)\.Contains\('[^']+'\.ToLower\(\)\)",
            $@"and\s+contains\({propertyName},\s*'[^']+'\)",
            $@"and\s+{propertyName}\s+contains\s+'[^']+'",
            // With trailing "and"
            $@"\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\(\)\.Contains\(""[^""]+""\.ToLower\(\)\)\s+and",
            $@"\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\(\)\.Contains\('[^']+'\.ToLower\(\)\)\s+and",
            $@"contains\({propertyName},\s*'[^']+'\)\s+and",
            $@"{propertyName}\s+contains\s+'[^']+'\s+and"
        };
        
        var result = filter;
        foreach (var pattern in patterns)
        {
            result = System.Text.RegularExpressions.Regex.Replace(result, pattern, "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        }
        
        // Clean up extra "and" or "or" operators
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\s+and\s+and\s+", " and ", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\s+or\s+or\s+", " or ", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @"^\s*and\s+", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\s+and\s+$", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @"^\s*or\s+", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\s+or\s+$", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = result.Trim();
        
        return result;
    }
    
    private string CleanupFilterOperators(string filter)
    {
        if (string.IsNullOrWhiteSpace(filter))
            return string.Empty;
            
        var result = filter;
        
        // Remove standalone operators at the start
        result = System.Text.RegularExpressions.Regex.Replace(result, @"^\s*(and|or)\s+", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        
        // Remove standalone operators at the end
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\s+(and|or)\s+$", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        
        // Remove empty parentheses: () or ( ) or (and) or (or)
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\(\s*(and|or)?\s*\)", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        
        // Remove duplicate operators
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\s+(and|or)\s+(and|or)\s+", " $1 ", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        
        // Remove operators before/after parentheses
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\s+(and|or)\s+\(", " (", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\)\s+(and|or)\s+", ") ", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        
        result = result.Trim();
        return result;
    }
    
    private bool IsOnlyOperators(string filter)
    {
        if (string.IsNullOrWhiteSpace(filter))
            return true;
            
        // Remove all whitespace and check if only operators remain
        var cleaned = System.Text.RegularExpressions.Regex.Replace(filter, @"\s+", "");
        var onlyOperators = System.Text.RegularExpressions.Regex.IsMatch(cleaned, @"^(and|or|\(|\)|\s)+$", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        return onlyOperators;
    }
    
    private async Task<List<int>> FindUserIdsByName(string searchTerm, int? roleId, CancellationToken ct)
    {
        try
        {
            // Query Users OData to find matching users by name
            string nameFilter;
            if (roleId.HasValue)
            {
                nameFilter = $"(RoleId eq {roleId.Value}) and (contains(FirstName, '{searchTerm}') or contains(LastName, '{searchTerm}'))";
            }
            else
            {
                // Search across all roles
                nameFilter = $"(contains(FirstName, '{searchTerm}') or contains(LastName, '{searchTerm}'))";
            }
            var result = await ODataService.QueryAsync<Shared.User>("Users", 0, 1000, null, nameFilter, ct);
            
            return result.Items.Select(u => u.Id).ToList();
        }
        catch (Exception ex)
        {
            return new List<int>();
        }
    }
    
    private string? TransformOrderBy(string? orderBy)
    {
        if (string.IsNullOrEmpty(orderBy))
            return orderBy;
            
        // Transform DTO property names to entity property names
        // PatientName and AddedByName are DTO-only, so we can't sort by them in OData
        // We'll sort client-side instead, but we need to remove them from the OData orderBy
        var result = orderBy;
        
        // Remove PatientName and AddedByName from orderBy (we'll sort client-side)
        // Pattern: "PatientName asc" or "AddedByName desc" or "PatientName, OtherProperty asc"
        result = System.Text.RegularExpressions.Regex.Replace(result, @"PatientName\s+(asc|desc),?\s*", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @"AddedByName\s+(asc|desc),?\s*", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @",\s*PatientName\s+(asc|desc)", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @",\s*AddedByName\s+(asc|desc)", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        
        // Clean up extra commas
        result = System.Text.RegularExpressions.Regex.Replace(result, @",\s*,", ",", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = result.Trim().TrimStart(',').TrimEnd(',');
        
        // If result is empty, return null (no OData sorting)
        if (string.IsNullOrWhiteSpace(result))
            return null;
            
        return result;
    }
    
    private List<ContentItemDto> SortContentResultsByComputedProperty(List<ContentItemDto> items, string orderBy)
    {
        if (items == null || !items.Any())
            return items;
            
        var orderByLower = orderBy.ToLowerInvariant();
        
        // Parse orderBy: "PatientName asc" or "AddedByName desc"
        var isDescending = orderByLower.Contains("desc");
        
        if (orderByLower.Contains("patientname"))
        {
            items = isDescending
                ? items.OrderByDescending(a => a.PatientName).ToList()
                : items.OrderBy(a => a.PatientName).ToList();
        }
        else if (orderByLower.Contains("addedbyname"))
        {
            items = isDescending
                ? items.OrderByDescending(a => a.AddedByName).ToList()
                : items.OrderBy(a => a.AddedByName).ToList();
        }
        
        return items;
    }
    
    private ContentItemDto MapContentToDto(ContentItem content, Dictionary<int, Shared.User>? userCache = null)
    {
        var dto = new ContentItemDto
        {
            Id = content.Id,
            Title = content.Title,
            Description = content.Description,
            OriginalFileName = content.OriginalFileName,
            FileSizeBytes = content.FileSizeBytes,
            CreatedAt = content.CreatedAt,
            ContentTypeModelId = content.ContentTypeModelId,
            PatientId = content.PatientId,
            AddedByUserId = content.AddedByUserId,
            IsIgnoredByDoctor = content.IsIgnoredByDoctor,
            IgnoredByDoctorId = content.IgnoredByDoctorId,
            IgnoredAt = content.IgnoredAt
        };
        
        // Populate PatientName from navigation property or cache
        if (content.Patient != null)
        {
            dto.PatientName = $"{content.Patient.FirstName} {content.Patient.LastName}";
        }
        else if (userCache != null && userCache.TryGetValue(content.PatientId, out var patient))
        {
            dto.PatientName = $"{patient.FirstName} {patient.LastName}";
        }
        else
        {
            dto.PatientName = $"Client #{content.PatientId}";
        }
        
        // Populate AddedByName from navigation property or cache
        if (content.AddedByUserId.HasValue)
        {
            if (content.AddedByUser != null)
            {
                dto.AddedByName = $"{content.AddedByUser.FirstName} {content.AddedByUser.LastName}";
            }
            else if (userCache != null && userCache.TryGetValue(content.AddedByUserId.Value, out var addedByUser))
            {
                dto.AddedByName = $"{addedByUser.FirstName} {addedByUser.LastName}";
            }
            else
            {
                dto.AddedByName = $"User #{content.AddedByUserId.Value}";
            }
        }
        else
        {
            dto.AddedByName = "Self";
        }
        
        return dto;
    }

    private void InitializeColumns()
    {
        _columns = new List<SMDataGridColumn<ContentItemDto>>
        {
            new SMDataGridTemplateColumn<ContentItemDto>
            {
                Property = nameof(ContentItemDto.Title),
                Title = "Title",
                Width = "200px",
                Template = content => builder =>
                {
                    builder.OpenElement(0, "div");
                    builder.OpenElement(1, "strong");
                    builder.AddContent(2, content.Title);
                    builder.CloseElement();
                    builder.OpenElement(3, "br");
                    builder.CloseElement();
                    builder.OpenElement(4, "small");
                    builder.AddAttribute(5, "class", "text-muted");
                    builder.AddContent(6, content.Description);
                    builder.CloseElement();
                    builder.CloseElement();
                }
            },
            new SMDataGridColumn<ContentItemDto>
            {
                Property = nameof(ContentItemDto.PatientName),
                Title = "Client", 
                Width = "150px"
            },
            new SMDataGridTemplateColumn<ContentItemDto>
            {
                Property = nameof(ContentItemDto.OriginalFileName),
                Title = "File",
                Width = "150px",
                Template = content => builder =>
                {
                    builder.OpenElement(0, "div");
                    builder.OpenElement(1, "i");
                    builder.AddAttribute(2, "class", GetFileIcon(GetContentTypeName(content.ContentTypeModelId)));
                    builder.CloseElement();
                    builder.AddContent(3, " ");
                    builder.AddContent(4, content.OriginalFileName);
                    builder.OpenElement(5, "br");
                    builder.CloseElement();
                    builder.OpenElement(6, "small");
                    builder.AddAttribute(7, "class", "text-muted");
                    builder.AddContent(8, FormatFileSize(content.FileSizeBytes));
                    builder.CloseElement();
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<ContentItemDto>
            {
                Property = nameof(ContentItemDto.ContentTypeModelId),
                Title = "Type",
                Width = "100px",
                Template = content => builder =>
                {
                    builder.OpenElement(0, "span");
                    builder.AddAttribute(1, "class", $"content-type-badge {GetTypeClass(GetContentTypeName(content.ContentTypeModelId))}");
                    builder.AddContent(2, GetContentTypeName(content.ContentTypeModelId));
                    builder.CloseElement();
                }
            },
            new SMDataGridBadgeColumn<ContentItemDto>
            {
                Property = nameof(ContentItemDto.IsIgnoredByDoctor),
                Title = "AI Status",
                Width = "130px",
                GetBadgeData = content => content.IsIgnoredByDoctor
                    ? ("ðŸš« Ignored", NotificationSeverity.Warning, true)
                    : ("âœ… Active", NotificationSeverity.Success, true)
            },
            new SMDataGridTemplateColumn<ContentItemDto>
            {
                Property = nameof(ContentItemDto.CreatedAt),
                Title = "Added",
                Width = "120px",
                Template = content => builder =>
                {
                    builder.AddContent(0, content.CreatedAt.ToString("MMM dd, yyyy"));
                    builder.OpenElement(1, "br");
                    builder.CloseElement();
                    builder.OpenElement(2, "small");
                    builder.AddAttribute(3, "class", "text-muted");
                    builder.AddContent(4, content.CreatedAt.ToString("HH:mm"));
                    builder.CloseElement();
                }
            },
            new SMDataGridColumn<ContentItemDto>
            {
                Property = nameof(ContentItemDto.AddedByName),
                Title = "Added By",
                Width = "120px"
            }
        };
    }


    private void InitializeActions()
    {
        _actions.Add(new SMDataGridActionButton<ContentItemDto>
        {
            Icon = "visibility",
            ButtonStyle = ButtonStyle.Info,
            Variant = Variant.Flat,
            Size = ButtonSize.Small,
            Tooltip = "View/Download",
            OnClick = async (row, ct) => await ViewContent(row)
        });

        // Edit action (not for Coordinator or Attorney - read-only)
        if (AuthService.CurrentUser?.RoleId != 4 && AuthService.CurrentUser?.RoleId != 5) // Coordinator and Attorney can only view
        {
            _actions.Add(new SMDataGridActionButton<ContentItemDto>
            {
                Icon = "edit",
                ButtonStyle = ButtonStyle.Success,
                Variant = Variant.Flat,
                Size = ButtonSize.Small,
                Tooltip = "Edit",
                OnClick = async (row, ct) => await EditContent(row)
            });
        }

        if (AuthService.CurrentUser?.RoleId == 2) // Doctor can ignore/unignore
        {
            _actions.Add(new SMDataGridActionButton<ContentItemDto>
            {
                IconFunc = content => content.IsIgnoredByDoctor ? "undo" : "block",
                ButtonStyleFunc = content => content.IsIgnoredByDoctor ? ButtonStyle.Info : ButtonStyle.Warning,
                Variant = Variant.Flat,
                Size = ButtonSize.Small,
                TooltipFunc = content => content.IsIgnoredByDoctor 
                    ? "Unignore for AI analysis" 
                    : "Ignore for AI analysis",
                OnClick = async (row, ct) => await ToggleIgnoreContentAsync(row)
            });
        }

        if (AuthService.CurrentUser?.RoleId == 3) // Only admin can delete (not Coordinator)
        {
            _actions.Add(new SMDataGridActionButton<ContentItemDto>
            {
                Icon = "delete",
                ButtonStyle = ButtonStyle.Danger,
                Variant = Variant.Flat,
                Size = ButtonSize.Small,
                Tooltip = "Delete",
                OnClick = async (row, ct) => await DeleteContent(row)
            });
        }
    }

    private async Task ShowAddContentForm()
    {
        editingContent = null;
        contentForm = new ContentForm();
        if (AuthService.CurrentUser?.RoleId == 1) // Patient
        {
            contentForm.PatientId = AuthService.CurrentUser.Id;
        }
        
        // Clear validation errors (in same order as validation)
        showPatientError = false;
        showTitleError = false;
        showFileError = false;
        
        showContentForm = true;
        await InvokeAsync(StateHasChanged);
    }

    private async Task EditContent(ContentItemDto content)
    {
        editingContent = new ContentItem
        {
            Id = content.Id,
            PatientId = content.PatientId,
            Title = content.Title,
            Description = content.Description
        };
        contentForm = new ContentForm
        {
            Id = content.Id,
            PatientId = content.PatientId,
            Title = content.Title,
            Description = content.Description
        };
        showContentForm = true;
        await InvokeAsync(StateHasChanged);
    }

    private async Task SaveContent()
    {
        try
        {
            if (editingContent == null)
            {
                // Clear previous validation errors (in same order as validation)
                showPatientError = false;
                showTitleError = false;
                showFileError = false;
                StateHasChanged();

                // Add new content - validate from top to bottom
                // 1. Patient selection (for doctors and admins only)
                if ((AuthService.CurrentUser?.RoleId == 2 || AuthService.CurrentUser?.RoleId == 3) && contentForm.PatientId == 0)
                {
                    showPatientError = true;
                    NotificationService.Notify(NotificationSeverity.Warning, "Patient Required", "Please select a patient for this content.");
                    StateHasChanged();
                    return;
                }

                // 2. Title (required for all users)
                if (string.IsNullOrWhiteSpace(contentForm.Title))
                {
                    showTitleError = true;
                    NotificationService.Notify(NotificationSeverity.Warning, "Title Required", "Please enter a title for the content.");
                    StateHasChanged();
                    return;
                }

                // 3. File selection (required for all users)
                if (selectedFile == null)
                {
                    showFileError = true;
                    NotificationService.Notify(NotificationSeverity.Warning, "No File Selected", "Please select a file to upload before clicking Upload.");
                    StateHasChanged();
                    return;
                }

                isSaving = true;
                StateHasChanged();

                var formData = new MultipartFormDataContent();
                formData.Add(new StringContent(contentForm.PatientId.ToString()), "PatientId");
                
                if (AuthService.CurrentUser?.Id != null)
                {
                    formData.Add(new StringContent(AuthService.CurrentUser.Id.ToString()), "AddedByUserId");
                }
                
                formData.Add(new StringContent(contentForm.Title), "Title");
                formData.Add(new StringContent(contentForm.Description), "Description");
                formData.Add(new StreamContent(selectedFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024)), "File",
                selectedFile.Name);

                var response = await Http.PostAsync("api/content/upload", formData);
                if (response.IsSuccessStatusCode)
                {
                    NotificationService.Notify(NotificationSeverity.Success, "Success", "Content uploaded successfully!");
                    if (_grid != null) await _grid.RefreshAsync();
                    CloseContentForm();
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to upload content: " + error);
                }
            }
            else
            {
                // Update existing content - validate before setting isSaving
                if (string.IsNullOrWhiteSpace(contentForm.Title))
                {
                    NotificationService.Notify(NotificationSeverity.Warning, "Title Required", "Please enter a title for the content.");
                    return;
                }

                isSaving = true;
                StateHasChanged();

                var updateRequest = new ContentUpdateRequest
                {
                    Title = contentForm.Title,
                    Description = contentForm.Description,
                    AddedByUserId = AuthService.CurrentUser?.Id
                };

                var response = await Http.PutAsJsonAsync($"api/content/{editingContent.Id}", updateRequest);
                if (response.IsSuccessStatusCode)
                {
                    NotificationService.Notify(NotificationSeverity.Success, "Success", "Content updated successfully!");
                    if (_grid != null) await _grid.RefreshAsync();
                    CloseContentForm();
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to update content: " + error);
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", "An error occurred: " + ex.Message);
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private async Task ViewContent(ContentItemDto content)
    {
        try
        {
            var response = await Http.GetAsync($"api/content/{content.Id}/url");
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<dynamic>();
                var url = result?.GetProperty("url").GetString();
                if (!string.IsNullOrEmpty(url))
                {
                    // Open in new tab
                    await JSRuntime.InvokeVoidAsync("window.open", new object[] { url, "_blank" });
                }
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to get content URL.");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", "An error occurred: " + ex.Message);
        }
    }

    private async Task ToggleIgnoreContentAsync(ContentItemDto content)
    {
        try
        {
            // Add authorization header
            var token = AuthService.Token;
            var request = new HttpRequestMessage(HttpMethod.Post, $"api/content/{content.Id}/toggle-ignore");
            if (!string.IsNullOrEmpty(token))
            {
                request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }
            
            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<System.Text.Json.JsonElement>();
                var message = result.TryGetProperty("message", out var msgProp) ? msgProp.GetString() : string.Empty;
                var isIgnored = message?.Contains("ignored") == true && !message.Contains("unignored");
                
                // Reload data to get updated ignore status from server
                if (_grid != null) await _grid.RefreshAsync();
                
                NotificationService.Notify(NotificationSeverity.Success, "Success", 
                    isIgnored 
                        ? "Content ignored. It will be excluded from AI health check analysis." 
                        : "Content unignored. It will be included in AI health check analysis.");
                StateHasChanged();
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to toggle ignore status: {errorContent}");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to toggle ignore status: {ex.Message}");
        }
    }

    private async Task DeleteContent(ContentItemDto content)
    {
        try
        {
            var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete '{content.Title}'?");
            if (confirmed)
            {
                var response = await Http.DeleteAsync($"api/content/{content.Id}");
                if (response.IsSuccessStatusCode)
                {
                    NotificationService.Notify(NotificationSeverity.Success, "Success", "Content deleted successfully!");
                    if (_grid != null) await _grid.RefreshAsync();
                }
                else
                {
                    NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to delete content.");
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", "An error occurred: " + ex.Message);
        }
    }

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        showFileError = false;
        StateHasChanged();
    }

    private void ClearDescription()
    {
        contentForm.Description = string.Empty;
        StateHasChanged();
    }

    private void ClearSelectedFile()
    {
        selectedFile = null;
        showFileError = false;
        StateHasChanged();
    }

    private string GetFileInputClass()
    {
        return selectedFile == null ? "form-control file-input-empty" : "form-control file-input-selected";
    }

    private string GetFormTitle()
    {
        if (editingContent == null)
        {
            return AuthService.CurrentUser?.RoleId switch
            {
                1 => "Upload New Content", // Patient
                2 => "Add Content for Patient", // Doctor
                3 => "Add New Content", // Admin
                _ => "Add New Content"
            };
        }
        else
        {
            return "Edit Content";
        }
    }

    private string GetPatientLabelClass()
    {
        return showPatientError ? "form-label validation-error" : "form-label";
    }

    private string GetTitleLabelClass()
    {
        return showTitleError ? "form-label validation-error" : "form-label";
    }

    private string GetFileLabelClass()
    {
        return showFileError ? "form-label validation-error" : "form-label";
    }

    private async Task CloseContentForm()
    {
        showContentForm = false;
        editingContent = null;
        contentForm = new ContentForm();
        selectedFile = null;
        // Clear validation errors
        showPatientError = false;
        showTitleError = false;
        showFileError = false;
        await InvokeAsync(StateHasChanged);
    }

    private string GetFileIcon(string typeName)
    {
        return typeName switch
        {
            "Image" => "fas fa-image",
            "Video" => "fas fa-video",
            "Audio" => "fas fa-music",
            "Document" => "fas fa-file-alt",
            _ => "fas fa-file"
        };
    }

    private string GetTypeClass(string typeName)
    {
        return typeName switch
        {
            "Image" => "image",
            "Video" => "video",
            "Audio" => "audio",
            "Document" => "document",
            _ => "other"
        };
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private string GetContentTypeName(int contentTypeId)
    {
        return contentTypeId switch
        {
            1 => "Document",
            2 => "Image", 
            3 => "Video",
            4 => "Audio",
            _ => "Other"
        };
    }

    public class ContentForm
    {
        public int Id { get; set; }
        public int PatientId { get; set; }
        public string Title { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
    }

    public class ContentUpdateRequest
    {
        public string Title { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public int? AddedByUserId { get; set; }
    }

    public class ContentItemDto
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public string OriginalFileName { get; set; } = string.Empty;
        public long FileSizeBytes { get; set; }
        public DateTime CreatedAt { get; set; }
        public int ContentTypeModelId { get; set; }
        public int PatientId { get; set; }
        public string PatientName { get; set; } = string.Empty; // DTO-only property for display and filtering
        public int? AddedByUserId { get; set; }
        public string AddedByName { get; set; } = string.Empty; // DTO-only property for display and filtering
        public bool IsIgnoredByDoctor { get; set; } = false;
        public int? IgnoredByDoctorId { get; set; }
        public DateTime? IgnoredAt { get; set; }
    }

}

<style>
    .content-page {
        padding: 20px;
    }

    .content-header {
        margin-bottom: 20px;
    }

    .add-content-section {
        margin-bottom: 20px;
    }

    .content-grid {
        margin-top: 20px;
    }

    .content-type-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
    }

    .content-type-badge.image {
        background-color: #d4edda;
        color: #155724;
    }

    .content-type-badge.video {
        background-color: #cce5ff;
        color: #004085;
    }

    .content-type-badge.audio {
        background-color: #f8d7da;
        color: #721c24;
    }

    .content-type-badge.document {
        background-color: #fff3cd;
        color: #856404;
    }

    .content-type-badge.other {
        background-color: #e2e3e5;
        color: #383d41;
    }

    .text-muted {
        color: #6c757d;
        font-size: 12px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #333;
        font-size: 14px;
    }

    .form-label .required-asterisk {
        color: #dc3545 !important;
        font-weight: bold !important;
        font-size: 16px !important;
        margin-left: 2px;
        text-shadow: 0 0 1px rgba(220, 53, 69, 0.3);
    }

    .validation-error {
        position: relative;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .validation-error::after {
        content: "Required";
        font-size: 11px;
        color: #dc3545;
        background-color: #fff5f5;
        padding: 2px 6px;
        border-radius: 3px;
        border: 1px solid #f5c6cb;
        font-weight: 500;
    }

    .optional-text {
        color: #6c757d;
        font-size: 12px;
        font-weight: normal;
        font-style: italic;
    }

    .required-asterisk {
        color: #dc3545 !important;
        font-weight: bold !important;
        font-size: 16px !important;
        margin-left: 2px;
    }

    .file-input-empty {
        border: 2px dashed #ccc !important;
        background-color: #f9f9f9;
        color: #666;
        cursor: pointer;
        transition: all 0.3s ease;
        padding: 12px;
        text-align: center;
    }

    .file-input-empty:hover {
        border-color: #007bff !important;
        background-color: #f0f8ff;
        color: #007bff;
    }

    .file-input-selected {
        border: 2px solid #28a745 !important;
        background-color: #f8fff8;
        color: #155724;
        cursor: pointer;
        transition: all 0.3s ease;
        padding: 12px;
        text-align: center;
    }

    .file-input-selected:hover {
        border-color: #1e7e34 !important;
        background-color: #f0fff0;
    }

    .file-input-hint {
        margin-top: 5px;
        padding: 8px 12px;
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 4px;
        color: #856404;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .file-input-hint i {
        color: #f39c12;
    }

    .file-selected-info {
        margin-top: 5px;
        padding: 8px 12px;
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 4px;
        color: #155724;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .file-selected-info i {
        color: #28a745;
    }

    .patient-info-display {
        padding: 12px 16px;
        background-color: #e3f2fd;
        border: 1px solid #bbdefb;
        border-radius: 6px;
        color: #1565c0;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .patient-info-display i {
        color: #1976d2;
        font-size: 16px;
    }

    .patient-info-display strong {
        color: #0d47a1;
    }

    .description-container {
        position: relative;
        display: flex;
        align-items: flex-start;
    }

    .clear-description-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 12px;
        color: #666;
        transition: all 0.2s ease;
        z-index: 10;
    }

    .clear-description-btn:hover {
        background: #e0e0e0;
        color: #333;
        border-color: #bbb;
    }

    .clear-description-btn:active {
        background: #d0d0d0;
        transform: scale(0.95);
    }

    .file-selection-container {
        position: relative;
        display: flex;
        align-items: center;
    }

    .clear-file-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 12px;
        color: #666;
        transition: all 0.2s ease;
        z-index: 10;
    }

    .clear-file-btn:hover {
        background: #e0e0e0;
        color: #333;
        border-color: #bbb;
    }

    .clear-file-btn:active {
        background: #d0d0d0;
        transform: scale(0.95);
    }
</style>

