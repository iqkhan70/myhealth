@page "/content"
@inject HttpClient Http
@inject NotificationService NotificationService
@inject IAuthService AuthService
@inject IJSRuntime JSRuntime
@using Microsoft.JSInterop
@using SM_MentalHealthApp.Shared
@using SM_MentalHealthApp.Client.Services
@using SM_MentalHealthApp.Client.Components.Grid
@using SM_MentalHealthApp.Client.Components.Common
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components
@using Radzen
@using Radzen.Blazor

<div class="content-page">
    <div class="content-header">
        @if (AuthService.CurrentUser?.RoleId == 1) // Patient
        {
            <h2>My Content</h2>
            <p>Manage your personal content and documents.</p>
        }
        else if (AuthService.CurrentUser?.RoleId == 2) // Doctor
        {
            <h2>Patient Content</h2>
            <p>View and manage content for your assigned patients.</p>
        }
        else if (AuthService.CurrentUser?.RoleId == 3) // Admin
        {
            <h2>All Content</h2>
            <p>Manage all content across the platform.</p>
        }
        else if (AuthService.CurrentUser?.RoleId == 4) // Coordinator
        {
            <h2>Client Content</h2>
            <p>View client content and documents.</p>
        }
        else if (AuthService.CurrentUser?.RoleId == 5) // Attorney
        {
            <h2>Patient Content</h2>
            <p>View patient content and documents.</p>
        }
        else
        {
            <h2>Access Denied</h2>
            <p>You don't have permission to view this page.</p>
        }
    </div>

    @if (AuthService.CurrentUser?.RoleId == 1 || AuthService.CurrentUser?.RoleId == 2 || AuthService.CurrentUser?.RoleId
        == 3 || AuthService.CurrentUser?.RoleId == 4 || AuthService.CurrentUser?.RoleId == 5)
    {
        <!-- Add Content Button (hidden for Coordinator and Attorney) -->
        @if (AuthService.CurrentUser?.RoleId != 4 && AuthService.CurrentUser?.RoleId != 5)
        {
            <div class="add-content-section">
                <RadzenButton Text="Add New Content" ButtonStyle="ButtonStyle.Primary" Icon="add" Click="@ShowAddContentForm" />
            </div>
        }

        <!-- Content Grid -->
        <div class="content-grid">
            @if (_columns.Any())
            {
                <SMDataGrid TItem="ContentItemDto" Columns="_columns" Actions="_actions" ActionsWidth="200px"
                    LoadItems="LoadContentItems" PageSize="10" @ref="_grid" AutoLoad="true" />
            }
        </div>
    }
</div>

<!-- Add/Edit Content Modal -->
@if (showContentForm)
{
    <SMModal IsVisible="@showContentForm" 
             Title="@GetFormTitle()" 
             OnClose="CloseContentForm"
             Size="Medium">
    <Body>
        <form @onsubmit="@SaveContent" @onsubmit:preventDefault="true">
            @if (AuthService.CurrentUser?.RoleId == 2 || AuthService.CurrentUser?.RoleId == 3)
            {
                <div class="form-group">
                    <label class="form-label @GetPatientLabelClass()">Select Patient: <span class="required-asterisk">*</span></label>
                    <RadzenDropDown Data="@patients" TextProperty="FullName" ValueProperty="Id"
                        @bind-Value="contentForm.PatientId" AllowFiltering="true"
                        FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" Placeholder="Choose a patient..."
                        Style="width: 100%" 
                        @onchange="@(() => { showPatientError = false; StateHasChanged(); })" />
                </div>
            }
            else if (AuthService.CurrentUser?.RoleId == 1)
            {
                <div class="form-group">
                    <div class="patient-info-display">
                        <i class="fas fa-user"></i>
                        <span>Uploading content for: <strong>@(AuthService.CurrentUser?.FirstName) @(AuthService.CurrentUser?.LastName)</strong></span>
                    </div>
                </div>
            }

            <div class="form-group">
                <label class="form-label @GetTitleLabelClass()">Title: <span class="required-asterisk">*</span></label>
                <RadzenTextBox @bind-Value="contentForm.Title" Placeholder="Enter content title..."
                    Style="width: 100%" 
                    @onchange="@(() => { showTitleError = false; StateHasChanged(); })" />
            </div>

            <div class="form-group">
                <label class="form-label">Description: <span class="optional-text">(Optional)</span></label>
                <div class="description-container">
                    <RadzenTextArea @bind-Value="contentForm.Description" Placeholder="Enter content description (optional)... You can leave this empty or clear it anytime."
                        Style="width: 100%; height: 80px;" />
                    @if (!string.IsNullOrWhiteSpace(contentForm.Description))
                    {
                        <button type="button" class="clear-description-btn" @onclick="ClearDescription" title="Clear description">
                            <i class="fas fa-times"></i>
                        </button>
                    }
                </div>
            </div>

            @if (editingContent == null)
            {
                <div class="form-group">
                    <label class="form-label @GetFileLabelClass()">File: <span class="required-asterisk">*</span></label>
                    <div class="file-selection-container">
                        <InputFile OnChange="@OnFileSelected" accept="*/*" class="@GetFileInputClass()" />
                        @if (selectedFile != null)
                        {
                            <button type="button" class="clear-file-btn" @onclick="ClearSelectedFile" title="Clear selected file">
                                <i class="fas fa-times"></i>
                            </button>
                        }
                    </div>
                    @if (selectedFile == null)
                    {
                        <div class="file-input-hint">
                            <i class="fas fa-info-circle"></i>
                            Please select a file to upload
                        </div>
                    }
                    else
                    {
                        <div class="file-selected-info">
                            <i class="fas fa-check-circle text-success"></i>
                            Selected: @selectedFile.Name (@(selectedFile.Size / 1024) KB)
                        </div>
                    }
                </div>
            }
        </form>
    </Body>
    <Footer>
        <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@CloseContentForm" />
        <RadzenButton Text="@(editingContent == null ? "Upload" : "Save")" ButtonStyle="ButtonStyle.Primary"
            ButtonType="ButtonType.Submit" Disabled="@isSaving" Click="@SaveContent" />
    </Footer>
    </SMModal>
}

@code {
    private SMDataGrid<ContentItemDto>? _grid;
    private List<User> patients = new();
    private bool showContentForm = false;
    private bool isSaving = false;
    private ContentItem? editingContent = null;
    private ContentForm contentForm = new();
    private IBrowserFile? selectedFile = null;
    
    // Validation state tracking
    private bool showPatientError = false;
    private bool showTitleError = false;
    private bool showFileError = false;

    private List<SMDataGridColumn<ContentItemDto>> _columns = new();
    private readonly List<SMDataGridActionButton<ContentItemDto>> _actions = [];

    protected override async Task OnInitializedAsync()
    {
        await AuthService.InitializeAsync();
        await LoadPatients();
        InitializeColumns();
        InitializeActions();
    }

    private async Task LoadPatients()
    {
        try
        {
            // Load patients based on user role
            if (AuthService.CurrentUser?.RoleId == 2) // Doctor - only assigned patients
            {
                var patientsResponse = await
                Http.GetFromJsonAsync<List<User>>($"api/admin/doctor/{AuthService.CurrentUser.Id}/patients");
                patients = patientsResponse ?? new();
            }
            else if (AuthService.CurrentUser?.RoleId == 4) // Coordinator - only assigned patients
            {
                var patientsResponse = await
                Http.GetFromJsonAsync<List<User>>($"api/admin/doctor/{AuthService.CurrentUser.Id}/patients");
                patients = patientsResponse ?? new();
            }
            else if (AuthService.CurrentUser?.RoleId == 5) // Attorney - only assigned patients
            {
                var patientsResponse = await
                Http.GetFromJsonAsync<List<User>>($"api/admin/doctor/{AuthService.CurrentUser.Id}/patients");
                patients = patientsResponse ?? new();
            }
            else if (AuthService.CurrentUser?.RoleId == 3) // Admin - all patients
            {
                var patientsResponse = await Http.GetFromJsonAsync<List<User>>("api/admin/patients");
                patients = patientsResponse ?? new();
            }
            else
            {
                patients = new();
            }
        }
        catch (Exception ex)
        {
            // Don't show error for empty results - just set to empty list
            // Only show error for actual failures (401, 403, etc.)
            if (ex.Message.Contains("401") || ex.Message.Contains("403") || ex.Message.Contains("Unauthorized"))
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load patients: " + ex.Message);
            }
            patients = new(); // Set to empty list on error
        }
    }

    private async Task<IEnumerable<ContentItemDto>> LoadContentItems(CancellationToken ct)
    {
        try
        {
            // Ensure patients are loaded for doctors/admins/coordinators/attorneys before loading content
            if ((AuthService.CurrentUser?.RoleId == 2 || AuthService.CurrentUser?.RoleId == 3 || AuthService.CurrentUser?.RoleId == 4 || AuthService.CurrentUser?.RoleId == 5) && !patients.Any())
            {
                await LoadPatients();
            }

            // Load content based on user role
            if (AuthService.CurrentUser?.RoleId == 1) // Patient
            {
                var response = await Http.GetFromJsonAsync<List<ContentItemDto>>($"api/content/patient/{AuthService.CurrentUser.Id}");
                return response ?? new List<ContentItemDto>();
            }
            else if (AuthService.CurrentUser?.RoleId == 2 || AuthService.CurrentUser?.RoleId == 4 || AuthService.CurrentUser?.RoleId == 5) // Doctor, Coordinator, or Attorney
            {
                // For attorneys, the server already filters by assigned patients
                // For doctors and coordinators, filter client-side
                if (AuthService.CurrentUser?.RoleId == 5) // Attorney - server already filtered
                {
                    try
                    {
                        var response = await Http.GetFromJsonAsync<List<ContentItemDto>>("api/content/all");
                        return response ?? new List<ContentItemDto>();
                    }
                    catch (Exception ex)
                    {
                        // Log the error for debugging
                        Console.WriteLine($"Error loading content for attorney: {ex.Message}");
                        // Only show error for actual failures (401, 403, etc.), not for empty results
                        if (ex.Message.Contains("401") || ex.Message.Contains("403") || ex.Message.Contains("Unauthorized"))
                        {
                            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load content: " + ex.Message);
                        }
                        return new List<ContentItemDto>();
                    }
                }
                else // Doctor or Coordinator - filter client-side
                {
                    // Load content only for assigned patients
                    var assignedPatientIds = patients.Select(p => p.Id).ToList();
                    if (!assignedPatientIds.Any())
                    {
                        return new List<ContentItemDto>();
                    }
                    var allContentResponse = await Http.GetFromJsonAsync<List<ContentItemDto>>("api/content/all");
                    return allContentResponse?.Where(c => assignedPatientIds.Contains(c.PatientId)).ToList() ?? new List<ContentItemDto>();
                }
            }
            else if (AuthService.CurrentUser?.RoleId == 3) // Admin - all content
            {
                var response = await Http.GetFromJsonAsync<List<ContentItemDto>>("api/content/all");
                return response ?? new List<ContentItemDto>();
            }
        }
        catch (Exception ex)
        {
            // Only show error for actual failures (401, 403, etc.), not for empty results
            if (ex.Message.Contains("401") || ex.Message.Contains("403") || ex.Message.Contains("Unauthorized"))
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load content: " + ex.Message);
            }
            // For other errors or empty results, just return empty list
        }
        return new List<ContentItemDto>();
    }

    private void InitializeColumns()
    {
        _columns = new List<SMDataGridColumn<ContentItemDto>>
        {
            new SMDataGridTemplateColumn<ContentItemDto>
            {
                Property = nameof(ContentItemDto.Title),
                Title = "Title",
                Width = "200px",
                Template = content => builder =>
                {
                    builder.OpenElement(0, "div");
                    builder.OpenElement(1, "strong");
                    builder.AddContent(2, content.Title);
                    builder.CloseElement();
                    builder.OpenElement(3, "br");
                    builder.CloseElement();
                    builder.OpenElement(4, "small");
                    builder.AddAttribute(5, "class", "text-muted");
                    builder.AddContent(6, content.Description);
                    builder.CloseElement();
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<ContentItemDto>
            {
                Property = nameof(ContentItemDto.PatientId),
                Title = AuthService.CurrentUser?.RoleId == 4 ? "Client" : "Patient", // Coordinator sees "Client", others see "Patient"
                Width = "150px",
                Template = content => builder =>
                {
                    builder.OpenElement(0, "div");
                    builder.OpenElement(1, "strong");
                    if (AuthService.CurrentUser?.RoleId == 4) // Coordinator
                    {
                        builder.AddContent(2, $"Client #{content.PatientId}");
                    }
                    else
                    {
                        builder.AddContent(2, $"Patient #{content.PatientId}");
                    }
                    builder.CloseElement();
                    builder.OpenElement(3, "br");
                    builder.CloseElement();
                    builder.OpenElement(4, "small");
                    builder.AddAttribute(5, "class", "text-muted");
                    builder.AddContent(6, $"ID: {content.PatientId}");
                    builder.CloseElement();
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<ContentItemDto>
            {
                Property = nameof(ContentItemDto.OriginalFileName),
                Title = "File",
                Width = "150px",
                Template = content => builder =>
                {
                    builder.OpenElement(0, "div");
                    builder.OpenElement(1, "i");
                    builder.AddAttribute(2, "class", GetFileIcon(GetContentTypeName(content.ContentTypeModelId)));
                    builder.CloseElement();
                    builder.AddContent(3, " ");
                    builder.AddContent(4, content.OriginalFileName);
                    builder.OpenElement(5, "br");
                    builder.CloseElement();
                    builder.OpenElement(6, "small");
                    builder.AddAttribute(7, "class", "text-muted");
                    builder.AddContent(8, FormatFileSize(content.FileSizeBytes));
                    builder.CloseElement();
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<ContentItemDto>
            {
                Property = nameof(ContentItemDto.ContentTypeModelId),
                Title = "Type",
                Width = "100px",
                Template = content => builder =>
                {
                    builder.OpenElement(0, "span");
                    builder.AddAttribute(1, "class", $"content-type-badge {GetTypeClass(GetContentTypeName(content.ContentTypeModelId))}");
                    builder.AddContent(2, GetContentTypeName(content.ContentTypeModelId));
                    builder.CloseElement();
                }
            },
            new SMDataGridBadgeColumn<ContentItemDto>
            {
                Property = nameof(ContentItemDto.IsIgnoredByDoctor),
                Title = "AI Status",
                Width = "130px",
                GetBadgeData = content => content.IsIgnoredByDoctor
                    ? ("ðŸš« Ignored", NotificationSeverity.Warning, true)
                    : ("âœ… Active", NotificationSeverity.Success, true)
            },
            new SMDataGridTemplateColumn<ContentItemDto>
            {
                Property = nameof(ContentItemDto.CreatedAt),
                Title = "Added",
                Width = "120px",
                Template = content => builder =>
                {
                    builder.AddContent(0, content.CreatedAt.ToString("MMM dd, yyyy"));
                    builder.OpenElement(1, "br");
                    builder.CloseElement();
                    builder.OpenElement(2, "small");
                    builder.AddAttribute(3, "class", "text-muted");
                    builder.AddContent(4, content.CreatedAt.ToString("HH:mm"));
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<ContentItemDto>
            {
                Property = nameof(ContentItemDto.AddedByUserId),
                Title = "Added By",
                Width = "120px",
                Template = content => builder =>
                {
                    if (content.AddedByUserId.HasValue)
                    {
                        builder.OpenElement(0, "div");
                        builder.OpenElement(1, "strong");
                        builder.AddContent(2, $"User #{content.AddedByUserId}");
                        builder.CloseElement();
                        builder.OpenElement(3, "br");
                        builder.CloseElement();
                        builder.OpenElement(4, "small");
                        builder.AddAttribute(5, "class", "text-muted");
                        builder.AddContent(6, $"ID: {content.AddedByUserId}");
                        builder.CloseElement();
                        builder.CloseElement();
                    }
                    else
                    {
                        builder.OpenElement(0, "span");
                        builder.AddAttribute(1, "class", "text-muted");
                        builder.AddContent(2, "Self");
                        builder.CloseElement();
                    }
                }
            }
        };
    }


    private void InitializeActions()
    {
        _actions.Add(new SMDataGridActionButton<ContentItemDto>
        {
            Icon = "visibility",
            ButtonStyle = ButtonStyle.Info,
            Variant = Variant.Flat,
            Size = ButtonSize.Small,
            Tooltip = "View/Download",
            OnClick = async (row, ct) => await ViewContent(row)
        });

        // Edit action (not for Coordinator or Attorney - read-only)
        if (AuthService.CurrentUser?.RoleId != 4 && AuthService.CurrentUser?.RoleId != 5) // Coordinator and Attorney can only view
        {
            _actions.Add(new SMDataGridActionButton<ContentItemDto>
            {
                Icon = "edit",
                ButtonStyle = ButtonStyle.Success,
                Variant = Variant.Flat,
                Size = ButtonSize.Small,
                Tooltip = "Edit",
                OnClick = async (row, ct) => await EditContent(row)
            });
        }

        if (AuthService.CurrentUser?.RoleId == 2) // Doctor can ignore/unignore
        {
            _actions.Add(new SMDataGridActionButton<ContentItemDto>
            {
                IconFunc = content => content.IsIgnoredByDoctor ? "undo" : "block",
                ButtonStyleFunc = content => content.IsIgnoredByDoctor ? ButtonStyle.Info : ButtonStyle.Warning,
                Variant = Variant.Flat,
                Size = ButtonSize.Small,
                TooltipFunc = content => content.IsIgnoredByDoctor 
                    ? "Unignore for AI analysis" 
                    : "Ignore for AI analysis",
                OnClick = async (row, ct) => await ToggleIgnoreContentAsync(row)
            });
        }

        if (AuthService.CurrentUser?.RoleId == 3) // Only admin can delete (not Coordinator)
        {
            _actions.Add(new SMDataGridActionButton<ContentItemDto>
            {
                Icon = "delete",
                ButtonStyle = ButtonStyle.Danger,
                Variant = Variant.Flat,
                Size = ButtonSize.Small,
                Tooltip = "Delete",
                OnClick = async (row, ct) => await DeleteContent(row)
            });
        }
    }

    private async Task ShowAddContentForm()
    {
        editingContent = null;
        contentForm = new ContentForm();
        if (AuthService.CurrentUser?.RoleId == 1) // Patient
        {
            contentForm.PatientId = AuthService.CurrentUser.Id;
        }
        
        // Clear validation errors (in same order as validation)
        showPatientError = false;
        showTitleError = false;
        showFileError = false;
        
        showContentForm = true;
        await InvokeAsync(StateHasChanged);
    }

    private async Task EditContent(ContentItemDto content)
    {
        editingContent = new ContentItem
        {
            Id = content.Id,
            PatientId = content.PatientId,
            Title = content.Title,
            Description = content.Description
        };
        contentForm = new ContentForm
        {
            Id = content.Id,
            PatientId = content.PatientId,
            Title = content.Title,
            Description = content.Description
        };
        showContentForm = true;
        await InvokeAsync(StateHasChanged);
    }

    private async Task SaveContent()
    {
        Console.WriteLine("SaveContent method called");
        NotificationService.Notify(NotificationSeverity.Info, "Debug", "SaveContent method called!");
        try
        {
            if (editingContent == null)
            {
                // Clear previous validation errors (in same order as validation)
                showPatientError = false;
                showTitleError = false;
                showFileError = false;
                StateHasChanged();

                // Add new content - validate from top to bottom
                Console.WriteLine($"Validation: PatientId={contentForm.PatientId}, Title='{contentForm.Title}', Description='{contentForm.Description}', SelectedFile={selectedFile?.Name}");
                
                // 1. Patient selection (for doctors and admins only)
                if ((AuthService.CurrentUser?.RoleId == 2 || AuthService.CurrentUser?.RoleId == 3) && contentForm.PatientId == 0)
                {
                    Console.WriteLine("Patient validation failed");
                    showPatientError = true;
                    NotificationService.Notify(NotificationSeverity.Warning, "Patient Required", "Please select a patient for this content.");
                    StateHasChanged();
                    return;
                }

                // 2. Title (required for all users)
                if (string.IsNullOrWhiteSpace(contentForm.Title))
                {
                    Console.WriteLine("Title validation failed");
                    showTitleError = true;
                    NotificationService.Notify(NotificationSeverity.Warning, "Title Required", "Please enter a title for the content.");
                    StateHasChanged();
                    return;
                }

                // 3. File selection (required for all users)
                if (selectedFile == null)
                {
                    Console.WriteLine("File validation failed");
                    showFileError = true;
                    NotificationService.Notify(NotificationSeverity.Warning, "No File Selected", "Please select a file to upload before clicking Upload.");
                    StateHasChanged();
                    return;
                }

                Console.WriteLine("All validations passed, proceeding with upload");
                Console.WriteLine($"Current User ID: {AuthService.CurrentUser?.Id}");
                Console.WriteLine($"Current User Role: {AuthService.CurrentUser?.RoleId}");

                isSaving = true;
                StateHasChanged();

                var formData = new MultipartFormDataContent();
                formData.Add(new StringContent(contentForm.PatientId.ToString()), "PatientId");
                
                if (AuthService.CurrentUser?.Id != null)
                {
                    formData.Add(new StringContent(AuthService.CurrentUser.Id.ToString()), "AddedByUserId");
                    Console.WriteLine($"Added AddedByUserId: {AuthService.CurrentUser.Id}");
                }
                else
                {
                    Console.WriteLine("WARNING: No current user ID available!");
                }
                
                formData.Add(new StringContent(contentForm.Title), "Title");
                formData.Add(new StringContent(contentForm.Description), "Description");
                formData.Add(new StreamContent(selectedFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024)), "File",
                selectedFile.Name);

                var response = await Http.PostAsync("api/content/upload", formData);
                if (response.IsSuccessStatusCode)
                {
                    NotificationService.Notify(NotificationSeverity.Success, "Success", "Content uploaded successfully!");
                    if (_grid != null) await _grid.RefreshAsync();
                    CloseContentForm();
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to upload content: " + error);
                }
            }
            else
            {
                // Update existing content - validate before setting isSaving
                if (string.IsNullOrWhiteSpace(contentForm.Title))
                {
                    NotificationService.Notify(NotificationSeverity.Warning, "Title Required", "Please enter a title for the content.");
                    return;
                }

                isSaving = true;
                StateHasChanged();

                var updateRequest = new ContentUpdateRequest
                {
                    Title = contentForm.Title,
                    Description = contentForm.Description,
                    AddedByUserId = AuthService.CurrentUser?.Id
                };

                var response = await Http.PutAsJsonAsync($"api/content/{editingContent.Id}", updateRequest);
                if (response.IsSuccessStatusCode)
                {
                    NotificationService.Notify(NotificationSeverity.Success, "Success", "Content updated successfully!");
                    if (_grid != null) await _grid.RefreshAsync();
                    CloseContentForm();
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to update content: " + error);
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", "An error occurred: " + ex.Message);
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private async Task ViewContent(ContentItemDto content)
    {
        try
        {
            var response = await Http.GetAsync($"api/content/{content.Id}/url");
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<dynamic>();
                var url = result?.GetProperty("url").GetString();
                if (!string.IsNullOrEmpty(url))
                {
                    // Open in new tab
                    await JSRuntime.InvokeVoidAsync("window.open", new object[] { url, "_blank" });
                }
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to get content URL.");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", "An error occurred: " + ex.Message);
        }
    }

    private async Task ToggleIgnoreContentAsync(ContentItemDto content)
    {
        try
        {
            // Add authorization header
            var token = AuthService.Token;
            var request = new HttpRequestMessage(HttpMethod.Post, $"api/content/{content.Id}/toggle-ignore");
            if (!string.IsNullOrEmpty(token))
            {
                request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }
            
            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<System.Text.Json.JsonElement>();
                var message = result.TryGetProperty("message", out var msgProp) ? msgProp.GetString() : string.Empty;
                var isIgnored = message?.Contains("ignored") == true && !message.Contains("unignored");
                
                // Reload data to get updated ignore status from server
                if (_grid != null) await _grid.RefreshAsync();
                
                NotificationService.Notify(NotificationSeverity.Success, "Success", 
                    isIgnored 
                        ? "Content ignored. It will be excluded from AI health check analysis." 
                        : "Content unignored. It will be included in AI health check analysis.");
                StateHasChanged();
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to toggle ignore status: {errorContent}");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to toggle ignore status: {ex.Message}");
        }
    }

    private async Task DeleteContent(ContentItemDto content)
    {
        try
        {
            var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete '{content.Title}'?");
            if (confirmed)
            {
                var response = await Http.DeleteAsync($"api/content/{content.Id}");
                if (response.IsSuccessStatusCode)
                {
                    NotificationService.Notify(NotificationSeverity.Success, "Success", "Content deleted successfully!");
                    if (_grid != null) await _grid.RefreshAsync();
                }
                else
                {
                    NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to delete content.");
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", "An error occurred: " + ex.Message);
        }
    }

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        showFileError = false;
        StateHasChanged();
    }

    private void ClearDescription()
    {
        contentForm.Description = string.Empty;
        StateHasChanged();
    }

    private void ClearSelectedFile()
    {
        selectedFile = null;
        showFileError = false;
        StateHasChanged();
    }

    private string GetFileInputClass()
    {
        return selectedFile == null ? "form-control file-input-empty" : "form-control file-input-selected";
    }

    private string GetFormTitle()
    {
        if (editingContent == null)
        {
            return AuthService.CurrentUser?.RoleId switch
            {
                1 => "Upload New Content", // Patient
                2 => "Add Content for Patient", // Doctor
                3 => "Add New Content", // Admin
                _ => "Add New Content"
            };
        }
        else
        {
            return "Edit Content";
        }
    }

    private string GetPatientLabelClass()
    {
        return showPatientError ? "form-label validation-error" : "form-label";
    }

    private string GetTitleLabelClass()
    {
        return showTitleError ? "form-label validation-error" : "form-label";
    }

    private string GetFileLabelClass()
    {
        return showFileError ? "form-label validation-error" : "form-label";
    }

    private async Task CloseContentForm()
    {
        showContentForm = false;
        editingContent = null;
        contentForm = new ContentForm();
        selectedFile = null;
        // Clear validation errors
        showPatientError = false;
        showTitleError = false;
        showFileError = false;
        await InvokeAsync(StateHasChanged);
    }

    private string GetFileIcon(string typeName)
    {
        return typeName switch
        {
            "Image" => "fas fa-image",
            "Video" => "fas fa-video",
            "Audio" => "fas fa-music",
            "Document" => "fas fa-file-alt",
            _ => "fas fa-file"
        };
    }

    private string GetTypeClass(string typeName)
    {
        return typeName switch
        {
            "Image" => "image",
            "Video" => "video",
            "Audio" => "audio",
            "Document" => "document",
            _ => "other"
        };
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private string GetContentTypeName(int contentTypeId)
    {
        return contentTypeId switch
        {
            1 => "Document",
            2 => "Image", 
            3 => "Video",
            4 => "Audio",
            _ => "Other"
        };
    }

    public class ContentForm
    {
        public int Id { get; set; }
        public int PatientId { get; set; }
        public string Title { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
    }

    public class ContentUpdateRequest
    {
        public string Title { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public int? AddedByUserId { get; set; }
    }

    public class ContentItemDto
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public string OriginalFileName { get; set; } = string.Empty;
        public long FileSizeBytes { get; set; }
        public DateTime CreatedAt { get; set; }
        public int ContentTypeModelId { get; set; }
        public int PatientId { get; set; }
        public int? AddedByUserId { get; set; }
        public bool IsIgnoredByDoctor { get; set; } = false;
        public int? IgnoredByDoctorId { get; set; }
        public DateTime? IgnoredAt { get; set; }
    }

}

<style>
    .content-page {
        padding: 20px;
    }

    .content-header {
        margin-bottom: 20px;
    }

    .add-content-section {
        margin-bottom: 20px;
    }

    .content-grid {
        margin-top: 20px;
    }

    .content-type-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
    }

    .content-type-badge.image {
        background-color: #d4edda;
        color: #155724;
    }

    .content-type-badge.video {
        background-color: #cce5ff;
        color: #004085;
    }

    .content-type-badge.audio {
        background-color: #f8d7da;
        color: #721c24;
    }

    .content-type-badge.document {
        background-color: #fff3cd;
        color: #856404;
    }

    .content-type-badge.other {
        background-color: #e2e3e5;
        color: #383d41;
    }

    .text-muted {
        color: #6c757d;
        font-size: 12px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #333;
        font-size: 14px;
    }

    .form-label .required-asterisk {
        color: #dc3545 !important;
        font-weight: bold !important;
        font-size: 16px !important;
        margin-left: 2px;
        text-shadow: 0 0 1px rgba(220, 53, 69, 0.3);
    }

    .validation-error {
        position: relative;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .validation-error::after {
        content: "Required";
        font-size: 11px;
        color: #dc3545;
        background-color: #fff5f5;
        padding: 2px 6px;
        border-radius: 3px;
        border: 1px solid #f5c6cb;
        font-weight: 500;
    }

    .optional-text {
        color: #6c757d;
        font-size: 12px;
        font-weight: normal;
        font-style: italic;
    }

    .required-asterisk {
        color: #dc3545 !important;
        font-weight: bold !important;
        font-size: 16px !important;
        margin-left: 2px;
    }

    .file-input-empty {
        border: 2px dashed #ccc !important;
        background-color: #f9f9f9;
        color: #666;
        cursor: pointer;
        transition: all 0.3s ease;
        padding: 12px;
        text-align: center;
    }

    .file-input-empty:hover {
        border-color: #007bff !important;
        background-color: #f0f8ff;
        color: #007bff;
    }

    .file-input-selected {
        border: 2px solid #28a745 !important;
        background-color: #f8fff8;
        color: #155724;
        cursor: pointer;
        transition: all 0.3s ease;
        padding: 12px;
        text-align: center;
    }

    .file-input-selected:hover {
        border-color: #1e7e34 !important;
        background-color: #f0fff0;
    }

    .file-input-hint {
        margin-top: 5px;
        padding: 8px 12px;
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 4px;
        color: #856404;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .file-input-hint i {
        color: #f39c12;
    }

    .file-selected-info {
        margin-top: 5px;
        padding: 8px 12px;
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 4px;
        color: #155724;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .file-selected-info i {
        color: #28a745;
    }

    .patient-info-display {
        padding: 12px 16px;
        background-color: #e3f2fd;
        border: 1px solid #bbdefb;
        border-radius: 6px;
        color: #1565c0;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .patient-info-display i {
        color: #1976d2;
        font-size: 16px;
    }

    .patient-info-display strong {
        color: #0d47a1;
    }

    .description-container {
        position: relative;
        display: flex;
        align-items: flex-start;
    }

    .clear-description-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 12px;
        color: #666;
        transition: all 0.2s ease;
        z-index: 10;
    }

    .clear-description-btn:hover {
        background: #e0e0e0;
        color: #333;
        border-color: #bbb;
    }

    .clear-description-btn:active {
        background: #d0d0d0;
        transform: scale(0.95);
    }

    .file-selection-container {
        position: relative;
        display: flex;
        align-items: center;
    }

    .clear-file-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 12px;
        color: #666;
        transition: all 0.2s ease;
        z-index: 10;
    }

    .clear-file-btn:hover {
        background: #e0e0e0;
        color: #333;
        border-color: #bbb;
    }

    .clear-file-btn:active {
        background: #d0d0d0;
        transform: scale(0.95);
    }
</style>

