@page "/journal"
@using SM_MentalHealthApp.Client.Services
@using SM_MentalHealthApp.Client.Components.Grid
@using SM_MentalHealthApp.Shared
@using Radzen
@using Radzen.Blazor
@inject HttpClient Http
@inject NotificationService NotificationService
@inject IAuthService AuthService
@inject IJournalService JournalService

<PageTitle>Health Journal</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Journal Entry Form -->
            <div class="journal-form-card mb-4">
                <div class="form-header">
                    <h2><i class="fas fa-book me-2"></i>Health Journal</h2>
                    <p class="text-muted">Share your thoughts and feelings. Our AI companion will provide empathetic responses and mood analysis.</p>
                </div>

                <div class="form-content">
                    @if (AuthService.CurrentUser?.RoleId == 2) // Doctor
                    {
                        <div class="patient-selection mb-3">
                            <label style="white-space: nowrap; margin-bottom: 8px; display: block;">
                                üë§ Select Patient: 
                                @if (selectedPatientId == 0)
                                {
                                    <span class="required-indicator">*</span>
                                }
                            </label>
                            <RadzenDropDown @bind-Value="selectedPatientId" 
                                           Data="@assignedPatients" 
                                           ValueProperty="Id" 
                                           TextProperty="FullName"
                                           Placeholder="Search patients..." 
                                           AllowClear="true"
                                           AllowFiltering="true"
                                           FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                           Change="@OnPatientSelected"
                                           Style="width: 100%; min-width: 350px; max-width: 500px;"
                                           TValue="int"
                                           class="@GetPatientSelectClass()">
                                <Template Context="patient">
                                    <div style="padding: 6px 8px; line-height: 1.2;">
                                        <div style="font-weight: 500; font-size: 14px; margin-bottom: 2px;">@patient.FirstName @patient.LastName</div>
                                        <div style="font-size: 12px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">@patient.Email ‚Ä¢ ID: @patient.Id</div>
                                    </div>
                                </Template>
                            </RadzenDropDown>
                        </div>
                    }

                    <div class="mb-3">
                        <RadzenTextArea @bind-Value="entryText" 
                                        Placeholder="@(AuthService.CurrentUser?.RoleId == 2 ? "Enter journal entry for the selected patient..." : "How are you feeling today? What's on your mind?")" 
                                        Rows="5"
                                        Style="width: 100%;" />
                    </div>

                    <div class="d-flex gap-2">
                        <RadzenButton Text="üíæ Save Entry" 
                                     ButtonStyle="ButtonStyle.Success"
                                     Icon="save"
                                     Click="@SaveEntry" 
                                     Disabled="@(string.IsNullOrWhiteSpace(entryText) || (AuthService.CurrentUser?.RoleId == 2 && selectedPatientId == 0))" />
                    </div>
                    
                    @if (AuthService.CurrentUser?.RoleId == 2 && selectedPatientId == 0 && !string.IsNullOrWhiteSpace(entryText))
                    {
                        <div class="alert alert-warning mt-2">
                            <i class="fas fa-exclamation-triangle"></i>
                            Please select a patient before saving the journal entry.
                        </div>
                    }
                </div>
            </div>

            <!-- Journal Entries Grid -->
            <div class="entries-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h3><i class="fas fa-list me-2"></i>@(AuthService.CurrentUser?.RoleId == 2 ? "Patient Journal Entries" : "Your Journal Entries")</h3>
                        <p class="text-muted mb-0">@(AuthService.CurrentUser?.RoleId == 2 && selectedPatientId == 0 ? "Select a patient to view their journal entries" : "View and manage journal entries")</p>
                    </div>
                </div>

                @if (CanLoadEntries)
                {
                    <SMDataGrid TItem="JournalEntryDto" 
                               Columns="_columns" 
                               Actions="_actions" 
                               ActionsWidth="100px"
                               LoadItems="LoadJournalEntriesAsync" 
                               @ref="_grid" 
                               PageSize="10"
                               OnRowExpandCallback="@OnRowExpand">
                        <ExpansionTemplate Context="entry">
                            @{
                                var expandedEntry = expandedEntries.ContainsKey(entry.Id) ? expandedEntries[entry.Id] : entry;
                            }
                            <div class="p-3">
                                <div class="row">
                                    <div class="col-12">
                                        <h6>Journal Entry Details</h6>
                                        <div class="entry-meta mb-3">
                                            <div class="meta-row">
                                                <span class="meta-label"><strong>Created:</strong></span>
                                                <span class="meta-value">@expandedEntry.CreatedAt.ToString("MMM dd, yyyy 'at' h:mm tt")</span>
                                            </div>
                                            @if (!string.IsNullOrEmpty(expandedEntry.EnteredByName))
                                            {
                                                <div class="meta-row">
                                                    <span class="meta-label"><strong>Entered By:</strong></span>
                                                    <span class="meta-value">
                                                        @if (expandedEntry.EnteredByUserId.HasValue)
                                                        {
                                                            <i class="fas fa-user-md"></i>
                                                        }
                                                        else
                                                        {
                                                            <i class="fas fa-user"></i>
                                                        }
                                                        @expandedEntry.EnteredByName
                                                    </span>
                                                </div>
                                            }
                                            @if (!string.IsNullOrEmpty(expandedEntry.Mood))
                                            {
                                                <div class="meta-row">
                                                    <span class="meta-label"><strong>Mood:</strong></span>
                                                    <span class="meta-value">
                                                        <span class="badge @GetMoodClass(expandedEntry.Mood)">@expandedEntry.Mood</span>
                                                    </span>
                                                </div>
                                            }
                                        </div>
                                        
                                        <div class="journal-text-section mb-3">
                                            <h6>Journal Entry:</h6>
                                            <div class="content-text">@expandedEntry.Text</div>
                                        </div>
                                        
                                        @if (!string.IsNullOrEmpty(expandedEntry.AIResponse))
                                        {
                                            <div class="ai-response-section">
                                                <h6><i class="fas fa-robot me-2"></i>AI Response:</h6>
                                                <div class="content-text ai-response">@expandedEntry.AIResponse</div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </ExpansionTemplate>
                    </SMDataGrid>
                }
                else
                {
                    <div class="empty-state text-center p-5">
                        <div class="empty-icon" style="font-size: 4rem; margin-bottom: 1rem;">üìù</div>
                        @if (AuthService.CurrentUser?.RoleId == 2)
                        {
                            <h4>@(selectedPatientId == 0 ? "Select a patient to view their journal entries" : "No journal entries for this patient yet")</h4>
                            <p class="text-muted">@(selectedPatientId == 0 ? "Choose a patient from the dropdown above to see their journal entries, or create a new entry for them." : "This patient hasn't written any journal entries yet. You can create one for them above.")</p>
                        }
                        else
                        {
                            <h4>No journal entries yet</h4>
                            <p class="text-muted">Start by writing your first entry above!</p>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private string entryText = string.Empty;
    private List<User> assignedPatients = new();
    private int selectedPatientId = 0;
    private Dictionary<int, User> doctorCache = new();
    private Dictionary<int, JournalEntryDto> expandedEntries = new();
    private SMDataGrid<JournalEntryDto>? _grid;

    // Helper class for grid
    public class JournalEntryDto
    {
        public int Id { get; set; }
        public string Text { get; set; } = string.Empty;
        public string? AIResponse { get; set; }
        public string? Mood { get; set; }
        public DateTime CreatedAt { get; set; }
        public int? EnteredByUserId { get; set; }
        public string EnteredByName { get; set; } = string.Empty;
    }

    private bool CanLoadEntries => AuthService.CurrentUser != null && 
                                   (AuthService.CurrentUser.RoleId != 2 || selectedPatientId > 0);

    private readonly List<SMDataGridColumn<JournalEntryDto>> _columns = new();
    private readonly List<SMDataGridActionButton<JournalEntryDto>> _actions = new();

    protected override async Task OnInitializedAsync()
    {
        if (AuthService.CurrentUser?.RoleId == 2) // Doctor
        {
            await LoadAssignedPatients();
        }
        
        InitializeColumns();
        InitializeActions();
    }

    private void InitializeColumns()
    {
        _columns.AddRange(new[]
        {
            new SMDataGridTemplateColumn<JournalEntryDto>
            {
                Property = nameof(JournalEntryDto.CreatedAt),
                Title = "Entry Date",
                Width = "200px",
                Template = entry => builder =>
                {
                    builder.AddContent(0, entry.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy"));
                    builder.OpenElement(1, "br");
                    builder.CloseElement();
                    builder.OpenElement(2, "small");
                    builder.AddAttribute(3, "class", "text-muted");
                    builder.AddContent(4, entry.CreatedAt.ToLocalTime().ToString("h:mm tt"));
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<JournalEntryDto>
            {
                Property = nameof(JournalEntryDto.EnteredByName),
                Title = "Entered By",
                Width = "200px",
                Template = entry => builder =>
                {
                    builder.OpenElement(0, "span");
                    if (entry.EnteredByUserId.HasValue)
                    {
                        builder.AddAttribute(1, "class", "entry-entered-by");
                        builder.OpenElement(2, "i");
                        builder.AddAttribute(3, "class", "fas fa-user-md me-1");
                        builder.CloseElement();
                    }
                    else
                    {
                        builder.AddAttribute(1, "class", "entry-entered-by self");
                        builder.OpenElement(2, "i");
                        builder.AddAttribute(3, "class", "fas fa-user me-1");
                        builder.CloseElement();
                    }
                    builder.AddContent(4, entry.EnteredByName);
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<JournalEntryDto>
            {
                Property = nameof(JournalEntryDto.Mood),
                Title = "Mood",
                Width = "120px",
                Template = entry => builder =>
                {
                    builder.OpenElement(0, "span");
                    builder.AddAttribute(1, "class", $"badge {GetMoodClass(entry.Mood ?? "Unknown")}");
                    builder.AddContent(2, entry.Mood ?? "Unknown");
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<JournalEntryDto>
            {
                Property = nameof(JournalEntryDto.Text),
                Title = "Entry Preview",
                Width = "300px",
                Template = entry => builder =>
                {
                    builder.OpenElement(0, "div");
                    builder.AddAttribute(1, "class", "entry-preview");
                    var preview = entry.Text.Length > 100 ? entry.Text.Substring(0, 100) + "..." : entry.Text;
                    builder.AddContent(2, preview);
                    builder.CloseElement();
                }
            }
        });
    }

    private void InitializeActions()
    {
        // No actions needed for journal entries currently
        // Can add edit/delete later if needed
    }

    private async Task LoadAssignedPatients()
    {
        try
        {
            assignedPatients = await Http.GetFromJsonAsync<List<User>>("api/doctor/my-patients") ?? new();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load assigned patients: " + ex.Message);
        }
    }

    private async Task<IEnumerable<JournalEntryDto>> LoadJournalEntriesAsync(CancellationToken ct)
    {
        if (!CanLoadEntries)
        {
            return new List<JournalEntryDto>();
        }

        try
        {
            var targetUserId = AuthService.CurrentUser!.RoleId == 2 ? selectedPatientId : AuthService.CurrentUser.Id;
            var entries = await JournalService.GetEntriesForUserAsync(targetUserId, ct);
            
            // Load doctor information for entries that were entered by doctors
            await LoadDoctorInformation(entries);
            
            // Convert to DTOs
            var dtos = entries.Select(entry => new JournalEntryDto
            {
                Id = entry.Id,
                Text = entry.Text,
                AIResponse = entry.AIResponse,
                Mood = entry.Mood,
                CreatedAt = entry.CreatedAt,
                EnteredByUserId = entry.EnteredByUserId,
                EnteredByName = entry.EnteredByUserId.HasValue ? GetDoctorName(entry.EnteredByUserId) : "Self Entry"
            }).OrderByDescending(e => e.CreatedAt).ToList();

            return dtos;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load journal entries: " + ex.Message);
            return new List<JournalEntryDto>();
        }
    }

    private async Task LoadDoctorInformation(IEnumerable<JournalEntry> entries)
    {
        try
        {
            var doctorIds = entries
                .Where(e => e.EnteredByUserId.HasValue)
                .Select(e => e.EnteredByUserId.Value)
                .Distinct()
                .Where(id => !doctorCache.ContainsKey(id))
                .ToList();

            foreach (var doctorId in doctorIds)
            {
                await LoadSpecificDoctor(doctorId);
            }
        }
        catch (Exception)
        {
            // Silently handle errors
        }
    }

    private async Task LoadSpecificDoctor(int doctorId)
    {
        try
        {
            var doctor = await Http.GetFromJsonAsync<User>($"api/user/{doctorId}");
            if (doctor != null)
            {
                doctorCache[doctorId] = doctor;
            }
            else
            {
                doctorCache[doctorId] = new User 
                { 
                    Id = doctorId, 
                    FirstName = "Unknown", 
                    LastName = "Doctor" 
                };
            }
        }
        catch (Exception)
        {
            doctorCache[doctorId] = new User 
            { 
                Id = doctorId, 
                FirstName = "Unknown", 
                LastName = "Doctor" 
            };
        }
    }

    private async Task OnRowExpand(JournalEntryDto entry)
    {
        try
        {
            if (!expandedEntries.ContainsKey(entry.Id))
            {
                // Entry is already loaded with full details, just cache it
                expandedEntries[entry.Id] = entry;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load entry details: {ex.Message}");
        }
    }

    private async Task SaveEntry()
    {
        if (string.IsNullOrWhiteSpace(entryText))
            return;

        if (AuthService.CurrentUser?.RoleId == 2 && selectedPatientId == 0)
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Patient Required", "Please select a patient from the dropdown above before saving the journal entry.");
            return;
        }

        try
        {
            if (AuthService.CurrentUser == null)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "You must be logged in to save journal entries.");
                return;
            }

            var newEntry = new JournalEntry { Text = entryText };
            JournalEntry saved;

            if (AuthService.CurrentUser.RoleId == 2) // Doctor
            {
                saved = await JournalService.CreateEntryForPatientAsync(AuthService.CurrentUser.Id, selectedPatientId, newEntry);
            }
            else
            {
                saved = await JournalService.CreateEntryAsync(AuthService.CurrentUser.Id, newEntry);
            }

            entryText = string.Empty;
            
            if (_grid != null)
            {
                await _grid.RefreshAsync();
            }
            
            NotificationService.Notify(NotificationSeverity.Success, "Success", "Journal entry saved successfully!");
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to save journal entry: " + ex.Message);
        }
    }

    private async Task OnPatientSelected(object value)
    {
        selectedPatientId = value != null ? (int)value : 0;
        if (_grid != null)
        {
            await _grid.RefreshAsync();
        }
    }

    private string GetPatientSelectClass()
    {
        var baseClass = "patient-select-radzen";
        if (selectedPatientId == 0 && !string.IsNullOrWhiteSpace(entryText))
        {
            return $"{baseClass} validation-error";
        }
        return baseClass;
    }

    private string GetDoctorName(int? doctorId)
    {
        if (!doctorId.HasValue) return "Unknown Doctor";
        
        if (doctorCache.ContainsKey(doctorId.Value))
        {
            var doctor = doctorCache[doctorId.Value];
            return $"Dr. {doctor.FirstName} {doctor.LastName}";
        }
        
        return "Entered by Doctor";
    }

    private string GetMoodClass(string mood)
    {
        return mood switch
        {
            "Happy" => "bg-success",
            "Sad" => "bg-danger",
            "Anxious" => "bg-warning",
            "Distressed" => "bg-warning",
            "Crisis" => "bg-danger",
            "Neutral" => "bg-secondary",
            _ => "bg-secondary"
        };
    }
}

<style>
    .journal-form-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .form-header h2 {
        margin-bottom: 0.5rem;
    }

    .form-content {
        margin-top: 1.5rem;
    }

    .required-indicator {
        color: #dc3545;
        margin-left: 4px;
    }

    .patient-select-radzen.validation-error {
        border: 1px solid #dc3545;
    }

    .entry-entered-by {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .entry-entered-by.self {
        color: #6c757d;
    }

    .entry-preview {
        color: #666;
        font-size: 0.9em;
    }

    .meta-row {
        display: flex;
        margin-bottom: 10px;
    }

    .meta-label {
        font-weight: 500;
        color: #666;
        min-width: 120px;
    }

    .meta-value {
        color: #333;
        margin-left: 10px;
    }

    .content-text {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        border-left: 4px solid #007bff;
        white-space: pre-wrap;
        word-wrap: break-word;
        line-height: 1.6;
        font-size: 0.95em;
    }

    .ai-response {
        border-left-color: #28a745;
        margin-top: 15px;
    }

    .empty-state {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 3rem;
    }

    .empty-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }
</style>
