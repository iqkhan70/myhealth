@page "/users"
@inject HttpClient Http
@inject NotificationService NotificationService
@inject IAuthService AuthService
@inject IPatientService PatientService
@inject IJSRuntime JSRuntime
@using SM_MentalHealthApp.Shared
@using SM_MentalHealthApp.Client.Services
@using SM_MentalHealthApp.Client.Components.Grid
@using SM_MentalHealthApp.Client.Components.Common
@using SM_MentalHealthApp.Client.Helpers
@using Radzen
@using Radzen.Blazor
@using System.Net.Http

@code {
    // Track original values for dirty field detection
    private User? _originalUser;
}

<div class="users-page">
    <div class="users-header">
        @if (AuthService.CurrentUser?.RoleId == 2) // Doctor
        {
            <h2>My Patients</h2>
            <p>View and manage your assigned users' mental health journey.</p>
        }
        else if (AuthService.CurrentUser?.RoleId == 3) // Admin
        {
            Console.WriteLine("This is at test page");
            <h2>All Patients</h2>
            <p>Manage all patient records and view their mental health journey.</p>
            <button @onclick="ShowAddPatientForm" class="add-patient-btn">
                ➕ Add New Patient
            </button>
        }
        else
        {
            <h2>Access Denied</h2>
            <p>You don't have permission to view this page.</p>
        }
    </div>

    @if (AuthService.CurrentUser?.RoleId == 2 || AuthService.CurrentUser?.RoleId == 3) // Doctor or Admin
    {
        <!-- Custom Filters -->
        <div class="custom-filters">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Filter by Status:</label>
                    <RadzenDropDown Data="@statusOptions"
                                   ValueProperty="Value"
                                   TextProperty="Text"
                                   @bind-Value="selectedStatusFilter"
                                   Placeholder="All Statuses"
                                   Style="width: 100%" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Filter by Journal Entries:</label>
                    <RadzenDropDown Data="@journalFilterOptions"
                                   ValueProperty="Value"
                                   TextProperty="Text"
                                   @bind-Value="selectedJournalFilter"
                                   Placeholder="All Patients"
                                   Style="width: 100%" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <div>
                        <RadzenButton Text="Clear Filters" 
                                     ButtonStyle="ButtonStyle.Light" 
                                     Click="@ClearFilters"
                                     Style="width: 100%" />
                    </div>
                </div>
            </div>
        </div>

        <!-- Grid Info -->
        <div class="grid-info">
            <small class="text-muted">
                <i class="fas fa-info-circle"></i>
                Use the filter row below each column header for basic filtering, or use the custom filters above for status and journal entries.
            </small>
        </div>

        <!-- Patients Grid -->
        <div class="users-content">
            <SMDataGrid TItem="User" 
                       Columns="_columns" 
                       Actions="_actions" 
                       ActionsWidth="300px"
                       LoadItems="LoadPatientsAsync" 
                       @ref="_grid" 
                       PageSize="15"
                       OnRowExpandCallback="@OnRowExpand">
                <ExpansionTemplate Context="user">
                    @{
                        var expandedUser = expandedUsers.ContainsKey(user.Id) ? expandedUsers[user.Id] : user;
                    }
                    <div class="p-3">
                        <div class="row">
                            <div class="col-12">
                                <h6>Patient Details</h6>
                                <div class="patient-meta mb-3">
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Name:</strong></span>
                                        <span class="meta-value">@expandedUser.FirstName @expandedUser.LastName</span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Email:</strong></span>
                                        <span class="meta-value">@expandedUser.Email</span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Date of Birth:</strong></span>
                                        <span class="meta-value">@expandedUser.DateOfBirth.ToString("MMM dd, yyyy")</span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Gender:</strong></span>
                                        <span class="meta-value">@(expandedUser.Gender ?? "Not specified")</span>
                                    </div>
                                    @if (!string.IsNullOrEmpty(expandedUser.MobilePhone))
                                    {
                                        <div class="meta-row">
                                            <span class="meta-label"><strong>Mobile Phone:</strong></span>
                                            <span class="meta-value">@expandedUser.MobilePhone</span>
                                        </div>
                                    }
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Status:</strong></span>
                                        <span class="meta-value">
                                            <span class="status-badge @(expandedUser.IsActive ? "active" : "inactive")">
                                                @(expandedUser.IsActive ? "Active" : "Inactive")
                                            </span>
                                        </span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Member Since:</strong></span>
                                        <span class="meta-value">@expandedUser.CreatedAt.ToString("MMM dd, yyyy 'at' h:mm tt")</span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Last Login:</strong></span>
                                        <span class="meta-value">@(expandedUser.LastLoginAt?.ToString("MMM dd, yyyy 'at' h:mm tt") ?? "Never")</span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Journal Entries:</strong></span>
                                        <span class="meta-value">@expandedUser.JournalEntries.Count</span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Chat Sessions:</strong></span>
                                        <span class="meta-value">@expandedUser.ChatSessions.Count</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </ExpansionTemplate>
            </SMDataGrid>
        </div>
    }
</div>

<!-- Add/Edit Patient Modal -->
@if (showPatientForm)
{
    <div class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>@(editingUser == null ? "Add New Patient" : "Edit Patient")</h3>
                <button @onclick="ClosePatientForm" class="close-btn">✕</button>
            </div>
            
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>First Name *</label>
                        <input @bind="patientForm.FirstName" class="form-input" />
                    </div>
                    
                    <div class="form-group">
                        <label>Last Name *</label>
                        <input @bind="patientForm.LastName" class="form-input" />
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Email *</label>
                        <input @bind="patientForm.Email" type="email" class="form-input" />
                    </div>
                    
                    <div class="form-group">
                        <label>Password @(editingUser == null ? "*" : "(leave blank to keep current)")</label>
                        <input @bind="patientForm.Password" type="password" class="form-input" />
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Date of Birth *</label>
                        <input @bind="patientForm.DateOfBirth" type="date" class="form-input" />
                    </div>
                    
                    <div class="form-group">
                        <label>Gender</label>
                        <select @bind="patientForm.Gender" class="form-input">
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                            <option value="Prefer not to say">Prefer not to say</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Mobile Phone</label>
                        <input @bind="patientForm.MobilePhone" type="tel" class="form-input" placeholder="+1 (555) 123-4567" />
                    </div>
                    
                    <div class="form-group">
                        <!-- Empty div for layout balance -->
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button @onclick="ClosePatientForm" class="btn btn-secondary">Cancel</button>
                <button @onclick="SavePatient" disabled="@isSaving" class="btn btn-primary">
                    @(isSaving ? "Saving..." : (editingUser == null ? "Add Patient" : "Update Patient"))
                </button>
            </div>
        </div>
    </div>
}

<!-- Patient Details Modal -->
@if (showPatientDetails && selectedUser != null)
{
    <div class="modal-overlay">
        <div class="modal-content patient-details-modal">
            <div class="modal-header">
                <h3>User Details - @selectedUser.FirstName @selectedUser.LastName</h3>
                <button @onclick="ClosePatientDetails" class="close-btn">✕</button>
            </div>
            
            <div class="modal-body">
                <div class="patient-details-grid">
                    <div class="detail-section">
                        <h4>Personal Information</h4>
                        <div class="detail-item">
                            <span class="detail-label">Name:</span>
                            <span class="detail-value">@selectedUser.FirstName @selectedUser.LastName</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Email:</span>
                            <span class="detail-value">@selectedUser.Email</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Date of Birth:</span>
                            <span class="detail-value">@selectedUser.DateOfBirth.ToString("MMM dd, yyyy")</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Gender:</span>
                            <span class="detail-value">@(selectedUser.Gender ?? "Not specified")</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Mobile Phone:</span>
                            <span class="detail-value">@(selectedUser.MobilePhone ?? "Not provided")</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Status:</span>
                            <span class="status-badge @(selectedUser.IsActive ? "active" : "inactive")">
                                @(selectedUser.IsActive ? "Active" : "Inactive")
                            </span>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h4>Account Information</h4>
                        <div class="detail-item">
                            <span class="detail-label">Member Since:</span>
                            <span class="detail-value">@selectedUser.CreatedAt.ToString("MMM dd, yyyy 'at' h:mm tt")</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Last Login:</span>
                            <span class="detail-value">@(selectedUser.LastLoginAt?.ToString("MMM dd, yyyy 'at' h:mm tt") ?? "Never")</span>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h4>Activity Summary</h4>
                        <div class="detail-item">
                            <span class="detail-label">Journal Entries:</span>
                            <span class="detail-value">@selectedUser.JournalEntries.Count</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Chat Sessions:</span>
                            <span class="detail-value">@selectedUser.ChatSessions.Count</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button @onclick="ClosePatientDetails" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>
}

<!-- Patient Stats Modal -->
@if (showPatientStats && selectedUser != null && userStats is not null)
{
    <div class="modal-overlay">
        <div class="modal-content patient-stats-modal">
            <div class="modal-header">
                <h3>User Statistics - @selectedUser.FirstName @selectedUser.LastName</h3>
                <button @onclick="ClosePatientStats" class="close-btn">✕</button>
            </div>
            
            <div class="modal-body">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>Journal Activity</h4>
                        <div class="stat-value">@userStats.TotalJournalEntries</div>
                        <div class="stat-label">Total Entries</div>
                    </div>
                    
                    <div class="stat-card">
                        <h4>Recent Activity</h4>
                        <div class="stat-value">@userStats.EntriesLast30Days</div>
                        <div class="stat-label">Last 30 Days</div>
                    </div>
                    
                    <div class="stat-card">
                        <h4>Mood Distribution</h4>
                        <div class="mood-stats">
                            @foreach (var mood in userStats.MoodDistribution)
                            {
                                <div class="mood-stat">
                                    <span class="mood-label">@mood.Key:</span>
                                    <span class="mood-count">@mood.Value</span>
                                </div>
                            }
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <h4>Chat Activity</h4>
                        <div class="stat-value">@userStats.TotalChatSessions</div>
                        <div class="stat-label">Chat Sessions</div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button @onclick="ClosePatientStats" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>
}

<!-- Doctor Assignment Modal -->
@if (showAssignModal && selectedUser != null)
{
    <div class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Assign Patient to Another Doctor</h3>
                <button @onclick="CloseAssignModal" class="close-btn">✕</button>
            </div>
            
            <div class="modal-body">
                <div class="assignment-info">
                    <p><strong>Patient:</strong> @selectedUser.FirstName @selectedUser.LastName</p>
                    <p><strong>Email:</strong> @selectedUser.Email</p>
                </div>
                
                <div class="form-group">
                    <label>Select Doctor to Assign To:</label>
                    <RadzenDropDown Data="@availableDoctors"
                                   ValueProperty="Id"
                                   TextProperty="FullName"
                                   @bind-Value="selectedDoctorId"
                                   Placeholder="Choose a doctor..."
                                   Style="width: 100%" />
                </div>
            </div>
            
            <div class="modal-footer">
                <button @onclick="CloseAssignModal" class="btn btn-secondary">Cancel</button>
                <button @onclick="AssignPatientToDoctor" disabled="@isAssigning" class="btn btn-primary">
                    @(isAssigning ? "Assigning..." : "Assign Patient")
                </button>
            </div>
        </div>
    </div>
}

<!-- Unassign Confirmation Modal -->
@if (showUnassignConfirmation && selectedUser != null)
{
    <div class="modal-overlay" style="display: block !important; z-index: 9999 !important;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>⚠️ Confirm Unassignment</h3>
                <button @onclick="CloseUnassignConfirmation" class="close-btn">✕</button>
            </div>
            
            <div class="modal-body">
                <div style="background: red; color: white; padding: 10px; margin-bottom: 10px;">
                    DEBUG: Modal is showing! showUnassignConfirmation = @showUnassignConfirmation, selectedUser = @(selectedUser?.FirstName ?? "null")
                </div>
                <div class="confirmation-warning">
                    <div class="warning-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="warning-content">
                        <h4>Are you sure you want to unassign this patient?</h4>
                        <div class="patient-info">
                            <p><strong>Patient:</strong> @selectedUser?.FirstName @selectedUser?.LastName</p>
                            <p><strong>Email:</strong> @selectedUser?.Email</p>
                        </div>
                        <div class="warning-message">
                            <p><strong>Important:</strong> Once unassigned, you will no longer have access to this patient's records. 
                            You will need to contact an administrator to reassign the patient or ask another doctor to assign them to you.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button @onclick="CloseUnassignConfirmation" class="btn btn-secondary">Cancel</button>
                <button @onclick="ConfirmUnassignPatient" disabled="@isUnassigning" class="btn btn-danger">
                    @(isUnassigning ? "Unassigning..." : "Yes, Unassign Patient")
                </button>
            </div>
        </div>
    </div>
}

@code {
    private SMDataGrid<User>? _grid;
    private Dictionary<int, User> expandedUsers = new Dictionary<int, User>();
    private List<SMDataGridColumn<User>> _columns = new();
    private List<SMDataGridActionButton<User>> _actions = new();
    
    private User? selectedUser;
    private UserStats? userStats;
    private bool showPatientForm = false;
    private bool showPatientDetails = false;
    private bool showPatientStats = false;
    private bool showAssignModal = false;
    private bool showUnassignConfirmation = false;
    private bool isSaving = false;
    private bool isAssigning = false;
    private bool isUnassigning = false;
    private bool isPerformingHealthCheck = false;
    private User? editingUser;
    private CreatePatientRequest patientForm = new();
    private List<User> availableDoctors = new();
    private int selectedDoctorId = 0;
    
    // Custom filter variables
    private bool? selectedStatusFilter = null;
    private string? selectedJournalFilter = null;
    
    private readonly List<object> statusOptions = new()
    {
        new { Value = (bool?)null, Text = "All Statuses" },
        new { Value = (bool?)true, Text = "Active" },
        new { Value = (bool?)false, Text = "Inactive" }
    };
    
    private readonly List<object> journalFilterOptions = new()
    {
        new { Value = (string?)null, Text = "All Patients" },
        new { Value = "0", Text = "No Journal Entries" },
        new { Value = "1-5", Text = "1-5 Entries" },
        new { Value = "6-10", Text = "6-10 Entries" },
        new { Value = "10+", Text = "10+ Entries" }
    };

    protected override async Task OnInitializedAsync()
    {
        InitializeColumns();
        InitializeActions();
    }

    private void InitializeColumns()
    {
        _columns = new List<SMDataGridColumn<User>>
        {
            new SMDataGridTemplateColumn<User>
            {
                Property = nameof(User.FirstName),
                Title = "Name",
                Width = "200px",
                Template = user => builder =>
                {
                    builder.OpenElement(0, "div");
                    builder.OpenElement(1, "strong");
                    builder.AddContent(2, $"{user.FirstName} {user.LastName}");
                    builder.CloseElement();
                    builder.OpenElement(3, "br");
                    builder.CloseElement();
                    builder.OpenElement(4, "small");
                    builder.AddAttribute(5, "class", "text-muted");
                    builder.AddContent(6, user.Email);
                    builder.CloseElement();
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<User>
            {
                Property = nameof(User.DateOfBirth),
                Title = "Date of Birth",
                Width = "120px",
                Template = user => builder =>
                {
                    builder.AddContent(0, user.DateOfBirth.ToString("MMM dd, yyyy"));
                }
            },
            new SMDataGridTemplateColumn<User>
            {
                Property = nameof(User.Gender),
                Title = "Gender",
                Width = "100px",
                Template = user => builder =>
                {
                    if (!string.IsNullOrEmpty(user.Gender))
                    {
                        builder.OpenElement(0, "span");
                        builder.AddAttribute(1, "class", "badge badge-info");
                        builder.AddContent(2, user.Gender);
                        builder.CloseElement();
                    }
                    else
                    {
                        builder.OpenElement(3, "span");
                        builder.AddAttribute(4, "class", "text-muted");
                        builder.AddContent(5, "Not specified");
                        builder.CloseElement();
                    }
                }
            },
            new SMDataGridTemplateColumn<User>
            {
                Property = nameof(User.IsActive),
                Title = "Status",
                Width = "100px",
                Template = user => builder =>
                {
                    builder.OpenElement(0, "span");
                    builder.AddAttribute(1, "class", $"status-badge {(user.IsActive ? "active" : "inactive")}");
                    builder.AddContent(2, user.IsActive ? "Active" : "Inactive");
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<User>
            {
                Property = nameof(User.JournalEntries),
                Title = "Journal Entries",
                Width = "120px",
                Sortable = false,
                Template = user => builder =>
                {
                    builder.OpenElement(0, "span");
                    builder.AddAttribute(1, "class", "badge badge-primary");
                    builder.AddContent(2, user.JournalEntries?.Count ?? 0);
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<User>
            {
                Property = nameof(User.LastLoginAt),
                Title = "Last Login",
                Width = "120px",
                Template = user => builder =>
                {
                    builder.AddContent(0, user.LastLoginAt?.ToString("MMM dd, yyyy") ?? "Never");
                }
            },
            new SMDataGridTemplateColumn<User>
            {
                Property = nameof(User.CreatedAt),
                Title = "Member Since",
                Width = "120px",
                Template = user => builder =>
                {
                    builder.AddContent(0, user.CreatedAt.ToString("MMM dd, yyyy"));
                }
            }
        };
    }

    private void InitializeActions()
    {
        _actions.Add(new SMDataGridActionButton<User>
        {
            Icon = "visibility",
            ButtonStyle = ButtonStyle.Info,
            Variant = Variant.Flat,
            Size = ButtonSize.Small,
            OnClick = async (row, ct) => await ViewUserDetailsAsync(row, ct)
        });

        _actions.Add(new SMDataGridActionButton<User>
        {
            Icon = "edit",
            ButtonStyle = ButtonStyle.Success,
            Variant = Variant.Flat,
            Size = ButtonSize.Small,
            OnClick = async (row, ct) => await EditUserAsync(row, ct)
        });

        _actions.Add(new SMDataGridActionButton<User>
        {
            Icon = "analytics",
            ButtonStyle = ButtonStyle.Primary,
            Variant = Variant.Flat,
            Size = ButtonSize.Small,
            OnClick = async (row, ct) => await ViewUserStatsAsync(row, ct)
        });

        _actions.Add(new SMDataGridActionButton<User>
        {
            Icon = "psychology",
            ButtonStyle = ButtonStyle.Warning,
            Variant = Variant.Flat,
            Size = ButtonSize.Small,
            OnClick = async (row, ct) => await PerformAiHealthCheckAsync(row, ct),
            Disabled = (user) => isPerformingHealthCheck
        });

        // Doctor-specific actions
        if (AuthService.CurrentUser?.RoleId == 2)
        {
            _actions.Add(new SMDataGridActionButton<User>
            {
                Icon = "person_add",
                ButtonStyle = ButtonStyle.Warning,
                Variant = Variant.Flat,
                Size = ButtonSize.Small,
                OnClick = async (row, ct) => await ShowAssignPatientModalAsync(row, ct)
            });
        }

        // Admin-specific actions
        if (AuthService.CurrentUser?.RoleId == 3)
        {
            _actions.Add(new SMDataGridActionButton<User>
            {
                Icon = "block",
                ButtonStyle = ButtonStyle.Danger,
                Variant = Variant.Flat,
                Size = ButtonSize.Small,
                OnClick = async (row, ct) => await DeactivateUserAsync(row, ct),
                Disabled = (user) => !user.IsActive
            });

            _actions.Add(new SMDataGridActionButton<User>
            {
                Icon = "check",
                ButtonStyle = ButtonStyle.Success,
                Variant = Variant.Flat,
                Size = ButtonSize.Small,
                OnClick = async (row, ct) => await ReactivateUserAsync(row, ct),
                Disabled = (user) => user.IsActive
            });
        }
    }

    private async Task<IEnumerable<User>> LoadPatientsAsync(CancellationToken ct)
    {
        try
        {
            var users = await PatientService.ListAsync(ct);
            
            // Load journal entry counts for each patient
            foreach (var user in users.Where(u => u.RoleId == 1))
            {
                try
                {
                    var entries = await PatientService.GetJournalEntriesAsync(user.Id, ct);
                    user.JournalEntries = entries;
                }
                catch
                {
                    user.JournalEntries = new();
                }
            }

            // Apply custom filters
            var filtered = users.Where(u => u != null && u.RoleId == 1).AsEnumerable();

            if (selectedStatusFilter.HasValue)
            {
                filtered = filtered.Where(u => u.IsActive == selectedStatusFilter.Value);
            }

            if (!string.IsNullOrEmpty(selectedJournalFilter))
            {
                filtered = selectedJournalFilter switch
                {
                    "0" => filtered.Where(u => (u.JournalEntries?.Count ?? 0) == 0),
                    "1-5" => filtered.Where(u => (u.JournalEntries?.Count ?? 0) >= 1 && (u.JournalEntries?.Count ?? 0) <= 5),
                    "6-10" => filtered.Where(u => (u.JournalEntries?.Count ?? 0) >= 6 && (u.JournalEntries?.Count ?? 0) <= 10),
                    "10+" => filtered.Where(u => (u.JournalEntries?.Count ?? 0) > 10),
                    _ => filtered
                };
            }

            return filtered.ToList();
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to load patients: {ex.Message}");
            return new List<User>();
        }
    }

    private async Task OnRowExpand(User user)
    {
        try
        {
            if (!expandedUsers.ContainsKey(user.Id))
            {
                var fullUser = await PatientService.GetAsync(user.Id);
                if (fullUser != null)
                {
                    // Load journal entries and chat sessions
                    fullUser.JournalEntries = await PatientService.GetJournalEntriesAsync(user.Id);
                    expandedUsers[user.Id] = fullUser;
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to load patient details: {ex.Message}");
        }
    }

    private async Task ClearFilters()
    {
        selectedStatusFilter = null;
        selectedJournalFilter = null;
        if (_grid != null)
        {
            await _grid.RefreshAsync();
        }
    }



    private void ShowAddPatientForm()
    {
        editingUser = null;
        patientForm = new CreatePatientRequest { DateOfBirth = DateTime.Now.AddYears(-25) };
        showPatientForm = true;
        StateHasChanged();
    }

    private async Task EditUserAsync(User user, CancellationToken ct)
    {
        if (user == null) return;
        
        editingUser = user;
        _originalUser = user; // Store original for dirty field detection
        patientForm = new CreatePatientRequest
        {
            FirstName = user.FirstName ?? string.Empty,
            LastName = user.LastName ?? string.Empty,
            Email = user.Email ?? string.Empty,
            DateOfBirth = user.DateOfBirth,
            Gender = user.Gender ?? string.Empty,
            MobilePhone = user.MobilePhone ?? string.Empty
        };
        showPatientForm = true;
        StateHasChanged();
    }

    private void ClosePatientForm()
    {
        showPatientForm = false;
        editingUser = null;
        patientForm = new CreatePatientRequest();
    }

    private async Task SavePatient()
    {
        if (string.IsNullOrWhiteSpace(patientForm.FirstName) || 
            string.IsNullOrWhiteSpace(patientForm.LastName) || 
            string.IsNullOrWhiteSpace(patientForm.Email))
        {
            NotificationService.ShowWarning("Please fill in all required fields.");
            return;
        }

        if (editingUser == null && string.IsNullOrWhiteSpace(patientForm.Password))
        {
            NotificationService.ShowWarning("Password is required for new patients.");
            return;
        }

        try
        {
            isSaving = true;
            
            if (editingUser == null)
            {
                await PatientService.CreateAsync(patientForm);
                NotificationService.ShowSuccess("Patient added successfully!");
                if (_grid != null)
                {
                    await _grid.RefreshAsync();
                }
            }
            else
            {
                var updateRequest = new UpdatePatientRequest();
                
                if (_originalUser != null)
                {
                    if (!string.IsNullOrWhiteSpace(patientForm.FirstName) && patientForm.FirstName != (_originalUser.FirstName ?? string.Empty))
                    {
                        updateRequest.FirstName = patientForm.FirstName;
                    }
                    
                    if (!string.IsNullOrWhiteSpace(patientForm.LastName) && patientForm.LastName != (_originalUser.LastName ?? string.Empty))
                    {
                        updateRequest.LastName = patientForm.LastName;
                    }
                    
                    if (!string.IsNullOrWhiteSpace(patientForm.Email) && patientForm.Email != (_originalUser.Email ?? string.Empty))
                    {
                        updateRequest.Email = patientForm.Email;
                    }
                    
                    if (patientForm.DateOfBirth != _originalUser.DateOfBirth)
                    {
                        updateRequest.DateOfBirth = patientForm.DateOfBirth;
                    }
                    
                    if (!string.IsNullOrWhiteSpace(patientForm.Gender) && patientForm.Gender != (_originalUser.Gender ?? string.Empty))
                    {
                        updateRequest.Gender = patientForm.Gender;
                    }
                    
                    if (patientForm.MobilePhone != (_originalUser.MobilePhone ?? string.Empty))
                    {
                        updateRequest.MobilePhone = patientForm.MobilePhone;
                    }
                    
                    if (!string.IsNullOrWhiteSpace(patientForm.Password))
                    {
                        updateRequest.Password = patientForm.Password;
                    }
                }

                await PatientService.UpdateAsync(editingUser.Id, updateRequest);
                NotificationService.ShowSuccess("Patient updated successfully!");
                if (_grid != null)
                {
                    await _grid.RefreshAsync();
                }
            }
            
            ClosePatientForm();
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to save patient: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task ViewUserDetailsAsync(User user, CancellationToken ct)
    {
        if (user == null) return;
        
        selectedUser = user;
        showPatientDetails = true;
        StateHasChanged();
    }

    private void ClosePatientDetails()
    {
        showPatientDetails = false;
        selectedUser = null;
    }

    private async Task ViewUserStatsAsync(User user, CancellationToken ct)
    {
        if (user == null) return;
        
        try
        {
            selectedUser = user;
            userStats = await PatientService.GetStatsAsync(user.Id, ct);
            showPatientStats = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to load patient stats: {ex.Message}");
        }
    }

    private void ClosePatientStats()
    {
        showPatientStats = false;
        selectedUser = null;
        userStats = null;
    }

    private async Task PerformAiHealthCheckAsync(User user, CancellationToken ct)
    {
        if (user == null) return;
        
        try
        {
            isPerformingHealthCheck = true;
            StateHasChanged();
            
            NotificationService.ShowInfo($"Analyzing {user.FirstName} {user.LastName}'s health status...");
            
            var result = await PatientService.PerformAiHealthCheckAsync(user.Id, ct);
            
            if (result != null)
            {
                if (result.Severity == "High")
                {
                    NotificationService.ShowWarning($"⚠️ {result.Message} ({result.AlertsSent} doctors notified)");
                }
                else
                {
                    NotificationService.ShowSuccess($"✅ {result.Message}");
                }
                
                Console.WriteLine($"AI Response for {user.FirstName}: {result.AiResponse}");
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"AI Health Check failed: {ex.Message}");
        }
        finally
        {
            isPerformingHealthCheck = false;
            StateHasChanged();
        }
    }

    private async Task DeactivateUserAsync(User user, CancellationToken ct)
    {
        if (user == null) return;
        
        try
        {
            await PatientService.DeleteAsync(user.Id, ct);
            NotificationService.ShowSuccess("Patient deactivated successfully!");
            if (_grid != null)
            {
                await _grid.RefreshAsync();
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to deactivate patient: {ex.Message}");
        }
    }

    private async Task ReactivateUserAsync(User user, CancellationToken ct)
    {
        if (user == null) return;
        
        try
        {
            user.IsActive = true;
            var updatedUser = await PatientService.UpdateAsync(user.Id, new UpdatePatientRequest
            {
                FirstName = user.FirstName,
                LastName = user.LastName,
                Email = user.Email,
                DateOfBirth = user.DateOfBirth,
                Gender = user.Gender,
                MobilePhone = user.MobilePhone
            }, ct);
            
            NotificationService.ShowSuccess("Patient reactivated successfully!");
            if (_grid != null)
            {
                await _grid.RefreshAsync();
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to reactivate patient: {ex.Message}");
        }
    }

    private async Task ShowAssignPatientModalAsync(User user, CancellationToken ct)
    {
        if (user == null) return;
        
        try
        {
            selectedUser = user;
            selectedDoctorId = 0;
            
            availableDoctors = await PatientService.GetDoctorsAsync(ct);
            
            if (AuthService.CurrentUser?.Id != null)
            {
                availableDoctors = availableDoctors.Where(d => d.Id != AuthService.CurrentUser.Id).ToList();
            }
            
            showAssignModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to load doctors: {ex.Message}");
        }
    }

    private void CloseAssignModal()
    {
        showAssignModal = false;
        selectedUser = null;
        selectedDoctorId = 0;
        availableDoctors.Clear();
    }

    private async Task AssignPatientToDoctor()
    {
        if (selectedUser == null || selectedDoctorId == 0)
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Validation", "Please select a doctor to assign the patient to.");
            return;
        }

        try
        {
            isAssigning = true;
            
            var request = new DoctorAssignPatientRequest
            {
                PatientId = selectedUser.Id,
                ToDoctorId = selectedDoctorId
            };

            await PatientService.AssignToDoctorAsync(request);
            var response = new HttpResponseMessage(System.Net.HttpStatusCode.OK);

            if (response.IsSuccessStatusCode)
            {
                NotificationService.ShowSuccess("Patient assigned to doctor successfully!");
                CloseAssignModal();
                if (_grid != null)
                {
                    await _grid.RefreshAsync();
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                NotificationService.ShowError($"Failed to assign patient: {errorContent}");
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Error assigning patient: {ex.Message}");
        }
        finally
        {
            isAssigning = false;
        }
    }

    private void ShowUnassignConfirmation(User user)
    {
        if (user == null) return;
        
        Console.WriteLine($"ShowUnassignConfirmation called for user: {user.FirstName} {user.LastName}");
        selectedUser = user;
        showUnassignConfirmation = true;
        Console.WriteLine($"showUnassignConfirmation set to: {showUnassignConfirmation}");
        
        // Add a simple test to see if this method is being called
        NotificationService.ShowInfo($"ShowUnassignConfirmation called for {user.FirstName}");
        
        StateHasChanged();
    }

    private void CloseUnassignConfirmation()
    {
        showUnassignConfirmation = false;
        selectedUser = null;
    }

    private async Task ConfirmUnassignPatient()
    {
        if (selectedUser == null)
        {
            return;
        }

        try
        {
            isUnassigning = true;
            
            var request = new DoctorUnassignPatientRequest
            {
                PatientId = selectedUser.Id
            };

            await PatientService.UnassignFromDoctorAsync(request);
            var response = new HttpResponseMessage(System.Net.HttpStatusCode.OK);

            if (response.IsSuccessStatusCode)
            {
                NotificationService.ShowSuccess("Patient unassigned from you successfully!");
                CloseUnassignConfirmation();
                if (_grid != null)
                {
                    await _grid.RefreshAsync();
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                NotificationService.ShowError($"Failed to unassign patient: {errorContent}");
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Error unassigning patient: {ex.Message}");
        }
        finally
        {
            isUnassigning = false;
        }
    }
}

<style>
    .action-buttons {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
    }

    .action-buttons .rz-button {
        margin: 2px;
    }

    .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
    }

    .status-badge.active {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .status-badge.inactive {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .badge.badge-info {
        background-color: #d1ecf1;
        color: #0c5460;
    }

    .badge.badge-primary {
        background-color: #cce5ff;
        color: #004085;
    }

    .text-muted {
        color: #6c757d;
        font-size: 12px;
    }

    .grid-info {
        margin-bottom: 15px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border-left: 4px solid #007bff;
    }

    .grid-info i {
        margin-right: 5px;
        color: #007bff;
    }

    .custom-filters {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 15px;
        border: 1px solid #dee2e6;
    }

    .custom-filters .form-label {
        font-weight: 500;
        color: #333;
        margin-bottom: 5px;
    }

    .custom-filters .row {
        margin: 0;
    }

    .custom-filters .col-md-3 {
        padding: 0 10px;
    }

    .assignment-info {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        border-left: 4px solid #007bff;
    }

    .assignment-info p {
        margin: 5px 0;
        color: #333;
    }

    .assignment-info strong {
        color: #007bff;
    }

    .confirmation-warning {
        display: flex;
        align-items: flex-start;
        gap: 15px;
        padding: 20px;
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .warning-icon {
        font-size: 24px;
        color: #f39c12;
        margin-top: 5px;
    }

    .warning-content h4 {
        color: #856404;
        margin-bottom: 15px;
        font-size: 18px;
    }

    .patient-info {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 15px;
        border-left: 4px solid #007bff;
    }

    .patient-info p {
        margin: 5px 0;
        color: #333;
    }

    .patient-info strong {
        color: #007bff;
    }

    .warning-message {
        background-color: #f8d7da;
        padding: 15px;
        border-radius: 5px;
        border-left: 4px solid #dc3545;
    }

    .warning-message p {
        margin: 0;
        color: #721c24;
        font-size: 14px;
        line-height: 1.5;
    }

    .warning-message strong {
        color: #dc3545;
    }

    .btn-danger {
        background-color: #dc3545;
        border-color: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background-color: #c82333;
        border-color: #bd2130;
    }

    /* Form styling */
    .form-row {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
    }

    .form-group {
        flex: 1;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #333;
    }

    .form-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }

    .form-input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    .patient-meta {
        margin-bottom: 20px;
    }

    .meta-row {
        display: flex;
        margin-bottom: 10px;
    }

    .meta-label {
        font-weight: 500;
        color: #666;
        min-width: 120px;
    }

    .meta-value {
        color: #333;
        margin-left: 10px;
    }
</style>
