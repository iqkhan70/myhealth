@page "/users"
@inject HttpClient Http
@inject NotificationService NotificationService
@inject IAuthService AuthService
@inject IPatientService PatientService
@inject ODataService ODataService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@using Microsoft.AspNetCore.Components
@using SM_MentalHealthApp.Shared
@using SM_MentalHealthApp.Client.Services
@using SM_MentalHealthApp.Client.Components.Grid
@using SM_MentalHealthApp.Client.Components.Common
@using SM_MentalHealthApp.Client.Helpers
@using Radzen
@using Radzen.Blazor
@using System.Net.Http
@using System.Net.Http.Json

@code {
    // Track original values for dirty field detection
    private User? _originalUser;
}

<div class="users-page">
    <div class="users-header">
        @if (AuthService.CurrentUser?.RoleId == 2) // Doctor
        {
            <h2>My Clients</h2>
            <p>View and manage your assigned users' case journey.</p>
        }
        else if (AuthService.CurrentUser?.RoleId == 3) // Admin
        {
            <h2>All Clients</h2>
            <p>Manage all client records and view their case journey.</p>
            <button @onclick="ShowAddPatientForm" class="add-patient-btn">
                ➕ Add New Client
            </button>
        }
        else if (AuthService.CurrentUser?.RoleId == 4) // Coordinator
        {
            <h2>My Clients</h2>
            <p>View and assign clients to doctors.</p>
        }
        else if (AuthService.CurrentUser?.RoleId == 5) // Attorney
        {
            <h2>My Clients</h2>
            <p>View your assigned clients.</p>
        }
        else
        {
            <h2>Access Denied</h2>
            <p>You don't have permission to view this page.</p>
        }
    </div>

    @if (AuthService.CurrentUser?.RoleId == 2 || AuthService.CurrentUser?.RoleId == 3 || AuthService.CurrentUser?.RoleId == 4 || AuthService.CurrentUser?.RoleId == 5) // Doctor, Admin, Coordinator, or Attorney
    {
        <!-- Custom Filters -->
        <div class="custom-filters">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Filter by Status:</label>
                    <RadzenDropDown Data="@statusOptions"
                                   ValueProperty="Value"
                                   TextProperty="Text"
                                   @bind-Value="selectedStatusFilter"
                                   Placeholder="All Statuses"
                                   Style="width: 100%" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Filter by Journal Entries:</label>
                    <RadzenDropDown Data="@journalFilterOptions"
                                   ValueProperty="Value"
                                   TextProperty="Text"
                                   @bind-Value="selectedJournalFilter"
                                   Placeholder="All Clients"
                                   Style="width: 100%" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <div>
                        <RadzenButton Text="Clear Filters" 
                                     ButtonStyle="ButtonStyle.Light" 
                                     Click="@ClearFilters"
                                     Style="width: 100%" />
                    </div>
                </div>
            </div>
        </div>

        <!-- Grid Info -->
        <div class="grid-info">
            <small class="text-muted">
                <i class="fas fa-info-circle"></i>
                Use the filter row below each column header for basic filtering, or use the custom filters above for status and journal entries.
            </small>
        </div>

        <!-- Patients Grid -->
        <div class="users-content">
            <SMDataGrid TItem="User" 
                       Columns="_columns" 
                       Actions="_actions" 
                       ActionsWidth="300px"
                       LoadItemsPaged="LoadPatientsPagedAsync" 
                       @ref="_grid" 
                       PageSize="15"
                       OnRowExpandCallback="@OnRowExpand">
                <ExpansionTemplate Context="user">
                    @{
                        var expandedUser = expandedUsers.ContainsKey(user.Id) ? expandedUsers[user.Id] : user;
                    }
                    <div class="p-3">
                        <div class="row">
                            <div class="col-12">
                                @* Client Details Section - Expandable *@
                                <div class="client-details-section-header" style="cursor: pointer; display: flex; align-items: center; gap: 8px; padding: 8px 0;" @onclick="@(() => ToggleClientDetailsSection(expandedUser.Id))">
                                    <span style="font-size: 18px; transition: transform 0.2s; transform: @(expandedClientDetailsSections.Contains(expandedUser.Id) ? "rotate(90deg)" : "rotate(0deg)")">▶</span>
                                    <h6 class="mt-0 mb-0" style="margin: 0;">Client Details</h6>
                                </div>
                                @if (expandedClientDetailsSections.Contains(expandedUser.Id))
                                {
                                    <div class="patient-meta mb-3" style="margin-top: 12px;">
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Name:</strong></span>
                                        <span class="meta-value">@expandedUser.FirstName @expandedUser.LastName</span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Email:</strong></span>
                                        <span class="meta-value">@expandedUser.Email</span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Date of Birth:</strong></span>
                                        <span class="meta-value">@expandedUser.DateOfBirth.ToString("MMM dd, yyyy")</span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Gender:</strong></span>
                                        <span class="meta-value">@(expandedUser.Gender ?? "Not specified")</span>
                                    </div>
                                    @if (!string.IsNullOrEmpty(expandedUser.MobilePhone))
                                    {
                                        <div class="meta-row">
                                            <span class="meta-label"><strong>Mobile Phone:</strong></span>
                                            <span class="meta-value">@expandedUser.MobilePhone</span>
                                        </div>
                                    }
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Status:</strong></span>
                                        <span class="meta-value">
                                            <span class="status-badge @(expandedUser.IsActive ? "active" : "inactive")">
                                                @(expandedUser.IsActive ? "Active" : "Inactive")
                                            </span>
                                        </span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Member Since:</strong></span>
                                        <span class="meta-value">@expandedUser.CreatedAt.ToString("MMM dd, yyyy")</span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Last Login:</strong></span>
                                        <span class="meta-value">@(expandedUser.LastLoginAt?.ToString("MMM dd, yyyy") ?? "Never")</span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Journal Entries:</strong></span>
                                        <span class="meta-value">@expandedUser.JournalEntries.Count</span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Chat Sessions:</strong></span>
                                        <span class="meta-value">@expandedUser.ChatSessions.Count</span>
                                    </div>
                                    </div>
                                }
                                
                                @* Lead Intake Section - Expandable *@
                                <hr class="my-3" />
                                <div class="lead-intake-section-header" style="cursor: pointer; display: flex; align-items: center; gap: 8px; padding: 8px 0;" @onclick="@(() => ToggleLeadIntakeSection(expandedUser.Id))">
                                    <span style="font-size: 18px; transition: transform 0.2s; transform: @(expandedLeadIntakeSections.Contains(expandedUser.Id) ? "rotate(90deg)" : "rotate(0deg)")">▶</span>
                                    <h6 class="mt-0 mb-0" style="margin: 0;">Lead Intake</h6>
                                </div>
                                @if (expandedLeadIntakeSections.Contains(expandedUser.Id))
                                {
                                    <div class="patient-meta mb-3" style="margin-top: 12px;">
                                        @if (!string.IsNullOrEmpty(expandedUser.ResidenceStateCode))
                                        {
                                            <div class="meta-row">
                                                <span class="meta-label"><strong>Residence State:</strong></span>
                                                <span class="meta-value">@(GetStateName(expandedUser.ResidenceStateCode))</span>
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(expandedUser.AccidentStateCode))
                                        {
                                            <div class="meta-row">
                                                <span class="meta-label"><strong>Accident State:</strong></span>
                                                <span class="meta-value">@(GetStateName(expandedUser.AccidentStateCode))</span>
                                            </div>
                                        }
                                        @if (expandedUser.AccidentParticipantRoleId.HasValue)
                                        {
                                            <div class="meta-row">
                                                <span class="meta-label"><strong>Participant Role:</strong></span>
                                                <span class="meta-value">@(GetAccidentParticipantRoleLabel(expandedUser.AccidentParticipantRoleId.Value))</span>
                                            </div>
                                        }
                                        @if (expandedUser.VehicleDispositionId.HasValue)
                                        {
                                            <div class="meta-row">
                                                <span class="meta-label"><strong>Vehicle Disposition:</strong></span>
                                                <span class="meta-value">@(GetVehicleDispositionLabel(expandedUser.VehicleDispositionId.Value))</span>
                                            </div>
                                        }
                                        @if (expandedUser.TransportToCareMethodId.HasValue)
                                        {
                                            <div class="meta-row">
                                                <span class="meta-label"><strong>Transport to Care:</strong></span>
                                                <span class="meta-value">@(GetTransportToCareMethodLabel(expandedUser.TransportToCareMethodId.Value))</span>
                                            </div>
                                        }
                                        @if (expandedUser.MedicalAttentionTypeId.HasValue)
                                        {
                                            <div class="meta-row">
                                                <span class="meta-label"><strong>Medical Attention Type:</strong></span>
                                                <span class="meta-value">@(GetMedicalAttentionTypeLabel(expandedUser.MedicalAttentionTypeId.Value))</span>
                                            </div>
                                        }
                                        @if (expandedUser.PoliceInvolvement.HasValue)
                                        {
                                            <div class="meta-row">
                                                <span class="meta-label"><strong>Police Involvement:</strong></span>
                                                <span class="meta-value">@(expandedUser.PoliceInvolvement.Value ? "Yes" : "No")</span>
                                            </div>
                                        }
                                        @if (expandedUser.LostConsciousness.HasValue)
                                        {
                                            <div class="meta-row">
                                                <span class="meta-label"><strong>Lost Consciousness:</strong></span>
                                                <span class="meta-value">@(expandedUser.LostConsciousness.Value ? "Yes" : "No")</span>
                                            </div>
                                        }
                                        @if (expandedUser.NeuroSymptoms.HasValue)
                                        {
                                            <div class="meta-row">
                                                <span class="meta-label"><strong>Neurological Symptoms:</strong></span>
                                                <span class="meta-value">@(expandedUser.NeuroSymptoms.Value ? "Yes" : "No")</span>
                                            </div>
                                        }
                                        @if (expandedUser.MusculoskeletalSymptoms.HasValue)
                                        {
                                            <div class="meta-row">
                                                <span class="meta-label"><strong>Musculoskeletal Symptoms:</strong></span>
                                                <span class="meta-value">@(expandedUser.MusculoskeletalSymptoms.Value ? "Yes" : "No")</span>
                                            </div>
                                        }
                                        @if (expandedUser.PsychologicalSymptoms.HasValue)
                                        {
                                            <div class="meta-row">
                                                <span class="meta-label"><strong>Psychological Symptoms:</strong></span>
                                                <span class="meta-value">@(expandedUser.PsychologicalSymptoms.Value ? "Yes" : "No")</span>
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(expandedUser.SymptomsNotes))
                                        {
                                            <div class="meta-row">
                                                <span class="meta-label"><strong>Symptoms Notes:</strong></span>
                                                <span class="meta-value" style="white-space: pre-wrap;">@expandedUser.SymptomsNotes</span>
                                            </div>
                                        }
                                        @if (expandedUser.InsuranceContacted.HasValue)
                                        {
                                            <div class="meta-row">
                                                <span class="meta-label"><strong>Insurance Contacted:</strong></span>
                                                <span class="meta-value">@(expandedUser.InsuranceContacted.Value ? "Yes" : "No")</span>
                                            </div>
                                        }
                                        @if (expandedUser.RepresentedByAttorney.HasValue)
                                        {
                                            <div class="meta-row">
                                                <span class="meta-label"><strong>Represented by Attorney:</strong></span>
                                                <span class="meta-value">@(expandedUser.RepresentedByAttorney.Value ? "Yes" : "No")</span>
                                            </div>
                                        }
                                    </div>
                                    
                                    @* Edit Lead Intake Button (Admin only) *@
                                    @if (AuthService.CurrentUser?.RoleId == 3) // Admin only
                                    {
                                        <div class="col-12 mt-3">
                                            <RadzenButton Text="Edit Lead Intake" 
                                                         ButtonStyle="ButtonStyle.Primary" 
                                                         Size="ButtonSize.Small"
                                                         Click="@(() => ShowEditPatientLeadIntakeDialog(expandedUser))" />
                                        </div>
                                    }
                                }
                                
                                @* Accident Section - Expandable *@
                                <hr class="my-3" />
                                <div class="accident-section-header" style="cursor: pointer; display: flex; align-items: center; gap: 8px; padding: 8px 0;" @onclick="@(() => ToggleAccidentSection(expandedUser.Id))">
                                    <span style="font-size: 18px; transition: transform 0.2s; transform: @(expandedAccidentSections.Contains(expandedUser.Id) ? "rotate(90deg)" : "rotate(0deg)")">▶</span>
                                    <h6 class="mt-0 mb-0" style="margin: 0;">Accident section</h6>
                                </div>
                                @if (expandedAccidentSections.Contains(expandedUser.Id))
                                {
                                        <div class="patient-meta mb-3" style="margin-top: 12px;">
                                        
                                        @* 1. ACCIDENT BASICS (High Priority) *@
                                        <h6 style="font-weight: bold; margin-bottom: 10px; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 5px;">Accident Basics</h6>
                                        @if (expandedUser.AccidentDate.HasValue)
                                        {
                                            <div class="meta-row">
                                                <span class="meta-label"><strong>Accident Date:</strong></span>
                                                <span class="meta-value">@expandedUser.AccidentDate.Value.ToString("MMM dd, yyyy")</span>
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(expandedUser.AccidentDetails))
                                        {
                                            <div class="meta-row">
                                                <span class="meta-label"><strong>Accident Details:</strong></span>
                                                <span class="meta-value" style="white-space: pre-wrap;">@expandedUser.AccidentDetails</span>
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(expandedUser.AccidentAddress))
                                        {
                                            <div class="meta-row">
                                                <span class="meta-label"><strong>Accident Address:</strong></span>
                                                <span class="meta-value">@expandedUser.AccidentAddress</span>
                                            </div>
                                        }
                                        @if (expandedUser.DateReported.HasValue)
                                        {
                                            <div class="meta-row">
                                                <span class="meta-label"><strong>Date Reported:</strong></span>
                                                <span class="meta-value">@expandedUser.DateReported.Value.ToString("MMM dd, yyyy")</span>
                                            </div>
                                        }
                                        @if (expandedUser.Age.HasValue)
                                        {
                                            <div class="meta-row">
                                                <span class="meta-label"><strong>Age:</strong></span>
                                                <span class="meta-value">@expandedUser.Age</span>
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(expandedUser.Race))
                                        {
                                            <div class="meta-row">
                                                <span class="meta-label"><strong>Race:</strong></span>
                                                <span class="meta-value">@expandedUser.Race</span>
                                            </div>
                                        }
                                        
                                        @* 2. POLICE/LEGAL (High Priority) *@
                                        @if (expandedUser.PoliceInvolvement == true || !string.IsNullOrEmpty(expandedUser.PoliceCaseNumber))
                                        {
                                            <div class="meta-row" style="border-top: 2px solid #ddd; padding-top: 12px; margin-top: 12px;">
                                                <span class="meta-label"><strong>Police Involvement:</strong></span>
                                                <span class="meta-value">
                                                    @if (expandedUser.PoliceInvolvement == true) { <div>Yes</div> }
                                                    @if (!string.IsNullOrEmpty(expandedUser.PoliceCaseNumber))
                                                    {
                                                        <div>Case Number: @expandedUser.PoliceCaseNumber</div>
                                                    }
                                                </span>
                                            </div>
                                        }
                                        
                                        @* 3. INJURY ASSESSMENT (Medical Priority) *@
                                        @if (expandedUser.SymptomOngoingStatusId.HasValue || expandedUser.SymptomsHeadaches == true || expandedUser.SymptomsDizziness == true ||
                                             expandedUser.SymptomsNeckPain == true || expandedUser.SymptomsBackPain == true || expandedUser.SymptomsJointPain == true ||
                                             expandedUser.SymptomsNumbnessTingling == true || expandedUser.LostConsciousness == true ||
                                             expandedUser.NeuroSymptoms == true || expandedUser.MusculoskeletalSymptoms == true ||
                                             expandedUser.PsychologicalSymptoms == true || !string.IsNullOrEmpty(expandedUser.SymptomsNotes))
                                        {
                                            <div class="meta-row" style="border-top: 2px solid #ddd; padding-top: 12px; margin-top: 12px;">
                                                <span class="meta-label"><strong>Injury Assessment:</strong></span>
                                                <span class="meta-value">
                                                    @if (expandedUser.SymptomOngoingStatusId.HasValue)
                                                    {
                                                        <div><strong>Status:</strong> @GetSymptomOngoingStatusLabel(expandedUser.SymptomOngoingStatusId.Value)</div>
                                                    }
                                                    @if (expandedUser.LostConsciousness == true)
                                                    {
                                                        <div><strong>Lost Consciousness:</strong> Yes</div>
                                                    }
                                                    @if (expandedUser.NeuroSymptoms == true || expandedUser.MusculoskeletalSymptoms == true || expandedUser.PsychologicalSymptoms == true)
                                                    {
                                                        <div style="margin-top: 8px;"><strong>Symptom Types:</strong>
                                                            @if (expandedUser.NeuroSymptoms == true) { <span class="badge badge-secondary mr-1">Neurological</span> }
                                                            @if (expandedUser.MusculoskeletalSymptoms == true) { <span class="badge badge-secondary mr-1">Musculoskeletal</span> }
                                                            @if (expandedUser.PsychologicalSymptoms == true) { <span class="badge badge-secondary mr-1">Psychological</span> }
                                                        </div>
                                                    }
                                                    @if (expandedUser.SymptomsHeadaches == true || expandedUser.SymptomsDizziness == true ||
                                                         expandedUser.SymptomsNeckPain == true || expandedUser.SymptomsBackPain == true ||
                                                         expandedUser.SymptomsJointPain == true || expandedUser.SymptomsNumbnessTingling == true)
                                                    {
                                                        <div style="margin-top: 8px;"><strong>Specific Symptoms:</strong>
                                                            @if (expandedUser.SymptomsHeadaches == true) { <span class="badge badge-secondary mr-1">Headaches</span> }
                                                            @if (expandedUser.SymptomsDizziness == true) { <span class="badge badge-secondary mr-1">Dizziness</span> }
                                                            @if (expandedUser.SymptomsNeckPain == true) { <span class="badge badge-secondary mr-1">Neck Pain</span> }
                                                            @if (expandedUser.SymptomsBackPain == true) { <span class="badge badge-secondary mr-1">Back Pain</span> }
                                                            @if (expandedUser.SymptomsJointPain == true) { <span class="badge badge-secondary mr-1">Joint Pain</span> }
                                                            @if (expandedUser.SymptomsNumbnessTingling == true) { <span class="badge badge-secondary mr-1">Numbness/Tingling</span> }
                                                        </div>
                                                    }
                                                    @if (!string.IsNullOrEmpty(expandedUser.SymptomsNotes))
                                                    {
                                                        <div style="margin-top: 8px; white-space: pre-wrap;"><strong>Symptoms Notes:</strong> @expandedUser.SymptomsNotes</div>
                                                    }
                                                </span>
                                            </div>
                                        }
                                        
                                        @* 4. MEDICAL TREATMENT *@
                                        @if (expandedUser.WentToEmergencyRoom == true || !string.IsNullOrEmpty(expandedUser.ERHospitalName) || 
                                             expandedUser.ERVisitDate.HasValue || expandedUser.TreatingInjurySpecialist == true || 
                                             !string.IsNullOrEmpty(expandedUser.InjurySpecialistDetails))
                                        {
                                            <div class="meta-row" style="border-top: 1px solid #eee; padding-top: 12px; margin-top: 12px;">
                                                <span class="meta-label"><strong>Medical Treatment:</strong></span>
                                                <span class="meta-value">
                                                    @if (expandedUser.WentToEmergencyRoom == true)
                                                    {
                                                        <div>Went to ER: Yes</div>
                                                        @if (!string.IsNullOrEmpty(expandedUser.ERHospitalName))
                                                        {
                                                            <div>Hospital: @expandedUser.ERHospitalName</div>
                                                        }
                                                        @if (expandedUser.ERVisitDate.HasValue)
                                                        {
                                                            <div>Visit Date: @expandedUser.ERVisitDate.Value.ToString("MM/dd/yyyy")</div>
                                                        }
                                                    }
                                                    @if (expandedUser.TreatingInjurySpecialist == true)
                                                    {
                                                        <div>Treating with Injury Specialist: Yes</div>
                                                        @if (!string.IsNullOrEmpty(expandedUser.InjurySpecialistDetails))
                                                        {
                                                            <div style="white-space: pre-wrap; margin-top: 4px;">@expandedUser.InjurySpecialistDetails</div>
                                                        }
                                                    }
                                                </span>
                                            </div>
                                        }
                                        
                                        @* 5. INSURANCE & CLAIMS *@
                                        @if (expandedUser.InsuranceContacted == true || expandedUser.InsuranceAdjusterContacted == true || 
                                             expandedUser.ProvidedRecordedStatement == true || expandedUser.ReceivedSettlementOffer == true || 
                                             expandedUser.SettlementOfferAmount.HasValue || !string.IsNullOrEmpty(expandedUser.ClaimInsuranceCompany))
                                        {
                                            <div class="meta-row" style="border-top: 1px solid #eee; padding-top: 12px; margin-top: 12px;">
                                                <span class="meta-label"><strong>Insurance & Claims:</strong></span>
                                                <span class="meta-value">
                                                    @if (expandedUser.InsuranceContacted == true) { <div>Insurance Contacted: Yes</div> }
                                                    @if (expandedUser.InsuranceAdjusterContacted == true) { <div>Adjuster Contacted: Yes</div> }
                                                    @if (!string.IsNullOrEmpty(expandedUser.ClaimInsuranceCompany))
                                                    {
                                                        <div>Insurance Company: @expandedUser.ClaimInsuranceCompany</div>
                                                    }
                                                    @if (expandedUser.ProvidedRecordedStatement == true) { <div>Provided Statement: Yes</div> }
                                                    @if (expandedUser.ReceivedSettlementOffer == true)
                                                    {
                                                        <div>Settlement Offer: Yes</div>
                                                        @if (expandedUser.SettlementOfferAmount.HasValue)
                                                        {
                                                            <div>Amount: @expandedUser.SettlementOfferAmount.Value.ToString("C")</div>
                                                        }
                                                    }
                                                </span>
                                            </div>
                                        }
                                        
                                        @* 6. LEGAL REPRESENTATION *@
                                        @if (expandedUser.RepresentedByAttorney == true || expandedUser.SignedDocumentsRelatedToAccident == true || 
                                             !string.IsNullOrEmpty(expandedUser.SignedDocumentsNotes) || !string.IsNullOrEmpty(expandedUser.AttorneyName) || 
                                             !string.IsNullOrEmpty(expandedUser.AttorneyFirm))
                                        {
                                            <div class="meta-row" style="border-top: 1px solid #eee; padding-top: 12px; margin-top: 12px;">
                                                <span class="meta-label"><strong>Legal Representation:</strong></span>
                                                <span class="meta-value">
                                                    @if (expandedUser.RepresentedByAttorney == true) { <div>Represented by Attorney: Yes</div> }
                                                    @if (!string.IsNullOrEmpty(expandedUser.AttorneyName))
                                                    {
                                                        <div>Attorney: @expandedUser.AttorneyName</div>
                                                    }
                                                    @if (!string.IsNullOrEmpty(expandedUser.AttorneyFirm))
                                                    {
                                                        <div>Firm: @expandedUser.AttorneyFirm</div>
                                                    }
                                                    @if (expandedUser.SignedDocumentsRelatedToAccident == true) { <div>Signed Documents: Yes</div> }
                                                    @if (!string.IsNullOrEmpty(expandedUser.SignedDocumentsNotes))
                                                    {
                                                        <div style="white-space: pre-wrap; margin-top: 4px;">@expandedUser.SignedDocumentsNotes</div>
                                                    }
                                                </span>
                                            </div>
                                        }
                                        
                                        @* 7. VEHICLE & PROPERTY *@
                                        @if (!string.IsNullOrEmpty(expandedUser.VehicleDetails) || !string.IsNullOrEmpty(expandedUser.VehicleCurrentLocation) || 
                                             expandedUser.InsuranceEstimateCompleted == true || expandedUser.EstimatedRepairAmount.HasValue || 
                                             expandedUser.VehicleTotalLoss == true)
                                        {
                                            <div class="meta-row" style="border-top: 1px solid #eee; padding-top: 12px; margin-top: 12px;">
                                                <span class="meta-label"><strong>Vehicle & Property:</strong></span>
                                                <span class="meta-value">
                                                    @if (!string.IsNullOrEmpty(expandedUser.VehicleDetails))
                                                    {
                                                        <div style="white-space: pre-wrap;"><strong>Vehicle Details:</strong> @expandedUser.VehicleDetails</div>
                                                    }
                                                    @if (!string.IsNullOrEmpty(expandedUser.VehicleCurrentLocation))
                                                    {
                                                        <div>Current Location: @expandedUser.VehicleCurrentLocation</div>
                                                    }
                                                    @if (expandedUser.InsuranceEstimateCompleted == true)
                                                    {
                                                        <div>Estimate Completed: Yes</div>
                                                        @if (expandedUser.EstimatedRepairAmount.HasValue)
                                                        {
                                                            <div>Repair Amount: @expandedUser.EstimatedRepairAmount.Value.ToString("C")</div>
                                                        }
                                                    }
                                                    @if (expandedUser.VehicleTotalLoss == true) { <div>Total Loss: Yes</div> }
                                                </span>
                                            </div>
                                        }
                                        
                                        @* 8. WORK & LIFE IMPACT *@
                                        @if (expandedUser.MissedWork == true || expandedUser.MissedWorkDays.HasValue || expandedUser.WorkingWithRestrictions == true ||
                                             !string.IsNullOrEmpty(expandedUser.WorkRestrictionDetails) || expandedUser.DailyActivitiesAffected == true ||
                                             !string.IsNullOrEmpty(expandedUser.DailyActivitiesNotes))
                                        {
                                            <div class="meta-row" style="border-top: 1px solid #eee; padding-top: 12px; margin-top: 12px;">
                                                <span class="meta-label"><strong>Work & Life Impact:</strong></span>
                                                <span class="meta-value">
                                                    @if (expandedUser.MissedWork == true)
                                                    {
                                                        <div>Missed Work: Yes</div>
                                                        @if (expandedUser.MissedWorkDays.HasValue)
                                                        {
                                                            <div>Days Missed: @expandedUser.MissedWorkDays</div>
                                                        }
                                                    }
                                                    @if (expandedUser.WorkingWithRestrictions == true)
                                                    {
                                                        <div>Working with Restrictions: Yes</div>
                                                        @if (!string.IsNullOrEmpty(expandedUser.WorkRestrictionDetails))
                                                        {
                                                            <div style="white-space: pre-wrap; margin-top: 4px;">@expandedUser.WorkRestrictionDetails</div>
                                                        }
                                                    }
                                                    @if (expandedUser.DailyActivitiesAffected == true)
                                                    {
                                                        <div>Daily Activities Affected: Yes</div>
                                                        @if (!string.IsNullOrEmpty(expandedUser.DailyActivitiesNotes))
                                                        {
                                                            <div style="white-space: pre-wrap; margin-top: 4px;">@expandedUser.DailyActivitiesNotes</div>
                                                        }
                                                    }
                                                </span>
                                            </div>
                                        }
                                        
                                        @* 9. ADDITIONAL INFORMATION (Nice to have - Bottom) *@
                                        @if (!string.IsNullOrEmpty(expandedUser.RoadConditions) || !string.IsNullOrEmpty(expandedUser.DoctorsInformation) ||
                                             !string.IsNullOrEmpty(expandedUser.LawyersInformation) || !string.IsNullOrEmpty(expandedUser.AdditionalNotes))
                                        {
                                            <div class="meta-row" style="border-top: 1px solid #eee; padding-top: 12px; margin-top: 12px;">
                                                <span class="meta-label"><strong>Additional Information:</strong></span>
                                                <span class="meta-value">
                                                    @if (!string.IsNullOrEmpty(expandedUser.RoadConditions))
                                                    {
                                                        <div>Road Conditions: @expandedUser.RoadConditions</div>
                                                    }
                                                    @if (!string.IsNullOrEmpty(expandedUser.DoctorsInformation))
                                                    {
                                                        <div style="white-space: pre-wrap; margin-top: 4px;"><strong>Doctor's Information:</strong> @expandedUser.DoctorsInformation</div>
                                                    }
                                                    @if (!string.IsNullOrEmpty(expandedUser.LawyersInformation))
                                                    {
                                                        <div style="white-space: pre-wrap; margin-top: 4px;"><strong>Lawyer's Information:</strong> @expandedUser.LawyersInformation</div>
                                                    }
                                                    @if (!string.IsNullOrEmpty(expandedUser.AdditionalNotes))
                                                    {
                                                        <div style="white-space: pre-wrap; margin-top: 4px;"><strong>Additional Notes:</strong> @expandedUser.AdditionalNotes</div>
                                                    }
                                                </span>
                                            </div>
                                        }
                                        </div>
                                    
                                    @* Edit Accident Information Button (Admin and Coordinator) *@
                                    @if (AuthService.CurrentUser?.RoleId == 3 || AuthService.CurrentUser?.RoleId == 4) // Admin or Coordinator
                                    {
                                        <div class="col-12 mt-3">
                                            <RadzenButton Text="Edit Accident Information" 
                                                         ButtonStyle="ButtonStyle.Primary" 
                                                         Size="ButtonSize.Small"
                                                         Click="@(() => ShowEditPatientAccidentInfoDialog(expandedUser))" />
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    </div>
                </ExpansionTemplate>
            </SMDataGrid>
        </div>
    }
</div>

<!-- Add/Edit Patient Modal -->
@if (showPatientForm)
{
    <div class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>@(editingUser == null ? "Add New Patient" : "Edit Patient")</h3>
                <button @onclick="ClosePatientForm" class="close-btn">✕</button>
            </div>
            
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>First Name *</label>
                        <input @bind="patientForm.FirstName" class="form-input" />
                    </div>
                    
                    <div class="form-group">
                        <label>Last Name *</label>
                        <input @bind="patientForm.LastName" class="form-input" />
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Email *</label>
                        <input @bind="patientForm.Email" type="email" class="form-input" />
                    </div>
                    
                    <div class="form-group">
                        <label>Password @(editingUser == null ? "*" : "(leave blank to keep current)")</label>
                        <input @bind="patientForm.Password" type="password" class="form-input" />
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Date of Birth *</label>
                        <input @bind="patientForm.DateOfBirth" type="date" class="form-input" />
                    </div>
                    
                    <div class="form-group">
                        <label>Gender</label>
                        <select @bind="patientForm.Gender" class="form-input">
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                            <option value="Prefer not to say">Prefer not to say</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Mobile Phone</label>
                        <input @bind="patientForm.MobilePhone" type="tel" class="form-input" placeholder="+1 (555) 123-4567" />
                    </div>
                    
                    <div class="form-group">
                        <!-- Empty div for layout balance -->
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button @onclick="ClosePatientForm" class="btn btn-secondary">Cancel</button>
                <button @onclick="SavePatient" disabled="@isSaving" class="btn btn-primary">
                    @(isSaving ? "Saving..." : (editingUser == null ? "Add Patient" : "Update Patient"))
                </button>
            </div>
        </div>
    </div>
}

<!-- Patient Details Modal -->
@if (showPatientDetails && selectedUser != null)
{
    <div class="modal-overlay">
        <div class="modal-content patient-details-modal">
            <div class="modal-header">
                <h3>User Details - @selectedUser.FirstName @selectedUser.LastName</h3>
                <button @onclick="ClosePatientDetails" class="close-btn">✕</button>
            </div>
            
            <div class="modal-body">
                <div class="patient-details-grid">
                    <div class="detail-section">
                        <h4>Personal Information</h4>
                        <div class="detail-item">
                            <span class="detail-label">Name:</span>
                            <span class="detail-value">@selectedUser.FirstName @selectedUser.LastName</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Email:</span>
                            <span class="detail-value">@selectedUser.Email</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Date of Birth:</span>
                            <span class="detail-value">@selectedUser.DateOfBirth.ToString("MMM dd, yyyy")</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Gender:</span>
                            <span class="detail-value">@(selectedUser.Gender ?? "Not specified")</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Mobile Phone:</span>
                            <span class="detail-value">@(selectedUser.MobilePhone ?? "Not provided")</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Status:</span>
                            <span class="status-badge @(selectedUser.IsActive ? "active" : "inactive")">
                                @(selectedUser.IsActive ? "Active" : "Inactive")
                            </span>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h4>Account Information</h4>
                        <div class="detail-item">
                            <span class="detail-label">Member Since:</span>
                            <span class="detail-value">@selectedUser.CreatedAt.ToString("MMM dd, yyyy")</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Last Login:</span>
                            <span class="detail-value">@(selectedUser.LastLoginAt?.ToString("MMM dd, yyyy") ?? "Never")</span>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h4>Activity Summary</h4>
                        <div class="detail-item">
                            <span class="detail-label">Journal Entries:</span>
                            <span class="detail-value">@selectedUser.JournalEntries.Count</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Chat Sessions:</span>
                            <span class="detail-value">@selectedUser.ChatSessions.Count</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button @onclick="ClosePatientDetails" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>
}

<!-- Patient Stats Modal -->
@if (showPatientStats && selectedUser != null && userStats is not null)
{
    <div class="modal-overlay">
        <div class="modal-content patient-stats-modal">
            <div class="modal-header">
                <h3>User Statistics - @selectedUser.FirstName @selectedUser.LastName</h3>
                <button @onclick="ClosePatientStats" class="close-btn">✕</button>
            </div>
            
            <div class="modal-body">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>Journal Activity</h4>
                        <div class="stat-value">@userStats.TotalJournalEntries</div>
                        <div class="stat-label">Total Entries</div>
                    </div>
                    
                    <div class="stat-card">
                        <h4>Recent Activity</h4>
                        <div class="stat-value">@userStats.EntriesLast30Days</div>
                        <div class="stat-label">Last 30 Days</div>
                    </div>
                    
                    <div class="stat-card">
                        <h4>Mood Distribution</h4>
                        <div class="mood-stats">
                            @foreach (var mood in userStats.MoodDistribution)
                            {
                                <div class="mood-stat">
                                    <span class="mood-label">@mood.Key:</span>
                                    <span class="mood-count">@mood.Value</span>
                                </div>
                            }
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <h4>Chat Activity</h4>
                        <div class="stat-value">@userStats.TotalChatSessions</div>
                        <div class="stat-label">Chat Sessions</div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button @onclick="ClosePatientStats" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>
}

<!-- Doctor/Attorney Assignment Modal -->
@if (showAssignModal && selectedUser != null)
{
    <div class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>
                    @if (AuthService.CurrentUser?.RoleId == 5) // Attorney
                    {
                        <text>Assign Patient to Another Attorney</text>
                    }
                    else if (AuthService.CurrentUser?.RoleId == 4) // Coordinator
                    {
                        <text>Assign Client to Doctor or Attorney</text>
                    }
                    else // Doctor
                    {
                        <text>Assign Patient to Doctor or Attorney</text>
                    }
                </h3>
                <button @onclick="CloseAssignModal" class="close-btn">✕</button>
            </div>
            
            <div class="modal-body">
                <div class="assignment-info">
                    <p><strong>@(AuthService.CurrentUser?.RoleId == 4 ? "Client" : "Patient"):</strong> @selectedUser.FirstName @selectedUser.LastName</p>
                    <p><strong>Email:</strong> @selectedUser.Email</p>
                </div>
                
                <div class="form-group">
                    <label>
                        @if (AuthService.CurrentUser?.RoleId == 5) // Attorney
                        {
                            <text>Select Attorney to Assign To:</text>
                        }
                        else // Doctor or Coordinator
                        {
                            <text>Select Doctor or Attorney to Assign To:</text>
                        }
                    </label>
                    <RadzenDropDown Data="@availableDoctors"
                                   ValueProperty="Id"
                                   TextProperty="FullName"
                                   @bind-Value="selectedDoctorId"
                                   Placeholder="@(AuthService.CurrentUser?.RoleId == 5 ? "Choose an attorney..." : "Choose an SME or attorney...")"
                                   Style="width: 100%" />
                </div>
            </div>
            
            <div class="modal-footer">
                <button @onclick="CloseAssignModal" class="btn btn-secondary">Cancel</button>
                <button @onclick="AssignPatientToDoctor" disabled="@isAssigning" class="btn btn-primary">
                    @(isAssigning ? "Assigning..." : (AuthService.CurrentUser?.RoleId == 4 ? "Assign Client" : "Assign Patient"))
                </button>
            </div>
        </div>
    </div>
}

<!-- AI Health Check Results Dialog -->
@if (showHealthCheckDialog && currentHealthCheckResult != null)
{
    <SMModal IsVisible="@showHealthCheckDialog" 
             Title="🧠 AI Health Check Analysis" 
             OnClose="CloseHealthCheckDialog"
             Size="ExtraLarge">
        <Body>
            <div class="health-check-results">
                <div class="result-summary mb-3">
                    <div class="severity-badge @(currentHealthCheckResult.Severity == "High" ? "severity-high" : currentHealthCheckResult.Severity == "Normal" ? "severity-normal" : "severity-low")">
                        <strong>Severity: @currentHealthCheckResult.Severity</strong>
                    </div>
                    <p class="mt-2"><strong>Status:</strong> @currentHealthCheckResult.Message</p>
                    @if (currentHealthCheckResult.AlertsSent > 0)
                    {
                        <p class="text-success"><strong>✅ Alerts Sent:</strong> @currentHealthCheckResult.AlertsSent doctor(s) notified</p>
                    }
                    @if (currentHealthCheckResult.Severity == "High" && currentHealthCheckResult.AlertsSent == 0)
                    {
                        <div class="alert alert-warning mt-3">
                            <p class="mb-2"><strong>⚠️ High Severity Detected</strong></p>
                            <p class="mb-2">You can send alerts to @currentHealthCheckResult.DoctorsNotified assigned doctor(s) if needed.</p>
                            <RadzenButton Text="📤 Send Alerts to Doctors" 
                                         ButtonStyle="ButtonStyle.Danger" 
                                         Size="ButtonSize.Medium"
                                         Click="SendAlertsToDoctors"
                                         Disabled="@isSendingAlerts" />
                            @if (isSendingAlerts)
                            {
                                <span class="ms-2">Sending...</span>
                            }
                        </div>
                    }
                </div>
                
                @if (!string.IsNullOrEmpty(currentHealthCheckResult.AiResponse))
                {
                    <div class="ai-analysis-section">
                        <h5>📊 AI Analysis Report</h5>
                        <div class="ai-response-content">
                            @((MarkupString)currentHealthCheckResult.AiResponse.Replace("\n", "<br/>"))
                        </div>
                    </div>
                }

                @if (currentHealthCheckResult.SeveritySources != null && currentHealthCheckResult.SeveritySources.Any())
                {
                    <div class="severity-sources-section mt-4">
                        <h5>🔍 Sources Contributing to Severity Assessment</h5>
                        <p class="text-muted small mb-3">The following items were analyzed and contributed to the severity assessment. You can review them or mark them as not applicable if the condition has improved.</p>
                        
                        <div class="alert alert-info small mb-3">
                            <strong>Found @currentHealthCheckResult.SeveritySources.Count source(s)</strong> that contributed to this assessment.
                        </div>
                        
                        @foreach (var source in currentHealthCheckResult.SeveritySources)
                        {
                            <div class="source-item mb-3 p-3 border border-danger rounded" style="background-color: #fff5f5;">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="badge @GetSourceTypeBadgeClass(source.SourceType) me-2">
                                                @GetSourceTypeIcon(source.SourceType) @source.SourceType
                                            </span>
                                            <strong>@source.SourceTitle</strong>
                                            <span class="text-muted ms-2 small">@source.SourceDate.ToString("MM/dd/yyyy")</span>
                                        </div>
                                        <p class="mb-1 small text-muted">@source.SourcePreview</p>
                                        @if (!string.IsNullOrEmpty(source.ContributionReason))
                                        {
                                            <p class="mb-0 small"><strong>Reason:</strong> <span class="text-info">@source.ContributionReason</span></p>
                                        }
                                    </div>
                                    <div class="ms-3 d-flex flex-column gap-2">
                                        <RadzenButton Text="View" 
                                                     ButtonStyle="ButtonStyle.Info" 
                                                     Size="ButtonSize.Small"
                                                     Variant="Variant.Flat"
                                                     Click="@(() => NavigateToSource(source))" />
                                        <RadzenButton Text="Mark as Not Applicable" 
                                                     ButtonStyle="ButtonStyle.Warning" 
                                                     Size="ButtonSize.Small"
                                                     Variant="Variant.Flat"
                                                     Click="@(() => MarkSourceAsIgnored(source))" />
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </Body>
        <Footer>
            <RadzenButton Text="Close" 
                         ButtonStyle="ButtonStyle.Primary" 
                         Click="CloseHealthCheckDialog" />
        </Footer>
    </SMModal>
}

<!-- Unassign From Doctor Modal (Coordinator) -->
@if (showUnassignFromDoctorModal && selectedUser != null)
{
    <div class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>@(AuthService.CurrentUser?.RoleId == 4 ? "Unassign Client from Doctor/Coordinator" : "Unassign Patient from Doctor/Coordinator")</h3>
                <button @onclick="CloseUnassignFromDoctorModal" class="close-btn">✕</button>
            </div>
            
            <div class="modal-body">
                <div class="assignment-info">
                    <p><strong>@(AuthService.CurrentUser?.RoleId == 4 ? "Client" : "Patient"):</strong> @selectedUser.FirstName @selectedUser.LastName</p>
                    <p><strong>Email:</strong> @selectedUser.Email</p>
                </div>
                
                <div class="form-group">
                    <label>Select Doctor/Coordinator to Unassign From:</label>
                    <RadzenDropDown Data="@assignedDoctorsForUnassign"
                                   ValueProperty="Id"
                                   TextProperty="FullName"
                                   @bind-Value="selectedDoctorId"
                                   Placeholder="Choose an SME/coordinator..."
                                   Style="width: 100%" />
                </div>
            </div>
            
            <div class="modal-footer">
                <button @onclick="CloseUnassignFromDoctorModal" class="btn btn-secondary">Cancel</button>
                <button @onclick="UnassignPatientFromDoctor" disabled="@isUnassigning" class="btn btn-danger">
                    @(isUnassigning ? "Unassigning..." : (AuthService.CurrentUser?.RoleId == 4 ? "Unassign Client" : "Unassign Patient"))
                </button>
            </div>
        </div>
    </div>
}

<!-- Unassign Confirmation Modal -->
@if (showUnassignConfirmation && selectedUser != null)
{
    <div class="modal-overlay" style="display: block !important; z-index: 9999 !important;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>⚠️ Confirm Unassignment</h3>
                <button @onclick="CloseUnassignConfirmation" class="close-btn">✕</button>
            </div>
            
            <div class="modal-body">
                <div class="confirmation-warning">
                    <div class="warning-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="warning-content">
                        <h4>Are you sure you want to unassign this @(AuthService.CurrentUser?.RoleId == 4 ? "client" : "patient")?</h4>
                        <div class="patient-info">
                            <p><strong>@(AuthService.CurrentUser?.RoleId == 4 ? "Client" : "Patient"):</strong> @selectedUser?.FirstName @selectedUser?.LastName</p>
                            <p><strong>Email:</strong> @selectedUser?.Email</p>
                        </div>
                        <div class="warning-message">
                            <p><strong>Important:</strong> Once unassigned, you will no longer have access to this @(AuthService.CurrentUser?.RoleId == 4 ? "client's" : "patient's") records. 
                            You will need to contact an administrator to reassign the @(AuthService.CurrentUser?.RoleId == 4 ? "client" : "patient") or ask another doctor to assign them to you.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button @onclick="CloseUnassignConfirmation" class="btn btn-secondary">Cancel</button>
                <button @onclick="ConfirmUnassignPatient" disabled="@isUnassigning" class="btn btn-danger">
                    @(isUnassigning ? "Unassigning..." : (AuthService.CurrentUser?.RoleId == 4 ? "Yes, Unassign Client" : "Yes, Unassign Patient"))
                </button>
            </div>
        </div>
    </div>
}

<!-- Edit Patient Accident Information Dialog (Admin and Coordinator) -->
@if (showEditPatientAccidentInfoDialog && selectedUserForAccidentEdit != null)
{
    <SMModal IsVisible="@showEditPatientAccidentInfoDialog" 
             Title="Edit Accident Information" 
             OnClose="@(() => { showEditPatientAccidentInfoDialog = false; selectedUserForAccidentEdit = null; })"
             Size="Large">
        <Body>
            <div class="dialog-content">
                <div class="row">
                    @* 1. ACCIDENT BASICS (High Priority) *@
                    <div class="col-md-12 mb-3" style="border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px;">
                        <h6 style="font-weight: bold; color: #333; margin: 0;">Accident Basics</h6>
                    </div>
                    <div class="col-md-6 mb-3">
                        <RadzenFormField Text="Accident Date" class="w-100">
                            <RadzenDatePicker @bind-Value="editPatientAccidentDate" DateFormat="MM/dd/yyyy" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-6 mb-3">
                        <RadzenFormField Text="Date Reported" class="w-100">
                            <RadzenDatePicker @bind-Value="editPatientDateReported" DateFormat="MM/dd/yyyy" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-12 mb-3">
                        <RadzenFormField Text="Accident Details" class="w-100">
                            <RadzenTextArea @bind-Value="editPatientAccidentDetails" MaxLength="2000" Rows="4" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-12 mb-3">
                        <RadzenFormField Text="Accident Address" class="w-100">
                            <RadzenTextArea @bind-Value="editPatientAccidentAddress" MaxLength="500" Rows="2" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-6 mb-3">
                        <RadzenFormField Text="Age" class="w-100">
                            <RadzenNumeric @bind-Value="editPatientAge" Min="0" Max="150" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-6 mb-3">
                        <RadzenFormField Text="Race" class="w-100">
                            <RadzenTextBox @bind-Value="editPatientRace" MaxLength="100" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    
                    @* 2. POLICE/LEGAL (High Priority) *@
                    <div class="col-md-12 mb-3" style="border-top: 2px solid #ddd; padding-top: 15px; margin-top: 15px; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px;">
                        <h6 style="font-weight: bold; color: #333; margin: 0;">Police/Legal</h6>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <RadzenCheckBox @bind-Value="editPatientPoliceInvolvement" />
                            <label style="margin: 0; cursor: pointer;" @onclick="@(() => editPatientPoliceInvolvement = editPatientPoliceInvolvement == null ? true : !editPatientPoliceInvolvement)">Police Involvement</label>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <RadzenFormField Text="Police Case Number" class="w-100">
                            <RadzenTextBox @bind-Value="editPatientPoliceCaseNumber" MaxLength="100" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    
                    @* 3. INJURY ASSESSMENT (Medical Priority) *@
                    <div class="col-md-12 mb-3" style="border-top: 2px solid #ddd; padding-top: 15px; margin-top: 15px; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px;">
                        <h6 style="font-weight: bold; color: #333; margin: 0;">Injury Assessment</h6>
                    </div>
                    <div class="col-md-6 mb-3">
                        <RadzenFormField Text="Symptom Ongoing Status" class="w-100">
                            <RadzenDropDown Data="@symptomOngoingStatuses" 
                                           ValueProperty="Id" 
                                           TextProperty="Label" 
                                           @bind-Value="editPatientSymptomOngoingStatusId" 
                                           Placeholder="Select status..."
                                           Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <RadzenCheckBox @bind-Value="editPatientLostConsciousness" />
                            <label style="margin: 0; cursor: pointer;" @onclick="@(() => editPatientLostConsciousness = editPatientLostConsciousness == null ? true : !editPatientLostConsciousness)">Lost Consciousness</label>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <RadzenCheckBox @bind-Value="editPatientNeuroSymptoms" />
                            <label style="margin: 0; cursor: pointer;" @onclick="@(() => editPatientNeuroSymptoms = editPatientNeuroSymptoms == null ? true : !editPatientNeuroSymptoms)">Neurological Symptoms</label>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <RadzenCheckBox @bind-Value="editPatientMusculoskeletalSymptoms" />
                            <label style="margin: 0; cursor: pointer;" @onclick="@(() => editPatientMusculoskeletalSymptoms = editPatientMusculoskeletalSymptoms == null ? true : !editPatientMusculoskeletalSymptoms)">Musculoskeletal Symptoms</label>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <RadzenCheckBox @bind-Value="editPatientPsychologicalSymptoms" />
                            <label style="margin: 0; cursor: pointer;" @onclick="@(() => editPatientPsychologicalSymptoms = editPatientPsychologicalSymptoms == null ? true : !editPatientPsychologicalSymptoms)">Psychological Symptoms</label>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <RadzenCheckBox @bind-Value="editPatientSymptomsHeadaches" />
                            <label style="margin: 0; cursor: pointer;" @onclick="@(() => editPatientSymptomsHeadaches = editPatientSymptomsHeadaches == null ? true : !editPatientSymptomsHeadaches)">Headaches</label>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <RadzenCheckBox @bind-Value="editPatientSymptomsDizziness" />
                            <label style="margin: 0; cursor: pointer;" @onclick="@(() => editPatientSymptomsDizziness = editPatientSymptomsDizziness == null ? true : !editPatientSymptomsDizziness)">Dizziness</label>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <RadzenCheckBox @bind-Value="editPatientSymptomsNeckPain" />
                            <label style="margin: 0; cursor: pointer;" @onclick="@(() => editPatientSymptomsNeckPain = editPatientSymptomsNeckPain == null ? true : !editPatientSymptomsNeckPain)">Neck Pain</label>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <RadzenCheckBox @bind-Value="editPatientSymptomsBackPain" />
                            <label style="margin: 0; cursor: pointer;" @onclick="@(() => editPatientSymptomsBackPain = editPatientSymptomsBackPain == null ? true : !editPatientSymptomsBackPain)">Back Pain</label>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <RadzenCheckBox @bind-Value="editPatientSymptomsJointPain" />
                            <label style="margin: 0; cursor: pointer;" @onclick="@(() => editPatientSymptomsJointPain = editPatientSymptomsJointPain == null ? true : !editPatientSymptomsJointPain)">Joint Pain</label>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <RadzenCheckBox @bind-Value="editPatientSymptomsNumbnessTingling" />
                            <label style="margin: 0; cursor: pointer;" @onclick="@(() => editPatientSymptomsNumbnessTingling = editPatientSymptomsNumbnessTingling == null ? true : !editPatientSymptomsNumbnessTingling)">Numbness/Tingling</label>
                        </div>
                    </div>
                    <div class="col-md-12 mb-3">
                        <RadzenFormField Text="Symptoms Notes" class="w-100">
                            <RadzenTextArea @bind-Value="editPatientSymptomsNotes" MaxLength="2000" Rows="3" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    
                    @* 4. MEDICAL TREATMENT *@
                    <div class="col-md-12 mb-3" style="border-top: 1px solid #eee; padding-top: 15px; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px;">
                        <h6 style="font-weight: bold; color: #333; margin: 0;">Medical Treatment</h6>
                    </div>
                        <div class="col-md-6 mb-3">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <RadzenCheckBox @bind-Value="editPatientWentToEmergencyRoom" />
                                <label style="margin: 0; cursor: pointer;" @onclick="@(() => editPatientWentToEmergencyRoom = editPatientWentToEmergencyRoom == null ? true : !editPatientWentToEmergencyRoom)">Went to Emergency Room</label>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <RadzenFormField Text="ER Hospital Name" class="w-100">
                                <RadzenTextBox @bind-Value="editPatientERHospitalName" MaxLength="255" Style="width: 100%" />
                            </RadzenFormField>
                        </div>
                        <div class="col-md-6 mb-3">
                            <RadzenFormField Text="ER Visit Date" class="w-100">
                                <RadzenDatePicker @bind-Value="editPatientERVisitDate" DateFormat="MM/dd/yyyy" Style="width: 100%" />
                            </RadzenFormField>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <RadzenCheckBox @bind-Value="editPatientTreatingInjurySpecialist" />
                                <label style="margin: 0; cursor: pointer;" @onclick="@(() => editPatientTreatingInjurySpecialist = editPatientTreatingInjurySpecialist == null ? true : !editPatientTreatingInjurySpecialist)">Treating with Injury Specialist</label>
                            </div>
                        </div>
                        <div class="col-md-12 mb-3">
                            <RadzenFormField Text="Injury Specialist Details" class="w-100">
                                <RadzenTextArea @bind-Value="editPatientInjurySpecialistDetails" MaxLength="1000" Rows="3" Style="width: 100%" />
                            </RadzenFormField>
                        </div>
                    
                    @* 5. INSURANCE & CLAIMS *@
                    <div class="col-md-12 mb-3" style="border-top: 1px solid #eee; padding-top: 15px; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px;">
                        <h6 style="font-weight: bold; color: #333; margin: 0;">Insurance & Claims</h6>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <RadzenCheckBox @bind-Value="editPatientInsuranceContacted" />
                            <label style="margin: 0; cursor: pointer;" @onclick="@(() => editPatientInsuranceContacted = editPatientInsuranceContacted == null ? true : !editPatientInsuranceContacted)">Insurance Contacted</label>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <RadzenCheckBox @bind-Value="editPatientInsuranceAdjusterContacted" />
                            <label style="margin: 0; cursor: pointer;" @onclick="@(() => editPatientInsuranceAdjusterContacted = editPatientInsuranceAdjusterContacted == null ? true : !editPatientInsuranceAdjusterContacted)">Insurance Adjuster Contacted</label>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <RadzenFormField Text="Claim Insurance Company" class="w-100">
                            <RadzenTextBox @bind-Value="editPatientClaimInsuranceCompany" MaxLength="255" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <RadzenCheckBox @bind-Value="editPatientProvidedRecordedStatement" />
                            <label style="margin: 0; cursor: pointer;" @onclick="@(() => editPatientProvidedRecordedStatement = editPatientProvidedRecordedStatement == null ? true : !editPatientProvidedRecordedStatement)">Provided Recorded Statement</label>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <RadzenCheckBox @bind-Value="editPatientReceivedSettlementOffer" />
                            <label style="margin: 0; cursor: pointer;" @onclick="@(() => editPatientReceivedSettlementOffer = editPatientReceivedSettlementOffer == null ? true : !editPatientReceivedSettlementOffer)">Received Settlement Offer</label>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <RadzenFormField Text="Settlement Offer Amount" class="w-100">
                            <RadzenNumeric @bind-Value="editPatientSettlementOfferAmount" Min="0" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    
                    @* 6. LEGAL REPRESENTATION *@
                    <div class="col-md-12 mb-3" style="border-top: 1px solid #eee; padding-top: 15px; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px;">
                        <h6 style="font-weight: bold; color: #333; margin: 0;">Legal Representation</h6>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <RadzenCheckBox @bind-Value="editPatientRepresentedByAttorney" />
                            <label style="margin: 0; cursor: pointer;" @onclick="@(() => editPatientRepresentedByAttorney = editPatientRepresentedByAttorney == null ? true : !editPatientRepresentedByAttorney)">Represented by Attorney</label>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <RadzenFormField Text="Attorney Name" class="w-100">
                            <RadzenTextBox @bind-Value="editPatientAttorneyName" MaxLength="255" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-6 mb-3">
                        <RadzenFormField Text="Attorney Firm" class="w-100">
                            <RadzenTextBox @bind-Value="editPatientAttorneyFirm" MaxLength="255" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <RadzenCheckBox @bind-Value="editPatientSignedDocumentsRelatedToAccident" />
                            <label style="margin: 0; cursor: pointer;" @onclick="@(() => editPatientSignedDocumentsRelatedToAccident = editPatientSignedDocumentsRelatedToAccident == null ? true : !editPatientSignedDocumentsRelatedToAccident)">Signed Documents Related to Accident</label>
                        </div>
                    </div>
                    <div class="col-md-12 mb-3">
                        <RadzenFormField Text="Signed Documents Notes" class="w-100">
                            <RadzenTextArea @bind-Value="editPatientSignedDocumentsNotes" MaxLength="1000" Rows="3" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    
                    @* 7. VEHICLE & PROPERTY *@
                    <div class="col-md-12 mb-3" style="border-top: 1px solid #eee; padding-top: 15px; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px;">
                        <h6 style="font-weight: bold; color: #333; margin: 0;">Vehicle & Property</h6>
                    </div>
                    <div class="col-md-12 mb-3">
                        <RadzenFormField Text="Vehicle Details" class="w-100">
                            <RadzenTextArea @bind-Value="editPatientVehicleDetails" MaxLength="1000" Rows="3" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-12 mb-3">
                        <RadzenFormField Text="Vehicle Current Location" class="w-100">
                            <RadzenTextArea @bind-Value="editPatientVehicleCurrentLocation" MaxLength="500" Rows="2" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <RadzenCheckBox @bind-Value="editPatientInsuranceEstimateCompleted" />
                            <label style="margin: 0; cursor: pointer;" @onclick="@(() => editPatientInsuranceEstimateCompleted = editPatientInsuranceEstimateCompleted == null ? true : !editPatientInsuranceEstimateCompleted)">Insurance Estimate Completed</label>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <RadzenFormField Text="Estimated Repair Amount" class="w-100">
                            <RadzenNumeric @bind-Value="editPatientEstimatedRepairAmount" Min="0" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <RadzenCheckBox @bind-Value="editPatientVehicleTotalLoss" />
                            <label style="margin: 0; cursor: pointer;" @onclick="@(() => editPatientVehicleTotalLoss = editPatientVehicleTotalLoss == null ? true : !editPatientVehicleTotalLoss)">Vehicle Total Loss</label>
                        </div>
                    </div>
                    
                    @* 8. WORK & LIFE IMPACT *@
                    <div class="col-md-12 mb-3" style="border-top: 1px solid #eee; padding-top: 15px; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px;">
                        <h6 style="font-weight: bold; color: #333; margin: 0;">Work & Life Impact</h6>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <RadzenCheckBox @bind-Value="editPatientMissedWork" />
                            <label style="margin: 0; cursor: pointer;" @onclick="@(() => editPatientMissedWork = editPatientMissedWork == null ? true : !editPatientMissedWork)">Missed Work</label>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <RadzenFormField Text="Missed Work Days" class="w-100">
                            <RadzenNumeric @bind-Value="editPatientMissedWorkDays" Min="0" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <RadzenCheckBox @bind-Value="editPatientWorkingWithRestrictions" />
                            <label style="margin: 0; cursor: pointer;" @onclick="@(() => editPatientWorkingWithRestrictions = editPatientWorkingWithRestrictions == null ? true : !editPatientWorkingWithRestrictions)">Working with Restrictions</label>
                        </div>
                    </div>
                    <div class="col-md-12 mb-3">
                        <RadzenFormField Text="Work Restriction Details" class="w-100">
                            <RadzenTextArea @bind-Value="editPatientWorkRestrictionDetails" MaxLength="1000" Rows="3" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <RadzenCheckBox @bind-Value="editPatientDailyActivitiesAffected" />
                            <label style="margin: 0; cursor: pointer;" @onclick="@(() => editPatientDailyActivitiesAffected = editPatientDailyActivitiesAffected == null ? true : !editPatientDailyActivitiesAffected)">Daily Activities Affected</label>
                        </div>
                    </div>
                    <div class="col-md-12 mb-3">
                        <RadzenFormField Text="Daily Activities Notes" class="w-100">
                            <RadzenTextArea @bind-Value="editPatientDailyActivitiesNotes" MaxLength="1000" Rows="3" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    
                    @* 9. ADDITIONAL INFORMATION (Nice to have - Bottom) *@
                    <div class="col-md-12 mb-3" style="border-top: 1px solid #eee; padding-top: 15px; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px;">
                        <h6 style="font-weight: bold; color: #333; margin: 0;">Additional Information</h6>
                    </div>
                    <div class="col-md-6 mb-3">
                        <RadzenFormField Text="Road Conditions" class="w-100">
                            <RadzenTextBox @bind-Value="editPatientRoadConditions" MaxLength="200" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-12 mb-3">
                        <RadzenFormField Text="Doctor's Information" class="w-100">
                            <RadzenTextArea @bind-Value="editPatientDoctorsInformation" MaxLength="1000" Rows="3" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-12 mb-3">
                        <RadzenFormField Text="Lawyer's Information" class="w-100">
                            <RadzenTextArea @bind-Value="editPatientLawyersInformation" MaxLength="1000" Rows="3" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-12 mb-3">
                        <RadzenFormField Text="Additional Notes" class="w-100">
                            <RadzenTextArea @bind-Value="editPatientAdditionalNotes" MaxLength="2000" Rows="4" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                </div>
                
                <div class="dialog-actions">
                    <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" 
                                 Click="@(() => { showEditPatientAccidentInfoDialog = false; selectedUserForAccidentEdit = null; })" 
                                 Disabled="@isSavingAccidentInfo" />
                    <RadzenButton Text="Save" ButtonStyle="ButtonStyle.Primary" 
                                 Click="@SavePatientAccidentInfo" 
                                 Disabled="@isSavingAccidentInfo" />
                </div>
            </div>
        </Body>
    </SMModal>
}

<!-- Edit Patient Lead Intake Dialog (Admin only) -->
@if (showEditPatientLeadIntakeDialog && selectedUserForLeadIntakeEdit != null)
{
    <SMModal IsVisible="@showEditPatientLeadIntakeDialog" 
             Title="Edit Lead Intake" 
             OnClose="@(() => { showEditPatientLeadIntakeDialog = false; selectedUserForLeadIntakeEdit = null; })"
             Size="Large">
        <Body>
            <div class="dialog-content">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <RadzenFormField Text="Residence State" class="w-100">
                            <RadzenDropDown Data="@states" 
                                           ValueProperty="Code" 
                                           TextProperty="Name" 
                                           @bind-Value="editLeadIntakeResidenceStateCode" 
                                           Placeholder="Select state..."
                                           Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-6 mb-3">
                        <RadzenFormField Text="Accident State" class="w-100">
                            <RadzenDropDown Data="@states" 
                                           ValueProperty="Code" 
                                           TextProperty="Name" 
                                           @bind-Value="editLeadIntakeAccidentStateCode" 
                                           Placeholder="Select state..."
                                           Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-6 mb-3">
                        <RadzenFormField Text="Participant Role" class="w-100">
                            <RadzenDropDown Data="@accidentParticipantRoles" 
                                           ValueProperty="Id" 
                                           TextProperty="Label" 
                                           @bind-Value="editLeadIntakeParticipantRoleId" 
                                           Placeholder="Select role..."
                                           Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-6 mb-3">
                        <RadzenFormField Text="Vehicle Disposition" class="w-100">
                            <RadzenDropDown Data="@vehicleDispositions" 
                                           ValueProperty="Id" 
                                           TextProperty="Label" 
                                           @bind-Value="editLeadIntakeVehicleDispositionId" 
                                           Placeholder="Select disposition..."
                                           Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-6 mb-3">
                        <RadzenFormField Text="Transport to Care" class="w-100">
                            <RadzenDropDown Data="@transportToCareMethods" 
                                           ValueProperty="Id" 
                                           TextProperty="Label" 
                                           @bind-Value="editLeadIntakeTransportToCareMethodId" 
                                           Placeholder="Select method..."
                                           Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-6 mb-3">
                        <RadzenFormField Text="Medical Attention Type" class="w-100">
                            <RadzenDropDown Data="@medicalAttentionTypes" 
                                           ValueProperty="Id" 
                                           TextProperty="Label" 
                                           @bind-Value="editLeadIntakeMedicalAttentionTypeId" 
                                           Placeholder="Select type..."
                                           Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-6 mb-3" style="display: flex; align-items: center; gap: 8px;">
                        <RadzenCheckBox @bind-Value="editLeadIntakePoliceInvolvement" />
                        <label style="margin: 0; cursor: pointer;" @onclick="@(() => editLeadIntakePoliceInvolvement = editLeadIntakePoliceInvolvement == null ? true : !editLeadIntakePoliceInvolvement)">Police Involvement</label>
                    </div>
                    <div class="col-md-6 mb-3" style="display: flex; align-items: center; gap: 8px;">
                        <RadzenCheckBox @bind-Value="editLeadIntakeLostConsciousness" />
                        <label style="margin: 0; cursor: pointer;" @onclick="@(() => editLeadIntakeLostConsciousness = editLeadIntakeLostConsciousness == null ? true : !editLeadIntakeLostConsciousness)">Lost Consciousness</label>
                    </div>
                    <div class="col-md-6 mb-3" style="display: flex; align-items: center; gap: 8px;">
                        <RadzenCheckBox @bind-Value="editLeadIntakeNeuroSymptoms" />
                        <label style="margin: 0; cursor: pointer;" @onclick="@(() => editLeadIntakeNeuroSymptoms = editLeadIntakeNeuroSymptoms == null ? true : !editLeadIntakeNeuroSymptoms)">Neurological Symptoms</label>
                    </div>
                    <div class="col-md-6 mb-3" style="display: flex; align-items: center; gap: 8px;">
                        <RadzenCheckBox @bind-Value="editLeadIntakeMusculoskeletalSymptoms" />
                        <label style="margin: 0; cursor: pointer;" @onclick="@(() => editLeadIntakeMusculoskeletalSymptoms = editLeadIntakeMusculoskeletalSymptoms == null ? true : !editLeadIntakeMusculoskeletalSymptoms)">Musculoskeletal Symptoms</label>
                    </div>
                    <div class="col-md-6 mb-3" style="display: flex; align-items: center; gap: 8px;">
                        <RadzenCheckBox @bind-Value="editLeadIntakePsychologicalSymptoms" />
                        <label style="margin: 0; cursor: pointer;" @onclick="@(() => editLeadIntakePsychologicalSymptoms = editLeadIntakePsychologicalSymptoms == null ? true : !editLeadIntakePsychologicalSymptoms)">Psychological Symptoms</label>
                    </div>
                    <div class="col-md-6 mb-3" style="display: flex; align-items: center; gap: 8px;">
                        <RadzenCheckBox @bind-Value="editLeadIntakeInsuranceContacted" />
                        <label style="margin: 0; cursor: pointer;" @onclick="@(() => editLeadIntakeInsuranceContacted = editLeadIntakeInsuranceContacted == null ? true : !editLeadIntakeInsuranceContacted)">Insurance Contacted</label>
                    </div>
                    <div class="col-md-6 mb-3" style="display: flex; align-items: center; gap: 8px;">
                        <RadzenCheckBox @bind-Value="editLeadIntakeRepresentedByAttorney" />
                        <label style="margin: 0; cursor: pointer;" @onclick="@(() => editLeadIntakeRepresentedByAttorney = editLeadIntakeRepresentedByAttorney == null ? true : !editLeadIntakeRepresentedByAttorney)">Represented by Attorney</label>
                    </div>
                    <div class="col-md-12 mb-3">
                        <RadzenFormField Text="Symptoms Notes" class="w-100">
                            <RadzenTextArea @bind-Value="editLeadIntakeSymptomsNotes" MaxLength="2000" Rows="4" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                </div>
                
                <div class="dialog-actions">
                    <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" 
                                 Click="@(() => { showEditPatientLeadIntakeDialog = false; selectedUserForLeadIntakeEdit = null; })" 
                                 Disabled="@isSavingLeadIntake" />
                    <RadzenButton Text="Save" ButtonStyle="ButtonStyle.Primary" 
                                 Click="@SavePatientLeadIntake" 
                                 Disabled="@isSavingLeadIntake" />
                </div>
            </div>
        </Body>
    </SMModal>
}

@code {
    private SMDataGrid<User>? _grid;
    private Dictionary<int, User> expandedUsers = new Dictionary<int, User>();
    private HashSet<int> expandedAccidentSections = new HashSet<int>(); // Track which rows have accident section expanded
    private HashSet<int> expandedLeadIntakeSections = new HashSet<int>(); // Track which rows have lead intake section expanded
    private HashSet<int> expandedClientDetailsSections = new HashSet<int>(); // Track which rows have client details section expanded
    private List<SMDataGridColumn<User>> _columns = new();
    private List<SMDataGridActionButton<User>> _actions = new();
    
    private User? selectedUser;
    private UserStats? userStats;
    private bool showPatientForm = false;
    private bool showPatientDetails = false;
    private bool showPatientStats = false;
    private bool showAssignModal = false;
    private bool showUnassignConfirmation = false;
    private bool showUnassignFromDoctorModal = false;
    private List<User> assignedDoctorsForUnassign = new();
    private bool showHealthCheckDialog = false;
    private bool isSaving = false;
    private bool isAssigning = false;
    private bool isUnassigning = false;
    private bool isPerformingHealthCheck = false;
    private bool isSendingAlerts = false;
    private AiHealthCheckResult? currentHealthCheckResult;
    private User? currentHealthCheckPatient = null; // Store patient for sending alerts
    private User? editingUser;
    private CreatePatientRequest patientForm = new();
    private List<User> availableDoctors = new();
    private int selectedDoctorId = 0;
    private bool showEditPatientAccidentInfoDialog = false;
    private bool isSavingAccidentInfo = false;
    private User? selectedUserForAccidentEdit;
    private bool showEditPatientLeadIntakeDialog = false;
    private bool isSavingLeadIntake = false;
    private User? selectedUserForLeadIntakeEdit;
    
    // Lead Intake lookup data
    private List<State> states = new();
    private List<AccidentParticipantRole> accidentParticipantRoles = new();
    private List<VehicleDisposition> vehicleDispositions = new();
    private List<TransportToCareMethod> transportToCareMethods = new();
    private List<MedicalAttentionType> medicalAttentionTypes = new();
    private List<SymptomOngoingStatus> symptomOngoingStatuses = new();
    
    // Lead Intake form fields
    private string? editLeadIntakeResidenceStateCode;
    private string? editLeadIntakeAccidentStateCode;
    private int? editLeadIntakeParticipantRoleId;
    private int? editLeadIntakeVehicleDispositionId;
    private int? editLeadIntakeTransportToCareMethodId;
    private int? editLeadIntakeMedicalAttentionTypeId;
    private bool? editLeadIntakePoliceInvolvement;
    private bool? editLeadIntakeLostConsciousness;
    private bool? editLeadIntakeNeuroSymptoms;
    private bool? editLeadIntakeMusculoskeletalSymptoms;
    private bool? editLeadIntakePsychologicalSymptoms;
    private string editLeadIntakeSymptomsNotes = "";
    private bool? editLeadIntakeInsuranceContacted;
    private bool? editLeadIntakeRepresentedByAttorney;
    
    // Patient accident information form
    private int? editPatientAge;
    private string editPatientRace = "";
    private string editPatientAccidentAddress = "";
    private DateTime? editPatientAccidentDate;
    private string editPatientVehicleDetails = "";
    private DateTime? editPatientDateReported;
    private string editPatientPoliceCaseNumber = "";
    private string editPatientAccidentDetails = "";
    private string editPatientRoadConditions = "";
    private string editPatientDoctorsInformation = "";
    private string editPatientLawyersInformation = "";
    private string editPatientAdditionalNotes = "";
    private bool? editPatientPoliceInvolvement;
    
    // New Accident fields from Script121525.sql
    private int? editPatientSymptomOngoingStatusId;
    private bool? editPatientLostConsciousness;
    private bool? editPatientNeuroSymptoms;
    private bool? editPatientMusculoskeletalSymptoms;
    private bool? editPatientPsychologicalSymptoms;
    private string editPatientSymptomsNotes = "";
    private bool? editPatientInsuranceContacted;
    private bool? editPatientRepresentedByAttorney;
    private bool? editPatientSymptomsHeadaches;
    private bool? editPatientSymptomsDizziness;
    private bool? editPatientSymptomsNeckPain;
    private bool? editPatientSymptomsBackPain;
    private bool? editPatientSymptomsJointPain;
    private bool? editPatientSymptomsNumbnessTingling;
    private bool? editPatientWentToEmergencyRoom;
    private string editPatientERHospitalName = "";
    private DateTime? editPatientERVisitDate;
    private bool? editPatientTreatingInjurySpecialist;
    private string editPatientInjurySpecialistDetails = "";
    private bool? editPatientInsuranceAdjusterContacted;
    private bool? editPatientProvidedRecordedStatement;
    private bool? editPatientReceivedSettlementOffer;
    private decimal? editPatientSettlementOfferAmount;
    private string editPatientClaimInsuranceCompany = "";
    private bool? editPatientSignedDocumentsRelatedToAccident;
    private string editPatientSignedDocumentsNotes = "";
    private string editPatientAttorneyName = "";
    private string editPatientAttorneyFirm = "";
    private string editPatientVehicleCurrentLocation = "";
    private bool? editPatientInsuranceEstimateCompleted;
    private decimal? editPatientEstimatedRepairAmount;
    private bool? editPatientVehicleTotalLoss;
    private bool? editPatientMissedWork;
    private int? editPatientMissedWorkDays;
    private bool? editPatientWorkingWithRestrictions;
    private string editPatientWorkRestrictionDetails = "";
    private bool? editPatientDailyActivitiesAffected;
    private string editPatientDailyActivitiesNotes = "";
    
    // Custom filter variables
    private bool? selectedStatusFilter = null;
    private string? selectedJournalFilter = null;
    
    private readonly List<object> statusOptions = new()
    {
        new { Value = (bool?)null, Text = "All Statuses" },
        new { Value = (bool?)true, Text = "Active" },
        new { Value = (bool?)false, Text = "Inactive" }
    };
    
    private readonly List<object> journalFilterOptions = new()
    {
        new { Value = (string?)null, Text = "All Clients" },
        new { Value = "0", Text = "No Journal Entries" },
        new { Value = "1-5", Text = "1-5 Entries" },
        new { Value = "6-10", Text = "6-10 Entries" },
        new { Value = "10+", Text = "10+ Entries" }
    };

    protected override async Task OnInitializedAsync()
    {
        InitializeColumns();
        InitializeActions();
        await LoadLookupDataAsync();
    }
    
    private async Task LoadLookupDataAsync()
    {
        try
        {
            Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", AuthService.Token);
            
            // Load each lookup separately to catch individual errors
            try
            {
                var statesResponse = await Http.GetAsync("api/lookup/states");
                if (statesResponse.IsSuccessStatusCode)
                {
                    states = await statesResponse.Content.ReadFromJsonAsync<List<State>>() ?? new();
                }
                else
                {
                    Console.WriteLine($"Failed to load states: {statesResponse.StatusCode} - {await statesResponse.Content.ReadAsStringAsync()}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading states: {ex.Message}");
            }
            
            try
            {
                var rolesResponse = await Http.GetAsync("api/lookup/accident-participant-roles");
                if (rolesResponse.IsSuccessStatusCode)
                {
                    accidentParticipantRoles = await rolesResponse.Content.ReadFromJsonAsync<List<AccidentParticipantRole>>() ?? new();
                }
                else
                {
                    Console.WriteLine($"Failed to load accident participant roles: {rolesResponse.StatusCode} - {await rolesResponse.Content.ReadAsStringAsync()}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading accident participant roles: {ex.Message}");
            }
            
            try
            {
                var dispositionsResponse = await Http.GetAsync("api/lookup/vehicle-dispositions");
                if (dispositionsResponse.IsSuccessStatusCode)
                {
                    vehicleDispositions = await dispositionsResponse.Content.ReadFromJsonAsync<List<VehicleDisposition>>() ?? new();
                }
                else
                {
                    Console.WriteLine($"Failed to load vehicle dispositions: {dispositionsResponse.StatusCode} - {await dispositionsResponse.Content.ReadAsStringAsync()}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading vehicle dispositions: {ex.Message}");
            }
            
            try
            {
                var transportResponse = await Http.GetAsync("api/lookup/transport-to-care-methods");
                if (transportResponse.IsSuccessStatusCode)
                {
                    transportToCareMethods = await transportResponse.Content.ReadFromJsonAsync<List<TransportToCareMethod>>() ?? new();
                }
                else
                {
                    Console.WriteLine($"Failed to load transport to care methods: {transportResponse.StatusCode} - {await transportResponse.Content.ReadAsStringAsync()}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading transport to care methods: {ex.Message}");
            }
            
            try
            {
                var medicalResponse = await Http.GetAsync("api/lookup/medical-attention-types");
                if (medicalResponse.IsSuccessStatusCode)
                {
                    medicalAttentionTypes = await medicalResponse.Content.ReadFromJsonAsync<List<MedicalAttentionType>>() ?? new();
                }
                else
                {
                    Console.WriteLine($"Failed to load medical attention types: {medicalResponse.StatusCode} - {await medicalResponse.Content.ReadAsStringAsync()}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading medical attention types: {ex.Message}");
            }
            
            try
            {
                var symptomStatusResponse = await Http.GetAsync("api/lookup/symptom-ongoing-statuses");
                if (symptomStatusResponse.IsSuccessStatusCode)
                {
                    symptomOngoingStatuses = await symptomStatusResponse.Content.ReadFromJsonAsync<List<SymptomOngoingStatus>>() ?? new();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading symptom ongoing statuses: {ex.Message}");
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to load lookup data: {ex.Message}");
            Console.WriteLine($"Error in LoadLookupDataAsync: {ex.Message}");
        }
    }

    private void InitializeColumns()
    {
        _columns = new List<SMDataGridColumn<User>>
        {
            new SMDataGridTemplateColumn<User>
            {
                Property = nameof(User.FirstName),
                Title = "Name",
                Width = "200px",
                Template = user => builder =>
                {
                    builder.OpenElement(0, "div");
                    builder.OpenElement(1, "strong");
                    builder.AddContent(2, $"{user.FirstName} {user.LastName}");
                    builder.CloseElement();
                    builder.OpenElement(3, "br");
                    builder.CloseElement();
                    builder.OpenElement(4, "small");
                    builder.AddAttribute(5, "class", "text-muted");
                    builder.AddContent(6, user.Email);
                    builder.CloseElement();
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<User>
            {
                Property = nameof(User.DateOfBirth),
                Title = "Date of Birth",
                Width = "120px",
                Template = user => builder =>
                {
                    builder.AddContent(0, user.DateOfBirth.ToString("MMM dd, yyyy"));
                }
            },
            new SMDataGridTemplateColumn<User>
            {
                Property = nameof(User.Gender),
                Title = "Gender",
                Width = "100px",
                Template = user => builder =>
                {
                    if (!string.IsNullOrEmpty(user.Gender))
                    {
                        builder.OpenElement(0, "span");
                        builder.AddAttribute(1, "class", "badge badge-info");
                        builder.AddContent(2, user.Gender);
                        builder.CloseElement();
                    }
                    else
                    {
                        builder.OpenElement(3, "span");
                        builder.AddAttribute(4, "class", "text-muted");
                        builder.AddContent(5, "Not specified");
                        builder.CloseElement();
                    }
                }
            },
            new SMDataGridTemplateColumn<User>
            {
                Property = nameof(User.IsActive),
                Title = "Status",
                Width = "100px",
                Template = user => builder =>
                {
                    builder.OpenElement(0, "span");
                    builder.AddAttribute(1, "class", $"status-badge {(user.IsActive ? "active" : "inactive")}");
                    builder.AddContent(2, user.IsActive ? "Active" : "Inactive");
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<User>
            {
                Property = nameof(User.JournalEntries),
                Title = "Journal Entries",
                Width = "120px",
                Sortable = false,
                Template = user => builder =>
                {
                    builder.OpenElement(0, "span");
                    builder.AddAttribute(1, "class", "badge badge-primary");
                    builder.AddContent(2, user.JournalEntries?.Count ?? 0);
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<User>
            {
                Property = nameof(User.LastLoginAt),
                Title = "Last Login",
                Width = "120px",
                Template = user => builder =>
                {
                    builder.AddContent(0, user.LastLoginAt?.ToString("MMM dd, yyyy") ?? "Never");
                }
            },
            new SMDataGridTemplateColumn<User>
            {
                Property = nameof(User.CreatedAt),
                Title = "Member Since",
                Width = "120px",
                Template = user => builder =>
                {
                    builder.AddContent(0, user.CreatedAt.ToString("MMM dd, yyyy"));
                }
            }
        };
    }

    private void InitializeActions()
    {
        // View, Edit, Stats, and AI Health Check actions (not for Coordinator or Attorney - read-only)
        if (AuthService.CurrentUser?.RoleId != 4 && AuthService.CurrentUser?.RoleId != 5) // Coordinator and Attorney can only assign/unassign
        {
            _actions.Add(new SMDataGridActionButton<User>
            {
                Icon = "visibility",
                ButtonStyle = ButtonStyle.Info,
                Variant = Variant.Flat,
                Size = ButtonSize.Small,
                Tooltip = "View client details",
                OnClick = async (row, ct) => await ViewUserDetailsAsync(row, ct)
            });

            _actions.Add(new SMDataGridActionButton<User>
            {
                Icon = "edit",
                ButtonStyle = ButtonStyle.Success,
                Variant = Variant.Flat,
                Size = ButtonSize.Small,
                Tooltip = "Edit client information",
                OnClick = async (row, ct) => await EditUserAsync(row, ct)
            });

            _actions.Add(new SMDataGridActionButton<User>
            {
                Icon = "analytics",
                ButtonStyle = ButtonStyle.Primary,
                Variant = Variant.Flat,
                Size = ButtonSize.Small,
                Tooltip = "View client statistics",
                OnClick = async (row, ct) => await ViewUserStatsAsync(row, ct)
            });

            _actions.Add(new SMDataGridActionButton<User>
            {
                Icon = "psychology",
                ButtonStyle = ButtonStyle.Warning,
                Variant = Variant.Flat,
                Size = ButtonSize.Small,
                Tooltip = "Perform AI health check analysis",
                OnClick = async (row, ct) => await PerformAiHealthCheckAsync(row, ct),
                Disabled = (user) => isPerformingHealthCheck
            });
        }

        // Doctor-specific actions
        if (AuthService.CurrentUser?.RoleId == 2)
        {
            // For doctors: allow reassigning to another doctor or attorney
            _actions.Add(new SMDataGridActionButton<User>
            {
                Icon = "person_add",
                ButtonStyle = ButtonStyle.Warning,
                Variant = Variant.Flat,
                Size = ButtonSize.Small,
                Tooltip = "Assign client to another SME",
                OnClick = async (row, ct) => await ShowAssignPatientModalAsync(row, ct)
            });

            // For doctors: allow unassigning from themselves
            _actions.Add(new SMDataGridActionButton<User>
            {
                Icon = "person_remove",
                ButtonStyle = ButtonStyle.Danger,
                Variant = Variant.Flat,
                Size = ButtonSize.Small,
                Tooltip = "Unassign client from me",
                OnClick = async (row, ct) => 
                {
                    ShowUnassignConfirmation(row);
                    await Task.CompletedTask;
                }
            });
        }

        // Attorney-specific actions
        if (AuthService.CurrentUser?.RoleId == 5)
        {
            // For attorneys: allow assigning to another attorney
            _actions.Add(new SMDataGridActionButton<User>
            {
                Icon = "person_add",
                ButtonStyle = ButtonStyle.Warning,
                Variant = Variant.Flat,
                Size = ButtonSize.Small,
                Tooltip = "Assign client to another attorney",
                OnClick = async (row, ct) => await ShowAssignPatientModalAsync(row, ct)
            });

            // For attorneys: allow unassigning from themselves
            _actions.Add(new SMDataGridActionButton<User>
            {
                Icon = "person_remove",
                ButtonStyle = ButtonStyle.Danger,
                Variant = Variant.Flat,
                Size = ButtonSize.Small,
                Tooltip = "Unassign client from me",
                OnClick = async (row, ct) => 
                {
                    ShowUnassignConfirmation(row);
                    await Task.CompletedTask;
                }
            });
        }

        // Coordinator-specific actions (only assign/unassign)
        if (AuthService.CurrentUser?.RoleId == 4)
        {
            // For coordinators: allow assigning to a doctor or attorney
            _actions.Add(new SMDataGridActionButton<User>
            {
                Icon = "person_add",
                ButtonStyle = ButtonStyle.Warning,
                Variant = Variant.Flat,
                Size = ButtonSize.Small,
                Tooltip = "Assign client to an SME",
                OnClick = async (row, ct) => await ShowAssignPatientModalAsync(row, ct)
            });

            // For coordinators: allow unassigning from a doctor (using Admin endpoint)
            _actions.Add(new SMDataGridActionButton<User>
            {
                Icon = "person_remove",
                ButtonStyle = ButtonStyle.Danger,
                Variant = Variant.Flat,
                Size = ButtonSize.Small,
                Tooltip = "Unassign client from doctor",
                OnClick = async (row, ct) => await ShowUnassignFromDoctorModalAsync(row, ct)
            });
        }

        // Admin-specific actions
        if (AuthService.CurrentUser?.RoleId == 3)
        {
            _actions.Add(new SMDataGridActionButton<User>
            {
                Icon = "block",
                ButtonStyle = ButtonStyle.Danger,
                Variant = Variant.Flat,
                Size = ButtonSize.Small,
                Tooltip = "Deactivate client",
                OnClick = async (row, ct) => await DeactivateUserAsync(row, ct),
                Disabled = (user) => !user.IsActive
            });

            _actions.Add(new SMDataGridActionButton<User>
            {
                Icon = "check",
                ButtonStyle = ButtonStyle.Success,
                Variant = Variant.Flat,
                Size = ButtonSize.Small,
                Tooltip = "Reactivate client",
                OnClick = async (row, ct) => await ReactivateUserAsync(row, ct),
                Disabled = (user) => user.IsActive
            });
        }
    }

    // OData-based server-side pagination
    private async Task<PagedResult<User>> LoadPatientsPagedAsync(
        int skip, 
        int take, 
        string? orderBy, 
        string? filter, 
        CancellationToken ct)
    {
        try
        {
            // Build OData filter - always filter to patients (RoleId = 1)
            var odataFilter = "RoleId eq 1";
            
            // Add status filter if selected
            if (selectedStatusFilter.HasValue)
            {
                var statusValue = selectedStatusFilter.Value ? "true" : "false";
                odataFilter = $"{odataFilter} and IsActive eq {statusValue}";
            }
            
            // Transform and combine any additional filter from grid
            // The filter from Radzen is in C# syntax, so we need to transform it to OData syntax
            if (!string.IsNullOrEmpty(filter))
            {
                // Decode URL-encoded filter from Radzen
                var decodedFilter = System.Net.WebUtility.UrlDecode(filter);
                // Transform C#-style filter to OData syntax
                var transformedFilter = ODataFilterHelper.TransformToOData(decodedFilter);
                // Combine with existing filters
                odataFilter = $"{odataFilter} and ({transformedFilter})";
            }
            
            // Query OData endpoint (pass null for filter since we've already combined it)
            var result = await ODataService.QueryAsync<User>(
                "Users",
                skip,
                take,
                orderBy,
                odataFilter, // Pass the complete filter string
                ct
            );
            
            // Only load journal entries if journal filter is active (lazy loading to avoid N+1 requests)
            // Journal entries are also loaded on-demand when a row is expanded (OnRowExpand)
            if (!string.IsNullOrEmpty(selectedJournalFilter))
            {
                // Batch load journal entry counts for all users on current page
                var userIds = result.Items.Select(u => u.Id).ToList();
                var journalCounts = await GetJournalEntryCountsBatchAsync(userIds, ct);
                
                // Apply journal filter client-side based on counts
                var filteredItems = result.Items.AsEnumerable();
                filteredItems = selectedJournalFilter switch
                {
                    "0" => filteredItems.Where(u => (journalCounts.GetValueOrDefault(u.Id, 0)) == 0),
                    "1-5" => filteredItems.Where(u => {
                        var count = journalCounts.GetValueOrDefault(u.Id, 0);
                        return count >= 1 && count <= 5;
                    }),
                    "6-10" => filteredItems.Where(u => {
                        var count = journalCounts.GetValueOrDefault(u.Id, 0);
                        return count >= 6 && count <= 10;
                    }),
                    "10+" => filteredItems.Where(u => journalCounts.GetValueOrDefault(u.Id, 0) > 10),
                    _ => filteredItems
                };
                result.Items = filteredItems.ToList();
                // Note: TotalCount might be slightly off after client-side filtering, but it's acceptable
            }
            else
            {
                // Initialize empty journal entries list for all users (will be loaded on row expand)
                foreach (var user in result.Items)
                {
                    user.JournalEntries = new();
                }
            }
            
            return result;
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to load patients: {ex.Message}");
            return new PagedResult<User>
            {
                Items = new List<User>(),
                TotalCount = 0,
                PageNumber = (skip / take) + 1,
                PageSize = take
            };
        }
    }
    
    // Keep old method for backward compatibility (not used anymore)
    private async Task<IEnumerable<User>> LoadPatientsAsync(CancellationToken ct)
    {
        // This method is kept for backward compatibility but should not be used
        // The grid now uses LoadPatientsPagedAsync
        return new List<User>();
    }

    /// <summary>
    /// Batch fetch journal entry counts for multiple users (single API call instead of N calls)
    /// </summary>
    private async Task<Dictionary<int, int>> GetJournalEntryCountsBatchAsync(List<int> userIds, CancellationToken ct)
    {
        if (userIds == null || !userIds.Any())
            return new Dictionary<int, int>();

        try
        {
            // Single batch API call instead of N individual calls
            var response = await Http.PostAsJsonAsync("api/journal/counts/batch", userIds, ct);
            response.EnsureSuccessStatusCode();
            var counts = await response.Content.ReadFromJsonAsync<Dictionary<int, int>>(ct);
            return counts ?? userIds.ToDictionary(id => id, _ => 0);
        }
        catch
        {
            // Return zero counts for all users on error
            return userIds.ToDictionary(id => id, _ => 0);
        }
    }

    private async Task OnRowExpand(User user)
    {
        try
        {
            if (!expandedUsers.ContainsKey(user.Id))
            {
                // Load user details and journal entries in parallel to reduce request time
                var userTask = PatientService.GetAsync(user.Id);
                var journalTask = PatientService.GetJournalEntriesAsync(user.Id);
                
                await Task.WhenAll(userTask, journalTask);
                
                var fullUser = await userTask;
                if (fullUser != null)
                {
                    fullUser.JournalEntries = await journalTask;
                    expandedUsers[user.Id] = fullUser;
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to load client case details: {ex.Message}");
        }
    }

    private void ToggleAccidentSection(int userId)
    {
        if (expandedAccidentSections.Contains(userId))
        {
            expandedAccidentSections.Remove(userId);
        }
        else
        {
            expandedAccidentSections.Add(userId);
        }
        StateHasChanged();
    }

    private void ToggleLeadIntakeSection(int userId)
    {
        if (expandedLeadIntakeSections.Contains(userId))
        {
            expandedLeadIntakeSections.Remove(userId);
        }
        else
        {
            expandedLeadIntakeSections.Add(userId);
        }
        StateHasChanged();
    }

    private void ToggleClientDetailsSection(int userId)
    {
        if (expandedClientDetailsSections.Contains(userId))
        {
            expandedClientDetailsSections.Remove(userId);
        }
        else
        {
            expandedClientDetailsSections.Add(userId);
        }
        StateHasChanged();
    }
    
    private void ShowEditPatientLeadIntakeDialog(User user)
    {
        selectedUserForLeadIntakeEdit = user;
        editLeadIntakeResidenceStateCode = user.ResidenceStateCode;
        editLeadIntakeAccidentStateCode = user.AccidentStateCode;
        editLeadIntakeParticipantRoleId = user.AccidentParticipantRoleId;
        editLeadIntakeVehicleDispositionId = user.VehicleDispositionId;
        editLeadIntakeTransportToCareMethodId = user.TransportToCareMethodId;
        editLeadIntakeMedicalAttentionTypeId = user.MedicalAttentionTypeId;
        editLeadIntakePoliceInvolvement = user.PoliceInvolvement;
        editLeadIntakeLostConsciousness = user.LostConsciousness;
        editLeadIntakeNeuroSymptoms = user.NeuroSymptoms;
        editLeadIntakeMusculoskeletalSymptoms = user.MusculoskeletalSymptoms;
        editLeadIntakePsychologicalSymptoms = user.PsychologicalSymptoms;
        editLeadIntakeSymptomsNotes = user.SymptomsNotes ?? "";
        editLeadIntakeInsuranceContacted = user.InsuranceContacted;
        editLeadIntakeRepresentedByAttorney = user.RepresentedByAttorney;
        showEditPatientLeadIntakeDialog = true;
    }
    
    private async Task SavePatientLeadIntake()
    {
        if (selectedUserForLeadIntakeEdit == null) return;
        
        try
        {
            isSavingLeadIntake = true;
            StateHasChanged();
            
            var updateRequest = new
            {
                ResidenceStateCode = editLeadIntakeResidenceStateCode,
                AccidentStateCode = editLeadIntakeAccidentStateCode,
                AccidentParticipantRoleId = editLeadIntakeParticipantRoleId,
                VehicleDispositionId = editLeadIntakeVehicleDispositionId,
                TransportToCareMethodId = editLeadIntakeTransportToCareMethodId,
                MedicalAttentionTypeId = editLeadIntakeMedicalAttentionTypeId,
                PoliceInvolvement = editLeadIntakePoliceInvolvement,
                LostConsciousness = editLeadIntakeLostConsciousness,
                NeuroSymptoms = editLeadIntakeNeuroSymptoms,
                MusculoskeletalSymptoms = editLeadIntakeMusculoskeletalSymptoms,
                PsychologicalSymptoms = editLeadIntakePsychologicalSymptoms,
                SymptomsNotes = editLeadIntakeSymptomsNotes,
                InsuranceContacted = editLeadIntakeInsuranceContacted,
                RepresentedByAttorney = editLeadIntakeRepresentedByAttorney
            };
            
            // Add authorization header
            Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", AuthService.Token);
            
            var response = await Http.PutAsJsonAsync($"api/admin/update-patient/{selectedUserForLeadIntakeEdit.Id}/lead-intake", updateRequest);
            
            if (response.IsSuccessStatusCode)
            {
                NotificationService.ShowSuccess("Lead intake information updated successfully");
                showEditPatientLeadIntakeDialog = false;
                
                // Reload the patient data to get updated information, but keep the row expanded
                var userId = selectedUserForLeadIntakeEdit.Id;
                var updatedUser = await PatientService.GetAsync(userId);
                if (updatedUser != null)
                {
                    // Load journal entries if they were previously loaded
                    if (expandedUsers.ContainsKey(userId) && expandedUsers[userId].JournalEntries != null && expandedUsers[userId].JournalEntries.Any())
                    {
                        updatedUser.JournalEntries = await PatientService.GetJournalEntriesAsync(userId);
                    }
                    else
                    {
                        updatedUser.JournalEntries = new();
                    }
                    
                    // Update the expanded user data in place
                    expandedUsers[userId] = updatedUser;
                    
                    // Update the grid row in place
                    if (_grid != null)
                    {
                        try
                        {
                            await _grid.UpdateRowAsync(updatedUser, (user) => user.Id);
                        }
                        catch
                        {
                            // Fallback: just refresh the expanded row data
                            StateHasChanged();
                        }
                    }
                    else
                    {
                        StateHasChanged();
                    }
                }
                
                selectedUserForLeadIntakeEdit = null;
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                NotificationService.ShowError($"Failed to update lead intake information: {errorContent}");
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Error updating lead intake information: {ex.Message}");
        }
        finally
        {
            isSavingLeadIntake = false;
            StateHasChanged();
        }
    }
    
    private string GetStateName(string? stateCode)
    {
        if (string.IsNullOrEmpty(stateCode)) return "";
        return states.FirstOrDefault(s => s.Code == stateCode)?.Name ?? stateCode;
    }
    
    private string GetAccidentParticipantRoleLabel(int roleId)
    {
        return accidentParticipantRoles.FirstOrDefault(r => r.Id == roleId)?.Label ?? $"Role {roleId}";
    }
    
    private string GetVehicleDispositionLabel(int dispositionId)
    {
        return vehicleDispositions.FirstOrDefault(d => d.Id == dispositionId)?.Label ?? $"Disposition {dispositionId}";
    }
    
    private string GetTransportToCareMethodLabel(int methodId)
    {
        return transportToCareMethods.FirstOrDefault(m => m.Id == methodId)?.Label ?? $"Method {methodId}";
    }
    
    private string GetMedicalAttentionTypeLabel(int typeId)
    {
        return medicalAttentionTypes.FirstOrDefault(t => t.Id == typeId)?.Label ?? $"Type {typeId}";
    }
    
    private string GetSymptomOngoingStatusLabel(int statusId)
    {
        return symptomOngoingStatuses.FirstOrDefault(s => s.Id == statusId)?.Label ?? $"Status {statusId}";
    }

    private async Task ClearFilters()
    {
        selectedStatusFilter = null;
        selectedJournalFilter = null;
        if (_grid != null)
        {
            await _grid.RefreshAsync();
        }
    }



    private void ShowAddPatientForm()
    {
        editingUser = null;
        patientForm = new CreatePatientRequest { DateOfBirth = DateTime.Now.AddYears(-25) };
        showPatientForm = true;
        StateHasChanged();
    }

    private async Task EditUserAsync(User user, CancellationToken ct)
    {
        if (user == null) return;
        
        editingUser = user;
        _originalUser = user; // Store original for dirty field detection
        patientForm = new CreatePatientRequest
        {
            FirstName = user.FirstName ?? string.Empty,
            LastName = user.LastName ?? string.Empty,
            Email = user.Email ?? string.Empty,
            DateOfBirth = user.DateOfBirth,
            Gender = user.Gender ?? string.Empty,
            MobilePhone = user.MobilePhone ?? string.Empty
        };
        showPatientForm = true;
        StateHasChanged();
    }

    private void ClosePatientForm()
    {
        showPatientForm = false;
        editingUser = null;
        patientForm = new CreatePatientRequest();
    }

    private async Task SavePatient()
    {
        if (string.IsNullOrWhiteSpace(patientForm.FirstName) || 
            string.IsNullOrWhiteSpace(patientForm.LastName) || 
            string.IsNullOrWhiteSpace(patientForm.Email))
        {
            NotificationService.ShowWarning("Please fill in all required fields.");
            return;
        }

        if (editingUser == null && string.IsNullOrWhiteSpace(patientForm.Password))
        {
            NotificationService.ShowWarning("Password is required for new patients.");
            return;
        }

        try
        {
            isSaving = true;
            
            if (editingUser == null)
            {
                await PatientService.CreateAsync(patientForm);
                NotificationService.ShowSuccess("Client added successfully!");
                if (_grid != null)
                {
                    await _grid.RefreshAsync();
                }
                ClosePatientForm(); // Only close on success
            }
            else
            {
                var updateRequest = new UpdatePatientRequest();
                
                if (_originalUser != null)
                {
                    if (!string.IsNullOrWhiteSpace(patientForm.FirstName) && patientForm.FirstName != (_originalUser.FirstName ?? string.Empty))
                    {
                        updateRequest.FirstName = patientForm.FirstName;
                    }
                    
                    if (!string.IsNullOrWhiteSpace(patientForm.LastName) && patientForm.LastName != (_originalUser.LastName ?? string.Empty))
                    {
                        updateRequest.LastName = patientForm.LastName;
                    }
                    
                    if (!string.IsNullOrWhiteSpace(patientForm.Email) && patientForm.Email != (_originalUser.Email ?? string.Empty))
                    {
                        updateRequest.Email = patientForm.Email;
                    }
                    
                    // Always include DateOfBirth if it's been set (not DateTime.MinValue)
                    // Compare dates by date component only (ignore time) to handle timezone issues
                    var originalDate = _originalUser.DateOfBirth.Date;
                    var formDate = patientForm.DateOfBirth.Date;
                    if (formDate != originalDate || (formDate != DateTime.MinValue.Date && originalDate == DateTime.MinValue.Date))
                    {
                        updateRequest.DateOfBirth = patientForm.DateOfBirth;
                    }
                    
                    if (!string.IsNullOrWhiteSpace(patientForm.Gender) && patientForm.Gender != (_originalUser.Gender ?? string.Empty))
                    {
                        updateRequest.Gender = patientForm.Gender;
                    }
                    
                    if (patientForm.MobilePhone != (_originalUser.MobilePhone ?? string.Empty))
                    {
                        updateRequest.MobilePhone = patientForm.MobilePhone;
                    }
                    
                    if (!string.IsNullOrWhiteSpace(patientForm.Password))
                    {
                        updateRequest.Password = patientForm.Password;
                    }
                }

                var updatedPatient = await PatientService.UpdateAsync(editingUser.Id, updateRequest);
                NotificationService.ShowSuccess("Client updated successfully!");
                
                // Update only the specific row instead of reloading the entire grid
                if (_grid != null)
                {
                    try
                    {
                        // Update the row in place with the returned updated patient
                        await _grid.UpdateRowAsync(updatedPatient, (user) => user.Id);
                    }
                    catch
                    {
                        // Fallback to full refresh on error
                        await _grid.RefreshAsync();
                    }
                }
                ClosePatientForm(); // Only close on success
            }
        }
        catch (HttpRequestException ex)
        {
            // Extract error message from exception data if available
            var errorMessage = ex.Message;
            if (ex.Data.Contains("ErrorContent"))
            {
                errorMessage = ex.Data["ErrorContent"]?.ToString() ?? errorMessage;
            }
            NotificationService.ShowError(errorMessage);
            // Don't close dialog on error - keep it open so user can fix the issue
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to save client: {ex.Message}");
            // Don't close dialog on error - keep it open so user can fix the issue
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task ViewUserDetailsAsync(User user, CancellationToken ct)
    {
        if (user == null) return;
        
        selectedUser = user;
        showPatientDetails = true;
        StateHasChanged();
    }

    private void ClosePatientDetails()
    {
        showPatientDetails = false;
        selectedUser = null;
    }

    private async Task ViewUserStatsAsync(User user, CancellationToken ct)
    {
        if (user == null) return;
        
        try
        {
            selectedUser = user;
            userStats = await PatientService.GetStatsAsync(user.Id, ct);
            showPatientStats = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to load client stats: {ex.Message}");
        }
    }

    private void ClosePatientStats()
    {
        showPatientStats = false;
        selectedUser = null;
        userStats = null;
    }
    
    private void ShowEditPatientAccidentInfoDialog(User user)
    {
        selectedUserForAccidentEdit = user;
        editPatientAge = user.Age;
        editPatientRace = user.Race ?? "";
        editPatientAccidentAddress = user.AccidentAddress ?? "";
        editPatientAccidentDate = user.AccidentDate;
        editPatientVehicleDetails = user.VehicleDetails ?? "";
        editPatientDateReported = user.DateReported;
        editPatientPoliceCaseNumber = user.PoliceCaseNumber ?? "";
        editPatientAccidentDetails = user.AccidentDetails ?? "";
        editPatientRoadConditions = user.RoadConditions ?? "";
        editPatientDoctorsInformation = user.DoctorsInformation ?? "";
        editPatientLawyersInformation = user.LawyersInformation ?? "";
        editPatientAdditionalNotes = user.AdditionalNotes ?? "";
        editPatientPoliceInvolvement = user.PoliceInvolvement;
        
        // New fields from Script121525.sql
        editPatientSymptomOngoingStatusId = user.SymptomOngoingStatusId;
        editPatientLostConsciousness = user.LostConsciousness;
        editPatientNeuroSymptoms = user.NeuroSymptoms;
        editPatientMusculoskeletalSymptoms = user.MusculoskeletalSymptoms;
        editPatientPsychologicalSymptoms = user.PsychologicalSymptoms;
        editPatientSymptomsNotes = user.SymptomsNotes ?? "";
        editPatientInsuranceContacted = user.InsuranceContacted;
        editPatientRepresentedByAttorney = user.RepresentedByAttorney;
        editPatientSymptomsHeadaches = user.SymptomsHeadaches;
        editPatientSymptomsDizziness = user.SymptomsDizziness;
        editPatientSymptomsNeckPain = user.SymptomsNeckPain;
        editPatientSymptomsBackPain = user.SymptomsBackPain;
        editPatientSymptomsJointPain = user.SymptomsJointPain;
        editPatientSymptomsNumbnessTingling = user.SymptomsNumbnessTingling;
        editPatientWentToEmergencyRoom = user.WentToEmergencyRoom;
        editPatientERHospitalName = user.ERHospitalName ?? "";
        editPatientERVisitDate = user.ERVisitDate;
        editPatientTreatingInjurySpecialist = user.TreatingInjurySpecialist;
        editPatientInjurySpecialistDetails = user.InjurySpecialistDetails ?? "";
        editPatientInsuranceAdjusterContacted = user.InsuranceAdjusterContacted;
        editPatientProvidedRecordedStatement = user.ProvidedRecordedStatement;
        editPatientReceivedSettlementOffer = user.ReceivedSettlementOffer;
        editPatientSettlementOfferAmount = user.SettlementOfferAmount;
        editPatientClaimInsuranceCompany = user.ClaimInsuranceCompany ?? "";
        editPatientSignedDocumentsRelatedToAccident = user.SignedDocumentsRelatedToAccident;
        editPatientSignedDocumentsNotes = user.SignedDocumentsNotes ?? "";
        editPatientAttorneyName = user.AttorneyName ?? "";
        editPatientAttorneyFirm = user.AttorneyFirm ?? "";
        editPatientVehicleCurrentLocation = user.VehicleCurrentLocation ?? "";
        editPatientInsuranceEstimateCompleted = user.InsuranceEstimateCompleted;
        editPatientEstimatedRepairAmount = user.EstimatedRepairAmount;
        editPatientVehicleTotalLoss = user.VehicleTotalLoss;
        editPatientMissedWork = user.MissedWork;
        editPatientMissedWorkDays = user.MissedWorkDays;
        editPatientWorkingWithRestrictions = user.WorkingWithRestrictions;
        editPatientWorkRestrictionDetails = user.WorkRestrictionDetails ?? "";
        editPatientDailyActivitiesAffected = user.DailyActivitiesAffected;
        editPatientDailyActivitiesNotes = user.DailyActivitiesNotes ?? "";
        showEditPatientAccidentInfoDialog = true;
    }
    
    private async Task SavePatientAccidentInfo()
    {
        if (selectedUserForAccidentEdit == null) return;
        
        try
        {
            isSavingAccidentInfo = true;
            StateHasChanged();
            
            var updateRequest = new
            {
                Age = editPatientAge,
                Race = editPatientRace,
                AccidentAddress = editPatientAccidentAddress,
                AccidentDate = editPatientAccidentDate,
                VehicleDetails = editPatientVehicleDetails,
                DateReported = editPatientDateReported,
                PoliceCaseNumber = editPatientPoliceCaseNumber,
                AccidentDetails = editPatientAccidentDetails,
                RoadConditions = editPatientRoadConditions,
                DoctorsInformation = editPatientDoctorsInformation,
                LawyersInformation = editPatientLawyersInformation,
                AdditionalNotes = editPatientAdditionalNotes,
                PoliceInvolvement = editPatientPoliceInvolvement,
                // New fields from Script121525.sql
                SymptomOngoingStatusId = editPatientSymptomOngoingStatusId,
                LostConsciousness = editPatientLostConsciousness,
                NeuroSymptoms = editPatientNeuroSymptoms,
                MusculoskeletalSymptoms = editPatientMusculoskeletalSymptoms,
                PsychologicalSymptoms = editPatientPsychologicalSymptoms,
                SymptomsNotes = editPatientSymptomsNotes,
                InsuranceContacted = editPatientInsuranceContacted,
                RepresentedByAttorney = editPatientRepresentedByAttorney,
                SymptomsHeadaches = editPatientSymptomsHeadaches,
                SymptomsDizziness = editPatientSymptomsDizziness,
                SymptomsNeckPain = editPatientSymptomsNeckPain,
                SymptomsBackPain = editPatientSymptomsBackPain,
                SymptomsJointPain = editPatientSymptomsJointPain,
                SymptomsNumbnessTingling = editPatientSymptomsNumbnessTingling,
                WentToEmergencyRoom = editPatientWentToEmergencyRoom,
                ERHospitalName = editPatientERHospitalName,
                ERVisitDate = editPatientERVisitDate,
                TreatingInjurySpecialist = editPatientTreatingInjurySpecialist,
                InjurySpecialistDetails = editPatientInjurySpecialistDetails,
                InsuranceAdjusterContacted = editPatientInsuranceAdjusterContacted,
                ProvidedRecordedStatement = editPatientProvidedRecordedStatement,
                ReceivedSettlementOffer = editPatientReceivedSettlementOffer,
                SettlementOfferAmount = editPatientSettlementOfferAmount,
                ClaimInsuranceCompany = editPatientClaimInsuranceCompany,
                SignedDocumentsRelatedToAccident = editPatientSignedDocumentsRelatedToAccident,
                SignedDocumentsNotes = editPatientSignedDocumentsNotes,
                AttorneyName = editPatientAttorneyName,
                AttorneyFirm = editPatientAttorneyFirm,
                VehicleCurrentLocation = editPatientVehicleCurrentLocation,
                InsuranceEstimateCompleted = editPatientInsuranceEstimateCompleted,
                EstimatedRepairAmount = editPatientEstimatedRepairAmount,
                VehicleTotalLoss = editPatientVehicleTotalLoss,
                MissedWork = editPatientMissedWork,
                MissedWorkDays = editPatientMissedWorkDays,
                WorkingWithRestrictions = editPatientWorkingWithRestrictions,
                WorkRestrictionDetails = editPatientWorkRestrictionDetails,
                DailyActivitiesAffected = editPatientDailyActivitiesAffected,
                DailyActivitiesNotes = editPatientDailyActivitiesNotes
            };
            
            // Add authorization header
            Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", AuthService.Token);
            
            var response = await Http.PutAsJsonAsync($"api/admin/update-patient/{selectedUserForAccidentEdit.Id}/accident-info", updateRequest);
            
            if (response.IsSuccessStatusCode)
            {
                NotificationService.ShowSuccess("Accident information updated successfully");
                showEditPatientAccidentInfoDialog = false;
                
                // Reload the patient data to get updated information, but keep the row expanded
                var userId = selectedUserForAccidentEdit.Id;
                var updatedUser = await PatientService.GetAsync(userId);
                if (updatedUser != null)
                {
                    // Load journal entries if they were previously loaded
                    if (expandedUsers.ContainsKey(userId) && expandedUsers[userId].JournalEntries != null && expandedUsers[userId].JournalEntries.Any())
                    {
                        updatedUser.JournalEntries = await PatientService.GetJournalEntriesAsync(userId);
                    }
                    else
                    {
                        updatedUser.JournalEntries = new();
                    }
                    
                    // Update the expanded user data in place
                    expandedUsers[userId] = updatedUser;
                    
                    // Update the grid row in place
                    if (_grid != null)
                    {
                        try
                        {
                            await _grid.UpdateRowAsync(updatedUser, (user) => user.Id);
                        }
                        catch
                        {
                            // Fallback: just refresh the expanded row data
                            StateHasChanged();
                        }
                    }
                    else
                    {
                        StateHasChanged();
                    }
                }
                
                selectedUserForAccidentEdit = null;
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                NotificationService.ShowError($"Failed to update accident information: {errorContent}");
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Error updating accident information: {ex.Message}");
        }
        finally
        {
            isSavingAccidentInfo = false;
            StateHasChanged();
        }
    }

    private async Task PerformAiHealthCheckAsync(User user, CancellationToken ct)
    {
        if (user == null)
        {
            return;
        }
        
        try
        {
            isPerformingHealthCheck = true;
            StateHasChanged();
            
            NotificationService.ShowInfo($"Analyzing {user.FirstName} {user.LastName}'s health status...");
            
            var result = await PatientService.PerformAiHealthCheckAsync(user.Id, ct);
            
            if (result == null)
            {
                NotificationService.ShowError("AI Health Check returned no result. Please check server logs.");
                return;
            }
            
            if (result.Success)
            {
                // Store result for viewing in a dialog
                currentHealthCheckResult = result;
                currentHealthCheckPatient = user; // Store patient for sending alerts
                showHealthCheckDialog = true;
                
                StateHasChanged();
                
                // Show brief notification
                if (result.Severity == "High")
                {
                    var warningMsg = $"⚠️ {result.Message}";
                    NotificationService.ShowWarning(warningMsg, 8000); // 8 seconds
                }
                else if (result.Severity == "Normal" || result.Severity == "Low")
                {
                    var successMsg = $"✅ {result.Message}";
                    NotificationService.ShowSuccess(successMsg, 6000); // 6 seconds
                }
                else
                {
                    var infoMsg = $"ℹ️ {result.Message}";
                    NotificationService.ShowInfo(infoMsg, 6000); // 6 seconds
                }
            }
            else
            {
                NotificationService.ShowError($"AI Health Check failed: {result.Message}");
                StateHasChanged();
            }
        }
        catch (HttpRequestException httpEx)
        {
            var errorMsg = httpEx.Message;
            if (httpEx.Data.Contains("StatusCode"))
            {
                errorMsg = $"HTTP Error: {httpEx.Data["StatusCode"]} - {errorMsg}";
            }
            NotificationService.ShowError($"AI Health Check failed: {errorMsg}");
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"AI Health Check failed: {ex.Message}");
        }
        finally
        {
            isPerformingHealthCheck = false;
            StateHasChanged();
        }
    }

    private async Task DeactivateUserAsync(User user, CancellationToken ct)
    {
        if (user == null) return;
        
        try
        {
            await PatientService.DeleteAsync(user.Id, ct);
            NotificationService.ShowSuccess("Client deactivated successfully!");
            if (_grid != null)
            {
                await _grid.RefreshAsync();
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to deactivate client: {ex.Message}");
        }
    }

    private async Task ReactivateUserAsync(User user, CancellationToken ct)
    {
        if (user == null) return;
        
        try
        {
            user.IsActive = true;
            var updatedUser = await PatientService.UpdateAsync(user.Id, new UpdatePatientRequest
            {
                FirstName = user.FirstName,
                LastName = user.LastName,
                Email = user.Email,
                DateOfBirth = user.DateOfBirth,
                Gender = user.Gender,
                MobilePhone = user.MobilePhone
            }, ct);
            
            NotificationService.ShowSuccess("Client reactivated successfully!");
            if (_grid != null)
            {
                await _grid.RefreshAsync();
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to reactivate client: {ex.Message}");
        }
    }

    private async Task ShowAssignPatientModalAsync(User user, CancellationToken ct)
    {
        if (user == null) return;
        
        try
        {
            selectedUser = user;
            selectedDoctorId = 0;
            
            // Load assigners based on current user's role
            if (AuthService.CurrentUser?.RoleId == 2) // Doctor - can assign to doctors or attorneys
            {
                var doctors = await PatientService.GetDoctorsAsync(ct);
                var attorneys = await Http.GetFromJsonAsync<List<User>>("api/admin/attorneys") ?? new List<User>();
                availableDoctors = doctors.Concat(attorneys).ToList();
            }
            else if (AuthService.CurrentUser?.RoleId == 4) // Coordinator - can assign to doctors or attorneys
            {
                var doctors = await PatientService.GetDoctorsAsync(ct);
                var attorneys = await Http.GetFromJsonAsync<List<User>>("api/admin/attorneys") ?? new List<User>();
                availableDoctors = doctors.Concat(attorneys).ToList();
            }
            else if (AuthService.CurrentUser?.RoleId == 5) // Attorney - can only assign to other attorneys
            {
                availableDoctors = await Http.GetFromJsonAsync<List<User>>("api/admin/attorneys") ?? new List<User>();
            }
            
            if (AuthService.CurrentUser?.Id != null)
            {
                availableDoctors = availableDoctors.Where(d => d.Id != AuthService.CurrentUser.Id).ToList();
            }
            
            showAssignModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to load assigners: {ex.Message}");
        }
    }

    private void CloseAssignModal()
    {
        showAssignModal = false;
        selectedUser = null;
        selectedDoctorId = 0;
        availableDoctors.Clear();
        StateHasChanged();
    }

    private async Task AssignPatientToDoctor()
    {
        if (selectedUser == null || selectedDoctorId == 0)
        {
            NotificationService.ShowWarning("Please select an SME to assign the client to.");
            return;
        }

        try
        {
            isAssigning = true;
            
            // Use different endpoint based on role
            if (AuthService.CurrentUser?.RoleId == 4 || AuthService.CurrentUser?.RoleId == 5) // Coordinator or Attorney
            {
                var request = new AssignPatientRequest
                {
                    PatientId = selectedUser.Id,
                    DoctorId = selectedDoctorId
                };
                var response = await Http.PostAsJsonAsync("api/admin/assign", request);
                if (!response.IsSuccessStatusCode)
                {
                    var errorContent = await response.Content.ReadAsStringAsync();
                    throw new Exception(errorContent);
                }
            }
            else // Doctor
            {
                var request = new DoctorAssignPatientRequest
                {
                    PatientId = selectedUser.Id,
                    ToDoctorId = selectedDoctorId
                };
                await PatientService.AssignToDoctorAsync(request);
            }
            
            // Determine assigner type based on selected assigner's role
            var selectedAssigner = availableDoctors.FirstOrDefault(d => d.Id == selectedDoctorId);
            var assignerType = selectedAssigner?.RoleId == 5 ? "attorney" : "doctor";
            NotificationService.ShowSuccess($"Client assigned to {assignerType} successfully!");
            CloseAssignModal();
            if (_grid != null)
            {
                await _grid.RefreshAsync();
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Error assigning client: {ex.Message}");
        }
        finally
        {
            isAssigning = false;
        }
    }

    private void ShowUnassignConfirmation(User user)
    {
        if (user == null) return;
        
        selectedUser = user;
        showUnassignConfirmation = true;
        StateHasChanged();
    }

    private void CloseUnassignConfirmation()
    {
        showUnassignConfirmation = false;
        selectedUser = null;
        StateHasChanged();
    }

    private string GetSourceTypeIcon(string sourceType)
    {
        return sourceType switch
        {
            "JournalEntry" => "📝",
            "ClinicalNote" => "📋",
            "Content" => "📄",
            "Emergency" => "🚨",
            "ChatSession" => "💬",
            _ => "📌"
        };
    }

    private string GetSourceTypeBadgeClass(string sourceType)
    {
        // All severity-causing sources should be marked in red/warning
        return "bg-danger text-white";
    }

    private async Task NavigateToSource(SeveritySource source)
    {
        // Store the source ID in a way that the target page can use to highlight it
        // For now, navigate to the page - we can enhance this later to scroll to the specific item
        var route = source.NavigationRoute;
        
        // Add query parameter to identify the source
        var uri = $"{route}?sourceId={source.SourceId}&sourceType={source.SourceType}";
        Navigation.NavigateTo(uri);
        
        // Close the health check dialog
        CloseHealthCheckDialog();
    }

    private async Task MarkSourceAsIgnored(SeveritySource source)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            $"Are you sure you want to mark this {source.SourceType} as not applicable for AI analysis? This will exclude it from future health checks.");
        
        if (!confirmed)
            return;

        try
        {
            var endpoint = source.SourceType switch
            {
                "JournalEntry" => $"api/journal/entry/{source.SourceId}/toggle-ignore",
                "ClinicalNote" => $"api/clinicalnotes/{source.SourceId}/toggle-ignore", // Fixed: was clinical-notes, should be clinicalnotes
                "Content" => $"api/content/{source.SourceId}/toggle-ignore",
                "Emergency" => $"api/emergency/acknowledge/{source.SourceId}", // Acknowledge instead of ignore
                "ChatSession" => $"api/chathistory/sessions/{source.SourceId}/toggle-ignore", // Fixed: was chat-history, should be chathistory
                _ => null
            };

            if (endpoint == null)
            {
                NotificationService.ShowWarning("Unable to mark this source type as ignored.");
                return;
            }

            // For emergency incidents, we need to send AcknowledgeRequest body
            HttpResponseMessage response;
            if (source.SourceType == "Emergency")
            {
                var currentUserId = AuthService.CurrentUser?.Id ?? 0;
                var acknowledgeRequest = new
                {
                    DoctorId = currentUserId,
                    Response = "Marked as not applicable for AI analysis",
                    ActionTaken = "Excluded from health check"
                };
                response = await Http.PostAsJsonAsync(endpoint, acknowledgeRequest);
            }
            else
            {
                // For other source types, send empty body
                var token = AuthService.Token;
                var request = new HttpRequestMessage(HttpMethod.Post, endpoint);
                
                if (!string.IsNullOrEmpty(token))
                {
                    request.Headers.Authorization = 
                        new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
                }
                
                request.Content = new StringContent("", System.Text.Encoding.UTF8, "application/json");
                response = await Http.SendAsync(request);
            }
            
            if (response.IsSuccessStatusCode)
            {
                var responseContent = await response.Content.ReadAsStringAsync();
                NotificationService.ShowSuccess($"{source.SourceType} marked as not applicable. It will be excluded from future AI health checks.");
                
                // Remove from the current list
                if (currentHealthCheckResult?.SeveritySources != null)
                {
                    currentHealthCheckResult.SeveritySources.Remove(source);
                    await InvokeAsync(StateHasChanged);
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                NotificationService.ShowError($"Failed to mark source as ignored: {response.StatusCode}. Please try again.");
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Error: {ex.Message}");
        }
    }

    private async Task CloseHealthCheckDialog()
    {
        showHealthCheckDialog = false;
        currentHealthCheckResult = null;
        currentHealthCheckPatient = null;
        await InvokeAsync(StateHasChanged);
    }

    private async Task SendAlertsToDoctors()
    {
        if (currentHealthCheckPatient == null || currentHealthCheckResult == null)
        {
            NotificationService.ShowError("Cannot send alerts: Client information not available");
            return;
        }

        try
        {
            isSendingAlerts = true;
            StateHasChanged();

            var success = await PatientService.SendAiHealthAlertsAsync(currentHealthCheckPatient.Id);

            if (success)
            {
                // Update the result to show alerts were sent
                if (currentHealthCheckResult != null)
                {
                    currentHealthCheckResult.AlertsSent = currentHealthCheckResult.DoctorsNotified;
                }

                NotificationService.ShowSuccess($"Alerts sent to {currentHealthCheckResult?.DoctorsNotified ?? 0} doctor(s)");
                StateHasChanged();
            }
            else
            {
                NotificationService.ShowError("Failed to send alerts. Please try again.");
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Error sending alerts: {ex.Message}");
        }
        finally
        {
            isSendingAlerts = false;
            StateHasChanged();
        }
    }

    private async Task ConfirmUnassignPatient()
    {
        if (selectedUser == null)
        {
            return;
        }

        try
        {
            isUnassigning = true;
            
            // Use different endpoint based on role
            if (AuthService.CurrentUser?.RoleId == 5) // Attorney - use admin endpoint
            {
                if (AuthService.CurrentUser == null || AuthService.CurrentUser.Id == 0)
                {
                    NotificationService.ShowError("Unable to identify current user.");
                    return;
                }
                
                var request = new UnassignPatientRequest
                {
                    PatientId = selectedUser.Id,
                    DoctorId = AuthService.CurrentUser.Id
                };
                var response = await Http.SendAsync(new HttpRequestMessage(HttpMethod.Delete, "api/admin/unassign")
                {
                    Content = JsonContent.Create(request)
                });
                if (!response.IsSuccessStatusCode)
                {
                    var errorContent = await response.Content.ReadAsStringAsync();
                    throw new Exception(errorContent);
                }
            }
            else // Doctor - use doctor endpoint
            {
                var request = new DoctorUnassignPatientRequest
                {
                    PatientId = selectedUser.Id
                };
                await PatientService.UnassignFromDoctorAsync(request);
            }
            
            NotificationService.ShowSuccess("Client unassigned from you successfully!");
            CloseUnassignConfirmation();
            if (_grid != null)
            {
                await _grid.RefreshAsync();
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Error unassigning client: {ex.Message}");
        }
        finally
        {
            isUnassigning = false;
        }
    }

    private async Task ShowUnassignFromDoctorModalAsync(User user, CancellationToken ct)
    {
        if (user == null) return;
        
        try
        {
            selectedUser = user;
            
            // Get all assigners (doctors and coordinators) for this patient
            var response = await Http.GetAsync($"api/admin/patient/{user.Id}/doctors");
            if (!response.IsSuccessStatusCode)
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                NotificationService.ShowError($"Failed to load assigners: {response.StatusCode} - {errorContent}");
                return;
            }
            
            var assignersResponse = await response.Content.ReadFromJsonAsync<List<User>>();
            if (assignersResponse != null && assignersResponse.Any())
            {
                assignedDoctorsForUnassign = assignersResponse;
                
                // For Coordinator or Attorney: Check if patient is assigned to them
                if (AuthService.CurrentUser?.RoleId == 4 || AuthService.CurrentUser?.RoleId == 5)
                {
                    var isAssignedToUser = assignedDoctorsForUnassign.Any(a => a.Id == AuthService.CurrentUser.Id);
                    if (!isAssignedToUser)
                    {
                        var roleName = AuthService.CurrentUser?.RoleId == 4 ? "coordinator" : "attorney";
                        NotificationService.ShowWarning($"This client is not assigned to you. You can only unassign patients that are assigned to you.");
                        return;
                    }
                    
                    // For Coordinator or Attorney: Only show themselves in the dropdown (they can only unassign themselves)
                    assignedDoctorsForUnassign = assignedDoctorsForUnassign
                        .Where(a => a.Id == AuthService.CurrentUser.Id)
                        .ToList();
                }
            }
            else
            {
                assignedDoctorsForUnassign = new();
                NotificationService.ShowWarning("This client is not assigned to any doctor or coordinator.");
                return;
            }
            
            selectedDoctorId = assignedDoctorsForUnassign.FirstOrDefault()?.Id ?? 0;
            showUnassignFromDoctorModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to load assigned doctors/coordinators: {ex.Message}");
        }
    }

    private void CloseUnassignFromDoctorModal()
    {
        showUnassignFromDoctorModal = false;
        selectedUser = null;
        selectedDoctorId = 0;
        assignedDoctorsForUnassign.Clear();
        StateHasChanged();
    }

    private async Task UnassignPatientFromDoctor()
    {
        if (selectedUser == null || selectedDoctorId == 0)
        {
            NotificationService.ShowWarning("Please select a SME to unassign the client from.");
            return;
        }

        try
        {
            // For Coordinator or Attorney: Validate that patient has at least one doctor assigned (not just coordinators/attorneys)
            if (AuthService.CurrentUser?.RoleId == 4 || AuthService.CurrentUser?.RoleId == 5)
            {
                // Get all current assigners to check if at least one doctor will remain
                var allAssigners = await Http.GetFromJsonAsync<List<User>>($"api/admin/patient/{selectedUser.Id}/doctors");
                if (allAssigners != null)
                {
                    // Count doctors (excluding the one being unassigned if it's a doctor)
                    var remainingDoctors = allAssigners
                        .Where(a => a.RoleId == 2 && a.Id != selectedDoctorId) // RoleId 2 = Doctor, exclude the one being unassigned
                        .ToList();
                    
                    if (!remainingDoctors.Any())
                    {
                        NotificationService.ShowWarning("This client must be assigned to at least one SME. You cannot unassign yourself if the client will have no SMEs assigned.");
                        return;
                    }
                }
            }
            
            isUnassigning = true;
            
            var request = new UnassignPatientRequest
            {
                PatientId = selectedUser.Id,
                DoctorId = selectedDoctorId
            };

            var response = await Http.SendAsync(new HttpRequestMessage(HttpMethod.Delete, "api/admin/unassign")
            {
                Content = JsonContent.Create(request)
            });

            if (response.IsSuccessStatusCode)
            {
                NotificationService.ShowSuccess("Client unassigned successfully!");
                CloseUnassignFromDoctorModal();
                if (_grid != null)
                {
                    await _grid.RefreshAsync();
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                NotificationService.ShowError($"Failed to unassign client: {errorContent}");
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Error unassigning client: {ex.Message}");
        }
        finally
        {
            isUnassigning = false;
        }
    }

    public class AssignPatientRequest
    {
        public int PatientId { get; set; }
        public int DoctorId { get; set; }
    }

    public class UnassignPatientRequest
    {
        public int PatientId { get; set; }
        public int DoctorId { get; set; }
    }

    public class AssignmentDisplayModel
    {
        public int PatientId { get; set; }
        public string PatientName { get; set; } = string.Empty;
        public string PatientEmail { get; set; } = string.Empty;
        public int DoctorId { get; set; }
        public string DoctorName { get; set; } = string.Empty;
        public string DoctorEmail { get; set; } = string.Empty;
        public string? DoctorSpecialization { get; set; }
        public DateTime AssignedDate { get; set; }
    }
}

<style>
    .action-buttons {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
    }

    .action-buttons .rz-button {
        margin: 2px;
    }

    .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
    }

    .status-badge.active {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .status-badge.inactive {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .badge.badge-info {
        background-color: #d1ecf1;
        color: #0c5460;
    }

    .badge.badge-primary {
        background-color: #cce5ff;
        color: #004085;
    }

    .text-muted {
        color: #6c757d;
        font-size: 12px;
    }

    .grid-info {
        margin-bottom: 15px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border-left: 4px solid #007bff;
    }

    .grid-info i {
        margin-right: 5px;
        color: #007bff;
    }

    .custom-filters {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 15px;
        border: 1px solid #dee2e6;
    }

    .custom-filters .form-label {
        font-weight: 500;
        color: #333;
        margin-bottom: 5px;
    }

    .custom-filters .row {
        margin: 0;
    }

    .custom-filters .col-md-3 {
        padding: 0 10px;
    }

    .assignment-info {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        border-left: 4px solid #007bff;
    }

    .assignment-info p {
        margin: 5px 0;
        color: #333;
    }

    .assignment-info strong {
        color: #007bff;
    }

    .confirmation-warning {
        display: flex;
        align-items: flex-start;
        gap: 15px;
        padding: 20px;
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .warning-icon {
        font-size: 24px;
        color: #f39c12;
        margin-top: 5px;
    }

    .warning-content h4 {
        color: #856404;
        margin-bottom: 15px;
        font-size: 18px;
    }

    .patient-info {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 15px;
        border-left: 4px solid #007bff;
    }

    .patient-info p {
        margin: 5px 0;
        color: #333;
    }

    .patient-info strong {
        color: #007bff;
    }

    .warning-message {
        background-color: #f8d7da;
        padding: 15px;
        border-radius: 5px;
        border-left: 4px solid #dc3545;
    }

    .warning-message p {
        margin: 0;
        color: #721c24;
        font-size: 14px;
        line-height: 1.5;
    }

    .warning-message strong {
        color: #dc3545;
    }

    .btn-danger {
        background-color: #dc3545;
        border-color: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background-color: #c82333;
        border-color: #bd2130;
    }

    /* Form styling */
    .form-row {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
    }

    .form-group {
        flex: 1;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #333;
    }

    .form-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }

    .form-input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    .patient-meta {
        margin-bottom: 20px;
    }

    .meta-row {
        display: flex;
        margin-bottom: 10px;
    }

    .meta-label {
        font-weight: 500;
        color: #666;
        min-width: 120px;
    }

    .meta-value {
        color: #333;
        margin-left: 10px;
    }

    .health-check-results {
        padding: 10px;
    }

    .result-summary {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #007bff;
    }

    .severity-badge {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 1.1em;
        margin-bottom: 10px;
    }

    .severity-high {
        background-color: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
    }

    .severity-normal {
        background-color: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
    }

    .severity-low {
        background-color: #d1ecf1;
        color: #0c5460;
        border-left: 4px solid #17a2b8;
    }

    .ai-analysis-section {
        margin-top: 20px;
        padding: 15px;
        background: #ffffff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
    }

    .ai-analysis-section h5 {
        margin-bottom: 15px;
        color: #2c3e50;
    }

    .ai-response-content {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        border-left: 4px solid #007bff;
        white-space: pre-wrap;
        word-wrap: break-word;
        line-height: 1.6;
        font-size: 0.95em;
        max-height: 400px;
        overflow-y: auto;
    }

    /* Health Check Results Styles (content inside SMModal) */
</style>
