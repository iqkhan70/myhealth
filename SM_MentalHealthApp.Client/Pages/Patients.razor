@page "/users"
@inject HttpClient Http
@inject NotificationService NotificationService
@inject IAuthService AuthService
@inject IPatientService PatientService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@using Microsoft.AspNetCore.Components
@using SM_MentalHealthApp.Shared
@using SM_MentalHealthApp.Client.Services
@using SM_MentalHealthApp.Client.Components.Grid
@using SM_MentalHealthApp.Client.Components.Common
@using SM_MentalHealthApp.Client.Helpers
@using Radzen
@using Radzen.Blazor
@using System.Net.Http

@code {
    // Track original values for dirty field detection
    private User? _originalUser;
}

<div class="users-page">
    <div class="users-header">
        @if (AuthService.CurrentUser?.RoleId == 2) // Doctor
        {
            <h2>My Patients</h2>
            <p>View and manage your assigned users' mental health journey.</p>
        }
        else if (AuthService.CurrentUser?.RoleId == 3) // Admin
        {
            Console.WriteLine("This is at test page");
            <h2>All Patients</h2>
            <p>Manage all patient records and view their mental health journey.</p>
            <button @onclick="ShowAddPatientForm" class="add-patient-btn">
                ‚ûï Add New Patient
            </button>
        }
        else
        {
            <h2>Access Denied</h2>
            <p>You don't have permission to view this page.</p>
        }
    </div>

    @if (AuthService.CurrentUser?.RoleId == 2 || AuthService.CurrentUser?.RoleId == 3) // Doctor or Admin
    {
        <!-- Custom Filters -->
        <div class="custom-filters">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Filter by Status:</label>
                    <RadzenDropDown Data="@statusOptions"
                                   ValueProperty="Value"
                                   TextProperty="Text"
                                   @bind-Value="selectedStatusFilter"
                                   Placeholder="All Statuses"
                                   Style="width: 100%" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Filter by Journal Entries:</label>
                    <RadzenDropDown Data="@journalFilterOptions"
                                   ValueProperty="Value"
                                   TextProperty="Text"
                                   @bind-Value="selectedJournalFilter"
                                   Placeholder="All Patients"
                                   Style="width: 100%" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <div>
                        <RadzenButton Text="Clear Filters" 
                                     ButtonStyle="ButtonStyle.Light" 
                                     Click="@ClearFilters"
                                     Style="width: 100%" />
                    </div>
                </div>
            </div>
        </div>

        <!-- Grid Info -->
        <div class="grid-info">
            <small class="text-muted">
                <i class="fas fa-info-circle"></i>
                Use the filter row below each column header for basic filtering, or use the custom filters above for status and journal entries.
            </small>
        </div>

        <!-- Patients Grid -->
        <div class="users-content">
            <SMDataGrid TItem="User" 
                       Columns="_columns" 
                       Actions="_actions" 
                       ActionsWidth="300px"
                       LoadItems="LoadPatientsAsync" 
                       @ref="_grid" 
                       PageSize="15"
                       OnRowExpandCallback="@OnRowExpand">
                <ExpansionTemplate Context="user">
                    @{
                        var expandedUser = expandedUsers.ContainsKey(user.Id) ? expandedUsers[user.Id] : user;
                    }
                    <div class="p-3">
                        <div class="row">
                            <div class="col-12">
                                <h6>Patient Details</h6>
                                <div class="patient-meta mb-3">
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Name:</strong></span>
                                        <span class="meta-value">@expandedUser.FirstName @expandedUser.LastName</span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Email:</strong></span>
                                        <span class="meta-value">@expandedUser.Email</span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Date of Birth:</strong></span>
                                        <span class="meta-value">@expandedUser.DateOfBirth.ToString("MMM dd, yyyy")</span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Gender:</strong></span>
                                        <span class="meta-value">@(expandedUser.Gender ?? "Not specified")</span>
                                    </div>
                                    @if (!string.IsNullOrEmpty(expandedUser.MobilePhone))
                                    {
                                        <div class="meta-row">
                                            <span class="meta-label"><strong>Mobile Phone:</strong></span>
                                            <span class="meta-value">@expandedUser.MobilePhone</span>
                                        </div>
                                    }
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Status:</strong></span>
                                        <span class="meta-value">
                                            <span class="status-badge @(expandedUser.IsActive ? "active" : "inactive")">
                                                @(expandedUser.IsActive ? "Active" : "Inactive")
                                            </span>
                                        </span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Member Since:</strong></span>
                                        <span class="meta-value">@expandedUser.CreatedAt.ToString("MMM dd, yyyy 'at' h:mm tt")</span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Last Login:</strong></span>
                                        <span class="meta-value">@(expandedUser.LastLoginAt?.ToString("MMM dd, yyyy 'at' h:mm tt") ?? "Never")</span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Journal Entries:</strong></span>
                                        <span class="meta-value">@expandedUser.JournalEntries.Count</span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Chat Sessions:</strong></span>
                                        <span class="meta-value">@expandedUser.ChatSessions.Count</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </ExpansionTemplate>
            </SMDataGrid>
        </div>
    }
</div>

<!-- Add/Edit Patient Modal -->
@if (showPatientForm)
{
    <div class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>@(editingUser == null ? "Add New Patient" : "Edit Patient")</h3>
                <button @onclick="ClosePatientForm" class="close-btn">‚úï</button>
            </div>
            
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>First Name *</label>
                        <input @bind="patientForm.FirstName" class="form-input" />
                    </div>
                    
                    <div class="form-group">
                        <label>Last Name *</label>
                        <input @bind="patientForm.LastName" class="form-input" />
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Email *</label>
                        <input @bind="patientForm.Email" type="email" class="form-input" />
                    </div>
                    
                    <div class="form-group">
                        <label>Password @(editingUser == null ? "*" : "(leave blank to keep current)")</label>
                        <input @bind="patientForm.Password" type="password" class="form-input" />
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Date of Birth *</label>
                        <input @bind="patientForm.DateOfBirth" type="date" class="form-input" />
                    </div>
                    
                    <div class="form-group">
                        <label>Gender</label>
                        <select @bind="patientForm.Gender" class="form-input">
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                            <option value="Prefer not to say">Prefer not to say</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Mobile Phone</label>
                        <input @bind="patientForm.MobilePhone" type="tel" class="form-input" placeholder="+1 (555) 123-4567" />
                    </div>
                    
                    <div class="form-group">
                        <!-- Empty div for layout balance -->
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button @onclick="ClosePatientForm" class="btn btn-secondary">Cancel</button>
                <button @onclick="SavePatient" disabled="@isSaving" class="btn btn-primary">
                    @(isSaving ? "Saving..." : (editingUser == null ? "Add Patient" : "Update Patient"))
                </button>
            </div>
        </div>
    </div>
}

<!-- Patient Details Modal -->
@if (showPatientDetails && selectedUser != null)
{
    <div class="modal-overlay">
        <div class="modal-content patient-details-modal">
            <div class="modal-header">
                <h3>User Details - @selectedUser.FirstName @selectedUser.LastName</h3>
                <button @onclick="ClosePatientDetails" class="close-btn">‚úï</button>
            </div>
            
            <div class="modal-body">
                <div class="patient-details-grid">
                    <div class="detail-section">
                        <h4>Personal Information</h4>
                        <div class="detail-item">
                            <span class="detail-label">Name:</span>
                            <span class="detail-value">@selectedUser.FirstName @selectedUser.LastName</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Email:</span>
                            <span class="detail-value">@selectedUser.Email</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Date of Birth:</span>
                            <span class="detail-value">@selectedUser.DateOfBirth.ToString("MMM dd, yyyy")</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Gender:</span>
                            <span class="detail-value">@(selectedUser.Gender ?? "Not specified")</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Mobile Phone:</span>
                            <span class="detail-value">@(selectedUser.MobilePhone ?? "Not provided")</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Status:</span>
                            <span class="status-badge @(selectedUser.IsActive ? "active" : "inactive")">
                                @(selectedUser.IsActive ? "Active" : "Inactive")
                            </span>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h4>Account Information</h4>
                        <div class="detail-item">
                            <span class="detail-label">Member Since:</span>
                            <span class="detail-value">@selectedUser.CreatedAt.ToString("MMM dd, yyyy 'at' h:mm tt")</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Last Login:</span>
                            <span class="detail-value">@(selectedUser.LastLoginAt?.ToString("MMM dd, yyyy 'at' h:mm tt") ?? "Never")</span>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h4>Activity Summary</h4>
                        <div class="detail-item">
                            <span class="detail-label">Journal Entries:</span>
                            <span class="detail-value">@selectedUser.JournalEntries.Count</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Chat Sessions:</span>
                            <span class="detail-value">@selectedUser.ChatSessions.Count</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button @onclick="ClosePatientDetails" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>
}

<!-- Patient Stats Modal -->
@if (showPatientStats && selectedUser != null && userStats is not null)
{
    <div class="modal-overlay">
        <div class="modal-content patient-stats-modal">
            <div class="modal-header">
                <h3>User Statistics - @selectedUser.FirstName @selectedUser.LastName</h3>
                <button @onclick="ClosePatientStats" class="close-btn">‚úï</button>
            </div>
            
            <div class="modal-body">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>Journal Activity</h4>
                        <div class="stat-value">@userStats.TotalJournalEntries</div>
                        <div class="stat-label">Total Entries</div>
                    </div>
                    
                    <div class="stat-card">
                        <h4>Recent Activity</h4>
                        <div class="stat-value">@userStats.EntriesLast30Days</div>
                        <div class="stat-label">Last 30 Days</div>
                    </div>
                    
                    <div class="stat-card">
                        <h4>Mood Distribution</h4>
                        <div class="mood-stats">
                            @foreach (var mood in userStats.MoodDistribution)
                            {
                                <div class="mood-stat">
                                    <span class="mood-label">@mood.Key:</span>
                                    <span class="mood-count">@mood.Value</span>
                                </div>
                            }
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <h4>Chat Activity</h4>
                        <div class="stat-value">@userStats.TotalChatSessions</div>
                        <div class="stat-label">Chat Sessions</div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button @onclick="ClosePatientStats" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>
}

<!-- Doctor Assignment Modal -->
@if (showAssignModal && selectedUser != null)
{
    <div class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Assign Patient to Another Doctor</h3>
                <button @onclick="CloseAssignModal" class="close-btn">‚úï</button>
            </div>
            
            <div class="modal-body">
                <div class="assignment-info">
                    <p><strong>Patient:</strong> @selectedUser.FirstName @selectedUser.LastName</p>
                    <p><strong>Email:</strong> @selectedUser.Email</p>
                </div>
                
                <div class="form-group">
                    <label>Select Doctor to Assign To:</label>
                    <RadzenDropDown Data="@availableDoctors"
                                   ValueProperty="Id"
                                   TextProperty="FullName"
                                   @bind-Value="selectedDoctorId"
                                   Placeholder="Choose a doctor..."
                                   Style="width: 100%" />
                </div>
            </div>
            
            <div class="modal-footer">
                <button @onclick="CloseAssignModal" class="btn btn-secondary">Cancel</button>
                <button @onclick="AssignPatientToDoctor" disabled="@isAssigning" class="btn btn-primary">
                    @(isAssigning ? "Assigning..." : "Assign Patient")
                </button>
            </div>
        </div>
    </div>
}

<!-- AI Health Check Results Dialog -->
@if (showHealthCheckDialog && currentHealthCheckResult != null)
{
    <div class="modal-overlay health-check-modal-overlay" style="display: block !important; z-index: 9999 !important;">
        <div class="modal-content health-check-modal-content">
            <div class="modal-header health-check-modal-header">
                <h3>üß† AI Health Check Analysis</h3>
                <button @onclick="CloseHealthCheckDialog" class="close-btn">‚úï</button>
            </div>
            
            <div class="modal-body health-check-modal-body">
                <div class="health-check-results">
                    <div class="result-summary mb-3">
                        <div class="severity-badge @(currentHealthCheckResult.Severity == "High" ? "severity-high" : currentHealthCheckResult.Severity == "Normal" ? "severity-normal" : "severity-low")">
                            <strong>Severity: @currentHealthCheckResult.Severity</strong>
                        </div>
                        <p class="mt-2"><strong>Status:</strong> @currentHealthCheckResult.Message</p>
                        @if (currentHealthCheckResult.AlertsSent > 0)
                        {
                            <p><strong>Alerts Sent:</strong> @currentHealthCheckResult.AlertsSent doctor(s) notified</p>
                        }
                    </div>
                    
                    @if (!string.IsNullOrEmpty(currentHealthCheckResult.AiResponse))
                    {
                        <div class="ai-analysis-section">
                            <h5>üìä AI Analysis Report</h5>
                            <div class="ai-response-content">
                                @((MarkupString)currentHealthCheckResult.AiResponse.Replace("\n", "<br/>"))
                            </div>
                        </div>
                    }

                    @if (currentHealthCheckResult.SeveritySources != null && currentHealthCheckResult.SeveritySources.Any())
                    {
                        <div class="severity-sources-section mt-4">
                            <h5>üîç Sources Contributing to Severity Assessment</h5>
                            <p class="text-muted small mb-3">The following items were analyzed and contributed to the severity assessment. You can review them or mark them as not applicable if the patient's condition has improved.</p>
                            
                            <div class="alert alert-info small mb-3">
                                <strong>Found @currentHealthCheckResult.SeveritySources.Count source(s)</strong> that contributed to this assessment.
                            </div>
                            
                            @foreach (var source in currentHealthCheckResult.SeveritySources)
                            {
                                <div class="source-item mb-3 p-3 border border-danger rounded" style="background-color: #fff5f5;">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-center mb-2">
                                                <span class="badge @GetSourceTypeBadgeClass(source.SourceType) me-2">
                                                    @GetSourceTypeIcon(source.SourceType) @source.SourceType
                                                </span>
                                                <strong>@source.SourceTitle</strong>
                                                <span class="text-muted ms-2 small">@source.SourceDate.ToString("MM/dd/yyyy")</span>
                                            </div>
                                            <p class="mb-1 small text-muted">@source.SourcePreview</p>
                                            @if (!string.IsNullOrEmpty(source.ContributionReason))
                                            {
                                                <p class="mb-0 small"><strong>Reason:</strong> <span class="text-info">@source.ContributionReason</span></p>
                                            }
                                        </div>
                                        <div class="ms-3 d-flex flex-column gap-2">
                                            <RadzenButton Text="View" 
                                                         ButtonStyle="ButtonStyle.Info" 
                                                         Size="ButtonSize.Small"
                                                         Variant="Variant.Flat"
                                                         Click="@(() => NavigateToSource(source))" />
                                            <RadzenButton Text="Mark as Not Applicable" 
                                                         ButtonStyle="ButtonStyle.Warning" 
                                                         Size="ButtonSize.Small"
                                                         Variant="Variant.Flat"
                                                         Click="@(() => MarkSourceAsIgnored(source))" />
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
            
            <div class="modal-footer health-check-modal-footer">
                <button @onclick="CloseHealthCheckDialog" class="btn btn-primary">Close</button>
            </div>
        </div>
    </div>
}

<!-- Unassign Confirmation Modal -->
@if (showUnassignConfirmation && selectedUser != null)
{
    <div class="modal-overlay" style="display: block !important; z-index: 9999 !important;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ö†Ô∏è Confirm Unassignment</h3>
                <button @onclick="CloseUnassignConfirmation" class="close-btn">‚úï</button>
            </div>
            
            <div class="modal-body">
                <div class="confirmation-warning">
                    <div class="warning-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="warning-content">
                        <h4>Are you sure you want to unassign this patient?</h4>
                        <div class="patient-info">
                            <p><strong>Patient:</strong> @selectedUser?.FirstName @selectedUser?.LastName</p>
                            <p><strong>Email:</strong> @selectedUser?.Email</p>
                        </div>
                        <div class="warning-message">
                            <p><strong>Important:</strong> Once unassigned, you will no longer have access to this patient's records. 
                            You will need to contact an administrator to reassign the patient or ask another doctor to assign them to you.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button @onclick="CloseUnassignConfirmation" class="btn btn-secondary">Cancel</button>
                <button @onclick="ConfirmUnassignPatient" disabled="@isUnassigning" class="btn btn-danger">
                    @(isUnassigning ? "Unassigning..." : "Yes, Unassign Patient")
                </button>
            </div>
        </div>
    </div>
}

@code {
    private SMDataGrid<User>? _grid;
    private Dictionary<int, User> expandedUsers = new Dictionary<int, User>();
    private List<SMDataGridColumn<User>> _columns = new();
    private List<SMDataGridActionButton<User>> _actions = new();
    
    private User? selectedUser;
    private UserStats? userStats;
    private bool showPatientForm = false;
    private bool showPatientDetails = false;
    private bool showPatientStats = false;
    private bool showAssignModal = false;
    private bool showUnassignConfirmation = false;
    private bool showHealthCheckDialog = false;
    private bool isSaving = false;
    private bool isAssigning = false;
    private bool isUnassigning = false;
    private bool isPerformingHealthCheck = false;
    private AiHealthCheckResult? currentHealthCheckResult;
    private User? editingUser;
    private CreatePatientRequest patientForm = new();
    private List<User> availableDoctors = new();
    private int selectedDoctorId = 0;
    
    // Custom filter variables
    private bool? selectedStatusFilter = null;
    private string? selectedJournalFilter = null;
    
    private readonly List<object> statusOptions = new()
    {
        new { Value = (bool?)null, Text = "All Statuses" },
        new { Value = (bool?)true, Text = "Active" },
        new { Value = (bool?)false, Text = "Inactive" }
    };
    
    private readonly List<object> journalFilterOptions = new()
    {
        new { Value = (string?)null, Text = "All Patients" },
        new { Value = "0", Text = "No Journal Entries" },
        new { Value = "1-5", Text = "1-5 Entries" },
        new { Value = "6-10", Text = "6-10 Entries" },
        new { Value = "10+", Text = "10+ Entries" }
    };

    protected override async Task OnInitializedAsync()
    {
        InitializeColumns();
        InitializeActions();
    }

    private void InitializeColumns()
    {
        _columns = new List<SMDataGridColumn<User>>
        {
            new SMDataGridTemplateColumn<User>
            {
                Property = nameof(User.FirstName),
                Title = "Name",
                Width = "200px",
                Template = user => builder =>
                {
                    builder.OpenElement(0, "div");
                    builder.OpenElement(1, "strong");
                    builder.AddContent(2, $"{user.FirstName} {user.LastName}");
                    builder.CloseElement();
                    builder.OpenElement(3, "br");
                    builder.CloseElement();
                    builder.OpenElement(4, "small");
                    builder.AddAttribute(5, "class", "text-muted");
                    builder.AddContent(6, user.Email);
                    builder.CloseElement();
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<User>
            {
                Property = nameof(User.DateOfBirth),
                Title = "Date of Birth",
                Width = "120px",
                Template = user => builder =>
                {
                    builder.AddContent(0, user.DateOfBirth.ToString("MMM dd, yyyy"));
                }
            },
            new SMDataGridTemplateColumn<User>
            {
                Property = nameof(User.Gender),
                Title = "Gender",
                Width = "100px",
                Template = user => builder =>
                {
                    if (!string.IsNullOrEmpty(user.Gender))
                    {
                        builder.OpenElement(0, "span");
                        builder.AddAttribute(1, "class", "badge badge-info");
                        builder.AddContent(2, user.Gender);
                        builder.CloseElement();
                    }
                    else
                    {
                        builder.OpenElement(3, "span");
                        builder.AddAttribute(4, "class", "text-muted");
                        builder.AddContent(5, "Not specified");
                        builder.CloseElement();
                    }
                }
            },
            new SMDataGridTemplateColumn<User>
            {
                Property = nameof(User.IsActive),
                Title = "Status",
                Width = "100px",
                Template = user => builder =>
                {
                    builder.OpenElement(0, "span");
                    builder.AddAttribute(1, "class", $"status-badge {(user.IsActive ? "active" : "inactive")}");
                    builder.AddContent(2, user.IsActive ? "Active" : "Inactive");
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<User>
            {
                Property = nameof(User.JournalEntries),
                Title = "Journal Entries",
                Width = "120px",
                Sortable = false,
                Template = user => builder =>
                {
                    builder.OpenElement(0, "span");
                    builder.AddAttribute(1, "class", "badge badge-primary");
                    builder.AddContent(2, user.JournalEntries?.Count ?? 0);
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<User>
            {
                Property = nameof(User.LastLoginAt),
                Title = "Last Login",
                Width = "120px",
                Template = user => builder =>
                {
                    builder.AddContent(0, user.LastLoginAt?.ToString("MMM dd, yyyy") ?? "Never");
                }
            },
            new SMDataGridTemplateColumn<User>
            {
                Property = nameof(User.CreatedAt),
                Title = "Member Since",
                Width = "120px",
                Template = user => builder =>
                {
                    builder.AddContent(0, user.CreatedAt.ToString("MMM dd, yyyy"));
                }
            }
        };
    }

    private void InitializeActions()
    {
        _actions.Add(new SMDataGridActionButton<User>
        {
            Icon = "visibility",
            ButtonStyle = ButtonStyle.Info,
            Variant = Variant.Flat,
            Size = ButtonSize.Small,
            Tooltip = "View patient details",
            OnClick = async (row, ct) => await ViewUserDetailsAsync(row, ct)
        });

        _actions.Add(new SMDataGridActionButton<User>
        {
            Icon = "edit",
            ButtonStyle = ButtonStyle.Success,
            Variant = Variant.Flat,
            Size = ButtonSize.Small,
            Tooltip = "Edit patient information",
            OnClick = async (row, ct) => await EditUserAsync(row, ct)
        });

        _actions.Add(new SMDataGridActionButton<User>
        {
            Icon = "analytics",
            ButtonStyle = ButtonStyle.Primary,
            Variant = Variant.Flat,
            Size = ButtonSize.Small,
            Tooltip = "View patient statistics",
            OnClick = async (row, ct) => await ViewUserStatsAsync(row, ct)
        });

        _actions.Add(new SMDataGridActionButton<User>
        {
            Icon = "psychology",
            ButtonStyle = ButtonStyle.Warning,
            Variant = Variant.Flat,
            Size = ButtonSize.Small,
            Tooltip = "Perform AI health check analysis",
            OnClick = async (row, ct) => await PerformAiHealthCheckAsync(row, ct),
            Disabled = (user) => isPerformingHealthCheck
        });

        // Doctor-specific actions
        if (AuthService.CurrentUser?.RoleId == 2)
        {
            // For doctors: allow reassigning to another doctor
            _actions.Add(new SMDataGridActionButton<User>
            {
                Icon = "person_add",
                ButtonStyle = ButtonStyle.Warning,
                Variant = Variant.Flat,
                Size = ButtonSize.Small,
                Tooltip = "Assign patient to another doctor",
                OnClick = async (row, ct) => await ShowAssignPatientModalAsync(row, ct)
            });

            // For doctors: allow unassigning from themselves
            _actions.Add(new SMDataGridActionButton<User>
            {
                Icon = "person_remove",
                ButtonStyle = ButtonStyle.Danger,
                Variant = Variant.Flat,
                Size = ButtonSize.Small,
                Tooltip = "Unassign patient from me",
                OnClick = async (row, ct) => 
                {
                    ShowUnassignConfirmation(row);
                    await Task.CompletedTask;
                }
            });
        }

        // Admin-specific actions
        if (AuthService.CurrentUser?.RoleId == 3)
        {
            _actions.Add(new SMDataGridActionButton<User>
            {
                Icon = "block",
                ButtonStyle = ButtonStyle.Danger,
                Variant = Variant.Flat,
                Size = ButtonSize.Small,
                Tooltip = "Deactivate patient",
                OnClick = async (row, ct) => await DeactivateUserAsync(row, ct),
                Disabled = (user) => !user.IsActive
            });

            _actions.Add(new SMDataGridActionButton<User>
            {
                Icon = "check",
                ButtonStyle = ButtonStyle.Success,
                Variant = Variant.Flat,
                Size = ButtonSize.Small,
                Tooltip = "Reactivate patient",
                OnClick = async (row, ct) => await ReactivateUserAsync(row, ct),
                Disabled = (user) => user.IsActive
            });
        }
    }

    private async Task<IEnumerable<User>> LoadPatientsAsync(CancellationToken ct)
    {
        try
        {
            var users = await PatientService.ListAsync(ct);
            
            // Load journal entry counts for each patient
            foreach (var user in users.Where(u => u.RoleId == 1))
            {
                try
                {
                    var entries = await PatientService.GetJournalEntriesAsync(user.Id, ct);
                    user.JournalEntries = entries;
                }
                catch
                {
                    user.JournalEntries = new();
                }
            }

            // Apply custom filters
            var filtered = users.Where(u => u != null && u.RoleId == 1).AsEnumerable();

            if (selectedStatusFilter.HasValue)
            {
                filtered = filtered.Where(u => u.IsActive == selectedStatusFilter.Value);
            }

            if (!string.IsNullOrEmpty(selectedJournalFilter))
            {
                filtered = selectedJournalFilter switch
                {
                    "0" => filtered.Where(u => (u.JournalEntries?.Count ?? 0) == 0),
                    "1-5" => filtered.Where(u => (u.JournalEntries?.Count ?? 0) >= 1 && (u.JournalEntries?.Count ?? 0) <= 5),
                    "6-10" => filtered.Where(u => (u.JournalEntries?.Count ?? 0) >= 6 && (u.JournalEntries?.Count ?? 0) <= 10),
                    "10+" => filtered.Where(u => (u.JournalEntries?.Count ?? 0) > 10),
                    _ => filtered
                };
            }

            return filtered.ToList();
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to load patients: {ex.Message}");
            return new List<User>();
        }
    }

    private async Task OnRowExpand(User user)
    {
        try
        {
            if (!expandedUsers.ContainsKey(user.Id))
            {
                var fullUser = await PatientService.GetAsync(user.Id);
                if (fullUser != null)
                {
                    // Load journal entries and chat sessions
                    fullUser.JournalEntries = await PatientService.GetJournalEntriesAsync(user.Id);
                    expandedUsers[user.Id] = fullUser;
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to load patient details: {ex.Message}");
        }
    }

    private async Task ClearFilters()
    {
        selectedStatusFilter = null;
        selectedJournalFilter = null;
        if (_grid != null)
        {
            await _grid.RefreshAsync();
        }
    }



    private void ShowAddPatientForm()
    {
        editingUser = null;
        patientForm = new CreatePatientRequest { DateOfBirth = DateTime.Now.AddYears(-25) };
        showPatientForm = true;
        StateHasChanged();
    }

    private async Task EditUserAsync(User user, CancellationToken ct)
    {
        if (user == null) return;
        
        editingUser = user;
        _originalUser = user; // Store original for dirty field detection
        patientForm = new CreatePatientRequest
        {
            FirstName = user.FirstName ?? string.Empty,
            LastName = user.LastName ?? string.Empty,
            Email = user.Email ?? string.Empty,
            DateOfBirth = user.DateOfBirth,
            Gender = user.Gender ?? string.Empty,
            MobilePhone = user.MobilePhone ?? string.Empty
        };
        showPatientForm = true;
        StateHasChanged();
    }

    private void ClosePatientForm()
    {
        showPatientForm = false;
        editingUser = null;
        patientForm = new CreatePatientRequest();
    }

    private async Task SavePatient()
    {
        if (string.IsNullOrWhiteSpace(patientForm.FirstName) || 
            string.IsNullOrWhiteSpace(patientForm.LastName) || 
            string.IsNullOrWhiteSpace(patientForm.Email))
        {
            NotificationService.ShowWarning("Please fill in all required fields.");
            return;
        }

        if (editingUser == null && string.IsNullOrWhiteSpace(patientForm.Password))
        {
            NotificationService.ShowWarning("Password is required for new patients.");
            return;
        }

        try
        {
            isSaving = true;
            
            if (editingUser == null)
            {
                await PatientService.CreateAsync(patientForm);
                NotificationService.ShowSuccess("Patient added successfully!");
                if (_grid != null)
                {
                    await _grid.RefreshAsync();
                }
            }
            else
            {
                var updateRequest = new UpdatePatientRequest();
                
                if (_originalUser != null)
                {
                    if (!string.IsNullOrWhiteSpace(patientForm.FirstName) && patientForm.FirstName != (_originalUser.FirstName ?? string.Empty))
                    {
                        updateRequest.FirstName = patientForm.FirstName;
                    }
                    
                    if (!string.IsNullOrWhiteSpace(patientForm.LastName) && patientForm.LastName != (_originalUser.LastName ?? string.Empty))
                    {
                        updateRequest.LastName = patientForm.LastName;
                    }
                    
                    if (!string.IsNullOrWhiteSpace(patientForm.Email) && patientForm.Email != (_originalUser.Email ?? string.Empty))
                    {
                        updateRequest.Email = patientForm.Email;
                    }
                    
                    if (patientForm.DateOfBirth != _originalUser.DateOfBirth)
                    {
                        updateRequest.DateOfBirth = patientForm.DateOfBirth;
                    }
                    
                    if (!string.IsNullOrWhiteSpace(patientForm.Gender) && patientForm.Gender != (_originalUser.Gender ?? string.Empty))
                    {
                        updateRequest.Gender = patientForm.Gender;
                    }
                    
                    if (patientForm.MobilePhone != (_originalUser.MobilePhone ?? string.Empty))
                    {
                        updateRequest.MobilePhone = patientForm.MobilePhone;
                    }
                    
                    if (!string.IsNullOrWhiteSpace(patientForm.Password))
                    {
                        updateRequest.Password = patientForm.Password;
                    }
                }

                await PatientService.UpdateAsync(editingUser.Id, updateRequest);
                NotificationService.ShowSuccess("Patient updated successfully!");
                if (_grid != null)
                {
                    await _grid.RefreshAsync();
                }
            }
            
            ClosePatientForm();
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to save patient: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task ViewUserDetailsAsync(User user, CancellationToken ct)
    {
        if (user == null) return;
        
        selectedUser = user;
        showPatientDetails = true;
        StateHasChanged();
    }

    private void ClosePatientDetails()
    {
        showPatientDetails = false;
        selectedUser = null;
    }

    private async Task ViewUserStatsAsync(User user, CancellationToken ct)
    {
        if (user == null) return;
        
        try
        {
            selectedUser = user;
            userStats = await PatientService.GetStatsAsync(user.Id, ct);
            showPatientStats = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to load patient stats: {ex.Message}");
        }
    }

    private void ClosePatientStats()
    {
        showPatientStats = false;
        selectedUser = null;
        userStats = null;
    }

    private async Task PerformAiHealthCheckAsync(User user, CancellationToken ct)
    {
        if (user == null)
        {
            await JSRuntime.InvokeVoidAsync("console.error", "PerformAiHealthCheckAsync: user is null");
            return;
        }
        
        try
        {
            await JSRuntime.InvokeVoidAsync("console.log", $"PerformAiHealthCheckAsync called for user: {user.Id} - {user.FirstName} {user.LastName}");
            
            isPerformingHealthCheck = true;
            StateHasChanged();
            
            NotificationService.ShowInfo($"Analyzing {user.FirstName} {user.LastName}'s health status...");
            
            await JSRuntime.InvokeVoidAsync("console.log", $"Calling API: api/admin/ai-health-check/{user.Id}");
            var result = await PatientService.PerformAiHealthCheckAsync(user.Id, ct);
            
            if (result == null)
            {
                await JSRuntime.InvokeVoidAsync("console.error", "Result is null");
                NotificationService.ShowError("AI Health Check returned no result. Please check server logs.");
                return;
            }
            
            await JSRuntime.InvokeVoidAsync("console.log", "Result received:", 
                $"Success: {result.Success}, Severity: {result.Severity}, Message: {result.Message}, AlertsSent: {result.AlertsSent}");
            
            if (result.Success)
            {
                await JSRuntime.InvokeVoidAsync("console.log", "Showing notification for severity:", result.Severity);
                
                // Store result for viewing in a dialog
                currentHealthCheckResult = result;
                showHealthCheckDialog = true;
                
                // Debug: Log severity sources
                await JSRuntime.InvokeVoidAsync("console.log", "Severity Sources:", 
                    result.SeveritySources != null ? result.SeveritySources.Count : 0,
                    result.SeveritySources);
                
                StateHasChanged();
                
                // Show brief notification
                if (result.Severity == "High")
                {
                    var warningMsg = $"‚ö†Ô∏è {result.Message}";
                    await JSRuntime.InvokeVoidAsync("console.log", "Showing warning:", warningMsg);
                    NotificationService.ShowWarning(warningMsg, 8000); // 8 seconds
                }
                else if (result.Severity == "Normal" || result.Severity == "Low")
                {
                    var successMsg = $"‚úÖ {result.Message}";
                    await JSRuntime.InvokeVoidAsync("console.log", "Showing success:", successMsg);
                    NotificationService.ShowSuccess(successMsg, 6000); // 6 seconds
                }
                else
                {
                    var infoMsg = $"‚ÑπÔ∏è {result.Message}";
                    await JSRuntime.InvokeVoidAsync("console.log", "Showing info:", infoMsg);
                    NotificationService.ShowInfo(infoMsg, 6000); // 6 seconds
                }
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("console.error", "Result.Success is false:", result.Message);
                NotificationService.ShowError($"AI Health Check failed: {result.Message}");
                StateHasChanged();
            }
        }
        catch (HttpRequestException httpEx)
        {
            var errorMsg = httpEx.Message;
            if (httpEx.Data.Contains("StatusCode"))
            {
                errorMsg = $"HTTP Error: {httpEx.Data["StatusCode"]} - {errorMsg}";
            }
            NotificationService.ShowError($"AI Health Check failed: {errorMsg}");
            await JSRuntime.InvokeVoidAsync("console.error", "AI Health Check HTTP Error:", httpEx);
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"AI Health Check failed: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("console.error", "AI Health Check Error:", ex.Message, ex.StackTrace);
        }
        finally
        {
            isPerformingHealthCheck = false;
            StateHasChanged();
        }
    }

    private async Task DeactivateUserAsync(User user, CancellationToken ct)
    {
        if (user == null) return;
        
        try
        {
            await PatientService.DeleteAsync(user.Id, ct);
            NotificationService.ShowSuccess("Patient deactivated successfully!");
            if (_grid != null)
            {
                await _grid.RefreshAsync();
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to deactivate patient: {ex.Message}");
        }
    }

    private async Task ReactivateUserAsync(User user, CancellationToken ct)
    {
        if (user == null) return;
        
        try
        {
            user.IsActive = true;
            var updatedUser = await PatientService.UpdateAsync(user.Id, new UpdatePatientRequest
            {
                FirstName = user.FirstName,
                LastName = user.LastName,
                Email = user.Email,
                DateOfBirth = user.DateOfBirth,
                Gender = user.Gender,
                MobilePhone = user.MobilePhone
            }, ct);
            
            NotificationService.ShowSuccess("Patient reactivated successfully!");
            if (_grid != null)
            {
                await _grid.RefreshAsync();
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to reactivate patient: {ex.Message}");
        }
    }

    private async Task ShowAssignPatientModalAsync(User user, CancellationToken ct)
    {
        if (user == null) return;
        
        try
        {
            selectedUser = user;
            selectedDoctorId = 0;
            
            availableDoctors = await PatientService.GetDoctorsAsync(ct);
            
            if (AuthService.CurrentUser?.Id != null)
            {
                availableDoctors = availableDoctors.Where(d => d.Id != AuthService.CurrentUser.Id).ToList();
            }
            
            showAssignModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to load doctors: {ex.Message}");
        }
    }

    private void CloseAssignModal()
    {
        showAssignModal = false;
        selectedUser = null;
        selectedDoctorId = 0;
        availableDoctors.Clear();
        StateHasChanged();
    }

    private async Task AssignPatientToDoctor()
    {
        if (selectedUser == null || selectedDoctorId == 0)
        {
            NotificationService.ShowWarning("Please select a doctor to assign the patient to.");
            return;
        }

        try
        {
            isAssigning = true;
            
            var request = new DoctorAssignPatientRequest
            {
                PatientId = selectedUser.Id,
                ToDoctorId = selectedDoctorId
            };

            await PatientService.AssignToDoctorAsync(request);
            
            NotificationService.ShowSuccess("Patient assigned to doctor successfully!");
            CloseAssignModal();
            if (_grid != null)
            {
                await _grid.RefreshAsync();
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Error assigning patient: {ex.Message}");
        }
        finally
        {
            isAssigning = false;
        }
    }

    private void ShowUnassignConfirmation(User user)
    {
        if (user == null) return;
        
        selectedUser = user;
        showUnassignConfirmation = true;
        StateHasChanged();
    }

    private void CloseUnassignConfirmation()
    {
        showUnassignConfirmation = false;
        selectedUser = null;
        StateHasChanged();
    }

    private string GetSourceTypeIcon(string sourceType)
    {
        return sourceType switch
        {
            "JournalEntry" => "üìù",
            "ClinicalNote" => "üìã",
            "Content" => "üìÑ",
            "Emergency" => "üö®",
            _ => "üìå"
        };
    }

    private string GetSourceTypeBadgeClass(string sourceType)
    {
        // All severity-causing sources should be marked in red/warning
        return "bg-danger text-white";
    }

    private async Task NavigateToSource(SeveritySource source)
    {
        // Store the source ID in a way that the target page can use to highlight it
        // For now, navigate to the page - we can enhance this later to scroll to the specific item
        var route = source.NavigationRoute;
        
        // Add query parameter to identify the source
        var uri = $"{route}?sourceId={source.SourceId}&sourceType={source.SourceType}";
        Navigation.NavigateTo(uri);
        
        // Close the health check dialog
        CloseHealthCheckDialog();
    }

    private async Task MarkSourceAsIgnored(SeveritySource source)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            $"Are you sure you want to mark this {source.SourceType} as not applicable for AI analysis? This will exclude it from future health checks.");
        
        if (!confirmed)
            return;

        try
        {
            var endpoint = source.SourceType switch
            {
                "JournalEntry" => $"api/journal/entry/{source.SourceId}/toggle-ignore",
                "ClinicalNote" => $"api/clinical-notes/{source.SourceId}/toggle-ignore",
                "Content" => $"api/content/{source.SourceId}/toggle-ignore",
                "Emergency" => $"api/emergency/{source.SourceId}/acknowledge", // Acknowledge instead of ignore
                _ => null
            };

            if (endpoint == null)
            {
                NotificationService.ShowWarning("Unable to mark this source type as ignored.");
                return;
            }

            var response = await Http.PostAsync(endpoint, null);
            if (response.IsSuccessStatusCode)
            {
                NotificationService.ShowSuccess($"{source.SourceType} marked as not applicable. It will be excluded from future AI health checks.");
                
                // Remove from the current list
                if (currentHealthCheckResult?.SeveritySources != null)
                {
                    currentHealthCheckResult.SeveritySources.Remove(source);
                    StateHasChanged();
                }
            }
            else
            {
                NotificationService.ShowError("Failed to mark source as ignored. Please try again.");
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Error: {ex.Message}");
        }
    }

    private void CloseHealthCheckDialog()
    {
        showHealthCheckDialog = false;
        currentHealthCheckResult = null;
        StateHasChanged();
    }

    private async Task ConfirmUnassignPatient()
    {
        if (selectedUser == null)
        {
            return;
        }

        try
        {
            isUnassigning = true;
            
            var request = new DoctorUnassignPatientRequest
            {
                PatientId = selectedUser.Id
            };

            await PatientService.UnassignFromDoctorAsync(request);
            
            NotificationService.ShowSuccess("Patient unassigned from you successfully!");
            CloseUnassignConfirmation();
            if (_grid != null)
            {
                await _grid.RefreshAsync();
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Error unassigning patient: {ex.Message}");
        }
        finally
        {
            isUnassigning = false;
        }
    }
}

<style>
    .action-buttons {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
    }

    .action-buttons .rz-button {
        margin: 2px;
    }

    .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
    }

    .status-badge.active {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .status-badge.inactive {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .badge.badge-info {
        background-color: #d1ecf1;
        color: #0c5460;
    }

    .badge.badge-primary {
        background-color: #cce5ff;
        color: #004085;
    }

    .text-muted {
        color: #6c757d;
        font-size: 12px;
    }

    .grid-info {
        margin-bottom: 15px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border-left: 4px solid #007bff;
    }

    .grid-info i {
        margin-right: 5px;
        color: #007bff;
    }

    .custom-filters {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 15px;
        border: 1px solid #dee2e6;
    }

    .custom-filters .form-label {
        font-weight: 500;
        color: #333;
        margin-bottom: 5px;
    }

    .custom-filters .row {
        margin: 0;
    }

    .custom-filters .col-md-3 {
        padding: 0 10px;
    }

    .assignment-info {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        border-left: 4px solid #007bff;
    }

    .assignment-info p {
        margin: 5px 0;
        color: #333;
    }

    .assignment-info strong {
        color: #007bff;
    }

    .confirmation-warning {
        display: flex;
        align-items: flex-start;
        gap: 15px;
        padding: 20px;
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .warning-icon {
        font-size: 24px;
        color: #f39c12;
        margin-top: 5px;
    }

    .warning-content h4 {
        color: #856404;
        margin-bottom: 15px;
        font-size: 18px;
    }

    .patient-info {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 15px;
        border-left: 4px solid #007bff;
    }

    .patient-info p {
        margin: 5px 0;
        color: #333;
    }

    .patient-info strong {
        color: #007bff;
    }

    .warning-message {
        background-color: #f8d7da;
        padding: 15px;
        border-radius: 5px;
        border-left: 4px solid #dc3545;
    }

    .warning-message p {
        margin: 0;
        color: #721c24;
        font-size: 14px;
        line-height: 1.5;
    }

    .warning-message strong {
        color: #dc3545;
    }

    .btn-danger {
        background-color: #dc3545;
        border-color: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background-color: #c82333;
        border-color: #bd2130;
    }

    /* Form styling */
    .form-row {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
    }

    .form-group {
        flex: 1;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #333;
    }

    .form-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }

    .form-input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    .patient-meta {
        margin-bottom: 20px;
    }

    .meta-row {
        display: flex;
        margin-bottom: 10px;
    }

    .meta-label {
        font-weight: 500;
        color: #666;
        min-width: 120px;
    }

    .meta-value {
        color: #333;
        margin-left: 10px;
    }

    .health-check-results {
        padding: 10px;
    }

    .result-summary {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #007bff;
    }

    .severity-badge {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 1.1em;
        margin-bottom: 10px;
    }

    .severity-high {
        background-color: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
    }

    .severity-normal {
        background-color: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
    }

    .severity-low {
        background-color: #d1ecf1;
        color: #0c5460;
        border-left: 4px solid #17a2b8;
    }

    .ai-analysis-section {
        margin-top: 20px;
        padding: 15px;
        background: #ffffff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
    }

    .ai-analysis-section h5 {
        margin-bottom: 15px;
        color: #2c3e50;
    }

    .ai-response-content {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        border-left: 4px solid #007bff;
        white-space: pre-wrap;
        word-wrap: break-word;
        line-height: 1.6;
        font-size: 0.95em;
        max-height: 400px;
        overflow-y: auto;
    }

    /* Health Check Dialog Specific Styles */
    .health-check-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        padding: 20px;
        box-sizing: border-box;
    }

    .health-check-modal-content {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        max-width: 800px;
        width: 100%;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
    }

    .health-check-modal-header {
        flex-shrink: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
    }

    .health-check-modal-header h3 {
        margin: 0;
        color: #333;
    }

    .health-check-modal-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        min-height: 0;
    }

    .health-check-modal-footer {
        flex-shrink: 0;
        display: flex;
        justify-content: flex-end;
        padding: 15px 20px;
        border-top: 1px solid #e0e0e0;
        background: #f8f9fa;
    }

    .health-check-modal-footer .btn {
        padding: 8px 20px;
        font-size: 14px;
    }

    /* Ensure close button is always visible */
    .health-check-modal-header .close-btn {
        position: relative;
        z-index: 10;
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #666;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .health-check-modal-header .close-btn:hover {
        color: #333;
        background-color: #f0f0f0;
        border-radius: 4px;
    }

    /* Responsive adjustments */
    @@media (max-height: 600px) {
        .health-check-modal-content {
            max-height: 95vh;
        }

        .health-check-modal-body {
            padding: 15px;
        }

        .ai-response-content {
            max-height: 250px;
        }
    }

    @@media (max-width: 768px) {
        .health-check-modal-content {
            max-width: 95%;
            max-height: 95vh;
        }

        .health-check-modal-overlay {
            padding: 10px;
        }
    }
</style>
