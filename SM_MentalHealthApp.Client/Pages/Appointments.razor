@page "/appointments"
@using SM_MentalHealthApp.Shared
@using SM_MentalHealthApp.Client.Services
@using SM_MentalHealthApp.Client.Components.Grid
@using SM_MentalHealthApp.Client.Components.Common
@using SM_MentalHealthApp.Client.Helpers
@using Radzen
@using Radzen.Blazor
@using System.Linq
@inject HttpClient Http
@inject IAuthService AuthService
@inject IAppointmentService AppointmentService
@inject ODataService ODataService
@inject IJSRuntime JSRuntime
@inject NotificationService NotificationService

<PageTitle>Appointment Management</PageTitle>

<style>
    .appointment-container {
        padding: 20px;
    }

    .appointment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .appointment-controls {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        align-items: end;
    }

    .control-group {
        display: flex;
        flex-direction: column;
        min-width: 200px;
    }

    .control-label {
        font-weight: 500;
        margin-bottom: 5px;
        font-size: 14px;
    }

    .badge-urgent {
        background-color: #dc3545;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
    }

    .badge-regular {
        background-color: #28a745;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
    }

    .badge-after-hours {
        background-color: #ffc107;
        color: #000;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
    }

    .status-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
    }

    .status-scheduled { background-color: #17a2b8; color: white; }
    .status-confirmed { background-color: #28a745; color: white; }
    .status-inprogress { background-color: #ffc107; color: #000; }
    .status-completed { background-color: #6c757d; color: white; }
    .status-cancelled { background-color: #dc3545; color: white; }
    .status-noshow { background-color: #fd7e14; color: white; }

    .appointment-meta {
        margin-bottom: 20px;
    }

    .meta-row {
        display: flex;
        margin-bottom: 10px;
    }

    .meta-label {
        font-weight: 500;
        color: #666;
        min-width: 120px;
    }

    .meta-value {
        color: #333;
        margin-left: 10px;
    }


    .form-row-3 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
    }

    @@media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .form-row-3 {
            grid-template-columns: 1fr;
        }
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
    }

    .form-row-full {
        grid-column: 1 / -1;
    }

    .form-label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
    }

    .required-asterisk {
        color: red;
    }

    .error-message {
        color: #dc3545;
        font-size: 14px;
        margin-top: 5px;
    }

    .validation-warning {
        background-color: #fff3cd;
        border: 1px solid #ffc107;
        color: #856404;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
    }
</style>

<div class="appointment-container">
    <div class="appointment-header">
        <h2><i class="fas fa-calendar-alt me-2"></i>Appointment Management</h2>
        <RadzenButton Icon="add" Text="New Appointment" ButtonStyle="ButtonStyle.Success"
            Click="@(async () => await ShowAddDialog())" />
    </div>

    <!-- Filters -->
    <div class="appointment-controls">
        @if (AuthService.CurrentUser?.RoleId == 3 || AuthService.CurrentUser?.RoleId == 4) // Admin or Coordinator - can filter by doctor
        {
            <div class="control-group">
                <label class="control-label">Doctor</label>
                <RadzenDropDown Data="@doctors" TextProperty="FullName" ValueProperty="Id"
                    @bind-value="filterDoctorId" AllowFiltering="true" Placeholder="All Doctors"
                    Style="width: 200px" />
            </div>
        }
        <div class="control-group">
            <label class="control-label">Patient</label>
            <RadzenDropDown Data="@patients" TextProperty="FullName" ValueProperty="Id"
                @bind-value="filterPatientId" AllowFiltering="true" Placeholder="All Patients"
                Style="width: 200px" />
        </div>
        <div class="control-group">
            <label class="control-label">Start Date</label>
            <RadzenDatePicker @bind-value="filterStartDate" DateFormat="MM/dd/yyyy" 
                Style="width: 200px" />
        </div>
        <div class="control-group">
            <label class="control-label">End Date</label>
            <RadzenDatePicker @bind-value="filterEndDate" DateFormat="MM/dd/yyyy" 
                Style="width: 200px" />
        </div>
        <div class="control-group">
            <RadzenButton Text="Apply Filters" ButtonStyle="ButtonStyle.Primary" 
                Click="@ApplyFilters" Icon="filter" />
        </div>
        <div class="control-group">
            <RadzenButton Text="Clear" ButtonStyle="ButtonStyle.Light" 
                Click="@ClearFilters" Icon="clear" />
        </div>
        @if (AuthService.CurrentUser?.RoleId == 2 || AuthService.CurrentUser?.RoleId == 3 || AuthService.CurrentUser?.RoleId == 4) // Doctor, Admin, or Coordinator
        {
            <div class="control-group">
                <RadzenButton Text="Manage OOO" ButtonStyle="ButtonStyle.Info" 
                    Click="@(async () => await ShowOOODialog())" Icon="event_busy" />
            </div>
            @if (filterDoctorId.HasValue)
            {
                <div class="control-group">
                    <RadzenButton Text="View OOO Periods" ButtonStyle="ButtonStyle.Success" 
                        Click="@(() => ShowAllOOOView(filterDoctorId.Value))" Icon="calendar_view_week" />
                </div>
            }
        }
    </div>

    <!-- Appointments Grid -->
    <SMDataGrid TItem="AppointmentDto" 
               Columns="_columns" 
               Actions="_actions" 
               ActionsWidth="150px"
               LoadItemsPaged="LoadAppointmentsPagedAsync" 
               @ref="_grid" 
               PageSize="10"
               AllowPaging="true"
               AllowFiltering="true"
               FilterMode="FilterMode.Advanced"
               ShowPagingSummary="true"
               OnRowExpandCallback="@OnRowExpand">
        <ExpansionTemplate Context="appointment">
            @{
                var expandedAppointment = expandedAppointments.ContainsKey(appointment.Id) ? expandedAppointments[appointment.Id] : appointment;
            }
            <div class="p-3">
                <div class="row">
                    <div class="col-12">
                        <h6>Appointment Details</h6>
                        <div class="appointment-meta mb-3">
                            <div class="meta-row">
                                <span class="meta-label"><strong>Doctor:</strong></span>
                                <span class="meta-value">@expandedAppointment.DoctorName (@expandedAppointment.DoctorEmail)</span>
                            </div>
                            <div class="meta-row">
                                <span class="meta-label"><strong>Patient:</strong></span>
                                <span class="meta-value">@expandedAppointment.PatientName (@expandedAppointment.PatientEmail)</span>
                            </div>
                            <div class="meta-row">
                                <span class="meta-label"><strong>Date & Time:</strong></span>
                                <span class="meta-value">@expandedAppointment.AppointmentDateTime.ToString("MMM dd, yyyy HH:mm") - @expandedAppointment.EndDateTime.ToString("HH:mm")</span>
                            </div>
                            <div class="meta-row">
                                <span class="meta-label"><strong>Duration:</strong></span>
                                <span class="meta-value">@expandedAppointment.Duration.TotalMinutes.ToString("0") minutes</span>
                            </div>
                            <div class="meta-row">
                                <span class="meta-label"><strong>Type:</strong></span>
                                <span class="meta-value">
                                    @if (expandedAppointment.IsUrgentCare)
                                    {
                                        <span class="badge-urgent">URGENT CARE</span>
                                    }
                                    else
                                    {
                                        <span class="badge-regular">REGULAR</span>
                                    }
                                    @if (!expandedAppointment.IsBusinessHours && !expandedAppointment.IsUrgentCare)
                                    {
                                        <span class="badge-after-hours">AFTER HOURS</span>
                                    }
                                </span>
                            </div>
                            <div class="meta-row">
                                <span class="meta-label"><strong>Status:</strong></span>
                                <span class="meta-value">
                                    <span class="status-badge status-@expandedAppointment.Status.ToString().ToLower()">
                                        @expandedAppointment.Status.ToString().ToUpper()
                                    </span>
                                </span>
                            </div>
                            @if (!string.IsNullOrEmpty(expandedAppointment.TimeZoneId) && expandedAppointment.TimeZoneId != "UTC")
                            {
                                <div class="meta-row">
                                    <span class="meta-label"><strong>Timezone:</strong></span>
                                    <span class="meta-value">üìç @expandedAppointment.TimeZoneId</span>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(expandedAppointment.Reason))
                            {
                                <div class="meta-row">
                                    <span class="meta-label"><strong>Reason:</strong></span>
                                    <span class="meta-value">@expandedAppointment.Reason</span>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(expandedAppointment.Notes))
                            {
                                <div class="meta-row">
                                    <span class="meta-label"><strong>Notes:</strong></span>
                                    <span class="meta-value">@expandedAppointment.Notes</span>
                                </div>
                            }
                            <div class="meta-row">
                                <span class="meta-label"><strong>Created By:</strong></span>
                                <span class="meta-value">@expandedAppointment.CreatedBy</span>
                            </div>
                            <div class="meta-row">
                                <span class="meta-label"><strong>Created At:</strong></span>
                                <span class="meta-value">@expandedAppointment.CreatedAt.ToString("MMM dd, yyyy HH:mm")</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </ExpansionTemplate>
    </SMDataGrid>

    <!-- Add/Edit Appointment Modal -->
    @if (showDialog)
    {
        <SMModal IsVisible="@showDialog" 
                 Title="@(editingAppointment == null ? "New Appointment" : "Edit Appointment")" 
                 OnClose="CloseDialog"
                 Size="Large">
            <Body>
                @if (!string.IsNullOrEmpty(validationError))
                {
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i> @validationError
                    </div>
                }
                @if (validationWarnings.Any())
                {
                    <div class="validation-warning">
                        <strong>Warnings:</strong>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            @foreach (var warning in validationWarnings)
                            {
                                <li>@warning</li>
                            }
                        </ul>
                    </div>
                }
                <div class="form-row-3">
                    @if (AuthService.CurrentUser?.RoleId == 2) // Doctor - show read-only
                    {
                        <div class="form-group">
                            <label class="form-label">Doctor</label>
                            <RadzenTextBox Value="@currentDoctorName" 
                                ReadOnly="true" Style="width: 100%; background-color: #f5f5f5;" />
                        </div>
                    }
                    else // Admin or Coordinator - show dropdown
                    {
                        <div class="form-group">
                            <label class="form-label">Doctor <span class="required-asterisk">*</span></label>
                            <RadzenDropDown Data="@doctors" TextProperty="FullName" ValueProperty="Id"
                                @bind-value="appointmentForm.DoctorId" Change="@OnDoctorChanged"
                                AllowFiltering="true" Placeholder="Select Doctor"
                                Style="width: 100%" />
                        </div>
                    }
                    <div class="form-group">
                        <label class="form-label">Patient <span class="required-asterisk">*</span></label>
                        <RadzenDropDown Data="@availablePatients" TextProperty="FullName" ValueProperty="Id"
                            @bind-value="appointmentForm.PatientId" AllowFiltering="true" Placeholder="Select Patient"
                            Style="width: 100%" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Appointment Type</label>
                        <RadzenDropDown Data="@appointmentTypes" TextProperty="Name" ValueProperty="Value"
                            @bind-value="appointmentForm.AppointmentType" TValue="AppointmentType" Style="width: 100%" />
                    </div>
                </div>
                @if (appointmentForm.DoctorId > 0 && availablePatients.Count == 0)
                {
                    <div class="error-message form-row-full">No patients assigned to this doctor. Please assign a patient first.</div>
                }
                @if (appointmentForm.DoctorId > 0)
                {
                    <div class="form-row form-row-full">
                        <div class="form-group" style="width: 100%;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <label class="form-label" style="margin-bottom: 0;">Doctor Out of Office Periods</label>
                                <RadzenButton Text="View All OOO" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small"
                                    Click="@(() => ShowAllOOOView(appointmentForm.DoctorId))" Icon="event_busy" />
                            </div>
                            @if (doctorOOOPeriods.Any())
                            {
                                <div style="background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 10px; max-height: 200px; overflow-y: auto;">
                                    <div style="font-weight: 600; margin-bottom: 8px; color: #856404;">
                                        <i class="fas fa-exclamation-triangle"></i> Doctor is unavailable during these periods:
                                    </div>
                                    @foreach (var ooo in doctorOOOPeriods.OrderBy(o => o.Date).ThenBy(o => o.StartTime ?? TimeSpan.Zero))
                                    {
                                        <div style="margin-bottom: 8px; padding: 8px; background-color: white; border-radius: 3px; font-size: 13px;">
                                            <div style="font-weight: 500; color: #333;">
                                                üìÖ @ooo.Date.ToString("MMM dd, yyyy")
                                                @if (ooo.StartTime.HasValue && ooo.EndTime.HasValue)
                                                {
                                                    <span style="color: #856404;">
                                                        - @($"{ooo.StartTime.Value.Hours:D2}:{ooo.StartTime.Value.Minutes:D2}") to @($"{ooo.EndTime.Value.Hours:D2}:{ooo.EndTime.Value.Minutes:D2}")
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span style="color: #dc3545; font-weight: 600;">- FULL DAY</span>
                                                }
                                            </div>
                                            @if (!string.IsNullOrEmpty(ooo.Reason))
                                            {
                                                <div style="color: #666; font-size: 12px; margin-top: 4px;">
                                                    <i class="fas fa-info-circle"></i> @ooo.Reason
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div style="background-color: #d4edda; border: 1px solid #28a745; border-radius: 4px; padding: 10px; color: #155724;">
                                    <i class="fas fa-check-circle"></i> Doctor is available (no OOO periods in the next 30 days)
                                </div>
                            }
                        </div>
                    </div>
                }
                <div class="form-row-3">
                    <div class="form-group">
                        <label class="form-label">Date <span class="required-asterisk">*</span></label>
                        <RadzenDatePicker @bind-value="appointmentDateTime" DateFormat="MM/dd/yyyy" 
                            Style="width: 100%" 
                            Change="@(async (DateTime? date) => { if (date.HasValue && appointmentForm.DoctorId > 0) { await LoadDoctorOOOPeriods(appointmentForm.DoctorId); } })" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time <span class="required-asterisk">*</span></label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <RadzenDropDown Data="@hourOptions" @bind-value="appointmentHour" 
                                TValue="int" Style="width: 80px;" Placeholder="Hour" />
                            <span>:</span>
                            <RadzenDropDown Data="@minuteOptions" @bind-value="appointmentMinute" 
                                TValue="int" Style="width: 80px;" Placeholder="Min" />
                            <RadzenDropDown Data="@amPmOptions" @bind-value="appointmentAmPm" 
                                TValue="string" Style="width: 80px;" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Duration (minutes) <span class="required-asterisk">*</span></label>
                        <RadzenNumeric TValue="int" @bind-value="durationMinutes" Min="15" Max="240" Step="15" 
                            Style="width: 100%" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Timezone <span class="required-asterisk">*</span></label>
                        <RadzenDropDown Data="@timezones" TextProperty="DisplayName" ValueProperty="Id"
                            @bind-value="selectedTimezone" TValue="string" AllowFiltering="true" Placeholder="Select Timezone"
                            Style="width: 100%" />
                    </div>
                </div>
                <div class="form-row form-row-full">
                    <div class="form-group" style="width: 100%;">
                        <label class="form-label">Reason</label>
                        <RadzenTextBox @bind-value="appointmentForm.Reason" Placeholder="Reason for appointment" 
                            Style="width: 100%" />
                    </div>
                </div>
                <div class="form-row form-row-full">
                    <div class="form-group" style="width: 100%;">
                        <label class="form-label">Notes</label>
                        <RadzenTextArea @bind-value="appointmentForm.Notes" Placeholder="Additional notes" 
                            Rows="3" Style="width: 100%" />
                    </div>
                </div>
            </Body>
            <Footer>
                <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@CloseDialog" />
                <RadzenButton Text="@(editingAppointment == null ? "Create" : "Update")" 
                    ButtonStyle="ButtonStyle.Success" Click="@SaveAppointment" />
            </Footer>
        </SMModal>
    }

    <!-- OOO Management Modal -->
    @if (showOOODialog)
    {
        <SMModal IsVisible="@showOOODialog" 
                 Title="Manage Doctor Out of Office" 
                 OnClose="CloseOOODialog"
                 Size="Large">
            <Body>
                <div class="form-group">
                    <label class="form-label">Doctor</label>
                    @if (AuthService.CurrentUser?.RoleId == 2) // Doctor - show read-only
                    {
                        <RadzenTextBox Value="@currentDoctorName" 
                            ReadOnly="true" Style="width: 100%; background-color: #f5f5f5;" />
                    }
                    else // Admin or Coordinator - show dropdown
                    {
                        <RadzenDropDown Data="@doctors" TextProperty="FullName" ValueProperty="Id"
                            Value="@oooForm.DoctorId" ValueChanged="@((int? value) => OnOOODoctorChanged(value))" AllowFiltering="true" Placeholder="Select Doctor"
                            Style="width: 100%" />
                    }
                </div>
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <RadzenDatePicker Value="@oooDate" ValueChanged="@((DateTime? value) => OnOOODateChanged(value))" DateFormat="MM/dd/yyyy" 
                        Style="width: 100%" />
                </div>
                <div class="form-group">
                    <label class="form-label">Timezone <span class="required-asterisk">*</span></label>
                    <RadzenDropDown Data="@timezones" TextProperty="DisplayName" ValueProperty="Id"
                        @bind-value="selectedOOOTimezone" TValue="string" AllowFiltering="true" Placeholder="Select Timezone"
                        Style="width: 100%" />
                </div>
                <div class="form-group">
                    <RadzenCheckBox @bind-value="oooForm.IsOutOfOffice" Name="IsOutOfOffice" />
                    <label>Mark as Out of Office</label>
                </div>
                @if (oooForm.IsOutOfOffice)
                {
                    <div class="form-group">
                        <label class="form-label">Reason</label>
                        <RadzenTextBox @bind-value="oooForm.Reason" Placeholder="Reason for being out of office" 
                            Style="width: 100%" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Partial Day (Optional)</label>
                        <div style="margin-bottom: 10px;">
                            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                <span style="min-width: 50px;">From:</span>
                                <RadzenDropDown Data="@hourOptions" @bind-value="oooStartHour" 
                                    TValue="int?" Style="width: 80px;" Placeholder="Hour" />
                                <span>:</span>
                                <RadzenDropDown Data="@minuteOptions" @bind-value="oooStartMinute" 
                                    TValue="int?" Style="width: 80px;" Placeholder="Min" />
                                <RadzenDropDown Data="@amPmOptions" @bind-value="oooStartAmPm" 
                                    TValue="string" Style="width: 80px;" />
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <span style="min-width: 50px;">To:</span>
                                <RadzenDropDown Data="@hourOptions" @bind-value="oooEndHour" 
                                    TValue="int?" Style="width: 80px;" Placeholder="Hour" />
                                <span>:</span>
                                <RadzenDropDown Data="@minuteOptions" @bind-value="oooEndMinute" 
                                    TValue="int?" Style="width: 80px;" Placeholder="Min" />
                                <RadzenDropDown Data="@amPmOptions" @bind-value="oooEndAmPm" 
                                    TValue="string" Style="width: 80px;" />
                            </div>
                        </div>
                        <small style="color: #666;">Leave empty for full day OOO</small>
                    </div>
                    @if (oooForm.StartTime.HasValue || oooForm.EndTime.HasValue)
                    {
                        <div class="form-group" style="background-color: #f0f0f0; padding: 10px; border-radius: 4px; margin-top: 10px;">
                            <strong>Current OOO Time:</strong>
                            <div style="margin-top: 5px;">
                                @if (oooForm.StartTime.HasValue && oooForm.EndTime.HasValue)
                                {
                                    <span>@($"{oooForm.StartTime.Value.Hours:D2}:{oooForm.StartTime.Value.Minutes:D2}") - @($"{oooForm.EndTime.Value.Hours:D2}:{oooForm.EndTime.Value.Minutes:D2}")</span>
                                }
                                else if (oooForm.StartTime.HasValue)
                                {
                                    <span>From @($"{oooForm.StartTime.Value.Hours:D2}:{oooForm.StartTime.Value.Minutes:D2}")</span>
                                }
                                else if (oooForm.EndTime.HasValue)
                                {
                                    <span>Until @($"{oooForm.EndTime.Value.Hours:D2}:{oooForm.EndTime.Value.Minutes:D2}")</span>
                                }
                                else
                                {
                                    <span>Full Day</span>
                                }
                                @if (!string.IsNullOrEmpty(selectedOOOTimezone) && selectedOOOTimezone != "UTC")
                                {
                                    <div style="font-size: 11px; color: #666; margin-top: 3px;">üìç @selectedOOOTimezone</div>
                                }
                            </div>
                        </div>
                    }
                }
            </Body>
            <Footer>
                <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@CloseOOODialog" />
                <RadzenButton Text="Save" ButtonStyle="ButtonStyle.Success" Click="@SaveOOO" />
            </Footer>
        </SMModal>
    }

    <!-- View All OOO Periods Modal -->
    @if (showOOOView)
    {
        <SMModal IsVisible="@showOOOView" 
                 Title="Doctor Out of Office Periods" 
                 OnClose="CloseOOOView"
                 Size="Large">
            <Body>
                @if (selectedDoctorForOOO.HasValue)
                {
                    var selectedDoctor = doctors.FirstOrDefault(d => d.Id == selectedDoctorForOOO.Value);
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Doctor</label>
                                <RadzenTextBox Value="@(selectedDoctor != null ? $"{selectedDoctor.FirstName} {selectedDoctor.LastName}" : "")" 
                                    ReadOnly="true" Style="width: 100%; background-color: #f5f5f5;" />
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Start Date</label>
                                <RadzenDatePicker @bind-value="oooViewStartDate" DateFormat="MM/dd/yyyy" 
                                    Style="width: 100%" Change="@(async (DateTime? date) => { if (date.HasValue) { oooViewStartDate = date.Value; await LoadAllOOOPeriods(selectedDoctorForOOO.Value); } })" />
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">End Date</label>
                                <RadzenDatePicker @bind-value="oooViewEndDate" DateFormat="MM/dd/yyyy" 
                                    Style="width: 100%" Change="@(async (DateTime? date) => { if (date.HasValue) { oooViewEndDate = date.Value; await LoadAllOOOPeriods(selectedDoctorForOOO.Value); } })" />
                            </div>
                            <div class="form-group" style="display: flex; align-items: end;">
                                <RadzenButton Text="Refresh" ButtonStyle="ButtonStyle.Info" 
                                    Click="@(async () => await LoadAllOOOPeriods(selectedDoctorForOOO.Value))" Icon="refresh" />
                            </div>
                        </div>
                    </div>

                    @if (doctorOOOPeriods.Any())
                    {
                        <div style="max-height: 500px; overflow-y: auto;">
                            <div style="margin-bottom: 10px; font-weight: 600; color: #333;">
                                Found @doctorOOOPeriods.Count OOO period(s) in the selected date range:
                            </div>
                            @foreach (var ooo in doctorOOOPeriods.OrderBy(o => o.Date).ThenBy(o => o.StartTime ?? TimeSpan.Zero))
                            {
                                <div style="margin-bottom: 12px; padding: 12px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; color: #856404; margin-bottom: 6px; font-size: 15px;">
                                                <i class="fas fa-calendar-times"></i> @ooo.Date.ToString("dddd, MMMM dd, yyyy")
                                            </div>
                                            @if (ooo.StartTime.HasValue && ooo.EndTime.HasValue)
                                            {
                                                <div style="color: #856404; margin-bottom: 6px;">
                                                    <i class="fas fa-clock"></i> 
                                                    <strong>@($"{ooo.StartTime.Value.Hours:D2}:{ooo.StartTime.Value.Minutes:D2}")</strong> 
                                                    to 
                                                    <strong>@($"{ooo.EndTime.Value.Hours:D2}:{ooo.EndTime.Value.Minutes:D2}")</strong>
                                                </div>
                                            }
                                            else
                                            {
                                                <div style="color: #dc3545; font-weight: 600; margin-bottom: 6px;">
                                                    <i class="fas fa-ban"></i> FULL DAY - Doctor is unavailable all day
                                                </div>
                                            }
                                            @if (!string.IsNullOrEmpty(ooo.Reason))
                                            {
                                                <div style="color: #666; font-size: 13px; margin-top: 6px; padding: 8px; background-color: white; border-radius: 3px;">
                                                    <i class="fas fa-info-circle"></i> <strong>Reason:</strong> @ooo.Reason
                                                </div>
                                            }
                                            @if (!string.IsNullOrEmpty(ooo.TimeZoneId) && ooo.TimeZoneId != "UTC")
                                            {
                                                <div style="color: #666; font-size: 12px; margin-top: 4px;">
                                                    <i class="fas fa-globe"></i> Timezone: @ooo.TimeZoneId
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div style="text-align: center; padding: 40px; background-color: #d4edda; border: 1px solid #28a745; border-radius: 4px; color: #155724;">
                            <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 15px;"></i>
                            <div style="font-size: 16px; font-weight: 600;">No Out of Office Periods</div>
                            <div style="font-size: 14px; margin-top: 8px;">Doctor is available during the selected date range.</div>
                        </div>
                    }
                }
            </Body>
            <Footer>
                <RadzenButton Text="Close" ButtonStyle="ButtonStyle.Light" Click="CloseOOOView" />
            </Footer>
        </SMModal>
    }
</div>

@code {
    private SMDataGrid<AppointmentDto>? _grid;
    private List<User> doctors = new();
    private List<User> patients = new();
    private List<User> availablePatients = new();
    private Dictionary<int, AppointmentDto> expandedAppointments = new Dictionary<int, AppointmentDto>();
    private List<DoctorAvailability> doctorOOOPeriods = new();
    private bool showOOOView = false;
    private int? selectedDoctorForOOO = null;
    private DateTime oooViewStartDate = DateTime.Now.Date;
    private DateTime oooViewEndDate = DateTime.Now.Date.AddDays(30);
    
    private List<SMDataGridColumn<AppointmentDto>> _columns = new();
    private List<SMDataGridActionButton<AppointmentDto>> _actions = new();
    private bool showDialog = false;
    private bool showOOODialog = false;
    private AppointmentDto? editingAppointment = null;
    private CreateAppointmentRequest appointmentForm = new();
    private DoctorAvailabilityRequest oooForm = new();
    private string selectedOOOTimezone = "America/New_York"; // Default timezone for OOO
    
    // Filters
    private int? filterDoctorId = null;
    private int? filterPatientId = null;
    private DateTime? filterStartDate = null;
    private DateTime? filterEndDate = null;

    // Appointment form
    private DateTime? appointmentDateTime = DateTime.Now.Date.AddDays(1);
    private int appointmentHour = 9; // 1-12
    private int appointmentMinute = 0; // 0-59
    private string appointmentAmPm = "AM"; // "AM" or "PM"

    // OOO form
    private DateTime? oooDate = DateTime.Now.Date;
    private int? oooStartHour = null; // 1-12
    private int? oooStartMinute = null; // 0-59
    private string oooStartAmPm = "AM"; // "AM" or "PM"
    private int? oooEndHour = null; // 1-12
    private int? oooEndMinute = null; // 0-59
    private string oooEndAmPm = "AM"; // "AM" or "PM"

    private int durationMinutes = 30;
    private string validationError = "";
    private List<string> validationWarnings = new();
    private string selectedTimezone = "America/New_York"; // Default timezone
    private string currentDoctorName = ""; // For doctor read-only display

    private class AppointmentTypeOption
    {
        public string Name { get; set; } = string.Empty;
        public AppointmentType Value { get; set; }
    }

    private class TimezoneOption
    {
        public string Id { get; set; } = string.Empty;
        public string DisplayName { get; set; } = string.Empty;
    }

    private List<AppointmentTypeOption> appointmentTypes = new()
    {
        new AppointmentTypeOption { Name = "Regular", Value = AppointmentType.Regular },
        new AppointmentTypeOption { Name = "Urgent Care", Value = AppointmentType.UrgentCare }
    };

    private List<int> hourOptions = Enumerable.Range(1, 12).ToList();
    private List<int> minuteOptions = Enumerable.Range(0, 60).ToList();
    private List<string> amPmOptions = new() { "AM", "PM" };

    private List<TimezoneOption> timezones = new()
    {
        new TimezoneOption { Id = "America/New_York", DisplayName = "Eastern Time (ET) - America/New_York" },
        new TimezoneOption { Id = "America/Chicago", DisplayName = "Central Time (CT) - America/Chicago" },
        new TimezoneOption { Id = "America/Denver", DisplayName = "Mountain Time (MT) - America/Denver" },
        new TimezoneOption { Id = "America/Los_Angeles", DisplayName = "Pacific Time (PT) - America/Los_Angeles" },
        new TimezoneOption { Id = "America/Phoenix", DisplayName = "Arizona Time - America/Phoenix" },
        new TimezoneOption { Id = "America/Anchorage", DisplayName = "Alaska Time - America/Anchorage" },
        new TimezoneOption { Id = "Pacific/Honolulu", DisplayName = "Hawaii Time - Pacific/Honolulu" },
        new TimezoneOption { Id = "UTC", DisplayName = "Coordinated Universal Time (UTC)" },
        new TimezoneOption { Id = "Europe/London", DisplayName = "Greenwich Mean Time (GMT) - Europe/London" },
        new TimezoneOption { Id = "Europe/Paris", DisplayName = "Central European Time (CET) - Europe/Paris" },
        new TimezoneOption { Id = "Asia/Tokyo", DisplayName = "Japan Standard Time (JST) - Asia/Tokyo" },
        new TimezoneOption { Id = "Asia/Shanghai", DisplayName = "China Standard Time (CST) - Asia/Shanghai" },
        new TimezoneOption { Id = "Asia/Dubai", DisplayName = "Gulf Standard Time (GST) - Asia/Dubai" },
        new TimezoneOption { Id = "Asia/Kolkata", DisplayName = "India Standard Time (IST) - Asia/Kolkata" },
        new TimezoneOption { Id = "Australia/Sydney", DisplayName = "Australian Eastern Time (AET) - Australia/Sydney" },
        new TimezoneOption { Id = "America/Toronto", DisplayName = "Eastern Time (ET) - America/Toronto" },
        new TimezoneOption { Id = "America/Vancouver", DisplayName = "Pacific Time (PT) - America/Vancouver" },
        new TimezoneOption { Id = "America/Mexico_City", DisplayName = "Central Time (CT) - America/Mexico_City" },
        new TimezoneOption { Id = "America/Sao_Paulo", DisplayName = "Brasilia Time - America/Sao_Paulo" },
        new TimezoneOption { Id = "Europe/Berlin", DisplayName = "Central European Time (CET) - Europe/Berlin" }
    };

    protected override async Task OnInitializedAsync()
    {
        await AuthService.InitializeAsync();
        await LoadData();
        InitializeColumns();
        InitializeActions();
    }

    private async Task LoadData()
    {
        try
        {
            // Check user role
            var currentUser = AuthService.CurrentUser;
            var isDoctor = currentUser?.RoleId == 2;
            var isAdmin = currentUser?.RoleId == 3;
            var isCoordinator = currentUser?.RoleId == 4;

            if (isDoctor)
            {
                // For doctors: clear all filters (API will automatically filter by doctor)
                filterDoctorId = null;
                filterPatientId = null;
                filterStartDate = null;
                filterEndDate = null;

                // For doctors: load only their assigned patients
                List<User>? patientsResponse = null;
                try
                {
                    patientsResponse = await Http.GetFromJsonAsync<List<User>>("api/doctor/my-patients");
                }
                catch
                {
                    try
                    {
                        if (currentUser != null)
                        {
                            patientsResponse = await Http.GetFromJsonAsync<List<User>>($"api/admin/doctor/{currentUser.Id}/patients");
                        }
                    }
                    catch
                    {
                        patientsResponse = new();
                    }
                }
                availablePatients = patientsResponse ?? new();
                patients = availablePatients;
                
                if (currentUser != null)
                {
                    var doctorUser = new User
                    {
                        Id = currentUser.Id,
                        FirstName = currentUser.FirstName,
                        LastName = currentUser.LastName,
                        Email = currentUser.Email,
                        RoleId = currentUser.RoleId
                    };
                    doctors = new List<User> { doctorUser };
                    currentDoctorName = $"{currentUser.FirstName} {currentUser.LastName}";
                    appointmentForm.DoctorId = currentUser.Id;
                }
            }
            else if (isAdmin || isCoordinator)
            {
                var doctorsResponse = await Http.GetFromJsonAsync<List<User>>("api/admin/doctors");
                doctors = doctorsResponse ?? new();

                var patientsResponse = await Http.GetFromJsonAsync<List<User>>("api/admin/patients");
                patients = patientsResponse ?? new();
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Error loading data: {ex.Message}");
        }
    }

    private void InitializeColumns()
    {
        _columns = new List<SMDataGridColumn<AppointmentDto>>
        {
            new SMDataGridTemplateColumn<AppointmentDto>
            {
                Property = nameof(AppointmentDto.AppointmentDateTime),
                Title = "Date & Time",
                Width = "180px",
                Template = appointment => builder =>
                {
                    builder.OpenElement(0, "div");
                    builder.AddContent(1, appointment.AppointmentDateTime.ToString("MM/dd/yyyy"));
                    builder.CloseElement();
                    builder.OpenElement(2, "div");
                    builder.AddAttribute(3, "style", "font-size: 12px; color: #666;");
                    builder.AddContent(4, appointment.AppointmentDateTime.ToString("hh:mm tt"));
                    builder.CloseElement();
                    if (!string.IsNullOrEmpty(appointment.TimeZoneId) && appointment.TimeZoneId != "UTC")
                    {
                        builder.OpenElement(5, "div");
                        builder.AddAttribute(6, "style", "font-size: 11px; color: #999; margin-top: 2px;");
                        builder.AddContent(7, $"üìç {appointment.TimeZoneId}");
                        builder.CloseElement();
                    }
                }
            },
            new SMDataGridColumn<AppointmentDto>
            {
                Property = nameof(AppointmentDto.DoctorName),
                Title = "Doctor",
                Width = "150px"
            },
            new SMDataGridColumn<AppointmentDto>
            {
                Property = nameof(AppointmentDto.PatientName),
                Title = "Patient",
                Width = "150px"
            },
            new SMDataGridTemplateColumn<AppointmentDto>
            {
                Property = nameof(AppointmentDto.Duration),
                Title = "Duration",
                Width = "100px",
                Template = appointment => builder =>
                {
                    builder.AddContent(0, $"{appointment.Duration.TotalMinutes:0} min");
                }
            },
            new SMDataGridTemplateColumn<AppointmentDto>
            {
                Property = nameof(AppointmentDto.AppointmentType),
                Title = "Type",
                Width = "120px",
                Template = appointment => builder =>
                {
                    if (appointment.IsUrgentCare)
                    {
                        builder.OpenElement(0, "span");
                        builder.AddAttribute(1, "class", "badge-urgent");
                        builder.AddContent(2, "URGENT CARE");
                        builder.CloseElement();
                    }
                    else
                    {
                        builder.OpenElement(3, "span");
                        builder.AddAttribute(4, "class", "badge-regular");
                        builder.AddContent(5, "REGULAR");
                        builder.CloseElement();
                    }
                    if (!appointment.IsBusinessHours && !appointment.IsUrgentCare)
                    {
                        builder.OpenElement(6, "span");
                        builder.AddAttribute(7, "class", "badge-after-hours");
                        builder.AddContent(8, "AFTER HOURS");
                        builder.CloseElement();
                    }
                }
            },
            new SMDataGridTemplateColumn<AppointmentDto>
            {
                Property = nameof(AppointmentDto.Status),
                Title = "Status",
                Width = "120px",
                Template = appointment => builder =>
                {
                    builder.OpenElement(0, "span");
                    builder.AddAttribute(1, "class", $"status-badge status-{appointment.Status.ToString().ToLower()}");
                    builder.AddContent(2, appointment.Status.ToString().ToUpper());
                    builder.CloseElement();
                }
            },
            new SMDataGridColumn<AppointmentDto>
            {
                Property = nameof(AppointmentDto.Reason),
                Title = "Reason",
                Width = "200px"
            },
            new SMDataGridColumn<AppointmentDto>
            {
                Property = nameof(AppointmentDto.CreatedBy),
                Title = "Created By",
                Width = "120px"
            }
        };
    }

    private void InitializeActions()
    {
        _actions.Add(new SMDataGridActionButton<AppointmentDto>
        {
            Icon = "edit",
            ButtonStyle = ButtonStyle.Light,
            Variant = Variant.Flat,
            Size = ButtonSize.Small,
            Tooltip = "Edit appointment",
            OnClick = async (row, ct) => await EditAppointmentAsync(row, ct)
        });

        _actions.Add(new SMDataGridActionButton<AppointmentDto>
        {
            Icon = "cancel",
            ButtonStyle = ButtonStyle.Danger,
            Variant = Variant.Flat,
            Size = ButtonSize.Small,
            Tooltip = "Cancel appointment",
            OnClick = async (row, ct) => await CancelAppointmentAsync(row, ct),
            Disabled = (appointment) => appointment.Status != AppointmentStatus.Scheduled && appointment.Status != AppointmentStatus.Confirmed
        });
    }

    private async Task<PagedResult<AppointmentDto>> LoadAppointmentsPagedAsync(
        int skip, 
        int take, 
        string? orderBy, 
        string? filter, 
        CancellationToken ct)
    {
        try
        {
            // Build OData filter
            var odataFilter = "";
            
            // Add doctor filter if specified (for admins and coordinators)
            int? doctorId = null;
            if ((AuthService.CurrentUser?.RoleId == 3 || AuthService.CurrentUser?.RoleId == 4) && filterDoctorId.HasValue)
            {
                doctorId = filterDoctorId.Value;
                odataFilter = $"DoctorId eq {doctorId.Value}";
            }
            
            // Add patient filter if specified
            if (filterPatientId.HasValue)
            {
                if (!string.IsNullOrEmpty(odataFilter))
                    odataFilter += " and ";
                odataFilter += $"PatientId eq {filterPatientId.Value}";
            }
            
            // Add date range filters if specified
            if (filterStartDate.HasValue)
            {
                if (!string.IsNullOrEmpty(odataFilter))
                    odataFilter += " and ";
                var startDateStr = filterStartDate.Value.ToString("yyyy-MM-dd");
                odataFilter += $"AppointmentDateTime ge {startDateStr}";
            }
            
            if (filterEndDate.HasValue)
            {
                if (!string.IsNullOrEmpty(odataFilter))
                    odataFilter += " and ";
                var endDateStr = filterEndDate.Value.AddDays(1).ToString("yyyy-MM-dd"); // Add 1 day to include the end date
                odataFilter += $"AppointmentDateTime lt {endDateStr}";
            }
            
            // Transform and combine any additional filter from grid
            if (!string.IsNullOrEmpty(filter))
            {
                // Decode URL-encoded filter from Radzen
                var decodedFilter = System.Net.WebUtility.UrlDecode(filter);
                
                // Handle DoctorName, PatientName, and CreatedBy filters (these are DTO-only, need special handling)
                // Check if filter contains these properties first
                var hasDoctorName = decodedFilter.Contains("DoctorName", StringComparison.OrdinalIgnoreCase);
                var hasPatientName = decodedFilter.Contains("PatientName", StringComparison.OrdinalIgnoreCase);
                var hasCreatedBy = decodedFilter.Contains("CreatedBy", StringComparison.OrdinalIgnoreCase);
                
                if (hasDoctorName)
                {
                    var doctorNameFilter = ExtractNameFilter(decodedFilter, "DoctorName");
                    if (!string.IsNullOrEmpty(doctorNameFilter))
                    {
                        // Find matching doctor IDs
                        var doctorIds = await FindUserIdsByName(doctorNameFilter, 2, ct); // RoleId 2 = Doctor
                        if (doctorIds.Any())
                        {
                            var doctorIdFilter = string.Join(" or ", doctorIds.Select(id => $"DoctorId eq {id}"));
                            if (!string.IsNullOrEmpty(odataFilter))
                                odataFilter = $"{odataFilter} and ({doctorIdFilter})";
                            else
                                odataFilter = $"({doctorIdFilter})";
                        }
                        else
                        {
                            // No matching doctors, return empty result
                            return new PagedResult<AppointmentDto>
                            {
                                Items = new List<AppointmentDto>(),
                                TotalCount = 0,
                                PageNumber = (skip / take) + 1,
                                PageSize = take
                            };
                        }
                    }
                    // Always remove DoctorName filter from the rest (even if extraction failed)
                    decodedFilter = RemoveNameFilter(decodedFilter, "DoctorName");
                }
                
                if (hasPatientName)
                {
                    var patientNameFilter = ExtractNameFilter(decodedFilter, "PatientName");
                    if (!string.IsNullOrEmpty(patientNameFilter))
                    {
                        // Find matching patient IDs
                        var patientIds = await FindUserIdsByName(patientNameFilter, 1, ct); // RoleId 1 = Patient
                        if (patientIds.Any())
                        {
                            var patientIdFilter = string.Join(" or ", patientIds.Select(id => $"PatientId eq {id}"));
                            if (!string.IsNullOrEmpty(odataFilter))
                                odataFilter = $"{odataFilter} and ({patientIdFilter})";
                            else
                                odataFilter = $"({patientIdFilter})";
                        }
                        else
                        {
                            // No matching patients, return empty result
                            return new PagedResult<AppointmentDto>
                            {
                                Items = new List<AppointmentDto>(),
                                TotalCount = 0,
                                PageNumber = (skip / take) + 1,
                                PageSize = take
                            };
                        }
                    }
                    // Always remove PatientName filter from the rest (even if extraction failed)
                    decodedFilter = RemoveNameFilter(decodedFilter, "PatientName");
                }
                
                if (hasCreatedBy)
                {
                    var createdByFilter = ExtractNameFilter(decodedFilter, "CreatedBy");
                    if (!string.IsNullOrEmpty(createdByFilter))
                    {
                        // Find matching user IDs (can be any role - doctor, admin, coordinator, etc.)
                        // Search across all roles since CreatedByUserId can be any user
                        var userIds = await FindUserIdsByName(createdByFilter, null, ct); // null = all roles
                        if (userIds.Any())
                        {
                            var userIdFilter = string.Join(" or ", userIds.Select(id => $"CreatedByUserId eq {id}"));
                            if (!string.IsNullOrEmpty(odataFilter))
                                odataFilter = $"{odataFilter} and ({userIdFilter})";
                            else
                                odataFilter = $"({userIdFilter})";
                        }
                        else
                        {
                            // No matching users, return empty result
                            return new PagedResult<AppointmentDto>
                            {
                                Items = new List<AppointmentDto>(),
                                TotalCount = 0,
                                PageNumber = (skip / take) + 1,
                                PageSize = take
                            };
                        }
                    }
                    // Always remove CreatedBy filter from the rest (even if extraction failed)
                    decodedFilter = RemoveNameFilter(decodedFilter, "CreatedBy");
                }
                
                // Clean up any leftover operators from removed filters
                decodedFilter = CleanupFilterOperators(decodedFilter);
                
                // Transform remaining C#-style filter to OData syntax (only if there's actual content)
                string? transformedFilter = null;
                if (!string.IsNullOrWhiteSpace(decodedFilter) && !IsOnlyOperators(decodedFilter))
                {
                    transformedFilter = ODataFilterHelper.TransformToOData(decodedFilter);
                }
                
                // Combine with existing filters
                if (!string.IsNullOrEmpty(transformedFilter))
                {
                    if (!string.IsNullOrEmpty(odataFilter))
                        odataFilter = $"{odataFilter} and ({transformedFilter})";
                    else
                        odataFilter = transformedFilter;
                }
            }
            
            // Transform orderBy to use entity properties instead of DTO properties
            string? transformedOrderBy = null;
            if (!string.IsNullOrEmpty(orderBy))
            {
                transformedOrderBy = TransformOrderBy(orderBy);
            }
            
            // Query OData endpoint
            var result = await ODataService.QueryAsync<AppointmentDto>(
                "Appointments",
                skip,
                take,
                transformedOrderBy,
                string.IsNullOrEmpty(odataFilter) ? null : odataFilter,
                ct
            );
            
            // If we sorted by DoctorName, PatientName, or CreatedBy, we need to sort the results client-side
            // because OData can't sort by computed DTO properties
            if (!string.IsNullOrEmpty(orderBy) && (orderBy.Contains("DoctorName", StringComparison.OrdinalIgnoreCase) || 
                                                     orderBy.Contains("PatientName", StringComparison.OrdinalIgnoreCase) ||
                                                     orderBy.Contains("CreatedBy", StringComparison.OrdinalIgnoreCase)))
            {
                result = SortResultsByComputedProperty(result, orderBy);
            }
            
            return result;
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to load appointments: {ex.Message}");
            return new PagedResult<AppointmentDto>
            {
                Items = new List<AppointmentDto>(),
                TotalCount = 0,
                PageNumber = (skip / take) + 1,
                PageSize = take
            };
        }
    }

    private string? ExtractNameFilter(string filter, string propertyName)
    {
        // Extract search term from Radzen-generated filters like:
        // (DoctorName == null ? "" : DoctorName).ToLower().Contains("Dr.".ToLower())
        // contains(DoctorName, 'dr')
        // DoctorName contains 'dr'
        var patterns = new[]
        {
            // Radzen C#-style: (DoctorName == null ? "" : DoctorName).ToLower().Contains("value".ToLower())
            $@"\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\(\)\.Contains\(""([^""]+)""\.ToLower\(\)\)",
            // Radzen C#-style with single quotes
            $@"\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\(\)\.Contains\('([^']+)'\.ToLower\(\)\)",
            // OData-style: contains(DoctorName, 'dr')
            $@"contains\({propertyName},\s*'([^']+)'\)",
            // OData-style: DoctorName contains 'dr'
            $@"{propertyName}\s+contains\s+'([^']+)'",
            // OData-style with tolower
            $@"contains\(tolower\({propertyName}\),\s*tolower\('([^']+)'\)\)",
            $@"tolower\({propertyName}\)\s+contains\s+'([^']+)'"
        };
        
        foreach (var pattern in patterns)
        {
            var match = System.Text.RegularExpressions.Regex.Match(filter, pattern, System.Text.RegularExpressions.RegexOptions.IgnoreCase);
            if (match.Success && match.Groups.Count > 1)
            {
                return match.Groups[1].Value;
            }
        }
        
        return null;
    }
    
    private string CleanupFilterOperators(string filter)
    {
        if (string.IsNullOrWhiteSpace(filter))
            return string.Empty;
            
        var result = filter;
        
        // Remove standalone operators at the start
        result = System.Text.RegularExpressions.Regex.Replace(result, @"^\s*(and|or)\s+", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        
        // Remove standalone operators at the end
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\s+(and|or)\s+$", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        
        // Remove empty parentheses: () or ( ) or (and) or (or)
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\(\s*(and|or)?\s*\)", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        
        // Remove duplicate operators
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\s+(and|or)\s+(and|or)\s+", " $1 ", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        
        // Remove operators before/after parentheses
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\s+(and|or)\s+\(", " (", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\)\s+(and|or)\s+", ") ", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        
        result = result.Trim();
        return result;
    }
    
    private bool IsOnlyOperators(string filter)
    {
        if (string.IsNullOrWhiteSpace(filter))
            return true;
            
        // Remove all whitespace and check if only operators remain
        var cleaned = System.Text.RegularExpressions.Regex.Replace(filter, @"\s+", "");
        var onlyOperators = System.Text.RegularExpressions.Regex.IsMatch(cleaned, @"^(and|or|\(|\)|\s)+$", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        return onlyOperators;
    }
    
    private string RemoveNameFilter(string filter, string propertyName)
    {
        // Remove the filter clause for the given property name
        // Handle Radzen C#-style filters: (DoctorName == null ? "" : DoctorName).ToLower().Contains("value".ToLower())
        var patterns = new[]
        {
            // Radzen C#-style with double quotes
            $@"\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\(\)\.Contains\(""[^""]+""\.ToLower\(\)\)",
            // Radzen C#-style with single quotes
            $@"\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\(\)\.Contains\('[^']+'\.ToLower\(\)\)",
            // Radzen C#-style without parentheses: (Property == null ? "" : Property).ToLower.Contains("value".ToLower)
            $@"\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\.Contains\(""[^""]+""\.ToLower\)",
            $@"\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\.Contains\('[^']+'\.ToLower\)",
            // OData-style patterns
            $@"contains\({propertyName},\s*'[^']+'\)",
            $@"{propertyName}\s+contains\s+'[^']+'",
            $@"contains\(tolower\({propertyName}\),\s*tolower\('[^']+'\)\)",
            $@"tolower\({propertyName}\)\s+contains\s+'[^']+'",
            // With "and" operators
            $@"and\s+\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\(\)\.Contains\(""[^""]+""\.ToLower\(\)\)",
            $@"and\s+\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\(\)\.Contains\('[^']+'\.ToLower\(\)\)",
            $@"and\s+\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\.Contains\(""[^""]+""\.ToLower\)",
            $@"and\s+\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\.Contains\('[^']+'\.ToLower\)",
            $@"and\s+contains\({propertyName},\s*'[^']+'\)",
            $@"and\s+{propertyName}\s+contains\s+'[^']+'",
            // With trailing "and"
            $@"\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\(\)\.Contains\(""[^""]+""\.ToLower\(\)\)\s+and",
            $@"\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\(\)\.Contains\('[^']+'\.ToLower\(\)\)\s+and",
            $@"\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\.Contains\(""[^""]+""\.ToLower\)\s+and",
            $@"\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\.Contains\('[^']+'\.ToLower\)\s+and",
            $@"contains\({propertyName},\s*'[^']+'\)\s+and",
            $@"{propertyName}\s+contains\s+'[^']+'\s+and"
        };
        
        var result = filter;
        foreach (var pattern in patterns)
        {
            result = System.Text.RegularExpressions.Regex.Replace(result, pattern, "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        }
        
        // Clean up extra "and" or "or" operators
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\s+and\s+and\s+", " and ", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\s+or\s+or\s+", " or ", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @"^\s*and\s+", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\s+and\s+$", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @"^\s*or\s+", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\s+or\s+$", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        
        // Remove empty parentheses
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\(\s*\)", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\(\s*(and|or)\s*\)", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        
        result = result.Trim();
        
        return result;
    }
    
    private string? TransformOrderBy(string? orderBy)
    {
        if (string.IsNullOrEmpty(orderBy))
            return orderBy;
            
        // Transform DTO property names to entity property names
        // DoctorName, PatientName, and CreatedBy are DTO-only, so we can't sort by them in OData
        // We'll sort client-side instead, but we need to remove them from the OData orderBy
        var result = orderBy;
        
        // Remove DoctorName, PatientName, and CreatedBy from orderBy (we'll sort client-side)
        // Pattern: "DoctorName asc" or "DoctorName desc" or "DoctorName, OtherProperty asc"
        result = System.Text.RegularExpressions.Regex.Replace(result, @"DoctorName\s+(asc|desc),?\s*", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @"PatientName\s+(asc|desc),?\s*", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @"CreatedBy\s+(asc|desc),?\s*", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @",\s*DoctorName\s+(asc|desc)", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @",\s*PatientName\s+(asc|desc)", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @",\s*CreatedBy\s+(asc|desc)", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        
        // Clean up extra commas
        result = System.Text.RegularExpressions.Regex.Replace(result, @",\s*,", ",", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = result.Trim().TrimStart(',').TrimEnd(',');
        
        // If result is empty, return null (no OData sorting)
        if (string.IsNullOrWhiteSpace(result))
            return null;
            
        return result;
    }
    
    private PagedResult<AppointmentDto> SortResultsByComputedProperty(PagedResult<AppointmentDto> result, string orderBy)
    {
        if (result.Items == null || !result.Items.Any())
            return result;
            
        var items = result.Items.ToList();
        var orderByLower = orderBy.ToLowerInvariant();
        
        // Parse orderBy: "DoctorName asc" or "PatientName desc" or "CreatedBy asc"
        var isDescending = orderByLower.Contains("desc");
        
        if (orderByLower.Contains("doctorname"))
        {
            items = isDescending
                ? items.OrderByDescending(a => a.DoctorName).ToList()
                : items.OrderBy(a => a.DoctorName).ToList();
        }
        else if (orderByLower.Contains("patientname"))
        {
            items = isDescending
                ? items.OrderByDescending(a => a.PatientName).ToList()
                : items.OrderBy(a => a.PatientName).ToList();
        }
        else if (orderByLower.Contains("createdby"))
        {
            items = isDescending
                ? items.OrderByDescending(a => a.CreatedBy).ToList()
                : items.OrderBy(a => a.CreatedBy).ToList();
        }
        
        return new PagedResult<AppointmentDto>
        {
            Items = items,
            TotalCount = result.TotalCount,
            PageNumber = result.PageNumber,
            PageSize = result.PageSize
        };
    }
    
    private async Task<List<int>> FindUserIdsByName(string searchTerm, int? roleId, CancellationToken ct)
    {
        try
        {
            // Query Users OData to find matching users by name
            string nameFilter;
            if (roleId.HasValue)
            {
                nameFilter = $"(RoleId eq {roleId.Value}) and (contains(FirstName, '{searchTerm}') or contains(LastName, '{searchTerm}'))";
            }
            else
            {
                // Search across all roles
                nameFilter = $"(contains(FirstName, '{searchTerm}') or contains(LastName, '{searchTerm}'))";
            }
            var result = await ODataService.QueryAsync<Shared.User>("Users", 0, 1000, null, nameFilter, ct);
            
            return result.Items.Select(u => u.Id).ToList();
        }
        catch (Exception ex)
        {
            return new List<int>();
        }
    }

    private async Task OnRowExpand(AppointmentDto appointment)
    {
        try
        {
            if (!expandedAppointments.ContainsKey(appointment.Id))
            {
                var fullAppointment = await AppointmentService.GetAsync(appointment.Id);
                if (fullAppointment != null)
                {
                    expandedAppointments[appointment.Id] = fullAppointment;
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to load appointment details: {ex.Message}");
        }
    }

    private async Task ApplyFilters()
    {
        if (_grid != null)
        {
            await _grid.RefreshAsync();
        }
    }

    private async Task LoadAvailablePatients(int doctorId)
    {
        try
        {
            var response = await Http.GetFromJsonAsync<List<User>>($"api/admin/doctor/{doctorId}/patients");
            availablePatients = response ?? new();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            availablePatients = new();
            await JSRuntime.InvokeVoidAsync("console.error", $"Error loading patients: {ex.Message}");
        }
    }

    private async Task ShowAddDialog()
    {
        editingAppointment = null;
        var currentUser = AuthService.CurrentUser;
        var isDoctor = currentUser?.RoleId == 2;
        var isCoordinator = currentUser?.RoleId == 4;
        var isAdmin = currentUser?.RoleId == 3;

        appointmentForm = new CreateAppointmentRequest
        {
            AppointmentType = AppointmentType.Regular,
            Duration = TimeSpan.FromMinutes(30),
            TimeZoneId = "America/New_York",
            DoctorId = isDoctor ? (currentUser?.Id ?? 0) : 0
        };
        appointmentDateTime = DateTime.Now.Date.AddDays(1);
        appointmentHour = 9;
        appointmentMinute = 0;
        appointmentAmPm = "AM";
        durationMinutes = 30;
        selectedTimezone = "America/New_York";
        validationError = "";
        validationWarnings = new();

        // Load patients based on role
        if (isDoctor)
        {
            // For doctors, load their assigned patients (already loaded in LoadData)
            availablePatients = patients;
            // Load OOO periods for the doctor
            await LoadDoctorOOOPeriods(appointmentForm.DoctorId);
        }
        else if (isCoordinator)
        {
            // For coordinators, load their assigned patients
            try
            {
                if (currentUser != null)
                {
                    var response = await Http.GetFromJsonAsync<List<User>>($"api/admin/doctor/{currentUser.Id}/patients");
                    availablePatients = response ?? new();
                }
                else
                {
                    availablePatients = new();
                }
            }
            catch (Exception ex)
            {
                availablePatients = new();
                await JSRuntime.InvokeVoidAsync("console.error", $"Error loading coordinator patients: {ex.Message}");
            }
            doctorOOOPeriods = new();
        }
        else if (isAdmin)
        {
            // For admin, load all patients (already loaded in LoadData)
            availablePatients = patients;
            doctorOOOPeriods = new();
        }
        else
        {
            availablePatients = new();
            doctorOOOPeriods = new();
        }

        showDialog = true;
        await InvokeAsync(StateHasChanged);
    }

    private async Task EditAppointmentAsync(AppointmentDto appointment, CancellationToken ct)
    {
        var currentUser = AuthService.CurrentUser;
        var isDoctor = currentUser?.RoleId == 2;

        // Doctors can only edit their own appointments
        if (isDoctor && appointment.DoctorId != currentUser?.Id)
        {
            NotificationService.ShowWarning("You can only edit your own appointments");
            return;
        }

        editingAppointment = appointment;
        appointmentForm = new CreateAppointmentRequest
        {
            DoctorId = appointment.DoctorId,
            PatientId = appointment.PatientId,
            AppointmentDateTime = appointment.AppointmentDateTime,
            Duration = appointment.Duration,
            AppointmentType = appointment.AppointmentType,
            Reason = appointment.Reason,
            Notes = appointment.Notes,
            TimeZoneId = !string.IsNullOrEmpty(appointment.TimeZoneId) ? appointment.TimeZoneId : "America/New_York"
        };
        appointmentDateTime = appointment.AppointmentDateTime.Date;
        
        // Convert 24-hour to 12-hour format
        var hour24 = appointment.AppointmentDateTime.Hour;
        appointmentHour = hour24 == 0 ? 12 : (hour24 > 12 ? hour24 - 12 : hour24);
        appointmentMinute = appointment.AppointmentDateTime.Minute;
        appointmentAmPm = hour24 >= 12 ? "PM" : "AM";
        
        durationMinutes = (int)appointment.Duration.TotalMinutes;
        selectedTimezone = !string.IsNullOrEmpty(appointment.TimeZoneId) ? appointment.TimeZoneId : "America/New_York";
        validationError = "";
        validationWarnings = new();
        showDialog = true;
        
        if (isDoctor)
        {
            availablePatients = patients; // Already loaded
        }
        else
        {
            await LoadAvailablePatients(appointment.DoctorId);
        }
        
        // Load OOO periods for the doctor
        await LoadDoctorOOOPeriods(appointment.DoctorId);
        
        await InvokeAsync(StateHasChanged);
    }

    private async Task SaveAppointment()
    {
        try
        {
            validationError = "";
            validationWarnings = new();

            if (appointmentForm.DoctorId == 0)
            {
                validationError = "Please select a doctor";
                return;
            }

            if (appointmentForm.PatientId == 0)
            {
                validationError = "Please select a patient";
                return;
            }

            if (!appointmentDateTime.HasValue)
            {
                validationError = "Please select a date";
                return;
            }

            if (appointmentHour < 1 || appointmentHour > 12)
            {
                validationError = "Please select a valid hour";
                return;
            }

            if (appointmentMinute < 0 || appointmentMinute > 59)
            {
                validationError = "Please select a valid minute";
                return;
            }

            if (string.IsNullOrWhiteSpace(selectedTimezone))
            {
                validationError = "Please select a timezone";
                return;
            }

            // Convert 12-hour to 24-hour format
            int hour24 = appointmentHour;
            if (appointmentAmPm == "PM" && appointmentHour != 12)
            {
                hour24 = appointmentHour + 12;
            }
            else if (appointmentAmPm == "AM" && appointmentHour == 12)
            {
                hour24 = 0;
            }

            var timeSpan = new TimeSpan(hour24, appointmentMinute, 0);

            // Create DateTime in the selected timezone (as Unspecified kind)
            var localDateTime = appointmentDateTime.Value.Date.Add(timeSpan);
            appointmentForm.AppointmentDateTime = DateTime.SpecifyKind(localDateTime, DateTimeKind.Unspecified);
            appointmentForm.Duration = TimeSpan.FromMinutes(durationMinutes);
            appointmentForm.TimeZoneId = selectedTimezone;

            // Validate before creating
            var validationResponse = await Http.PostAsJsonAsync("api/appointment/validate", appointmentForm);
            if (validationResponse.IsSuccessStatusCode)
            {
                var validationResult = await validationResponse.Content.ReadFromJsonAsync<AppointmentValidationResult>();
                if (validationResult != null && !validationResult.IsValid)
                {
                    validationError = validationResult.ErrorMessage ?? "Validation failed";
                    validationWarnings = validationResult.Warnings;
                    return;
                }
                if (validationResult != null && validationResult.Warnings.Any())
                {
                    validationWarnings = validationResult.Warnings;
                }
            }

            HttpResponseMessage response;
            if (editingAppointment == null)
            {
                response = await Http.PostAsJsonAsync("api/appointment", appointmentForm);
            }
            else
            {
                var updateRequest = new UpdateAppointmentRequest
                {
                    Id = editingAppointment.Id,
                    AppointmentDateTime = appointmentForm.AppointmentDateTime,
                    Duration = appointmentForm.Duration,
                    AppointmentType = appointmentForm.AppointmentType,
                    Reason = appointmentForm.Reason,
                    Notes = appointmentForm.Notes,
                    TimeZoneId = appointmentForm.TimeZoneId
                };
                response = await Http.PutAsJsonAsync($"api/appointment/{editingAppointment.Id}", updateRequest);
            }

            if (response.IsSuccessStatusCode)
            {
                NotificationService.ShowSuccess("Appointment saved successfully!");
                await CloseDialog();
                if (_grid != null)
                {
                    await _grid.RefreshAsync();
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                validationError = $"Error saving appointment: {errorContent}";
            }
        }
        catch (Exception ex)
        {
            validationError = $"Error: {ex.Message}";
        }
    }

    private async Task CancelAppointmentAsync(AppointmentDto appointment, CancellationToken ct)
    {
        var currentUser = AuthService.CurrentUser;
        var isDoctor = currentUser?.RoleId == 2;

        // Doctors can only cancel their own appointments
        if (isDoctor && appointment.DoctorId != currentUser?.Id)
        {
            NotificationService.ShowWarning("You can only cancel your own appointments");
            return;
        }

        var details = $"Patient: {appointment.PatientName}\n" +
                     $"Date: {appointment.AppointmentDateTime:MM/dd/yyyy}\n" +
                     $"Time: {appointment.AppointmentDateTime:hh:mm tt}";
        
        var confirmed = await JSRuntime.ConfirmDestructiveAsync("cancel this appointment", details, "appointment");
        
        if (!confirmed)
            return;

        try
        {
            await AppointmentService.CancelAsync(appointment.Id, ct);
            NotificationService.ShowSuccess("Appointment cancelled successfully!");
            if (_grid != null)
            {
                await _grid.RefreshAsync();
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to cancel appointment: {ex.Message}");
        }
    }

    private async Task CloseDialog()
    {
        showDialog = false;
        editingAppointment = null;
        appointmentForm = new();
        validationError = "";
        validationWarnings = new();
        await InvokeAsync(StateHasChanged);
    }

    private async Task ClearFilters()
    {
        filterDoctorId = null;
        filterPatientId = null;
        filterStartDate = null;
        filterEndDate = null;
        if (_grid != null)
        {
            await _grid.RefreshAsync();
        }
    }

    private async Task ShowOOODialog()
    {
        var currentUser = AuthService.CurrentUser;
        var isDoctor = currentUser?.RoleId == 2;

        oooForm = new DoctorAvailabilityRequest
        {
            IsOutOfOffice = false,
            DoctorId = isDoctor ? (currentUser?.Id ?? 0) : 0
        };
        oooDate = DateTime.Now.Date;
        oooStartHour = null;
        oooStartMinute = null;
        oooStartAmPm = "AM";
        oooEndHour = null;
        oooEndMinute = null;
        oooEndAmPm = "AM";
        selectedOOOTimezone = "America/New_York"; // Reset to default
        showOOODialog = true;
        await InvokeAsync(StateHasChanged);

        // Load existing OOO entry if doctor is selected and date is set
        if (oooForm.DoctorId > 0 && oooDate.HasValue)
        {
            await LoadExistingOOO();
        }
    }

    private async Task LoadExistingOOO()
    {
        if (oooForm.DoctorId == 0 || !oooDate.HasValue)
            return;

        try
        {
            var response = await Http.GetAsync($"api/appointment/doctor-availability/{oooForm.DoctorId}?date={oooDate.Value:yyyy-MM-dd}");
            if (response.IsSuccessStatusCode)
            {
                var availability = await response.Content.ReadFromJsonAsync<DoctorAvailability>();
                if (availability != null)
                {
                    oooForm.IsOutOfOffice = availability.IsOutOfOffice;
                    oooForm.Reason = availability.Reason ?? "";
                    oooForm.StartTime = availability.StartTime;
                    oooForm.EndTime = availability.EndTime;
                    selectedOOOTimezone = availability.TimeZoneId ?? "America/New_York";
                    
                    // Convert 24-hour TimeSpan to 12-hour format
                    if (availability.StartTime.HasValue)
                    {
                        var hour24 = availability.StartTime.Value.Hours;
                        oooStartHour = hour24 == 0 ? 12 : (hour24 > 12 ? hour24 - 12 : hour24);
                        oooStartMinute = availability.StartTime.Value.Minutes;
                        oooStartAmPm = hour24 >= 12 ? "PM" : "AM";
                    }
                    else
                    {
                        oooStartHour = null;
                        oooStartMinute = null;
                        oooStartAmPm = "AM";
                    }
                    
                    if (availability.EndTime.HasValue)
                    {
                        var hour24 = availability.EndTime.Value.Hours;
                        oooEndHour = hour24 == 0 ? 12 : (hour24 > 12 ? hour24 - 12 : hour24);
                        oooEndMinute = availability.EndTime.Value.Minutes;
                        oooEndAmPm = hour24 >= 12 ? "PM" : "AM";
                    }
                    else
                    {
                        oooEndHour = null;
                        oooEndMinute = null;
                        oooEndAmPm = "AM";
                    }
                    
                    await InvokeAsync(StateHasChanged);
                }
            }
        }
        catch (Exception ex)
        {
            // Silently fail - it's okay if there's no existing entry
        }
    }

    private async Task SaveOOO()
    {
        try
        {
            var currentUser = AuthService.CurrentUser;
            var isDoctor = currentUser?.RoleId == 2;

            // For doctors, ensure they're setting it for themselves
            if (isDoctor)
            {
                oooForm.DoctorId = currentUser?.Id ?? 0;
            }

            if (oooForm.DoctorId == 0)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Please select a doctor");
                return;
            }

            if (!oooDate.HasValue)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Please select a date");
                return;
            }

            oooForm.Date = oooDate.Value;
            oooForm.TimeZoneId = selectedOOOTimezone;
            
            // Convert 12-hour format to 24-hour TimeSpan
            if (oooStartHour.HasValue && oooStartMinute.HasValue)
            {
                int hour24 = oooStartHour.Value;
                if (oooStartAmPm == "PM" && oooStartHour.Value != 12)
                {
                    hour24 = oooStartHour.Value + 12;
                }
                else if (oooStartAmPm == "AM" && oooStartHour.Value == 12)
                {
                    hour24 = 0;
                }
                oooForm.StartTime = new TimeSpan(hour24, oooStartMinute.Value, 0);
            }
            else
            {
                oooForm.StartTime = null;
            }

            if (oooEndHour.HasValue && oooEndMinute.HasValue)
            {
                int hour24 = oooEndHour.Value;
                if (oooEndAmPm == "PM" && oooEndHour.Value != 12)
                {
                    hour24 = oooEndHour.Value + 12;
                }
                else if (oooEndAmPm == "AM" && oooEndHour.Value == 12)
                {
                    hour24 = 0;
                }
                oooForm.EndTime = new TimeSpan(hour24, oooEndMinute.Value, 0);
            }
            else
            {
                oooForm.EndTime = null;
            }

            var response = await Http.PostAsJsonAsync("api/appointment/doctor-availability", oooForm);
            if (response.IsSuccessStatusCode)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Doctor availability updated successfully!");
                await CloseOOODialog();
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                await JSRuntime.InvokeVoidAsync("alert", $"Error: {errorContent}");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
    }

    private async Task OnOOODoctorChanged(int? doctorId)
    {
        if (doctorId.HasValue)
        {
            oooForm.DoctorId = doctorId.Value;
            if (oooDate.HasValue)
            {
                await LoadExistingOOO();
            }
        }
    }

    private async Task OnOOODateChanged(DateTime? date)
    {
        oooDate = date;
        if (date.HasValue && oooForm.DoctorId > 0)
        {
            await LoadExistingOOO();
        }
    }

    private async Task CloseOOODialog()
    {
        showOOODialog = false;
        oooDate = null;
        oooForm = new();
        oooStartHour = null;
        oooStartMinute = null;
        oooStartAmPm = "AM";
        oooEndHour = null;
        oooEndMinute = null;
        oooEndAmPm = "AM";
        selectedOOOTimezone = "America/New_York";
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnDoctorChanged()
    {
        if (appointmentForm.DoctorId > 0 && showDialog)
        {
            await LoadAvailablePatients(appointmentForm.DoctorId);
            if (availablePatients.Count == 0)
            {
                appointmentForm.PatientId = 0;
            }
            // Load OOO periods for the selected doctor
            await LoadDoctorOOOPeriods(appointmentForm.DoctorId);
        }
        else
        {
            availablePatients = new();
            appointmentForm.PatientId = 0;
            doctorOOOPeriods = new();
        }
        StateHasChanged();
    }

    private async Task LoadDoctorOOOPeriods(int doctorId)
    {
        try
        {
            var startDate = appointmentDateTime?.Date ?? DateTime.Now.Date;
            var endDate = startDate.AddDays(30);
            var response = await Http.GetAsync($"api/appointment/doctor-availability/{doctorId}/range?startDate={startDate:yyyy-MM-dd}&endDate={endDate:yyyy-MM-dd}");
            if (response.IsSuccessStatusCode)
            {
                doctorOOOPeriods = await response.Content.ReadFromJsonAsync<List<DoctorAvailability>>() ?? new();
            }
            else
            {
                doctorOOOPeriods = new();
            }
        }
        catch (Exception ex)
        {
            doctorOOOPeriods = new();
        }
    }

    private async Task ShowAllOOOView(int doctorId)
    {
        selectedDoctorForOOO = doctorId;
        oooViewStartDate = DateTime.Now.Date;
        oooViewEndDate = DateTime.Now.Date.AddDays(90); // Show next 90 days
        await LoadAllOOOPeriods(doctorId);
        showOOOView = true;
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadAllOOOPeriods(int doctorId)
    {
        try
        {
            var response = await Http.GetAsync($"api/appointment/doctor-availability/{doctorId}/range?startDate={oooViewStartDate:yyyy-MM-dd}&endDate={oooViewEndDate:yyyy-MM-dd}");
            if (response.IsSuccessStatusCode)
            {
                doctorOOOPeriods = await response.Content.ReadFromJsonAsync<List<DoctorAvailability>>() ?? new();
            }
            else
            {
                doctorOOOPeriods = new();
            }
        }
        catch (Exception ex)
        {
            doctorOOOPeriods = new();
        }
        await InvokeAsync(StateHasChanged);
    }

    private async Task CloseOOOView()
    {
        showOOOView = false;
        selectedDoctorForOOO = null;
        doctorOOOPeriods = new();
        await InvokeAsync(StateHasChanged);
    }
}
