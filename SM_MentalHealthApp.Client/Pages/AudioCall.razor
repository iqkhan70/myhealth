@page "/audio-call/{UserId:int}"
@using SM_MentalHealthApp.Client.Services
@using SM_MentalHealthApp.Shared
@inject IAgoraService AgoraService
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject IJSRuntime JSRuntime
@inject IRealtimeService RealtimeService
@inject ISignalRService SignalRService
@implements IAsyncDisposable

<PageTitle>Audio Call</PageTitle>

<div class="audio-call-container">
    @if (!isInitialized)
    {
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>Initializing audio call...</p>
        </div>
    }
    else if (!isInCall)
    {
        // ‚úÖ Check if this is an incoming call (has channel parameter)
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var isIncomingCall = !string.IsNullOrEmpty(uri.Query) && uri.Query.Contains("channel=");
        
        @if (isIncomingCall)
        {
            // ‚úÖ Incoming call - show connecting state (auto-join is happening)
            <div class="call-setup">
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <h3>Connecting to call...</h3>
                    <p>@callStatus</p>
                    @if (!string.IsNullOrEmpty(error))
                    {
                        <p class="text-danger">@error</p>
                    }
                </div>
                <div class="call-actions" style="margin-top: 20px;">
                    <button class="btn btn-danger btn-lg" @onclick="CancelCall">
                        Cancel
                    </button>
                </div>
            </div>
        }
        else
        {
            // ‚úÖ Outgoing call - show Start Call button or connecting state
            @if (isConnecting)
            {
                // ‚úÖ Show connecting state while call is being established
                <div class="call-setup">
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <h3>Connecting...</h3>
                        <p>@callStatus</p>
                        @if (!string.IsNullOrEmpty(error))
                        {
                            <p class="text-danger">@error</p>
                        }
                    </div>
                    <div class="call-actions" style="margin-top: 20px;">
                        <button class="btn btn-danger btn-lg" @onclick="CancelCall">
                            Cancel
                        </button>
                    </div>
                </div>
            }
            else
            {
                // ‚úÖ Show Start Call button when not connecting
                <div class="call-setup">
                    <div class="call-info">
                        <h3>Audio Call with @targetUser?.FirstName @targetUser?.LastName</h3>
                        <p>Click "Start Call" to begin the audio call</p>
                    </div>
                    <div class="call-actions">
                        <button class="btn btn-primary btn-lg" @onclick="() => StartCall(UserId)">
                            Start Call
                        </button>
                        <button class="btn btn-secondary btn-lg" @onclick="CancelCall">
                            Cancel
                        </button>
                    </div>
                </div>
            }
        }
    }
    else
    {
        <div class="audio-call-interface">
            <!-- Audio Call Status -->
            <div class="audio-status">
                <div class="user-avatar">
                    <i class="fas fa-user fa-4x"></i>
                </div>
                <h3>@targetUser?.FirstName @targetUser?.LastName</h3>
                <p class="call-status">@callStatus</p>

                @if (remoteUsers.Any())
                {
                    <p class="connected-status">
                        <i class="fas fa-phone text-success"></i>
                        Connected
                    </p>
                }
                else
                {
                    <p class="connecting-status">
                        <i class="fas fa-spinner fa-spin"></i>
                        Connecting...
                    </p>
                }
            </div>

            <!-- Call Controls -->
            <div class="call-controls">
                <div class="control-buttons">
                    <button class="control-btn @(isMuted ? "active" : "")" @onclick="ToggleMute"
                        title="@(isMuted ? "Unmute" : "Mute")">
                        <i class="fas @(isMuted ? "fa-microphone-slash" : "fa-microphone")"></i>
                    </button>

                    <button class="control-btn end-call" @onclick="EndCall" title="End Call">
                        <i class="fas fa-phone-slash"></i>
                    </button>
                </div>
            </div>
        </div>
    }

    @if (!string.IsNullOrEmpty(error))
    {
        <div class="alert alert-danger mt-3">
            <strong>Error:</strong> @error
        </div>
    }
</div>

<style>
    .audio-call-container {
        height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-align: center;
    }

    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-top: 5px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .call-setup {
        max-width: 400px;
        padding: 40px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        backdrop-filter: blur(10px);
    }

    .call-info h3 {
        margin-bottom: 10px;
        font-size: 1.5rem;
    }

    .call-info p {
        margin-bottom: 30px;
        opacity: 0.9;
    }

    .call-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
    }

    .audio-call-interface {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 40px;
        max-width: 400px;
    }

    .audio-status {
        text-align: center;
    }

    .user-avatar {
        width: 120px;
        height: 120px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
    }

    .call-status {
        font-size: 1.1rem;
        margin: 10px 0;
        opacity: 0.9;
    }

    .connected-status {
        color: #4CAF50;
        font-weight: bold;
        margin-top: 15px;
    }

    .connecting-status {
        color: #FFC107;
        margin-top: 15px;
    }

    .call-controls {
        display: flex;
        justify-content: center;
    }

    .control-buttons {
        display: flex;
        gap: 20px;
    }

    .control-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: none;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .control-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }

    .control-btn.active {
        background: #f44336;
    }

    .control-btn.end-call {
        background: #f44336;
    }

    .control-btn.end-call:hover {
        background: #d32f2f;
    }

    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>

@code {
    [Parameter] public int UserId { get; set; }

    private User? targetUser;
    private bool isInitialized = false;
    private bool isInCall = false;
    private bool isConnecting = false;
    private bool isMuted = false;
    private string callStatus = "Initializing...";
    private string error = "";
    private List<uint> remoteUsers = new();
    private string currentChannel = "";
    private Timer? callTimeoutTimer = null; // Timer to auto-close if receiver doesn't answer
    private DateTime callStartTime = DateTime.MinValue;
    private bool receiverJoined = false; // Flag to track if receiver has joined (prevents timeout from firing)

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // ‚úÖ CRITICAL: Clean up any existing Agora connection to avoid UID_CONFLICT
            // This handles cases where user logged out/in or navigated back to call page
            try
            {
                if (AgoraService.IsInCall)
                {
                    Console.WriteLine($"‚ö†Ô∏è AudioCall: Detected existing call, cleaning up to avoid UID_CONFLICT");
                    await AgoraService.LeaveChannelAsync();
                    await Task.Delay(300); // Small delay for cleanup
                }
            }
            catch (Exception cleanupEx)
            {
                Console.WriteLine($"‚ö†Ô∏è AudioCall: Error during cleanup (non-critical): {cleanupEx.Message}");
            }

            // Get target user info
            targetUser = await GetUserById(UserId);
            if (targetUser == null)
            {
                error = "User not found";
                return;
            }

            // Initialize Agora
            var initialized = await AgoraService.InitializeAsync("b480142a879c4ed2ab7efb07d318abda");

            if (!initialized)
            {
                error = "Failed to initialize audio service";
                return;
            }

            isInitialized = true;
            
            // ‚úÖ Set up Agora event handlers to detect when remote user leaves
            AgoraService.OnUserJoined += HandleUserJoined;
            AgoraService.OnUserLeft += HandleUserLeft;
            AgoraService.OnConnectionStateChanged += HandleConnectionStateChanged;
            AgoraService.OnError += HandleError;
            Console.WriteLine("üìû AudioCall: Agora event handlers set up");

            // ‚úÖ Check if this is an incoming call (has channel parameter)
            // Works for both mobile calls (mobile_call=true) and web-to-web calls
            var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
            var queryString = uri.Query;
            Console.WriteLine($"üîç AudioCall: Checking query string: {queryString}");
            
            if (!string.IsNullOrEmpty(queryString))
            {
                var queryParams = new Dictionary<string, string>();
                foreach (var param in queryString.TrimStart('?').Split('&'))
                {
                    var parts = param.Split('=', 2);
                    if (parts.Length == 2)
                    {
                        queryParams[Uri.UnescapeDataString(parts[0])] = Uri.UnescapeDataString(parts[1]);
                    }
                }

                Console.WriteLine($"üîç AudioCall: Query params: {string.Join(", ", queryParams.Select(kvp => $"{kvp.Key}={kvp.Value}"))}");

                // ‚úÖ Auto-join if channel parameter exists
                // Check if this is an incoming call (has mobile_call=true) or outgoing call (caller initiated)
                if (queryParams.TryGetValue("channel", out var channelParam))
                {
                    Console.WriteLine($"‚úÖ AudioCall: Found channel parameter: {channelParam}");
                    
                    if (!string.IsNullOrEmpty(channelParam))
                    {
                        // ‚úÖ CRITICAL: Set currentChannel immediately so rejection handler can match it
                        currentChannel = channelParam;
                        Console.WriteLine($"üìû AudioCall: Set currentChannel to: {currentChannel} (for rejection handling)");
                        
                        // Check if this is a mobile call (incoming) or web-to-web call
                        var isMobileCall = queryParams.TryGetValue("mobile_call", out var mobileCallParam) && 
                                          mobileCallParam?.ToLower() == "true";
                        
                        if (isMobileCall)
                        {
                            // This is an incoming call from mobile - auto-join as receiver
                            Console.WriteLine("üì± AudioCall: This is an incoming mobile call - joining as receiver");
                            callStatus = "Joining incoming call...";
                            StateHasChanged(); // Update UI immediately
                            await JoinIncomingCallAsync(channelParam);
                            StateHasChanged(); // Update UI after join
                            return;
                        }
                        else
                        {
                            // This is an outgoing call (caller initiated from RealTimeChat) - start the call
                            Console.WriteLine("üìû AudioCall: This is an outgoing call - starting call as caller");
                            callStatus = "Starting call...";
                            StateHasChanged(); // Update UI immediately
                            await StartCall(UserId); // UserId is the target user ID
                            StateHasChanged(); // Update UI after start
                            return;
                        }
                    }
                    else
                    {
                        Console.WriteLine("‚ö†Ô∏è AudioCall: Channel parameter is empty");
                    }
                }
                else
                {
                    Console.WriteLine("‚ö†Ô∏è AudioCall: No channel parameter found in query string - this is a manual call");
                }
            }
            else
            {
                Console.WriteLine("‚ö†Ô∏è AudioCall: No query string found - this is an outgoing call");
            }

            callStatus = "Ready to call";
            
            // ‚úÖ Ensure SignalRService is connected
            if (!SignalRService.IsConnected)
            {
                Console.WriteLine("üìû AudioCall: SignalRService not connected, starting...");
                try
                {
                    await SignalRService.StartAsync();
                    await Task.Delay(1000); // Wait for connection
                    Console.WriteLine($"üìû AudioCall: SignalRService connection state: {SignalRService.IsConnected}");
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"‚ö†Ô∏è AudioCall: Error starting SignalRService: {ex.Message}");
                }
            }
            else
            {
                Console.WriteLine("üìû AudioCall: SignalRService is already connected");
            }
            
            // ‚úÖ Subscribe to call-ended events so both parties get notified
            RealtimeService.OnCallEnded += HandleCallEnded;
            SignalRService.OnCallEnded += HandleCallEnded;
            Console.WriteLine("üìû AudioCall: Subscribed to call-ended events from both services");
            
            // ‚úÖ Subscribe to call-rejected events so caller gets notified when receiver declines
            RealtimeService.OnCallRejected += HandleCallRejected;
            SignalRService.OnCallRejected += HandleCallRejected;
            Console.WriteLine("üìû AudioCall: Subscribed to call-rejected events from both services");
        }
        catch (Exception ex)
        {
            error = $"Initialization failed: {ex.Message}";
        }
    }
    
    private void HandleCallEnded(string channelName)
    {
        Console.WriteLine($"üìû ========== AudioCall: Call ended event received ==========");
        Console.WriteLine($"üìû AudioCall: Received channelName: '{channelName}'");
        Console.WriteLine($"üìû AudioCall: Current channel: '{currentChannel}'");
        Console.WriteLine($"üìû AudioCall: Channels match: {channelName == currentChannel}");
        Console.WriteLine($"üìû AudioCall: isInCall: {isInCall}");
        
        // ‚úÖ Check if this call-ended event is for our current call
        // Use case-insensitive comparison and also check if either is empty
        var channelsMatch = !string.IsNullOrEmpty(channelName) && 
                           !string.IsNullOrEmpty(currentChannel) && 
                           channelName.Equals(currentChannel, StringComparison.OrdinalIgnoreCase);
        
        if (channelsMatch || isInCall) // If we're in a call, assume it's for us
        {
            Console.WriteLine($"üìû AudioCall: ‚úÖ This is our call! Navigating back to chat...");
            // Navigate back to chat on the UI thread
            _ = Task.Run(async () =>
            {
                try
                {
                    if (isInCall)
                    {
                        await AgoraService.LeaveChannelAsync();
                        await Task.Delay(300); // Small delay for cleanup
                    }
                    await InvokeAsync(() =>
                    {
                        Console.WriteLine($"üìû AudioCall: Navigating to /real-time-chat");
                        Navigation.NavigateTo("/real-time-chat");
                        StateHasChanged();
                    });
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"‚ùå AudioCall: Error in HandleCallEnded: {ex.Message}");
                }
            });
        }
        else
        {
            Console.WriteLine($"üìû AudioCall: ‚ö†Ô∏è Call-ended event is for a different channel, ignoring");
            Console.WriteLine($"üìû AudioCall:   Received: '{channelName}'");
            Console.WriteLine($"üìû AudioCall:   Current: '{currentChannel}'");
        }
        Console.WriteLine($"üìû ========== End AudioCall: Call ended event ==========");
    }

    private void HandleCallRejected(string callId)
    {
        Console.WriteLine($"üìû ========== AudioCall: Call rejected event received ==========");
        Console.WriteLine($"üìû AudioCall: Received callId: '{callId}'");
        Console.WriteLine($"üìû AudioCall: Current channel: '{currentChannel}'");
        Console.WriteLine($"üìû AudioCall: isInCall: {isInCall}");
        Console.WriteLine($"üìû AudioCall: isConnecting: {isConnecting}");
        
        // ‚úÖ Stop the timeout timer since receiver declined
        StopCallTimeoutTimer();
        
        // ‚úÖ Check if this rejection is for our current call
        // Match by channel name (callId from server is usually the channel name)
        var channelsMatch = !string.IsNullOrEmpty(callId) && 
                           !string.IsNullOrEmpty(currentChannel) && 
                           callId.Equals(currentChannel, StringComparison.OrdinalIgnoreCase);
        
        // ‚úÖ Also check if we're on the AudioCall page (caller initiated a call)
        // If we're on this page and have a channel, we should handle rejection
        var isOnCallPage = Navigation.Uri.Contains("/audio-call/");
        
        // ‚úÖ If we're the caller (either in call or connecting, or on call page with channel), handle rejection
        if (channelsMatch || isInCall || isConnecting || (!string.IsNullOrEmpty(currentChannel) && isOnCallPage))
        {
            Console.WriteLine($"üìû AudioCall: ‚úÖ Call was rejected by receiver! Closing call...");
            
            // Navigate back to chat on the UI thread
            _ = Task.Run(async () =>
            {
                try
                {
                    // Leave Agora channel if we're in a call
                    if (isInCall)
                    {
                        await AgoraService.LeaveChannelAsync();
                        await Task.Delay(300); // Small delay for cleanup
                    }
                    
                    await InvokeAsync(() =>
                    {
                        // Show notification
                        NotificationService.Notify(NotificationSeverity.Warning, "Call Declined", 
                            $"{targetUser?.FirstName} {targetUser?.LastName} declined your call");
                        
                        Console.WriteLine($"üìû AudioCall: Navigating to /real-time-chat (call rejected)");
                        Navigation.NavigateTo("/real-time-chat");
                        StateHasChanged();
                    });
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"‚ùå AudioCall: Error in HandleCallRejected: {ex.Message}");
                }
            });
        }
        else
        {
            Console.WriteLine($"üìû AudioCall: ‚ö†Ô∏è Call-rejected event is for a different call, ignoring");
            Console.WriteLine($"üìû AudioCall:   Received: '{callId}'");
            Console.WriteLine($"üìû AudioCall:   Current: '{currentChannel}'");
        }
        Console.WriteLine($"üìû ========== End AudioCall: Call rejected event ==========");
    }

    private async Task JoinIncomingCallAsync(string channelName)
    {
        try
        {
            Console.WriteLine($"üéØ AudioCall: JoinIncomingCallAsync called with channel: {channelName}");
            
            // ‚úÖ Validate channel name
            if (string.IsNullOrWhiteSpace(channelName))
            {
                throw new Exception("Invalid channel name: channel name is empty or null");
            }

            // ‚úÖ CRITICAL: Force cleanup before joining to avoid UID_CONFLICT
            Console.WriteLine($"üîß AudioCall: Force cleaning up any existing Agora connection...");
            try
            {
                if (AgoraService.IsInCall)
                {
                    Console.WriteLine($"‚ö†Ô∏è AudioCall: Detected existing call, leaving first");
                    await AgoraService.LeaveChannelAsync();
                    await Task.Delay(800); // Wait for cleanup
                }
            }
            catch (Exception cleanupEx)
            {
                Console.WriteLine($"‚ö†Ô∏è AudioCall: Cleanup error (non-critical): {cleanupEx.Message}");
            }

            isConnecting = true;
            callStatus = "Connecting to call...";
            StateHasChanged(); // Update UI immediately

            var receiverId = AuthService.CurrentUser?.Id ?? 0;
            if (receiverId == 0)
                throw new Exception("Invalid receiver ID");

            Console.WriteLine($"üìû AudioCall: Receiver joining channel: {channelName}, UID: {receiverId}");

            // Get Agora token and App ID for the incoming channel
            var (token, appId) = await AgoraService.GetAgoraTokenAsync(channelName, (uint)receiverId);
            if (string.IsNullOrEmpty(appId))
            {
                Console.WriteLine($"‚ùå AudioCall: Failed to get App ID. AppId: {appId}");
                throw new Exception("Failed to get App ID");
            }
            
            // ‚úÖ Token can be empty if Token Authentication is disabled in Agora Console
            if (string.IsNullOrEmpty(token))
            {
                Console.WriteLine($"‚ö†Ô∏è AudioCall: No token received - Token Authentication may be disabled (this is OK for testing)");
            }

            Console.WriteLine($"‚úÖ AudioCall: Got token and App ID, joining channel...");
            Console.WriteLine($"üìû AudioCall: Joining as receiver with UID: {receiverId}");

            // Join the Agora channel (audio call - video disabled)
            // Use receiver's own ID as UID (not the caller's ID)
            var uid = (uint)receiverId;
            var success = await AgoraService.JoinChannelAsync(
            channelName,
            token,
            appId,
            uid,
            false // false = audio call only
            );

            if (!success)
            {
                Console.WriteLine($"‚ùå AudioCall: JoinChannelAsync returned false");
                throw new Exception("Failed to join call");
            }

            Console.WriteLine($"‚úÖ AudioCall: Successfully joined channel, setting isInCall = true");
            isInCall = true;
            currentChannel = channelName;
            callStatus = "Connected";
            StateHasChanged(); // Update UI after successful join
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå AudioCall: Error in JoinIncomingCallAsync: {ex.Message}");
            Console.WriteLine($"‚ùå AudioCall: Stack trace: {ex.StackTrace}");
            error = $"Failed to join incoming call: {ex.Message}";
            callStatus = "Call failed";
            isInCall = false; // Make sure we don't show as in call if it failed
            StateHasChanged(); // Update UI to show error
        }
        finally
        {
            isConnecting = false;
            StateHasChanged(); // Final UI update
        }
    }

    @* private async Task StartCall()
    {
        try
        {
            isConnecting = true;
            callStatus = "Connecting...";

            // Generate channel name
            //var channelName = $"call_{UserId}_{DateTime.UtcNow.Ticks}";

            var channelName = $"call_3_1";

            // Generate UID
            var uid = (uint)(AuthService.CurrentUser?.Id ?? 0);
            if (uid == 0) uid = (uint)new Random().Next(100000, 999999);

            // Get Agora token and App ID
            var (token, appId) = await AgoraService.GetAgoraTokenAsync(channelName, uid);
            if (string.IsNullOrEmpty(token) || string.IsNullOrEmpty(appId))
            {
                throw new Exception("Failed to get call token or App ID");
            }

            // Join channel (audio call)
            var success = await AgoraService.JoinChannelAsync(channelName, token, appId, uid, false);
            if (!success)
            {
                throw new Exception("Failed to join call");
            }

            isInCall = true;
            currentChannel = channelName;
            callStatus = "Connected";
        }
        catch (Exception ex)
        {
            error = $"Failed to start call: {ex.Message}";
            callStatus = "Call failed";
        }
        finally
        {
            isConnecting = false;
        }
    } *@


    private async Task StartCall(int targetUserId)
    {
        try
        {
            isConnecting = true;
            callStatus = "Connecting...";
            StateHasChanged(); // ‚úÖ Update UI immediately

            // ‚úÖ Generate consistent channel name between caller/callee
            var callerId = AuthService.CurrentUser?.Id ?? 0;
            if (callerId == 0)
                throw new Exception("Invalid caller ID");

            var smallerId = Math.Min(callerId, targetUserId);
            var largerId = Math.Max(callerId, targetUserId);
            var channelName = $"call_{smallerId}_{largerId}";

            // ‚úÖ Fetch token and App ID from server (server handles Redis)
            var (token, appId) = await AgoraService.GetAgoraTokenAsync(channelName, (uint)callerId);
            if (string.IsNullOrEmpty(appId))
                throw new Exception("Failed to get App ID");
            
            // ‚úÖ Token can be empty if Token Authentication is disabled in Agora Console
            if (string.IsNullOrEmpty(token))
            {
                Console.WriteLine($"‚ö†Ô∏è AudioCall: No token received - Token Authentication may be disabled (this is OK for testing)");
            }

            // ‚úÖ Join the Agora channel
            var uid = (uint)callerId;
            var success = await AgoraService.JoinChannelAsync(channelName, token, appId, uid, false);
            if (!success)
                throw new Exception("Failed to join call");

            isInCall = true;
            currentChannel = channelName;
            callStatus = "Ringing...";
            callStartTime = DateTime.UtcNow;
            receiverJoined = false; // Reset flag when starting a new call
            StateHasChanged(); // ‚úÖ Update UI to show status
            
            // ‚úÖ Play ringing sound for caller
            try
            {
                await JSRuntime.InvokeVoidAsync("playIncomingCallSound");
                Console.WriteLine("üîî AudioCall: Started playing ringtone for caller");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ö†Ô∏è AudioCall: Error playing ringtone: {ex.Message}");
            }
            
            // ‚úÖ Start timeout timer (20 seconds) - if receiver doesn't join, close the call
            StartCallTimeoutTimer();
        }
        catch (Exception ex)
        {
            error = $"Failed to start call: {ex.Message}";
            callStatus = "Call failed";
            StateHasChanged(); // ‚úÖ Update UI to show error
        }
        finally
        {
            isConnecting = false;
            StateHasChanged(); // ‚úÖ Final UI update
        }
    }
    
    private void StartCallTimeoutTimer()
    {
        // ‚úÖ Reset the receiver joined flag
        receiverJoined = false;
        
        // ‚úÖ Stop any existing timer
        callTimeoutTimer?.Dispose();
        callTimeoutTimer = null;
        
        // ‚úÖ Start 10-second timeout - if receiver doesn't join, close the call
        callTimeoutTimer = new Timer(async _ =>
        {
            // ‚úÖ CRITICAL: Check the flag BEFORE InvokeAsync to avoid race conditions
            if (receiverJoined)
            {
                Console.WriteLine($"‚úÖ AudioCall: Timeout cancelled - receiver already joined (flag checked before InvokeAsync)");
                return;
            }
            
            await InvokeAsync(() =>
            {
                // ‚úÖ CRITICAL: Check the receiverJoined flag AGAIN - if receiver joined, don't timeout
                if (receiverJoined)
                {
                    Console.WriteLine($"‚úÖ AudioCall: Timeout cancelled - receiver already joined (flag: {receiverJoined}, remoteUsers: {remoteUsers.Count})");
                    return;
                }
                
                // ‚úÖ Also check if receiver has joined (has remote users) OR if call is already connected
                // If receiver joined, remoteUsers.Count > 0, so don't timeout
                // Also check isInCall to ensure we're still in a call state
                if (remoteUsers.Count == 0 && !string.IsNullOrEmpty(currentChannel) && isInCall && !receiverJoined)
                {
                    Console.WriteLine($"‚è∞ AudioCall: Call timeout (15s) - receiver didn't answer, closing call...");
                    
                    // Close the call automatically
                    _ = Task.Run(async () =>
                    {
                        try
                        {
                            Console.WriteLine($"‚è∞ AudioCall: Timeout handler - notifying server and cleaning up...");
                            
                            // ‚úÖ CRITICAL: Notify server that call timed out (this will trigger call-ended event for receiver)
                            // Use the channel name to ensure receiver's dialog closes
                            try
                            {
                                Console.WriteLine($"üìû AudioCall: Calling SignalRService.EndCallAsync with channel: {currentChannel}");
                                await SignalRService.EndCallAsync(currentChannel);
                                Console.WriteLine($"‚úÖ AudioCall: EndCallAsync completed");
                            }
                            catch (Exception endCallEx)
                            {
                                Console.WriteLine($"‚ùå AudioCall: Error calling EndCallAsync: {endCallEx.Message}");
                                Console.WriteLine($"‚ùå AudioCall: Stack trace: {endCallEx.StackTrace}");
                            }
                            
                            // Leave Agora channel
                            try
                            {
                                await AgoraService.LeaveChannelAsync();
                                Console.WriteLine($"‚úÖ AudioCall: Left Agora channel");
                            }
                            catch (Exception leaveEx)
                            {
                                Console.WriteLine($"‚ö†Ô∏è AudioCall: Error leaving Agora channel: {leaveEx.Message}");
                            }
                            
                            await InvokeAsync(() =>
                            {
                                NotificationService.Notify(NotificationSeverity.Warning, "Call Timeout", 
                                    "No answer from receiver. Call ended.");
                                Navigation.NavigateTo("/real-time-chat");
                                StateHasChanged();
                            });
                        }
                        catch (Exception ex)
                        {
                            Console.WriteLine($"‚ùå AudioCall: Error in timeout handler: {ex.Message}");
                            Console.WriteLine($"‚ùå AudioCall: Stack trace: {ex.StackTrace}");
                        }
                    });
                }
                else
                {
                    Console.WriteLine($"‚úÖ AudioCall: Timeout check - receiverJoined: {receiverJoined}, remoteUsers: {remoteUsers.Count}, isInCall: {isInCall}, channel: {currentChannel}");
                }
            });
        }, null, TimeSpan.FromSeconds(15), Timeout.InfiniteTimeSpan); // One-time timer after 15 seconds
        
        Console.WriteLine($"‚è∞ AudioCall: Started 15-second timeout timer for call (receiverJoined: {receiverJoined})");
    }
    
    private void StopCallTimeoutTimer()
    {
        if (callTimeoutTimer != null)
        {
            callTimeoutTimer.Dispose();
            callTimeoutTimer = null;
            Console.WriteLine($"‚úÖ AudioCall: Stopped call timeout timer");
        }
    }



    private async Task EndCall()
    {
        try
        {
            Console.WriteLine("üìû AudioCall: Ending call...");
            
            // ‚úÖ Stop timeout timer (call is ending manually)
            StopCallTimeoutTimer();
            
            // ‚úÖ Stop ringing sound
            try
            {
                await JSRuntime.InvokeVoidAsync("stopIncomingCallSound");
                Console.WriteLine("üîï AudioCall: Stopped ringtone (call ending)");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ö†Ô∏è AudioCall: Error stopping ringtone: {ex.Message}");
            }
            
            // ‚úÖ Notify the other party via SignalR (use SignalRService for direct hub call)
            if (!string.IsNullOrEmpty(currentChannel))
            {
                try
                {
                    await SignalRService.EndCallAsync(currentChannel);
                    Console.WriteLine($"üìû AudioCall: Sent call-ended notification via SignalR for channel: {currentChannel}");
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"‚ö†Ô∏è AudioCall: Error sending call-ended notification: {ex.Message}");
                    // Fallback to RealtimeService
                    try
                    {
                        await RealtimeService.EndCallAsync(currentChannel);
                        Console.WriteLine($"üìû AudioCall: Sent call-ended notification via RealtimeService (fallback)");
                    }
                    catch (Exception ex2)
                    {
                        Console.WriteLine($"‚ö†Ô∏è AudioCall: Fallback also failed: {ex2.Message}");
                    }
                }
            }
            
            // Leave Agora channel
            await AgoraService.LeaveChannelAsync();
            isInCall = false;
            callStatus = "Call ended";
            StateHasChanged();
            
            // Navigate back to chat
            await Task.Delay(500); // Small delay to show call ended status
            Navigation.NavigateTo("/real-time-chat");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå AudioCall: Error ending call: {ex.Message}");
            error = $"Failed to end call: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task CancelCall()
    {
        try
        {
            // ‚úÖ If already in call or connecting, leave the channel first
            if (isInCall || isConnecting)
            {
                await AgoraService.LeaveChannelAsync();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error leaving channel during cancel: {ex.Message}");
        }
        finally
        {
            Navigation.NavigateTo("/");
        }
    }

    private async Task ToggleMute()
    {
        try
        {
            isMuted = !isMuted;
            await AgoraService.MuteLocalAudioAsync(isMuted);
        }
        catch (Exception ex)
        {
            error = $"Failed to toggle mute: {ex.Message}";
        }
    }

    private void HandleUserJoined(uint uid)
    {
        Console.WriteLine($"üìû ========== AudioCall: HandleUserJoined FIRED for uid {uid} ==========");
        Console.WriteLine($"üìû AudioCall: Remote user {uid} joined");
        
        if (!remoteUsers.Contains(uid))
        {
            remoteUsers.Add(uid);
            Console.WriteLine($"‚úÖ AudioCall: Added remote user {uid}, total remote users: {remoteUsers.Count}");
        }
        
        // ‚úÖ CRITICAL: Set the flag FIRST - this prevents the timeout callback from executing
        var oldFlagValue = receiverJoined;
        receiverJoined = true;
        Console.WriteLine($"‚úÖ AudioCall: Set receiverJoined flag from {oldFlagValue} to {receiverJoined}");
        
        // ‚úÖ CRITICAL: Stop the timeout timer - this prevents the timeout from firing
        StopCallTimeoutTimer();
        Console.WriteLine($"‚úÖ AudioCall: Stopped timeout timer (receiver joined)");
        
        // ‚úÖ Stop ringing sound immediately - use InvokeAsync to ensure UI thread
        InvokeAsync(async () =>
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("stopIncomingCallSound");
                Console.WriteLine("üîï AudioCall: Stopped ringtone (receiver joined)");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ö†Ô∏è AudioCall: Error stopping ringtone: {ex.Message}");
            }
        });
        
        callStatus = "Connected";
        Console.WriteLine($"‚úÖ AudioCall: Receiver accepted call, status updated to Connected");
        Console.WriteLine($"üìû ========== End AudioCall: HandleUserJoined ==========");
        
        InvokeAsync(StateHasChanged);
    }

    private void HandleUserLeft(uint uid)
    {
        Console.WriteLine($"üìû AudioCall: Remote user {uid} left (Agora event)");
        remoteUsers.Remove(uid);
        
        // ‚úÖ If we're in a call and the remote user left, navigate back to chat
        // This is a fallback in case SignalR call-ended event doesn't fire
        if (isInCall && remoteUsers.Count == 0)
        {
            Console.WriteLine($"üìû AudioCall: All remote users left, navigating back to chat (fallback)...");
            _ = Task.Run(async () =>
            {
                try
                {
                    await AgoraService.LeaveChannelAsync();
                    await Task.Delay(500); // Small delay for cleanup
                    await InvokeAsync(() =>
                    {
                        Console.WriteLine($"üìû AudioCall: Navigating to /real-time-chat (user-left fallback)");
                        Navigation.NavigateTo("/real-time-chat");
                        StateHasChanged();
                    });
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"‚ùå AudioCall: Error in HandleUserLeft fallback: {ex.Message}");
                }
            });
        }
        
        StateHasChanged();
    }

    private void HandleConnectionStateChanged(string state)
    {
        Console.WriteLine($"üìû AudioCall: Connection state changed: {state}");
        callStatus = state;
        StateHasChanged();
    }

    private void HandleError(string errorMessage)
    {
        Console.WriteLine($"‚ùå AudioCall: Agora error: {errorMessage}");
        error = errorMessage;
        StateHasChanged();
    }

    private Task<User?> GetUserById(int userId)
    {
        // This would typically call your user service
        // For now, return a mock user
        var user = new User
        {
            Id = userId,
            FirstName = "Test",
            LastName = "User"
        };
        return Task.FromResult<User?>(user);
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            // ‚úÖ Stop timeout timer
            StopCallTimeoutTimer();
            
            // ‚úÖ Unsubscribe from call-ended events
            RealtimeService.OnCallEnded -= HandleCallEnded;
            SignalRService.OnCallEnded -= HandleCallEnded;
            
            // ‚úÖ Unsubscribe from call-rejected events
            RealtimeService.OnCallRejected -= HandleCallRejected;
            SignalRService.OnCallRejected -= HandleCallRejected;
            
            // ‚úÖ Unsubscribe from Agora events
            AgoraService.OnUserJoined -= HandleUserJoined;
            AgoraService.OnUserLeft -= HandleUserLeft;
            AgoraService.OnConnectionStateChanged -= HandleConnectionStateChanged;
            AgoraService.OnError -= HandleError;
            
            if (isInCall)
            {
                await AgoraService.LeaveChannelAsync();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error disposing audio call: {ex.Message}");
        }
    }
}
