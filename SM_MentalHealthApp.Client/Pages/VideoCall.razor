@page "/video-call/{UserId:int}"
@using SM_MentalHealthApp.Client.Services
@using SM_MentalHealthApp.Shared
@using System.Text.Json
@inject IAgoraService AgoraService
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject IJSRuntime JSRuntime
@inject IRealtimeService RealtimeService
@inject ISignalRService SignalRService
@inject HttpClient Http
@implements IAsyncDisposable

<PageTitle>Video Call</PageTitle>

<div class="video-call-container">
    @if (!isInitialized)
    {
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>Initializing video call...</p>
        </div>
    }
    else if (!isInCall)
    {
        // ‚úÖ Check if this is an incoming call (has channel parameter)
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var isIncomingCall = !string.IsNullOrEmpty(uri.Query) && uri.Query.Contains("channel=");
        
        @if (isIncomingCall)
        {
            // ‚úÖ Incoming call - show connecting state (auto-join is happening)
            <div class="call-setup">
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <h3>Connecting to call...</h3>
                    <p>@callStatus</p>
                    @if (!string.IsNullOrEmpty(error))
                    {
                        <p class="text-danger">@error</p>
                    }
                </div>
            </div>
        }
        else
        {
            // ‚úÖ Outgoing call - show Start Call button
            <div class="call-setup">
                <div class="call-info">
                    <h3>Video Call with @targetUser?.FirstName @targetUser?.LastName</h3>
                    <p>Click "Start Call" to begin the video call</p>
                </div>
                <div class="call-actions">
                    <button class="btn btn-primary btn-lg" @onclick="() => StartVideoCall(UserId)" disabled="@isConnecting">
                        @if (isConnecting)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        Start Call
                    </button>
                    <button class="btn btn-secondary btn-lg" @onclick="CancelCall">
                        Cancel
                    </button>
                </div>
            </div>
        }
    }
    else
    {
        <div class="video-call-interface">
            <!-- Remote Video -->
            <div class="remote-video-container">
                @if (remoteUsers.Any())
                {
                    @foreach (var uid in remoteUsers)
                    {
                        <div class="remote-video" id="agora-remote-video-@uid">
                            <video id="agora-remote-video-@uid" autoplay playsinline></video>
                        </div>
                    }
                }
                else
                {
                    <div class="remote-video-placeholder">
                        <i class="fas fa-user fa-4x"></i>
                        <p>Waiting for @targetUser?.FirstName to join...</p>
                        <p class="call-status">@callStatus</p>
                    </div>
                }
            </div>

            <!-- Local Video (Picture-in-Picture) -->
            <div id="local-video-container" class="local-video-container">
                <video id="local-video" autoplay playsinline></video>
                @if (!isVideoEnabled)
                {
                    <div class="video-off-overlay">
                        <i class="fas fa-video-slash"></i>
                    </div>
                }
            </div>

            <!-- Call Controls -->
            <div class="call-controls">
                <div class="control-buttons">
                    <button class="control-btn @(isMuted ? "active" : "")" @onclick="ToggleMute"
                        title="@(isMuted ? "Unmute" : "Mute")">
                        <i class="fas @(isMuted ? "fa-microphone-slash" : "fa-microphone")"></i>
                    </button>
                    <button class="control-btn @(!isVideoEnabled ? "active" : "")" @onclick="ToggleVideo"
                        title="@(isVideoEnabled ? "Turn off camera" : "Turn on camera")">
                        <i class="fas @(isVideoEnabled ? "fa-video" : "fa-video-slash")"></i>
                    </button>
                    <button class="control-btn" @onclick="SwitchCamera" title="Switch camera" disabled="@(!isVideoEnabled)">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="control-btn end-call" @onclick="EndCall" title="End call">
                        <i class="fas fa-phone-slash"></i>
                    </button>
                </div>
            </div>

            <!-- Call Info -->
            <div class="call-info-overlay">
                <h4>@targetUser?.FirstName @targetUser?.LastName</h4>
                <p>@callStatus</p>
                @if (isInCall)
                {
                    <small>Channel: @currentChannel</small>
                }
            </div>
        </div>
    }

    @if (!string.IsNullOrEmpty(error))
    {
        <div class="alert alert-danger">
            <strong>Error:</strong> @error
            <button type="button" class="btn-close" @onclick="() => error = string.Empty"></button>
        </div>
    }
</div>

<style>
    .video-call-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: #000;
        z-index: 9999;
    }

    .loading-container {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
        color: white;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 3px solid #333;
        border-top: 3px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }

    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .call-setup {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
        color: white;
        text-align: center;
    }

    .call-info h3 {
        margin-bottom: 20px;
    }

    .call-actions {
        margin-top: 30px;
    }

    .call-actions .btn {
        margin: 0 10px;
        padding: 12px 30px;
    }

    .video-call-interface {
        position: relative;
        width: 100%;
        height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .remote-video-container {
        width: 100%;
        flex: 1; /* Take available space but leave room for controls */
        min-height: 0; /* Allow flex shrinking */
        background: #1a1a1a;
        position: relative;
        z-index: 1; /* Base layer for remote video */
        margin-bottom: 120px; /* Leave space for controls at bottom */
    }

    .remote-video {
        width: 100%;
        height: 100%;
    }

    .remote-video video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .remote-video-placeholder {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
        color: #666;
    }

    .remote-video-placeholder i {
        margin-bottom: 20px;
    }

    .call-status {
        color: #999;
        font-size: 14px;
    }

    .local-video-container {
        position: fixed; /* Changed from absolute to fixed to ensure it's positioned relative to viewport */
        top: 20px;
        right: 20px;
        width: 200px;
        height: 150px;
        border-radius: 12px;
        overflow: hidden;
        border: 2px solid #fff;
        background: #333;
        z-index: 5000; /* High z-index to ensure it's above remote video and info overlay, but below controls */
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        pointer-events: auto; /* Ensure it can receive pointer events */
    }

    .local-video-container video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .video-off-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #333;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #666;
    }

    .call-controls {
        position: fixed; /* Fixed position so it stays visible */
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10000; /* Very high z-index to ensure it's always on top */
        background: rgba(0, 0, 0, 0.5); /* Semi-transparent background for visibility */
        padding: 15px 25px;
        border-radius: 50px;
        backdrop-filter: blur(10px); /* Blur effect for better visibility */
    }

    .control-buttons {
        display: flex;
        gap: 15px;
    }

    .control-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: none;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        font-size: 20px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .control-btn:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .control-btn.active {
        background: #ff4444;
    }

    .control-btn.end-call {
        background: #ff4444;
    }

    .control-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .call-info-overlay {
        position: absolute;
        top: 30px;
        left: 30px;
        color: white;
        z-index: 1000; /* Ensure info appears above video */
    }

    .call-info-overlay h4 {
        margin: 0 0 5px 0;
        font-size: 18px;
    }

    .call-info-overlay p {
        margin: 0 0 5px 0;
        color: #ccc;
    }

    .call-info-overlay small {
        color: #999;
        font-size: 12px;
    }
</style>

@code {
    [Parameter] public int UserId { get; set; }

    private User? targetUser;
    private bool isInitialized = false;
    private bool isInCall = false;
    private bool isConnecting = false;
    private bool isMuted = false;
    private bool isVideoEnabled = true;
    private string callStatus = "Initializing...";
    private string currentChannel = string.Empty;
    private List<uint> remoteUsers = new();
    private string error = string.Empty;
    private Timer? callTimeoutTimer = null; // Timer to auto-close if receiver doesn't answer
    private DateTime callStartTime = DateTime.MinValue;
    private bool receiverJoined = false; // Flag to track if receiver has joined (prevents timeout from firing)

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Get target user info
            targetUser = await GetUserById(UserId);
            if (targetUser == null)
            {
                // Don't show error, just use a placeholder - the call can still proceed
                targetUser = new User
                {
                    Id = UserId,
                    FirstName = "User",
                    LastName = UserId.ToString()
                };
                Console.WriteLine($"‚ö†Ô∏è VideoCall: User {UserId} not found, using placeholder");
            }

            // Initialize Agora (using demo mode)
            const string AGORA_APP_ID = "b480142a879c4ed2ab7efb07d318abda"; // Demo mode for testing
            isInitialized = await AgoraService.InitializeAsync(AGORA_APP_ID);

            if (!isInitialized)
            {
                error = "Failed to initialize video call service";
                return;
            }

            // Set up event handlers
            AgoraService.OnUserJoined += HandleUserJoined;
            AgoraService.OnUserLeft += HandleUserLeft;
            AgoraService.OnConnectionStateChanged += HandleConnectionStateChanged;
            AgoraService.OnError += HandleError;

            // ‚úÖ Check if this is an incoming call (has channel parameter)
            // Works for both mobile calls (mobile_call=true) and web-to-web calls
            var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
            var queryString = uri.Query;
            Console.WriteLine($"üîç VideoCall: Checking query string: {queryString}");
            
            if (!string.IsNullOrEmpty(queryString))
            {
                var queryParams = new Dictionary<string, string>();
                foreach (var param in queryString.TrimStart('?').Split('&'))
                {
                    var parts = param.Split('=', 2);
                    if (parts.Length == 2)
                    {
                        queryParams[Uri.UnescapeDataString(parts[0])] = Uri.UnescapeDataString(parts[1]);
                    }
                }

                Console.WriteLine($"üîç VideoCall: Query params: {string.Join(", ", queryParams.Select(kvp => $"{kvp.Key}={kvp.Value}"))}");

                // ‚úÖ Auto-join if channel parameter exists
                // Check if this is an incoming call (has mobile_call=true) or outgoing call (caller initiated)
                if (queryParams.TryGetValue("channel", out var channelParam))
                {
                    Console.WriteLine($"‚úÖ VideoCall: Found channel parameter: {channelParam}");
                    
                    if (!string.IsNullOrEmpty(channelParam))
                    {
                        // ‚úÖ CRITICAL: Set currentChannel immediately so rejection handler can match it
                        currentChannel = channelParam;
                        Console.WriteLine($"üìû VideoCall: Set currentChannel to: {currentChannel} (for rejection handling)");
                        
                        // Check if this is a mobile call (incoming) or web-to-web call
                        var isMobileCall = queryParams.TryGetValue("mobile_call", out var mobileCallParam) && 
                                          mobileCallParam?.ToLower() == "true";
                        
                        if (isMobileCall)
                        {
                            // This is an incoming call from mobile - auto-join as receiver
                            Console.WriteLine("üì± VideoCall: This is an incoming mobile call - joining as receiver");
                            callStatus = "Joining incoming call...";
                            StateHasChanged(); // Update UI immediately
                            await JoinIncomingCallAsync(channelParam);
                            StateHasChanged(); // Update UI after join
                            return;
                        }
                        else
                        {
                            // This is an outgoing call (caller initiated from RealTimeChat) - start the call
                            Console.WriteLine("üìû VideoCall: This is an outgoing call - starting call as caller");
                            callStatus = "Starting call...";
                            StateHasChanged(); // Update UI immediately
                            await StartVideoCall(UserId); // UserId is the target user ID
                            StateHasChanged(); // Update UI after start
                            return;
                        }
                    }
                    else
                    {
                        Console.WriteLine("‚ö†Ô∏è VideoCall: Channel parameter is empty");
                    }
                }
                else
                {
                    Console.WriteLine("‚ö†Ô∏è VideoCall: No channel parameter found in query string - this is a manual call");
                }
            }
            else
            {
                Console.WriteLine("‚ö†Ô∏è VideoCall: No query string found - this is an outgoing call");
            }

            callStatus = "Ready to call";
            
            // ‚úÖ Ensure SignalRService is connected
            if (!SignalRService.IsConnected)
            {
                Console.WriteLine("üìû VideoCall: SignalRService not connected, starting...");
                try
                {
                    await SignalRService.StartAsync();
                    await Task.Delay(1000); // Wait for connection
                    Console.WriteLine($"üìû VideoCall: SignalRService connection state: {SignalRService.IsConnected}");
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"‚ö†Ô∏è VideoCall: Error starting SignalRService: {ex.Message}");
                }
            }
            else
            {
                Console.WriteLine("üìû VideoCall: SignalRService is already connected");
            }
            
            // ‚úÖ Subscribe to call-ended events so both parties get notified
            RealtimeService.OnCallEnded += HandleCallEnded;
            SignalRService.OnCallEnded += HandleCallEnded;
            Console.WriteLine("üìû VideoCall: Subscribed to call-ended events from both services");
            
            // ‚úÖ Subscribe to call-rejected events so caller gets notified when receiver declines
            RealtimeService.OnCallRejected += HandleCallRejected;
            SignalRService.OnCallRejected += HandleCallRejected;
            Console.WriteLine("üìû VideoCall: Subscribed to call-rejected events from both services");
        }
        catch (Exception ex)
        {
            error = $"Failed to initialize: {ex.Message}";
        }
    }
    
    private void HandleCallEnded(string channelName)
    {
        Console.WriteLine($"üìû ========== VideoCall: Call ended event received ==========");
        Console.WriteLine($"üìû VideoCall: Received channelName: '{channelName}'");
        Console.WriteLine($"üìû VideoCall: Current channel: '{currentChannel}'");
        Console.WriteLine($"üìû VideoCall: Channels match: {channelName == currentChannel}");
        Console.WriteLine($"üìû VideoCall: isInCall: {isInCall}");
        
        // ‚úÖ Check if this call-ended event is for our current call
        // Use case-insensitive comparison and also check if either is empty
        var channelsMatch = !string.IsNullOrEmpty(channelName) && 
                           !string.IsNullOrEmpty(currentChannel) && 
                           channelName.Equals(currentChannel, StringComparison.OrdinalIgnoreCase);
        
        if (channelsMatch || isInCall) // If we're in a call, assume it's for us
        {
            Console.WriteLine($"üìû VideoCall: ‚úÖ This is our call! Navigating back to chat...");
            // Navigate back to chat on the UI thread
            _ = Task.Run(async () =>
            {
                try
                {
                    if (isInCall)
                    {
                        await AgoraService.LeaveChannelAsync();
                        await Task.Delay(300); // Small delay for cleanup
                    }
                    await InvokeAsync(async () =>
                    {
                        Console.WriteLine($"üìû VideoCall: Navigating to /real-time-chat");
                        // Preserve clientId query parameter if in service request mode
                        try
                        {
                            var clientId = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "serviceRequestClientId");
                            if (!string.IsNullOrEmpty(clientId))
                            {
                                Navigation.NavigateTo($"/real-time-chat?clientId={clientId}");
                            }
                            else
                            {
                        Navigation.NavigateTo("/real-time-chat");
                            }
                        }
                        catch
                        {
                            Navigation.NavigateTo("/real-time-chat");
                        }
                        StateHasChanged();
                    });
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"‚ùå VideoCall: Error in HandleCallEnded: {ex.Message}");
                }
            });
        }
        else
        {
            Console.WriteLine($"üìû VideoCall: ‚ö†Ô∏è Call-ended event is for a different channel, ignoring");
            Console.WriteLine($"üìû VideoCall:   Received: '{channelName}'");
            Console.WriteLine($"üìû VideoCall:   Current: '{currentChannel}'");
        }
        Console.WriteLine($"üìû ========== End VideoCall: Call ended event ==========");
    }

    private void HandleCallRejected(string callId)
    {
        Console.WriteLine($"üìû ========== VideoCall: Call rejected event received ==========");
        Console.WriteLine($"üìû VideoCall: Received callId: '{callId}'");
        Console.WriteLine($"üìû VideoCall: Current channel: '{currentChannel}'");
        Console.WriteLine($"üìû VideoCall: isInCall: {isInCall}");
        
        // ‚úÖ Stop the timeout timer since receiver declined
        StopCallTimeoutTimer();
        
        // ‚úÖ Check if this rejection is for our current call
        // Match by channel name (callId from server is usually the channel name)
        var channelsMatch = !string.IsNullOrEmpty(callId) && 
                           !string.IsNullOrEmpty(currentChannel) && 
                           callId.Equals(currentChannel, StringComparison.OrdinalIgnoreCase);
        
        // ‚úÖ Also check if we're on the VideoCall page (caller initiated a call)
        // If we're on this page and have a channel, we should handle rejection
        var isOnCallPage = Navigation.Uri.Contains("/video-call/");
        
        // ‚úÖ If we're the caller (either in call or connecting, or on call page with channel), handle rejection
        if (channelsMatch || isInCall || (!string.IsNullOrEmpty(currentChannel) && isOnCallPage))
        {
            Console.WriteLine($"üìû VideoCall: ‚úÖ Call was rejected by receiver! Closing call...");
            
            // Navigate back to chat on the UI thread
            _ = Task.Run(async () =>
            {
                try
                {
                    // Leave Agora channel if we're in a call
                    if (isInCall)
                    {
                        await AgoraService.LeaveChannelAsync();
                        await Task.Delay(300); // Small delay for cleanup
                    }
                    
                    await InvokeAsync(() =>
                    {
                        // Show notification
                        NotificationService.Notify(NotificationSeverity.Warning, "Call Declined", 
                            $"{targetUser?.FirstName} {targetUser?.LastName} declined your call");
                        
                        Console.WriteLine($"üìû VideoCall: Navigating to /real-time-chat (call rejected)");
                        Navigation.NavigateTo("/real-time-chat");
                        StateHasChanged();
                    });
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"‚ùå VideoCall: Error in HandleCallRejected: {ex.Message}");
                }
            });
        }
        else
        {
            Console.WriteLine($"üìû VideoCall: ‚ö†Ô∏è Call-rejected event is for a different call, ignoring");
            Console.WriteLine($"üìû VideoCall:   Received: '{callId}'");
            Console.WriteLine($"üìû VideoCall:   Current: '{currentChannel}'");
        }
        Console.WriteLine($"üìû ========== End VideoCall: Call rejected event ==========");
    }

    private async Task JoinIncomingCallAsync(string channelName)
    {
        try
        {
            Console.WriteLine($"üéØ VideoCall: JoinIncomingCallAsync called with channel: {channelName}");
            
            // ‚úÖ Validate channel name
            if (string.IsNullOrWhiteSpace(channelName))
            {
                throw new Exception("Invalid channel name: channel name is empty or null");
            }

            isConnecting = true;
            callStatus = "Connecting to call...";
            StateHasChanged(); // Update UI immediately

            var callerId = AuthService.CurrentUser?.Id ?? 0;
            if (callerId == 0)
                throw new Exception("Invalid caller ID");

            Console.WriteLine($"üìû VideoCall: Getting token for channel: {channelName}, UID: {callerId}");

            // Get Agora token and App ID for the incoming channel
            var (token, appId) = await AgoraService.GetAgoraTokenAsync(channelName, (uint)callerId);
            if (string.IsNullOrEmpty(appId))
            {
                Console.WriteLine($"‚ùå VideoCall: Failed to get App ID. AppId: {appId}");
                throw new Exception("Failed to get App ID");
            }
            
            // ‚úÖ Token can be empty if Token Authentication is disabled in Agora Console
            if (string.IsNullOrEmpty(token))
            {
                Console.WriteLine($"‚ö†Ô∏è VideoCall: No token received - Token Authentication may be disabled (this is OK for testing)");
            }

            Console.WriteLine($"‚úÖ VideoCall: Got token and App ID, joining channel...");

            // Join the Agora channel (video enabled for video calls)
            var uid = (uint)callerId;
            var success = await AgoraService.JoinChannelAsync(
            channelName,
            token,
            appId,
            uid,
            true // true = video call
            );

            if (!success)
            {
                Console.WriteLine($"‚ùå VideoCall: JoinChannelAsync returned false");
                throw new Exception("Failed to join call");
            }

            Console.WriteLine($"‚úÖ VideoCall: Successfully joined channel, setting isInCall = true");
            isInCall = true;
            currentChannel = channelName;
            callStatus = "Connected";
            StateHasChanged(); // Update UI after successful join
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå VideoCall: Error in JoinIncomingCallAsync: {ex.Message}");
            Console.WriteLine($"‚ùå VideoCall: Stack trace: {ex.StackTrace}");
            error = $"Failed to join incoming call: {ex.Message}";
            callStatus = "Call failed";
            isInCall = false; // Make sure we don't show as in call if it failed
            StateHasChanged(); // Update UI to show error
        }
        finally
        {
            isConnecting = false;
            StateHasChanged(); // Final UI update
        }
    }

    @* private async Task StartCall()
    {
        try
        {
            isConnecting = true;
            callStatus = "Connecting...";

            // Create unique channel name
            var channelName = $"call_{UserId}_{DateTime.UtcNow.Ticks}";

            // Generate UID
            var uid = (uint)(AuthService.CurrentUser?.Id ?? 0);
            if (uid == 0) uid = (uint)new Random().Next(100000, 999999);

            // Get Agora token and App ID
            var (token, appId) = await AgoraService.GetAgoraTokenAsync(channelName, uid);
            if (string.IsNullOrEmpty(appId))
                throw new Exception("Failed to get App ID");
            
            // ‚úÖ Token can be empty if Token Authentication is disabled in Agora Console
            if (string.IsNullOrEmpty(token))
            {
                Console.WriteLine($"‚ö†Ô∏è VideoCall: No token received - Token Authentication may be disabled (this is OK for testing)");
            }

            // Join channel (this is always a video call since it's the VideoCall page)
            var success = await AgoraService.JoinChannelAsync(channelName, token, appId, uid, true);
            if (!success)
            {
                throw new Exception("Failed to join call");
            }

            isInCall = true;
            currentChannel = channelName;
            callStatus = "Connected";
        }
        catch (Exception ex)
        {
            error = $"Failed to start call: {ex.Message}";
            callStatus = "Call failed";
        }
        finally
        {
            isConnecting = false;
        }
    } *@

    private async Task StartVideoCall(int targetUserId)
    {
        try
        {
            isConnecting = true;
            callStatus = "Connecting...";


            Console.WriteLine("targetUserId.........: " + targetUserId);


            // ‚úÖ Generate consistent channel name between caller/callee
            var callerId = AuthService.CurrentUser?.Id ?? 0;
            if (callerId == 0)
                throw new Exception("Invalid caller ID");

            var smallerId = Math.Min(callerId, targetUserId);
            var largerId = Math.Max(callerId, targetUserId);
            var channelName = $"call_{smallerId}_{largerId}";

            // ‚úÖ Get Agora token and App ID (pass both channel + caller UID)
            var (token, appId) = await AgoraService.GetAgoraTokenAsync(channelName, (uint)callerId);
            if (string.IsNullOrEmpty(appId))
                throw new Exception("Failed to get App ID");
            
            // ‚úÖ Token can be empty if Token Authentication is disabled in Agora Console
            if (string.IsNullOrEmpty(token))
            {
                Console.WriteLine($"‚ö†Ô∏è VideoCall: No token received - Token Authentication may be disabled (this is OK for testing)");
            }

            // ‚úÖ Join the Agora channel (video enabled)
            var uid = (uint)callerId;
            var success = await AgoraService.JoinChannelAsync(
            channelName,
            token,
            appId,
            uid,
            true // true = video call
            );

            if (!success)
                throw new Exception("Failed to join call");

            isInCall = true;
            currentChannel = channelName;
            callStatus = "Ringing...";
            callStartTime = DateTime.UtcNow;
            receiverJoined = false; // Reset flag when starting a new call
            
            // ‚úÖ CRITICAL: Stop any existing ringtone first (in case of reconnection or retry)
            try
            {
                await JSRuntime.InvokeVoidAsync("stopIncomingCallSound");
                Console.WriteLine("üîï VideoCall: Stopped any existing ringtone before starting new call");
            }
            catch (Exception stopEx)
            {
                Console.WriteLine($"‚ö†Ô∏è VideoCall: Error stopping existing ringtone: {stopEx.Message}");
            }
            
            StateHasChanged(); // ‚úÖ Update UI to show status
            
            // ‚úÖ Play ringing sound for caller
            try
            {
                await JSRuntime.InvokeVoidAsync("playIncomingCallSound");
                Console.WriteLine("üîî VideoCall: Started playing ringtone for caller");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ö†Ô∏è VideoCall: Error playing ringtone: {ex.Message}");
            }
            
            // ‚úÖ Start timeout timer (20 seconds) - if receiver doesn't join, close the call
            StartCallTimeoutTimer();
        }
        catch (Exception ex)
        {
            error = $"Failed to start video call: {ex.Message}";
            callStatus = "Call failed";
            StateHasChanged();
        }
        finally
        {
            isConnecting = false;
            StateHasChanged();
        }
    }
    
    private void StartCallTimeoutTimer()
    {
        // ‚úÖ Reset the receiver joined flag
        receiverJoined = false;
        
        // ‚úÖ Stop any existing timer
        callTimeoutTimer?.Dispose();
        callTimeoutTimer = null;
        
        // ‚úÖ Start 10-second timeout - if receiver doesn't join, close the call
        callTimeoutTimer = new Timer(async _ =>
        {
            // ‚úÖ CRITICAL: Check the flag BEFORE InvokeAsync to avoid race conditions
            if (receiverJoined)
            {
                Console.WriteLine($"‚úÖ VideoCall: Timeout cancelled - receiver already joined (flag checked before InvokeAsync)");
                return;
            }
            
            await InvokeAsync(() =>
            {
                // ‚úÖ CRITICAL: Check the receiverJoined flag AGAIN - if receiver joined, don't timeout
                if (receiverJoined)
                {
                    Console.WriteLine($"‚úÖ VideoCall: Timeout cancelled - receiver already joined (flag: {receiverJoined}, remoteUsers: {remoteUsers.Count})");
                    return;
                }
                
                // ‚úÖ Also check if receiver has joined (has remote users) OR if call is already connected
                // If receiver joined, remoteUsers.Count > 0, so don't timeout
                // Also check isInCall to ensure we're still in a call state
                if (remoteUsers.Count == 0 && !string.IsNullOrEmpty(currentChannel) && isInCall && !receiverJoined)
                {
                    Console.WriteLine($"‚è∞ VideoCall: Call timeout (15s) - receiver didn't answer, closing call...");
                    
                    // Close the call automatically
                    _ = Task.Run(async () =>
                    {
                        try
                        {
                            Console.WriteLine($"‚è∞ VideoCall: Timeout handler - notifying server and cleaning up...");
                            
                            // ‚úÖ CRITICAL: Notify server that call timed out (this will trigger call-ended event for receiver)
                            // Use the channel name to ensure receiver's dialog closes
                            try
                            {
                                Console.WriteLine($"üìû VideoCall: Calling SignalRService.EndCallAsync with channel: {currentChannel}");
                                await SignalRService.EndCallAsync(currentChannel);
                                Console.WriteLine($"‚úÖ VideoCall: EndCallAsync completed");
                            }
                            catch (Exception endCallEx)
                            {
                                Console.WriteLine($"‚ùå VideoCall: Error calling EndCallAsync: {endCallEx.Message}");
                                Console.WriteLine($"‚ùå VideoCall: Stack trace: {endCallEx.StackTrace}");
                            }
                            
                            // Leave Agora channel
                            try
                            {
                                await AgoraService.LeaveChannelAsync();
                                Console.WriteLine($"‚úÖ VideoCall: Left Agora channel");
                            }
                            catch (Exception leaveEx)
                            {
                                Console.WriteLine($"‚ö†Ô∏è VideoCall: Error leaving Agora channel: {leaveEx.Message}");
                            }
                            
                            await InvokeAsync(() =>
                            {
                                NotificationService.Notify(NotificationSeverity.Warning, "Call Timeout", 
                                    "No answer from receiver. Call ended.");
                                Navigation.NavigateTo("/real-time-chat");
                                StateHasChanged();
                            });
                        }
                        catch (Exception ex)
                        {
                            Console.WriteLine($"‚ùå VideoCall: Error in timeout handler: {ex.Message}");
                            Console.WriteLine($"‚ùå VideoCall: Stack trace: {ex.StackTrace}");
                        }
                    });
                }
                else
                {
                    Console.WriteLine($"‚úÖ VideoCall: Timeout check - receiverJoined: {receiverJoined}, remoteUsers: {remoteUsers.Count}, isInCall: {isInCall}, channel: {currentChannel}");
                }
            });
        }, null, TimeSpan.FromSeconds(15), Timeout.InfiniteTimeSpan); // One-time timer after 15 seconds
        
        Console.WriteLine($"‚è∞ VideoCall: Started 15-second timeout timer for call (receiverJoined: {receiverJoined})");
    }
    
    private void StopCallTimeoutTimer()
    {
        if (callTimeoutTimer != null)
        {
            callTimeoutTimer.Dispose();
            callTimeoutTimer = null;
            Console.WriteLine($"‚úÖ VideoCall: Stopped call timeout timer");
        }
    }


    private async Task EndCall()
    {
        try
        {
            Console.WriteLine("üìû VideoCall: Ending call...");
            
            // ‚úÖ Stop timeout timer (call is ending manually)
            StopCallTimeoutTimer();
            
            // ‚úÖ Stop ringing sound
            try
            {
                await JSRuntime.InvokeVoidAsync("stopIncomingCallSound");
                Console.WriteLine("üîï VideoCall: Stopped ringtone (call ending)");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ö†Ô∏è VideoCall: Error stopping ringtone: {ex.Message}");
            }
            
            // ‚úÖ Notify the other party via SignalR (use SignalRService for direct hub call)
            if (!string.IsNullOrEmpty(currentChannel))
            {
                try
                {
                    await SignalRService.EndCallAsync(currentChannel);
                    Console.WriteLine($"üìû VideoCall: Sent call-ended notification via SignalR for channel: {currentChannel}");
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"‚ö†Ô∏è VideoCall: Error sending call-ended notification: {ex.Message}");
                    // Fallback to RealtimeService
                    try
                    {
                        await RealtimeService.EndCallAsync(currentChannel);
                        Console.WriteLine($"üìû VideoCall: Sent call-ended notification via RealtimeService (fallback)");
                    }
                    catch (Exception ex2)
                    {
                        Console.WriteLine($"‚ö†Ô∏è VideoCall: Fallback also failed: {ex2.Message}");
                    }
                }
            }
            
            // Leave Agora channel
            await AgoraService.LeaveChannelAsync();
            isInCall = false;
            callStatus = "Call ended";
            StateHasChanged();
            
            // Navigate back to chat - preserve clientId if in service request mode
            await Task.Delay(500); // Small delay to show call ended status
            try
            {
                var clientId = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "serviceRequestClientId");
                if (!string.IsNullOrEmpty(clientId))
                {
                    Navigation.NavigateTo($"/real-time-chat?clientId={clientId}");
                }
                else
                {
            Navigation.NavigateTo("/real-time-chat");
                }
            }
            catch
            {
                Navigation.NavigateTo("/real-time-chat");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå VideoCall: Error ending call: {ex.Message}");
            error = $"Failed to end call: {ex.Message}";
            StateHasChanged();
        }
    }

    private Task CancelCall()
    {
        Navigation.NavigateTo("/");
        return Task.CompletedTask;
    }

    private async Task ToggleMute()
    {
        try
        {
            isMuted = !isMuted;
            await AgoraService.MuteLocalAudioAsync(isMuted);
        }
        catch (Exception ex)
        {
            error = $"Failed to toggle mute: {ex.Message}";
        }
    }

    private async Task ToggleVideo()
    {
        try
        {
            isVideoEnabled = !isVideoEnabled;
            await AgoraService.EnableLocalVideoAsync(isVideoEnabled);
        }
        catch (Exception ex)
        {
            error = $"Failed to toggle video: {ex.Message}";
        }
    }

    private async Task SwitchCamera()
    {
        try
        {
            await AgoraService.SwitchCameraAsync();
        }
        catch (Exception ex)
        {
            error = $"Failed to switch camera: {ex.Message}";
        }
    }

    private void HandleUserJoined(uint uid)
    {
        Console.WriteLine($"üìû ========== VideoCall: HandleUserJoined FIRED for uid {uid} ==========");
        Console.WriteLine($"üìû VideoCall: Remote user {uid} joined");
        
        if (!remoteUsers.Contains(uid))
        {
            remoteUsers.Add(uid);
            Console.WriteLine($"‚úÖ VideoCall: Added remote user {uid}, total remote users: {remoteUsers.Count}");
        }
        
        // ‚úÖ CRITICAL: Set the flag FIRST - this prevents the timeout callback from executing
        var oldFlagValue = receiverJoined;
        receiverJoined = true;
        Console.WriteLine($"‚úÖ VideoCall: Set receiverJoined flag from {oldFlagValue} to {receiverJoined}");
        
        // ‚úÖ CRITICAL: Stop the timeout timer - this prevents the timeout from firing
        StopCallTimeoutTimer();
        Console.WriteLine($"‚úÖ VideoCall: Stopped timeout timer (receiver joined)");
        
        // ‚úÖ Stop ringing sound immediately - fire-and-forget async call for fastest response
        // This ensures the ringer stops immediately, especially on first call
        _ = Task.Run(async () =>
        {
            try
            {
                // Call immediately without delay
                await JSRuntime.InvokeVoidAsync("stopIncomingCallSound");
                Console.WriteLine("üîï VideoCall: Stopped ringtone (receiver joined)");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ö†Ô∏è VideoCall: Error stopping ringtone: {ex.Message}");
                // Retry once after a short delay
                try
                {
                    await Task.Delay(100);
                    await JSRuntime.InvokeVoidAsync("stopIncomingCallSound");
                    Console.WriteLine("üîï VideoCall: Stopped ringtone (retry successful)");
                }
                catch (Exception retryEx)
                {
                    Console.WriteLine($"‚ö†Ô∏è VideoCall: Retry also failed: {retryEx.Message}");
                    // Final fallback - try one more time
                    try
                    {
                        await Task.Delay(300);
                        await JSRuntime.InvokeVoidAsync("stopIncomingCallSound");
                        Console.WriteLine("üîï VideoCall: Stopped ringtone (final retry successful)");
                    }
                    catch (Exception finalEx)
                    {
                        Console.WriteLine($"‚ö†Ô∏è VideoCall: All retries failed: {finalEx.Message}");
                    }
                }
            }
        });
        
        callStatus = "Connected";
        Console.WriteLine($"‚úÖ VideoCall: Receiver accepted call, status updated to Connected");
        Console.WriteLine($"üìû ========== End VideoCall: HandleUserJoined ==========");
        
        InvokeAsync(StateHasChanged);
    }

    private void HandleUserLeft(uint uid)
    {
        Console.WriteLine($"üìû VideoCall: Remote user {uid} left (Agora event)");
        remoteUsers.Remove(uid);
        
        // ‚úÖ If we're in a call and the remote user left, navigate back to chat
        // This is a fallback in case SignalR call-ended event doesn't fire
        if (isInCall && remoteUsers.Count == 0)
        {
            Console.WriteLine($"üìû VideoCall: All remote users left, navigating back to chat (fallback)...");
            _ = Task.Run(async () =>
            {
                try
                {
                    await AgoraService.LeaveChannelAsync();
                    await Task.Delay(500); // Small delay for cleanup
                    await InvokeAsync(() =>
                    {
                        Console.WriteLine($"üìû VideoCall: Navigating to /real-time-chat (user-left fallback)");
                        Navigation.NavigateTo("/real-time-chat");
                        StateHasChanged();
                    });
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"‚ùå VideoCall: Error in HandleUserLeft fallback: {ex.Message}");
                }
            });
        }
        
        StateHasChanged();
    }

    private void HandleConnectionStateChanged(string state)
    {
        callStatus = state;
        StateHasChanged();
    }

    private void HandleError(string errorMessage)
    {
        error = errorMessage;
        StateHasChanged();
    }

    private async Task<User?> GetUserById(int userId)
    {
        try
        {
            // Try multiple API endpoints
            User? user = null;
            
            // Try api/user/{userId} first (used by Journal page)
            try
            {
                user = await Http.GetFromJsonAsync<User>($"api/user/{userId}");
                if (user != null && !string.IsNullOrEmpty(user.FirstName))
                {
                    Console.WriteLine($"‚úÖ VideoCall: Fetched user {userId} from api/user: {user.FirstName} {user.LastName}");
                    return user;
                }
            }
            catch (Exception ex1)
            {
                Console.WriteLine($"‚ö†Ô∏è VideoCall: api/user/{userId} failed: {ex1.Message}");
            }
            
            // Try api/patient/{userId} as fallback
            try
            {
                user = await Http.GetFromJsonAsync<User>($"api/patient/{userId}");
                if (user != null && !string.IsNullOrEmpty(user.FirstName))
                {
                    Console.WriteLine($"‚úÖ VideoCall: Fetched user {userId} from api/patient: {user.FirstName} {user.LastName}");
                    return user;
                }
            }
            catch (Exception ex2)
            {
                Console.WriteLine($"‚ö†Ô∏è VideoCall: api/patient/{userId} failed: {ex2.Message}");
            }
            
            // Try OData endpoint as another fallback
            try
            {
                var response = await Http.GetAsync($"odata/Users({userId})");
                if (response.IsSuccessStatusCode)
                {
                    var json = await response.Content.ReadFromJsonAsync<JsonElement>();
                    if (json.TryGetProperty("value", out var valueElement) && valueElement.ValueKind == JsonValueKind.Array)
                    {
                        var users = valueElement.EnumerateArray().ToList();
                        if (users.Any())
                        {
                            var userJson = users.First();
                            user = JsonSerializer.Deserialize<User>(userJson.GetRawText(), new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                            if (user != null && !string.IsNullOrEmpty(user.FirstName))
                            {
                                Console.WriteLine($"‚úÖ VideoCall: Fetched user {userId} from OData: {user.FirstName} {user.LastName}");
                                return user;
                            }
                        }
                    }
                    else if (json.TryGetProperty("FirstName", out _))
                    {
                        // Single result
                        user = JsonSerializer.Deserialize<User>(json.GetRawText(), new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                        if (user != null && !string.IsNullOrEmpty(user.FirstName))
                        {
                            Console.WriteLine($"‚úÖ VideoCall: Fetched user {userId} from OData (single): {user.FirstName} {user.LastName}");
                            return user;
                        }
                    }
                }
            }
            catch (Exception ex3)
            {
                Console.WriteLine($"‚ö†Ô∏è VideoCall: OData endpoint failed: {ex3.Message}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ö†Ô∏è VideoCall: All API attempts failed for user {userId}: {ex.Message}");
        }
        
        // Fallback to current user if fetching target user fails
        if (AuthService.CurrentUser?.Id == userId)
        {
            Console.WriteLine($"‚úÖ VideoCall: Using current user as fallback: {AuthService.CurrentUser.FirstName} {AuthService.CurrentUser.LastName}");
            return new User
            {
                Id = userId,
                FirstName = AuthService.CurrentUser.FirstName,
                LastName = AuthService.CurrentUser.LastName
            };
        }
        
        // Last resort: return null and let the UI handle it
        Console.WriteLine($"‚ö†Ô∏è VideoCall: Could not fetch user {userId}, returning null");
        return null;
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            // ‚úÖ Stop timeout timer
            StopCallTimeoutTimer();
            
            // ‚úÖ Unsubscribe from call-ended events
            RealtimeService.OnCallEnded -= HandleCallEnded;
            SignalRService.OnCallEnded -= HandleCallEnded;
            
            // ‚úÖ Unsubscribe from call-rejected events
            RealtimeService.OnCallRejected -= HandleCallRejected;
            SignalRService.OnCallRejected -= HandleCallRejected;
            
            if (isInCall)
            {
                await AgoraService.LeaveChannelAsync();
            }
            await AgoraService.DestroyAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error disposing Agora: {ex.Message}");
        }
    }
}
