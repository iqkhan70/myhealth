@page "/reset-password"
@using SM_MentalHealthApp.Client.Services
@using SM_MentalHealthApp.Shared
@inject HttpClient Http
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject IJSRuntime JSRuntime

<PageTitle>Reset Password</PageTitle>

<div class="login-container">
    <div class="login-card">
        <div class="login-header">
            <h2>üîê Reset Password</h2>
            <p>Enter your new password</p>
        </div>

        <div class="login-form">
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger" role="alert">
                    @errorMessage
                </div>
            }

            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success" role="alert">
                    @successMessage
                </div>
            }

            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" class="form-control" @bind="email" placeholder="Enter your email"
                    readonly disabled="@IsFormDisabled" />
            </div>

            <div class="form-group">
                <label for="newPassword">New Password</label>
                <input type="password" id="newPassword"
                    class="form-control @(string.IsNullOrEmpty(newPassword) && showValidation ? "is-invalid" : "")"
                    @bind="newPassword" placeholder="Enter new password" disabled="@IsFormDisabled" />
                @if (string.IsNullOrEmpty(newPassword) && showValidation)
                {
                    <div class="invalid-feedback">Password is required</div>
                }
                <small class="form-text text-muted">Password must be at least 6 characters long</small>
            </div>

            <div class="form-group">
                <label for="confirmPassword">Confirm Password</label>
                <input type="password" id="confirmPassword"
                    class="form-control @(newPassword != confirmPassword && showValidation ? "is-invalid" : "")"
                    @bind="confirmPassword" placeholder="Confirm new password" disabled="@IsFormDisabled" />
                @if (newPassword != confirmPassword && showValidation)
                {
                    <div class="invalid-feedback">Passwords do not match</div>
                }
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-primary btn-block" @onclick="HandleResetPassword"
                    disabled="@IsFormDisabled">
                    @if (isLoading)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    }
                    Reset Password
                </button>
            </div>

            @if (isSuccess)
            {
                <div class="text-center mt-3">
                    @if (isMobileDevice)
                    {
                        <div class="alert alert-info" role="alert">
                            <strong>Password changed successfully!</strong>
                            <p class="mb-0 mt-2">Please return to the mobile app to login with your new password.</p>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">Redirecting to login page...</p>
                        <a href="/login" class="btn btn-link">Go to Login</a>
                    }
                </div>
            }
            else
            {
                <div class="text-center mt-3">
                    <a href="/login" class="text-muted">Back to Login</a>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private string email = "";
    private string newPassword = "";
    private string confirmPassword = "";
    private string token = "";
    private bool isLoading = false;
    private bool showValidation = false;
    private bool isSuccess = false;
    private string errorMessage = "";
    private string successMessage = "";

    private bool IsFormDisabled => isLoading || isSuccess;
    private bool isMobileDevice = false;

    protected override async Task OnInitializedAsync()
    {
        // Detect if this is a mobile device
        try
        {
            isMobileDevice = await JSRuntime.InvokeAsync<bool>("eval", 
                @"/(android|iphone|ipad|ipod|blackberry|iemobile|opera mini|mobile|tablet)/i.test(navigator.userAgent)");
        }
        catch
        {
            // If detection fails, assume desktop
            isMobileDevice = false;
        }

        // Get token and email from query string
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = uri.Query;
        
        if (!string.IsNullOrEmpty(query))
        {
            // Parse query string manually
            var queryParams = query.TrimStart('?').Split('&');
            foreach (var param in queryParams)
            {
                var parts = param.Split('=', 2);
                if (parts.Length == 2)
                {
                    var key = parts[0];
                    var value = Uri.UnescapeDataString(parts[1]);
                    
                    if (key.Equals("token", StringComparison.OrdinalIgnoreCase))
                    {
                        token = value;
                    }
                    else if (key.Equals("email", StringComparison.OrdinalIgnoreCase))
                    {
                        email = value;
                    }
                }
            }
        }

        if (string.IsNullOrEmpty(token) || string.IsNullOrEmpty(email))
        {
            errorMessage = "Invalid reset link. Please request a new password reset.";
            // Don't disable fields if token/email is missing - allow user to manually enter email
            // Fields will only be disabled if isLoading or isSuccess is true
        }
    }

    private async Task HandleResetPassword()
    {
        showValidation = true;
        errorMessage = "";
        successMessage = "";

        if (string.IsNullOrEmpty(email))
        {
            errorMessage = "Email is required";
            return;
        }

        if (string.IsNullOrEmpty(newPassword))
        {
            errorMessage = "Password is required";
            return;
        }

        if (newPassword.Length < 6)
        {
            errorMessage = "Password must be at least 6 characters long";
            return;
        }

        if (newPassword != confirmPassword)
        {
            errorMessage = "Passwords do not match";
            return;
        }

        if (string.IsNullOrEmpty(token))
        {
            errorMessage = "Invalid reset token. Please request a new password reset.";
            return;
        }

        isLoading = true;
        StateHasChanged();

        try
        {
            var request = new ResetPasswordRequest
            {
                Token = token,
                Email = email,
                NewPassword = newPassword,
                ConfirmPassword = confirmPassword
            };

            var response = await Http.PostAsJsonAsync("api/auth/reset-password", request);
            var result = await response.Content.ReadFromJsonAsync<ResetPasswordResponse>();

            if (result != null && result.Success)
            {
                successMessage = result.Message;
                isSuccess = true;
                showValidation = false; // Clear validation when successful
                errorMessage = ""; // Clear any error messages
                newPassword = "";
                confirmPassword = "";
                
                // For mobile devices, show message instead of redirecting
                // For web/desktop, navigate to login page after a short delay
                if (!isMobileDevice)
                {
                    await Task.Delay(2000);
                    Navigation.NavigateTo("/login");
                }
                // Mobile users will see the success message and can return to app manually
            }
            else
            {
                errorMessage = result?.Message ?? "An error occurred. Please try again.";
                showValidation = false; // Don't show field-level validation on server errors
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to reset password: {ex.Message}";
            showValidation = false; // Don't show field-level validation on exceptions
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}
