@page "/clinical-decision-support"
@using SM_MentalHealthApp.Shared
@using SM_MentalHealthApp.Client.Services
@inject HttpClient Http
@inject IAuthService AuthService
@inject IPatientService PatientService
@inject IJSRuntime JSRuntime

<PageTitle>AI Clinical Decision Support</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-brain me-2"></i>AI Clinical Decision Support</h2>
                    <p class="text-muted mb-0">Get evidence-based recommendations for your diagnosis</p>
                </div>
            </div>

            <!-- Clinical Decision Support Component -->
            <div class="clinical-decision-support-wrapper">
                <ClinicalDecisionSupport Patients="@assignedPatients" />
            </div>
        </div>
    </div>
</div>

<style>
    .clinical-decision-support-wrapper {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 25px;
    }
</style>

@code {
    private List<User> assignedPatients = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadPatients();
    }

    private async Task LoadPatients()
    {
        try
        {
            // Load patients based on user role
            if (AuthService.CurrentUser?.RoleId == 2) // Doctor - only assigned patients
            {
                var doctorId = AuthService.CurrentUser?.Id ?? 0;
                if (doctorId > 0)
                {
                    var patientsResponse = await Http.GetFromJsonAsync<List<User>>($"api/admin/doctor/{doctorId}/patients");
                    assignedPatients = patientsResponse ?? new();
                }
            }
            else if (AuthService.CurrentUser?.RoleId == 3) // Admin - all patients
            {
                assignedPatients = (await PatientService.ListAsync(CancellationToken.None))?.ToList() ?? new();
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error loading patients: {ex.Message}");
            assignedPatients = new();
        }
    }
}
