@page "/clinical-notes"
@using SM_MentalHealthApp.Shared
@using SM_MentalHealthApp.Client.Services
@using SM_MentalHealthApp.Client.Components.Grid
@using SM_MentalHealthApp.Client.Components.Common
@using SM_MentalHealthApp.Client.Helpers
@using SM_MentalHealthApp.Client.Helpers
@using SM_MentalHealthApp.Client.Components
@using Radzen
@using Radzen.Blazor
@inject IClinicalNotesService ClinicalNotesService
@inject IAuthService AuthService
@inject IJSRuntime JSRuntime
@inject NotificationService NotificationService
@inject HttpClient Http

<PageTitle>Service Notes</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <SMPageHeader Title="Service Notes" 
                         Icon="fas fa-stethoscope">
                <ActionButton>
                    <RadzenButton Icon="add" Text="Add Note" ButtonStyle="ButtonStyle.Success"
                        Click="@(async () => await ShowAddNoteDialog())" />
                </ActionButton>
            </SMPageHeader>

            <!-- Service Request Selector (for SMEs) -->
            @if (AuthService.CurrentUser?.RoleId == 2 || AuthService.CurrentUser?.RoleId == 5 || AuthService.CurrentUser?.RoleId == 4)
            {
                <ServiceRequestSelector ClientId="@selectedPatientId" ServiceRequestIdChanged="@OnServiceRequestChanged" />
            }

            <SMDataGrid TItem="ClinicalNoteDto" 
                       Columns="_columns" 
                       Actions="_actions" 
                       ActionsWidth="150px"
                       LoadItemsPaged="LoadClinicalNotesPagedAsync" 
                       @ref="_grid" 
                       PageSize="5"
                       AllowPaging="true"
                       AllowFiltering="true"
                       FilterMode="FilterMode.Advanced"
                       ShowPagingSummary="true"
                       OnRowExpandCallback="@OnRowExpand">
                <ExpansionTemplate Context="note">
                    @{
                        var expandedNote = expandedNotes.ContainsKey(note.Id) ? expandedNotes[note.Id] : note;
                    }
                    <div class="p-3">
                        <div class="row">
                            <div class="col-12">
                                <h6>Service Note Details</h6>
                                <div class="note-meta mb-3">
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Client:</strong></span>
                                        <span class="meta-value">@expandedNote.PatientName (ID: @expandedNote.PatientId)</span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>SME:</strong></span>
                                        <span class="meta-value">@expandedNote.DoctorName (ID: @expandedNote.DoctorId)</span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Type:</strong></span>
                                        <span class="meta-value">
                                            <span class="badge @GetNoteTypeClass(expandedNote.NoteType)">@expandedNote.NoteType</span>
                                        </span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Priority:</strong></span>
                                        <span class="meta-value">
                                            <span class="badge @GetPriorityClass(expandedNote.Priority)">@expandedNote.Priority</span>
                                        </span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Created:</strong></span>
                                        <span class="meta-value">@expandedNote.CreatedAt.ToString("MMM dd, yyyy HH:mm")</span>
                                    </div>
                                    @if (expandedNote.UpdatedAt.HasValue)
                                    {
                                        <div class="meta-row">
                                            <span class="meta-label"><strong>Updated:</strong></span>
                                            <span class="meta-value">@expandedNote.UpdatedAt.Value.ToString("MMM dd, yyyy HH:mm")</span>
                                        </div>
                                    }
                                    @if (expandedNote.IsConfidential)
                                    {
                                        <div class="meta-row">
                                            <span class="meta-label"><strong>Status:</strong></span>
                                            <span class="meta-value">
                                                <i class="fas fa-lock text-warning"></i> Confidential
                                            </span>
                                        </div>
                                    }
                                    @if (!string.IsNullOrEmpty(expandedNote.Tags))
                                    {
                                        <div class="meta-row">
                                            <span class="meta-label"><strong>Tags:</strong></span>
                                            <span class="meta-value">@expandedNote.Tags</span>
                                        </div>
                                    }
                                </div>
                                
                                <div class="note-content-full">
                                    <h6>Full Content:</h6>
                                    <div class="content-text">@expandedNote.Content</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </ExpansionTemplate>
            </SMDataGrid>
        </div>
    </div>
</div>

<!-- Add/Edit Note Dialog -->
@if (showNoteDialog)
{
    <SMModal IsVisible="@showNoteDialog" 
             Title="@(editingNote?.Id == 0 ? "Add Service Note" : "Edit Service Note")" 
             OnClose="CloseNoteDialog"
             Size="Large">
        <Body>
            <form @onsubmit="@SaveNote" @onsubmit:preventDefault="true">
                <div class="form-group">
                    <label class="form-label">Client: <span class="required-asterisk">*</span></label>
                    <RadzenDropDown @bind-Value="noteForm.PatientId" Data="@patients" TextProperty="FullName"
                        ValueProperty="Id" Placeholder="Select Client" Style="width: 100%;" 
                        AllowClear="false" TValue="int" />
                    @if (noteForm.PatientId == 0 && showPatientRequiredError)
                    {
                        <span class="text-danger" style="font-size: 0.875rem; margin-top: 4px; display: block;">Please select a patient</span>
                    }
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Note Type: <span class="required-asterisk">*</span></label>
                        <RadzenDropDown @bind-Value="noteForm.NoteType" Data="@noteTypes" Placeholder="Note Type"
                            Style="width: 100%;" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority: <span class="required-asterisk">*</span></label>
                        <RadzenDropDown @bind-Value="noteForm.Priority" Data="@priorities" Placeholder="Priority"
                            Style="width: 100%;" />
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Title: <span class="required-asterisk">*</span></label>
                    <RadzenTextBox @bind-Value="noteForm.Title" Placeholder="Note Title" Style="width: 100%;" />
                </div>

                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <label class="form-label" style="margin-bottom: 0;">Content: <span class="required-asterisk">*</span></label>
                        @if (editingNote?.Id == 0 && noteForm.PatientId > 0)
                        {
                            <RadzenButton Text="ðŸ¤– AI Assist" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small"
                                Icon="auto_awesome" Click="@GenerateWithAI" Disabled="@isGeneratingAI"
                                Title="Generate structured clinical note using AI" />
                        }
                    </div>
                    @if (isGeneratingAI)
                    {
                        <div style="padding: 10px; background-color: #e3f2fd; border-radius: 4px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px;">
                            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                            <span style="color: #1976d2; font-size: 14px;">AI is generating your clinical note... This may take a moment.</span>
                        </div>
                    }
                    <RadzenTextArea @bind-Value="noteForm.Content" Placeholder="Note Content (or enter encounter data and click 'AI Assist' to generate structured note)"
                        Style="width: 100%; min-height: 200px;" />
                    @if (!string.IsNullOrEmpty(aiAnalysis))
                    {
                        <div style="margin-top: 12px; padding: 12px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong style="color: #856404;">
                                    <i class="fas fa-lightbulb"></i> AI Analysis - Missed Considerations & Follow-up Actions
                                </strong>
                                <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.ExtraSmall"
                                    Click="@(() => aiAnalysis = string.Empty)" Title="Dismiss" />
                            </div>
                            <div style="color: #856404; font-size: 14px; white-space: pre-wrap;">@aiAnalysis</div>
                        </div>
                    }
                </div>

                <div class="form-group">
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem">
                        <RadzenCheckBox @bind-Value="noteForm.IsConfidential" Name="IsConfidential" />
                        <RadzenText Text="Confidential" />
                    </RadzenStack>
                </div>

                <div class="form-group">
                    <label class="form-label">Tags:</label>
                    <RadzenTextBox @bind-Value="noteForm.Tags" Placeholder="Tags (comma-separated)"
                        Style="width: 100%;" />
                </div>
            </form>
        </Body>
        <Footer>
            <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@CloseNoteDialog" />
            <RadzenButton Text="Save" ButtonStyle="ButtonStyle.Success" ButtonType="ButtonType.Submit" Click="@SaveNote" />
        </Footer>
    </SMModal>
}

<!-- View Note Dialog -->
@if (showViewDialog)
{
    <SMModal IsVisible="@showViewDialog" 
             Title="Service Note Details" 
             OnClose="CloseViewDialog"
             Size="Large">
        <Body>
            @if (viewingNote != null)
            {
                <div class="note-details">
                    <h4>@viewingNote.Title</h4>
                    <div class="note-meta">
                        <div class="meta-row">
                            <span class="meta-label">Client:</span>
                            <span class="meta-value">@viewingNote.PatientName</span>
                        </div>
                        <div class="meta-row">
                            <span class="meta-label">SME:</span>
                            <span class="meta-value">@viewingNote.DoctorName</span>
                        </div>
                        <div class="meta-row">
                            <span class="meta-label">Type:</span>
                            <span class="meta-value">@viewingNote.NoteType</span>
                        </div>
                        <div class="meta-row">
                            <span class="meta-label">Priority:</span>
                            <span class="meta-value">@viewingNote.Priority</span>
                        </div>
                        <div class="meta-row">
                            <span class="meta-label">Created:</span>
                            <span class="meta-value">@viewingNote.CreatedAt.ToString("MMM dd, yyyy HH:mm")</span>
                        </div>
                        @if (viewingNote.UpdatedAt.HasValue)
                        {
                            <div class="meta-row">
                                <span class="meta-label">Updated:</span>
                                <span class="meta-value">@viewingNote.UpdatedAt.Value.ToString("MMM dd, yyyy HH:mm")</span>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(viewingNote.Tags))
                        {
                            <div class="meta-row">
                                <span class="meta-label">Tags:</span>
                                <span class="meta-value">@viewingNote.Tags</span>
                            </div>
                        }
                    </div>
                    <div class="note-content">
                        <h5>Content:</h5>
                        <div class="content-text">@viewingNote.Content</div>
                    </div>
                </div>
            }
        </Body>
    </SMModal>
}

@code {
    private SMDataGrid<ClinicalNoteDto>? _grid;
    private List<User> patients = new();
    private List<string> noteTypes = new();
    private List<string> priorities = new();

    private bool showNoteDialog = false;
    private bool showViewDialog = false;
    private bool showPatientRequiredError = false;
    private ClinicalNoteDto? editingNote;
    private ClinicalNoteDto? viewingNote;
    private CreateClinicalNoteRequest noteForm = new();
    private bool isGeneratingAI = false;
    private string aiAnalysis = string.Empty;

    private List<SMDataGridColumn<ClinicalNoteDto>> _columns = new();
    private List<SMDataGridActionButton<ClinicalNoteDto>> _actions = new();
    private Dictionary<int, ClinicalNoteDto> expandedNotes = new Dictionary<int, ClinicalNoteDto>();
    private int? selectedServiceRequestId;
    private int? selectedPatientId; // For ServiceRequest selector

    private async Task OnServiceRequestChanged(int? serviceRequestId)
    {
        selectedServiceRequestId = serviceRequestId;
        if (_grid != null)
        {
            await _grid.RefreshAsync();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadPatients();
        await LoadNoteTypes();
        await LoadPriorities();

        InitializeColumns();
        InitializeActions();
    }

    private void InitializeColumns()
    {
        _columns = new List<SMDataGridColumn<ClinicalNoteDto>>
        {
            new SMDataGridTemplateColumn<ClinicalNoteDto>
            {
                Property = nameof(ClinicalNoteDto.Title),
                Title = "Title",
                Width = "200px",
                Template = note => builder =>
                {
                    builder.OpenElement(0, "div");
                    builder.OpenElement(1, "strong");
                    builder.AddContent(2, note.Title);
                    builder.CloseElement();
                    if (note.IsConfidential)
                    {
                        builder.OpenElement(3, "i");
                        builder.AddAttribute(4, "class", "fas fa-lock text-warning ms-1");
                        builder.AddAttribute(5, "title", "Confidential");
                        builder.CloseElement();
                    }
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<ClinicalNoteDto>
            {
                Property = nameof(ClinicalNoteDto.PatientName),
                Title = "Client",
                Width = "150px",
                Template = note => builder =>
                {
                    builder.OpenElement(0, "div");
                    builder.OpenElement(1, "strong");
                    builder.AddContent(2, note.PatientName);
                    builder.CloseElement();
                    builder.OpenElement(3, "br");
                    builder.CloseElement();
                    builder.OpenElement(4, "small");
                    builder.AddAttribute(5, "class", "text-muted");
                    builder.AddContent(6, $"ID: {note.PatientId}");
                    builder.CloseElement();
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<ClinicalNoteDto>
            {
                Property = nameof(ClinicalNoteDto.NoteType),
                Title = "Type",
                Width = "120px",
                Template = note => builder =>
                {
                    var noteTypeClass = GetNoteTypeClass(note.NoteType);
                    // Debug: Log if follow-up is showing wrong color
                    if (note.NoteType?.ToLower().Contains("follow") == true && noteTypeClass == "bg-danger")
                    {
                    }
                    builder.OpenElement(0, "span");
                    builder.AddAttribute(1, "class", $"badge {noteTypeClass}");
                    builder.AddContent(2, note.NoteType);
                    builder.CloseElement();
                }
            },
            new SMDataGridBadgeColumn<ClinicalNoteDto>
            {
                Property = nameof(ClinicalNoteDto.IsIgnoredByDoctor),
                Title = "AI Status",
                Width = "120px",
                TextAlign = TextAlign.Center,
                GetBadgeData = (note) => note.IsIgnoredByDoctor 
                    ? ("ðŸš« Ignored", NotificationSeverity.Warning, true)
                    : ("âœ… Active", NotificationSeverity.Success, true)
            },
            new SMDataGridTemplateColumn<ClinicalNoteDto>
            {
                Property = nameof(ClinicalNoteDto.Priority),
                Title = "Priority",
                Width = "120px",
                Template = note => builder =>
                {
                    builder.OpenElement(0, "span");
                    builder.AddAttribute(1, "class", $"badge {GetPriorityClass(note.Priority)}");
                    builder.AddContent(2, note.Priority);
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<ClinicalNoteDto>
            {
                Property = nameof(ClinicalNoteDto.CreatedAt),
                Title = "Created",
                Width = "120px",
                Template = note => builder =>
                {
                    builder.AddContent(0, note.CreatedAt.ToString("MMM dd, yyyy"));
                    builder.OpenElement(1, "br");
                    builder.CloseElement();
                    builder.OpenElement(2, "small");
                    builder.AddAttribute(3, "class", "text-muted");
                    builder.AddContent(4, note.CreatedAt.ToString("HH:mm"));
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<ClinicalNoteDto>
            {
                Property = nameof(ClinicalNoteDto.DoctorName),
                Title = "SME",
                Width = "150px",
                Template = note => builder =>
                {
                    builder.OpenElement(0, "div");
                    builder.OpenElement(1, "strong");
                    builder.AddContent(2, note.DoctorName);
                    builder.CloseElement();
                    builder.OpenElement(3, "br");
                    builder.CloseElement();
                    builder.OpenElement(4, "small");
                    builder.AddAttribute(5, "class", "text-muted");
                    builder.AddContent(6, $"ID: {note.DoctorId}");
                    builder.CloseElement();
                    builder.CloseElement();
                }
            }
        };
    }

    private void InitializeActions()
    {
        _actions.Add(new SMDataGridActionButton<ClinicalNoteDto>
        {
            Icon = "visibility",
            ButtonStyle = ButtonStyle.Info,
            Variant = Variant.Flat,
            Size = ButtonSize.Small,
            Tooltip = "View clinical note details",
            OnClick = async (row, ct) => await ViewNoteAsync(row, ct)
        });

        // Edit action (not for Attorney - read-only)
        if (AuthService.CurrentUser?.RoleId != 5) // Attorney can only view
        {
            _actions.Add(new SMDataGridActionButton<ClinicalNoteDto>
            {
                Icon = "edit",
                ButtonStyle = ButtonStyle.Success,
                Variant = Variant.Flat,
                Size = ButtonSize.Small,
                Tooltip = "Edit clinical note",
                OnClick = async (row, ct) => await EditNoteAsync(row, ct)
            });
        }

        // Add ignore/unignore button for doctors (not for Attorney - read-only)
        if (AuthService.CurrentUser?.RoleId == 2) // Doctor
        {
            _actions.Add(new SMDataGridActionButton<ClinicalNoteDto>
            {
                IconFunc = (note) => note.IsIgnoredByDoctor ? "undo" : "block", // Use "undo" for unignore (distinct from "visibility" used for view)
                ButtonStyleFunc = (note) => note.IsIgnoredByDoctor ? ButtonStyle.Info : ButtonStyle.Warning,
                Variant = Variant.Flat,
                Size = ButtonSize.Small,
                TooltipFunc = (note) => note.IsIgnoredByDoctor 
                    ? $"Unignore for AI analysis (Ignored on: {note.IgnoredAt?.ToString("MM/dd/yyyy HH:mm") ?? "Unknown"})" 
                    : "Ignore for AI analysis - This will exclude this note from AI health check",
                OnClick = async (row, ct) => await ToggleIgnoreNoteAsync(row, ct),
                Disabled = (note) => note.DoctorId != GetCurrentUserId() // Only allow ignoring own notes
            });
        }

        _actions.Add(new SMDataGridActionButton<ClinicalNoteDto>
        {
            Icon = "delete",
            ButtonStyle = ButtonStyle.Danger,
            Variant = Variant.Flat,
            Size = ButtonSize.Small,
            Tooltip = "Delete clinical note",
            OnClick = async (row, ct) => await DeleteNoteAsync(row, ct),
            // Only show delete button if user is admin OR if user is doctor and owns this note
            Visible = (note) => 
            {
                var currentUser = AuthService.CurrentUser;
                if (currentUser == null) return false;
                
                // Admins can see delete button for all notes
                if (currentUser.RoleId == Shared.Constants.Roles.Admin)
                    return true;
                
                // Doctors can only see delete button for their own notes
                if (currentUser.RoleId == Shared.Constants.Roles.Doctor)
                    return note.DoctorId == currentUser.Id;
                
                // Other roles cannot delete
                return false;
            }
        });
    }

    private async Task<PagedResult<ClinicalNoteDto>> LoadClinicalNotesPagedAsync(
        int skip, 
        int take, 
        string? orderBy, 
        string? filter, 
        CancellationToken ct)
    {
        try
        {
            // Parse Radzen filter string using helper (similar to how Patients page does it)
            var (searchTerm, noteType, priority, isIgnoredByDoctor, createdDateFrom, createdDateTo) = ClinicalNotesFilterHelper.ParseFilter(filter);
            
            var result = await ClinicalNotesService.ListPagedAsync(skip, take, null, null, selectedServiceRequestId, searchTerm, noteType, priority, isIgnoredByDoctor, createdDateFrom, createdDateTo, ct);
            return result;
        }
        catch (Exception ex)
        {
            // Only show error for actual failures, not empty results
            if (ex.Message.Contains("401") || ex.Message.Contains("403") || ex.Message.Contains("Unauthorized"))
            {
                NotificationService.ShowError($"Failed to load clinical notes: {ex.Message}");
            }
            // For other errors, return empty result
            return new PagedResult<ClinicalNoteDto>
            {
                Items = new List<ClinicalNoteDto>(),
                TotalCount = 0,
                PageNumber = (skip / take) + 1,
                PageSize = take
            };
        }
    }

    private async Task LoadPatients()
    {
        try
        {
            // Load patients based on user role
            if (AuthService.CurrentUser?.RoleId == 2) // Doctor
            {
                var response = await Http.GetFromJsonAsync<List<User>>($"api/admin/doctor/{AuthService.CurrentUser.Id}/patients");
                patients = response ?? new();
            }
            else if (AuthService.CurrentUser?.RoleId == 4) // Coordinator
            {
                var response = await Http.GetFromJsonAsync<List<User>>($"api/admin/doctor/{AuthService.CurrentUser.Id}/patients");
                patients = response ?? new();
            }
            else if (AuthService.CurrentUser?.RoleId == 5) // Attorney
            {
                var response = await Http.GetFromJsonAsync<List<User>>($"api/admin/doctor/{AuthService.CurrentUser.Id}/patients");
                patients = response ?? new();
            }
            else if (AuthService.CurrentUser?.RoleId == 3) // Admin
            {
                var response = await Http.GetFromJsonAsync<List<User>>("api/admin/patients");
                patients = response ?? new();
            }
            else
            {
                patients = new();
            }
        }
        catch (Exception ex)
        {
            // Don't show error for empty results - just log to console
            await JSRuntime.InvokeVoidAsync("console.error", "Error loading patients:", ex.Message);
            patients = new(); // Set to empty list on error
        }
    }

    private async Task LoadNoteTypes()
    {
        try
        {
            noteTypes = await ClinicalNotesService.GetNoteTypesAsync();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", "Error loading note types:", ex.Message);
        }
    }

    private async Task LoadPriorities()
    {
        try
        {
            priorities = await ClinicalNotesService.GetPrioritiesAsync();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", "Error loading priorities:", ex.Message);
        }
    }

    private async Task ShowAddNoteDialog()
    {
        editingNote = new ClinicalNoteDto { Id = 0 };
        noteForm = new CreateClinicalNoteRequest { PatientId = 0 };
        showPatientRequiredError = false;
        aiAnalysis = string.Empty;
        isGeneratingAI = false;
        showNoteDialog = true;
        await InvokeAsync(StateHasChanged);
    }

    private async Task EditNoteAsync(ClinicalNoteDto note, CancellationToken ct)
    {
        editingNote = note;
        noteForm = new CreateClinicalNoteRequest
        {
            PatientId = note.PatientId,
            Title = note.Title,
            Content = note.Content,
            NoteType = note.NoteType,
            Priority = note.Priority,
            IsConfidential = note.IsConfidential,
            Tags = note.Tags
        };
        showNoteDialog = true;
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnRowExpand(ClinicalNoteDto note)
    {
        try
        {
            if (!expandedNotes.ContainsKey(note.Id))
            {
                var fullNote = await ClinicalNotesService.GetAsync(note.Id);
                if (fullNote != null)
                {
                    expandedNotes[note.Id] = fullNote;
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to load note details: {ex.Message}");
        }
    }

    private async Task ViewNoteAsync(ClinicalNoteDto note, CancellationToken ct)
    {
        try
        {
            var fullNote = await ClinicalNotesService.GetAsync(note.Id, ct);
            viewingNote = fullNote ?? note;
            showViewDialog = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to load note details: {ex.Message}");
        }
    }

    private async Task SaveNote()
    {
        try
        {
            // Validate required fields
            if (editingNote?.Id == 0)
            {
                // Validate patient is selected for new notes
                if (noteForm.PatientId <= 0)
                {
                    showPatientRequiredError = true;
                    NotificationService.ShowError("Please select a patient before saving the clinical note.");
                    StateHasChanged();
                    return;
                }

                // Validate other required fields
                if (string.IsNullOrWhiteSpace(noteForm.Title))
                {
                    NotificationService.ShowError("Please enter a title for the clinical note.");
                    return;
                }

                if (string.IsNullOrWhiteSpace(noteForm.Content))
                {
                    NotificationService.ShowError("Please enter content for the clinical note.");
                    return;
                }

                if (string.IsNullOrWhiteSpace(noteForm.NoteType))
                {
                    NotificationService.ShowError("Please select a note type.");
                    return;
                }

                if (string.IsNullOrWhiteSpace(noteForm.Priority))
                {
                    NotificationService.ShowError("Please select a priority.");
                    return;
                }

                showPatientRequiredError = false;
                
                // Create new note
                await ClinicalNotesService.CreateAsync(noteForm);
                showNoteDialog = false;
                if (_grid != null)
                {
                    await _grid.RefreshAsync();
                }
                NotificationService.ShowSuccess("Clinical note created successfully!");
            }
            else
            {
                // Validate required fields for updates
                if (string.IsNullOrWhiteSpace(noteForm.Title))
                {
                    NotificationService.ShowError("Please enter a title for the clinical note.");
                    return;
                }

                if (string.IsNullOrWhiteSpace(noteForm.Content))
                {
                    NotificationService.ShowError("Please enter content for the clinical note.");
                    return;
                }

                if (string.IsNullOrWhiteSpace(noteForm.NoteType))
                {
                    NotificationService.ShowError("Please select a note type.");
                    return;
                }

                if (string.IsNullOrWhiteSpace(noteForm.Priority))
                {
                    NotificationService.ShowError("Please select a priority.");
                    return;
                }

                // Update existing note
                var updateRequest = new UpdateClinicalNoteRequest
                {
                    Title = noteForm.Title,
                    Content = noteForm.Content,
                    NoteType = noteForm.NoteType,
                    Priority = noteForm.Priority,
                    IsConfidential = noteForm.IsConfidential,
                    Tags = noteForm.Tags
                };

                await ClinicalNotesService.UpdateAsync(editingNote!.Id, updateRequest);
                showNoteDialog = false;
                if (_grid != null)
                {
                    await _grid.RefreshAsync();
                }
                NotificationService.ShowSuccess("Clinical note updated successfully!");
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to save clinical note: {ex.Message}");
        }
    }

    private async Task CloseNoteDialog()
    {
        showNoteDialog = false;
        editingNote = null;
        noteForm = new CreateClinicalNoteRequest { PatientId = 0 };
        showPatientRequiredError = false;
        aiAnalysis = string.Empty;
        isGeneratingAI = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task CloseViewDialog()
    {
        showViewDialog = false;
        viewingNote = null;
        await InvokeAsync(StateHasChanged);
    }

    private string GetNoteTypeClass(string noteType)
    {
        if (string.IsNullOrWhiteSpace(noteType))
            return "bg-primary";
            
        var normalized = noteType.ToLower().Trim();
        
        // Remove any special characters that might interfere (except hyphen)
        normalized = normalized.Replace("_", "-").Replace("  ", " ").Trim();
        
        // Explicitly check for follow-up variations FIRST (before emergency check)
        // This ensures follow-up always gets blue, even if it contains the word "emergency" somehow
        if (normalized.Contains("follow"))
        {
            if (normalized == "follow-up" || normalized == "followup" || normalized == "follow up" || 
                normalized.StartsWith("follow-up") || normalized.StartsWith("followup") || normalized.StartsWith("follow up"))
            {
                return "bg-info";  // Blue for follow-up (using bg-info instead of bg-primary to ensure it's blue)
            }
        }
        
        // Explicitly check for emergency (most critical)
        if (normalized == "emergency" || normalized.StartsWith("emergency"))
            return "bg-danger";  // Red
        
        // Check other types
        return normalized switch
        {
            "treatment" => "bg-info",        // Blue for treatment
            "assessment" => "bg-warning",    // Yellow/orange for assessment
            "general" => "bg-success",       // Green for general (normal)
            _ => "bg-info"                   // Default to blue (info) for unknown types
        };
    }

    private string GetPriorityClass(string priority)
    {
        return priority.ToLower() switch
        {
            "low" => "bg-secondary",        // Gray for low
            "normal" => "bg-success",        // Green for normal (changed from bg-primary)
            "high" => "bg-warning",          // Yellow/orange for high
            "critical" => "bg-danger",       // Red for critical
            _ => "bg-secondary"              // Gray for unknown
        };
    }

    private async Task DeleteNoteAsync(ClinicalNoteDto note, CancellationToken ct)
    {
        var confirmed = await JSRuntime.ConfirmDestructiveAsync(
            "delete this clinical note",
            $"Note: {note.Title}\nPatient: {note.PatientName}",
            "clinical note");
        
        if (confirmed)
        {
            try
            {
                await ClinicalNotesService.DeleteAsync(note.Id, ct);
                if (_grid != null)
                {
                    await _grid.RefreshAsync();
                }
                NotificationService.ShowSuccess("Clinical note deleted successfully!");
            }
            catch (Exception ex)
            {
                NotificationService.ShowError($"Failed to delete clinical note: {ex.Message}");
            }
        }
    }

    private int GetCurrentUserId()
    {
        return AuthService.CurrentUser?.Id ?? 0;
    }

    private async Task ToggleIgnoreNoteAsync(ClinicalNoteDto note, CancellationToken ct)
    {
        try
        {
            var wasIgnored = note.IsIgnoredByDoctor;
            var isIgnored = await ClinicalNotesService.ToggleIgnoreAsync(note.Id, ct);
            
            // Update the note in the grid
            note.IsIgnoredByDoctor = isIgnored;
            note.IgnoredByDoctorId = isIgnored ? GetCurrentUserId() : null;
            note.IgnoredAt = isIgnored ? DateTime.UtcNow : null;
            
            NotificationService.ShowSuccess(isIgnored 
                ? "Clinical note ignored. It will be excluded from AI health check analysis." 
                : "Clinical note unignored. It will be included in AI health check analysis.");
            
            if (_grid != null)
            {
                await _grid.RefreshAsync();
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to toggle ignore status: {ex.Message}");
        }
    }

    private async Task GenerateWithAI()
    {
        if (noteForm.PatientId <= 0)
        {
            NotificationService.ShowWarning("Please select a patient first before using AI Assist.");
            return;
        }

        if (string.IsNullOrWhiteSpace(noteForm.Content))
        {
            NotificationService.ShowWarning("Please enter some encounter data or notes in the Content field first. The AI will use this to generate a structured clinical note.");
            return;
        }

        isGeneratingAI = true;
        aiAnalysis = string.Empty;
        await InvokeAsync(StateHasChanged);

        try
        {
            var request = new
            {
                EncounterData = noteForm.Content,
                PatientId = noteForm.PatientId
            };

            // Create a timeout-aware HTTP request (AI generation can take 60-90 seconds)
            using var cts = new CancellationTokenSource(TimeSpan.FromMinutes(3)); // 3 minute timeout
            
            await JSRuntime.InvokeVoidAsync("console.log", $"Calling chained AI API for patient {noteForm.PatientId}...");
            
            var response = await Http.PostAsJsonAsync("api/chainedai/generate-note-and-analysis", request, cts.Token);

            await JSRuntime.InvokeVoidAsync("console.log", $"Received response: StatusCode={response.StatusCode}");

            if (response.IsSuccessStatusCode)
            {
                var responseContent = await response.Content.ReadAsStringAsync(cts.Token);
                await JSRuntime.InvokeVoidAsync("console.log", $"Response content length: {responseContent.Length} characters");
                
                try
                {
                    var result = System.Text.Json.JsonSerializer.Deserialize<ChainedAIResult>(
                        responseContent,
                        new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });

                    await JSRuntime.InvokeVoidAsync("console.log", 
                        $"Deserialized result: Success={result?.Success ?? false}, " +
                        $"PrimaryModelOutput length={result?.PrimaryModelOutput?.Length ?? 0}, " +
                        $"SecondaryModelOutput length={result?.SecondaryModelOutput?.Length ?? 0}");

                if (result != null && result.Success)
                {
                    await JSRuntime.InvokeVoidAsync("console.log", "AI generation successful! Updating UI...");
                    
                    // Populate the form with the generated structured note
                    noteForm.Content = result.PrimaryModelOutput ?? string.Empty;
                    
                    // If title is empty, generate one from the structured note
                    if (string.IsNullOrWhiteSpace(noteForm.Title))
                    {
                        // Try to extract a title from the structured note (first line or first section)
                        var firstLine = result.PrimaryModelOutput?.Split('\n').FirstOrDefault(l => !string.IsNullOrWhiteSpace(l));
                        if (!string.IsNullOrWhiteSpace(firstLine) && firstLine.Length > 50)
                        {
                            noteForm.Title = firstLine.Substring(0, Math.Min(50, firstLine.Length)) + "...";
                        }
                        else if (!string.IsNullOrWhiteSpace(firstLine))
                        {
                            noteForm.Title = firstLine;
                        }
                        else
                        {
                            noteForm.Title = $"Service Note - {DateTime.Now:MMM dd, yyyy}";
                        }
                    }

                    // Store the analysis to show to the doctor
                    aiAnalysis = result.SecondaryModelOutput ?? string.Empty;

                    await JSRuntime.InvokeVoidAsync("console.log", 
                        $"Updated form: Content length={noteForm.Content.Length}, Analysis length={aiAnalysis.Length}");

                    // Force UI update
                    await InvokeAsync(StateHasChanged);

                    NotificationService.ShowSuccess($"AI generated structured note using {result.PrimaryModelName}. Review the analysis below for missed considerations.");
                }
                else
                {
                    var errorMsg = result?.ErrorMessage ?? "Unknown error";
                    await JSRuntime.InvokeVoidAsync("console.error", $"AI generation failed: {errorMsg}");
                    NotificationService.ShowError($"AI generation failed: {errorMsg}");
                }
                }
                catch (System.Text.Json.JsonException jsonEx)
                {
                    await JSRuntime.InvokeVoidAsync("console.error", $"JSON deserialization error: {jsonEx.Message}", responseContent.Substring(0, Math.Min(500, responseContent.Length)));
                    NotificationService.ShowError($"Failed to parse AI response. Check browser console for details.");
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync(cts.Token);
                await JSRuntime.InvokeVoidAsync("console.error", $"API call failed: StatusCode={response.StatusCode}, Error={errorContent}");
                NotificationService.ShowError($"Failed to generate AI note: {response.StatusCode} - {errorContent}");
            }
        }
        catch (TaskCanceledException)
        {
            await JSRuntime.InvokeVoidAsync("console.error", "AI generation timed out after 3 minutes");
            NotificationService.ShowError("AI generation timed out. The request took too long. Please try again with less data or check your Ollama connection.");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error calling AI service: {ex.Message}", ex.StackTrace);
            NotificationService.ShowError($"Error calling AI service: {ex.Message}");
        }
        finally
        {
            isGeneratingAI = false;
            await InvokeAsync(StateHasChanged);
        }
    }
}

<style>
    .form-group {
        margin-bottom: 20px;
    }

    .form-row {
        display: flex;
        gap: 20px;
    }

    .form-row .form-group {
        flex: 1;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
    }

    .required-asterisk {
        color: #dc3545;
    }

    .note-details {
        max-width: 100%;
    }

    .note-meta {
        margin-bottom: 20px;
    }

    .meta-row {
        display: flex;
        margin-bottom: 10px;
    }

    .meta-label {
        font-weight: 500;
        color: #666;
        min-width: 80px;
    }

    .meta-value {
        color: #333;
        margin-left: 10px;
    }

    .note-content h5 {
        margin-bottom: 10px;
        color: #333;
    }

    .content-text {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        border-left: 4px solid #007bff;
        white-space: pre-wrap;
        word-wrap: break-word;
        line-height: 1.6;
        font-size: 0.95em;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .note-details h4 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #2c3e50;
        font-size: 1.3em;
    }

    .note-details h5 {
        margin-top: 15px;
        margin-bottom: 10px;
        color: #2c3e50;
        font-size: 1.1em;
    }

    .note-content-full {
        margin-top: 20px;
    }

    .note-content-full h6 {
        margin-bottom: 10px;
        color: #2c3e50;
        font-size: 1.1em;
    }
</style>
