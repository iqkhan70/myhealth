@page "/clinical-notes"
@using SM_MentalHealthApp.Shared
@using SM_MentalHealthApp.Client.Services
@using SM_MentalHealthApp.Client.Components.Grid
@using SM_MentalHealthApp.Client.Components.Common
@using SM_MentalHealthApp.Client.Helpers
@using Radzen
@using Radzen.Blazor
@inject IClinicalNotesService ClinicalNotesService
@inject IAuthService AuthService
@inject IJSRuntime JSRuntime
@inject NotificationService NotificationService
@inject HttpClient Http

<PageTitle>Clinical Notes</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <SMPageHeader Title="Clinical Notes" 
                         Icon="fas fa-stethoscope">
                <ActionButton>
                    <RadzenButton Icon="add" Text="Add Note" ButtonStyle="ButtonStyle.Success"
                        Click="@(async () => await ShowAddNoteDialog())" />
                </ActionButton>
            </SMPageHeader>

            <SMDataGrid TItem="ClinicalNoteDto" 
                       Columns="_columns" 
                       Actions="_actions" 
                       ActionsWidth="150px"
                       LoadItems="LoadClinicalNotesAsync" 
                       @ref="_grid" 
                       PageSize="10"
                       OnRowExpandCallback="@OnRowExpand">
                <ExpansionTemplate Context="note">
                    @{
                        var expandedNote = expandedNotes.ContainsKey(note.Id) ? expandedNotes[note.Id] : note;
                    }
                    <div class="p-3">
                        <div class="row">
                            <div class="col-12">
                                <h6>Clinical Note Details</h6>
                                <div class="note-meta mb-3">
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Patient:</strong></span>
                                        <span class="meta-value">@expandedNote.PatientName (ID: @expandedNote.PatientId)</span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Doctor:</strong></span>
                                        <span class="meta-value">@expandedNote.DoctorName (ID: @expandedNote.DoctorId)</span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Type:</strong></span>
                                        <span class="meta-value">
                                            <span class="badge @GetNoteTypeClass(expandedNote.NoteType)">@expandedNote.NoteType</span>
                                        </span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Priority:</strong></span>
                                        <span class="meta-value">
                                            <span class="badge @GetPriorityClass(expandedNote.Priority)">@expandedNote.Priority</span>
                                        </span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Created:</strong></span>
                                        <span class="meta-value">@expandedNote.CreatedAt.ToString("MMM dd, yyyy HH:mm")</span>
                                    </div>
                                    @if (expandedNote.UpdatedAt.HasValue)
                                    {
                                        <div class="meta-row">
                                            <span class="meta-label"><strong>Updated:</strong></span>
                                            <span class="meta-value">@expandedNote.UpdatedAt.Value.ToString("MMM dd, yyyy HH:mm")</span>
                                        </div>
                                    }
                                    @if (expandedNote.IsConfidential)
                                    {
                                        <div class="meta-row">
                                            <span class="meta-label"><strong>Status:</strong></span>
                                            <span class="meta-value">
                                                <i class="fas fa-lock text-warning"></i> Confidential
                                            </span>
                                        </div>
                                    }
                                    @if (!string.IsNullOrEmpty(expandedNote.Tags))
                                    {
                                        <div class="meta-row">
                                            <span class="meta-label"><strong>Tags:</strong></span>
                                            <span class="meta-value">@expandedNote.Tags</span>
                                        </div>
                                    }
                                </div>
                                
                                <div class="note-content-full">
                                    <h6>Full Content:</h6>
                                    <div class="content-text">@expandedNote.Content</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </ExpansionTemplate>
            </SMDataGrid>
        </div>
    </div>
</div>

<!-- Add/Edit Note Dialog -->
@if (showNoteDialog)
{
    <SMModal IsVisible="@showNoteDialog" 
             Title="@(editingNote?.Id == 0 ? "Add Clinical Note" : "Edit Clinical Note")" 
             OnClose="CloseNoteDialog"
             Size="Large">
        <Body>
            <form @onsubmit="@SaveNote" @onsubmit:preventDefault="true">
                <div class="form-group">
                    <label class="form-label">Patient: <span class="required-asterisk">*</span></label>
                    <RadzenDropDown @bind-Value="noteForm.PatientId" Data="@patients" TextProperty="FullName"
                        ValueProperty="Id" Placeholder="Select Patient" Style="width: 100%;" 
                        AllowClear="false" TValue="int" />
                    @if (noteForm.PatientId == 0 && showPatientRequiredError)
                    {
                        <span class="text-danger" style="font-size: 0.875rem; margin-top: 4px; display: block;">Please select a patient</span>
                    }
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Note Type: <span class="required-asterisk">*</span></label>
                        <RadzenDropDown @bind-Value="noteForm.NoteType" Data="@noteTypes" Placeholder="Note Type"
                            Style="width: 100%;" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority: <span class="required-asterisk">*</span></label>
                        <RadzenDropDown @bind-Value="noteForm.Priority" Data="@priorities" Placeholder="Priority"
                            Style="width: 100%;" />
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Title: <span class="required-asterisk">*</span></label>
                    <RadzenTextBox @bind-Value="noteForm.Title" Placeholder="Note Title" Style="width: 100%;" />
                </div>

                <div class="form-group">
                    <label class="form-label">Content: <span class="required-asterisk">*</span></label>
                    <RadzenTextArea @bind-Value="noteForm.Content" Placeholder="Note Content"
                        Style="width: 100%; min-height: 200px;" />
                </div>

                <div class="form-group">
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem">
                        <RadzenCheckBox @bind-Value="noteForm.IsConfidential" Name="IsConfidential" />
                        <RadzenText Text="Confidential" />
                    </RadzenStack>
                </div>

                <div class="form-group">
                    <label class="form-label">Tags:</label>
                    <RadzenTextBox @bind-Value="noteForm.Tags" Placeholder="Tags (comma-separated)"
                        Style="width: 100%;" />
                </div>
            </form>
        </Body>
        <Footer>
            <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@CloseNoteDialog" />
            <RadzenButton Text="Save" ButtonStyle="ButtonStyle.Success" ButtonType="ButtonType.Submit" Click="@SaveNote" />
        </Footer>
    </SMModal>
}

<!-- View Note Dialog -->
@if (showViewDialog)
{
    <SMModal IsVisible="@showViewDialog" 
             Title="Clinical Note Details" 
             OnClose="CloseViewDialog"
             Size="Large">
        <Body>
            @if (viewingNote != null)
            {
                <div class="note-details">
                    <h4>@viewingNote.Title</h4>
                    <div class="note-meta">
                        <div class="meta-row">
                            <span class="meta-label">Patient:</span>
                            <span class="meta-value">@viewingNote.PatientName</span>
                        </div>
                        <div class="meta-row">
                            <span class="meta-label">Doctor:</span>
                            <span class="meta-value">@viewingNote.DoctorName</span>
                        </div>
                        <div class="meta-row">
                            <span class="meta-label">Type:</span>
                            <span class="meta-value">@viewingNote.NoteType</span>
                        </div>
                        <div class="meta-row">
                            <span class="meta-label">Priority:</span>
                            <span class="meta-value">@viewingNote.Priority</span>
                        </div>
                        <div class="meta-row">
                            <span class="meta-label">Created:</span>
                            <span class="meta-value">@viewingNote.CreatedAt.ToString("MMM dd, yyyy HH:mm")</span>
                        </div>
                        @if (viewingNote.UpdatedAt.HasValue)
                        {
                            <div class="meta-row">
                                <span class="meta-label">Updated:</span>
                                <span class="meta-value">@viewingNote.UpdatedAt.Value.ToString("MMM dd, yyyy HH:mm")</span>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(viewingNote.Tags))
                        {
                            <div class="meta-row">
                                <span class="meta-label">Tags:</span>
                                <span class="meta-value">@viewingNote.Tags</span>
                            </div>
                        }
                    </div>
                    <div class="note-content">
                        <h5>Content:</h5>
                        <div class="content-text">@viewingNote.Content</div>
                    </div>
                </div>
            }
        </Body>
    </SMModal>
}

@code {
    private SMDataGrid<ClinicalNoteDto>? _grid;
    private List<User> patients = new();
    private List<string> noteTypes = new();
    private List<string> priorities = new();

    private bool showNoteDialog = false;
    private bool showViewDialog = false;
    private bool showPatientRequiredError = false;
    private ClinicalNoteDto? editingNote;
    private ClinicalNoteDto? viewingNote;
    private CreateClinicalNoteRequest noteForm = new();

    private List<SMDataGridColumn<ClinicalNoteDto>> _columns = new();
    private List<SMDataGridActionButton<ClinicalNoteDto>> _actions = new();
    private Dictionary<int, ClinicalNoteDto> expandedNotes = new Dictionary<int, ClinicalNoteDto>();

    protected override async Task OnInitializedAsync()
    {
        await LoadPatients();
        await LoadNoteTypes();
        await LoadPriorities();

        InitializeColumns();
        InitializeActions();
    }

    private void InitializeColumns()
    {
        _columns = new List<SMDataGridColumn<ClinicalNoteDto>>
        {
            new SMDataGridTemplateColumn<ClinicalNoteDto>
            {
                Property = nameof(ClinicalNoteDto.Title),
                Title = "Title",
                Width = "200px",
                Template = note => builder =>
                {
                    builder.OpenElement(0, "div");
                    builder.OpenElement(1, "strong");
                    builder.AddContent(2, note.Title);
                    builder.CloseElement();
                    if (note.IsConfidential)
                    {
                        builder.OpenElement(3, "i");
                        builder.AddAttribute(4, "class", "fas fa-lock text-warning ms-1");
                        builder.AddAttribute(5, "title", "Confidential");
                        builder.CloseElement();
                    }
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<ClinicalNoteDto>
            {
                Property = nameof(ClinicalNoteDto.PatientName),
                Title = "Patient",
                Width = "150px",
                Template = note => builder =>
                {
                    builder.OpenElement(0, "div");
                    builder.OpenElement(1, "strong");
                    builder.AddContent(2, note.PatientName);
                    builder.CloseElement();
                    builder.OpenElement(3, "br");
                    builder.CloseElement();
                    builder.OpenElement(4, "small");
                    builder.AddAttribute(5, "class", "text-muted");
                    builder.AddContent(6, $"ID: {note.PatientId}");
                    builder.CloseElement();
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<ClinicalNoteDto>
            {
                Property = nameof(ClinicalNoteDto.NoteType),
                Title = "Type",
                Width = "120px",
                Template = note => builder =>
                {
                    var noteTypeClass = GetNoteTypeClass(note.NoteType);
                    // Debug: Log if follow-up is showing wrong color
                    if (note.NoteType?.ToLower().Contains("follow") == true && noteTypeClass == "bg-danger")
                    {
                        System.Diagnostics.Debug.WriteLine($"WARNING: Follow-up note type '{note.NoteType}' is getting red color!");
                    }
                    builder.OpenElement(0, "span");
                    builder.AddAttribute(1, "class", $"badge {noteTypeClass}");
                    builder.AddContent(2, note.NoteType);
                    builder.CloseElement();
                }
            },
            new SMDataGridBadgeColumn<ClinicalNoteDto>
            {
                Property = nameof(ClinicalNoteDto.IsIgnoredByDoctor),
                Title = "AI Status",
                Width = "120px",
                TextAlign = TextAlign.Center,
                GetBadgeData = (note) => note.IsIgnoredByDoctor 
                    ? ("ðŸš« Ignored", NotificationSeverity.Warning, true)
                    : ("âœ… Active", NotificationSeverity.Success, true)
            },
            new SMDataGridTemplateColumn<ClinicalNoteDto>
            {
                Property = nameof(ClinicalNoteDto.Priority),
                Title = "Priority",
                Width = "120px",
                Template = note => builder =>
                {
                    builder.OpenElement(0, "span");
                    builder.AddAttribute(1, "class", $"badge {GetPriorityClass(note.Priority)}");
                    builder.AddContent(2, note.Priority);
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<ClinicalNoteDto>
            {
                Property = nameof(ClinicalNoteDto.CreatedAt),
                Title = "Created",
                Width = "120px",
                Template = note => builder =>
                {
                    builder.AddContent(0, note.CreatedAt.ToString("MMM dd, yyyy"));
                    builder.OpenElement(1, "br");
                    builder.CloseElement();
                    builder.OpenElement(2, "small");
                    builder.AddAttribute(3, "class", "text-muted");
                    builder.AddContent(4, note.CreatedAt.ToString("HH:mm"));
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<ClinicalNoteDto>
            {
                Property = nameof(ClinicalNoteDto.DoctorName),
                Title = "Doctor",
                Width = "150px",
                Template = note => builder =>
                {
                    builder.OpenElement(0, "div");
                    builder.OpenElement(1, "strong");
                    builder.AddContent(2, note.DoctorName);
                    builder.CloseElement();
                    builder.OpenElement(3, "br");
                    builder.CloseElement();
                    builder.OpenElement(4, "small");
                    builder.AddAttribute(5, "class", "text-muted");
                    builder.AddContent(6, $"ID: {note.DoctorId}");
                    builder.CloseElement();
                    builder.CloseElement();
                }
            }
        };
    }

    private void InitializeActions()
    {
        _actions.Add(new SMDataGridActionButton<ClinicalNoteDto>
        {
            Icon = "visibility",
            ButtonStyle = ButtonStyle.Info,
            Variant = Variant.Flat,
            Size = ButtonSize.Small,
            Tooltip = "View clinical note details",
            OnClick = async (row, ct) => await ViewNoteAsync(row, ct)
        });

        _actions.Add(new SMDataGridActionButton<ClinicalNoteDto>
        {
            Icon = "edit",
            ButtonStyle = ButtonStyle.Success,
            Variant = Variant.Flat,
            Size = ButtonSize.Small,
            Tooltip = "Edit clinical note",
            OnClick = async (row, ct) => await EditNoteAsync(row, ct)
        });

        // Add ignore/unignore button for doctors
        if (AuthService.CurrentUser?.RoleId == 2) // Doctor
        {
            _actions.Add(new SMDataGridActionButton<ClinicalNoteDto>
            {
                IconFunc = (note) => note.IsIgnoredByDoctor ? "undo" : "block", // Use "undo" for unignore (distinct from "visibility" used for view)
                ButtonStyleFunc = (note) => note.IsIgnoredByDoctor ? ButtonStyle.Info : ButtonStyle.Warning,
                Variant = Variant.Flat,
                Size = ButtonSize.Small,
                TooltipFunc = (note) => note.IsIgnoredByDoctor 
                    ? $"Unignore for AI analysis (Ignored on: {note.IgnoredAt?.ToString("MM/dd/yyyy HH:mm") ?? "Unknown"})" 
                    : "Ignore for AI analysis - This will exclude this note from AI health check",
                OnClick = async (row, ct) => await ToggleIgnoreNoteAsync(row, ct),
                Disabled = (note) => note.DoctorId != GetCurrentUserId() // Only allow ignoring own notes
            });
        }

        _actions.Add(new SMDataGridActionButton<ClinicalNoteDto>
        {
            Icon = "delete",
            ButtonStyle = ButtonStyle.Danger,
            Variant = Variant.Flat,
            Size = ButtonSize.Small,
            Tooltip = "Delete clinical note",
            OnClick = async (row, ct) => await DeleteNoteAsync(row, ct),
            // Only show delete button if user is admin OR if user is doctor and owns this note
            Visible = (note) => 
            {
                var currentUser = AuthService.CurrentUser;
                if (currentUser == null) return false;
                
                // Admins can see delete button for all notes
                if (currentUser.RoleId == Shared.Constants.Roles.Admin)
                    return true;
                
                // Doctors can only see delete button for their own notes
                if (currentUser.RoleId == Shared.Constants.Roles.Doctor)
                    return note.DoctorId == currentUser.Id;
                
                // Other roles cannot delete
                return false;
            }
        });
    }

    private async Task<IEnumerable<ClinicalNoteDto>> LoadClinicalNotesAsync(CancellationToken ct)
    {
        try
        {
            var notes = await ClinicalNotesService.ListAsync(null, null, ct);
            return notes;
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to load clinical notes: {ex.Message}");
            return new List<ClinicalNoteDto>();
        }
    }

    private async Task LoadPatients()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<List<User>>("api/admin/patients");
            patients = response ?? new();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", "Error loading patients:", ex.Message);
        }
    }

    private async Task LoadNoteTypes()
    {
        try
        {
            noteTypes = await ClinicalNotesService.GetNoteTypesAsync();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", "Error loading note types:", ex.Message);
        }
    }

    private async Task LoadPriorities()
    {
        try
        {
            priorities = await ClinicalNotesService.GetPrioritiesAsync();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", "Error loading priorities:", ex.Message);
        }
    }

    private async Task ShowAddNoteDialog()
    {
        editingNote = new ClinicalNoteDto { Id = 0 };
        noteForm = new CreateClinicalNoteRequest { PatientId = 0 };
        showPatientRequiredError = false;
        showNoteDialog = true;
        await InvokeAsync(StateHasChanged);
    }

    private async Task EditNoteAsync(ClinicalNoteDto note, CancellationToken ct)
    {
        editingNote = note;
        noteForm = new CreateClinicalNoteRequest
        {
            PatientId = note.PatientId,
            Title = note.Title,
            Content = note.Content,
            NoteType = note.NoteType,
            Priority = note.Priority,
            IsConfidential = note.IsConfidential,
            Tags = note.Tags
        };
        showNoteDialog = true;
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnRowExpand(ClinicalNoteDto note)
    {
        try
        {
            if (!expandedNotes.ContainsKey(note.Id))
            {
                var fullNote = await ClinicalNotesService.GetAsync(note.Id);
                if (fullNote != null)
                {
                    expandedNotes[note.Id] = fullNote;
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to load note details: {ex.Message}");
        }
    }

    private async Task ViewNoteAsync(ClinicalNoteDto note, CancellationToken ct)
    {
        try
        {
            var fullNote = await ClinicalNotesService.GetAsync(note.Id, ct);
            viewingNote = fullNote ?? note;
            showViewDialog = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to load note details: {ex.Message}");
        }
    }

    private async Task SaveNote()
    {
        try
        {
            // Validate required fields
            if (editingNote?.Id == 0)
            {
                // Validate patient is selected for new notes
                if (noteForm.PatientId <= 0)
                {
                    showPatientRequiredError = true;
                    NotificationService.ShowError("Please select a patient before saving the clinical note.");
                    StateHasChanged();
                    return;
                }

                // Validate other required fields
                if (string.IsNullOrWhiteSpace(noteForm.Title))
                {
                    NotificationService.ShowError("Please enter a title for the clinical note.");
                    return;
                }

                if (string.IsNullOrWhiteSpace(noteForm.Content))
                {
                    NotificationService.ShowError("Please enter content for the clinical note.");
                    return;
                }

                if (string.IsNullOrWhiteSpace(noteForm.NoteType))
                {
                    NotificationService.ShowError("Please select a note type.");
                    return;
                }

                if (string.IsNullOrWhiteSpace(noteForm.Priority))
                {
                    NotificationService.ShowError("Please select a priority.");
                    return;
                }

                showPatientRequiredError = false;
                
                // Create new note
                await ClinicalNotesService.CreateAsync(noteForm);
                showNoteDialog = false;
                if (_grid != null)
                {
                    await _grid.RefreshAsync();
                }
                NotificationService.ShowSuccess("Clinical note created successfully!");
            }
            else
            {
                // Validate required fields for updates
                if (string.IsNullOrWhiteSpace(noteForm.Title))
                {
                    NotificationService.ShowError("Please enter a title for the clinical note.");
                    return;
                }

                if (string.IsNullOrWhiteSpace(noteForm.Content))
                {
                    NotificationService.ShowError("Please enter content for the clinical note.");
                    return;
                }

                if (string.IsNullOrWhiteSpace(noteForm.NoteType))
                {
                    NotificationService.ShowError("Please select a note type.");
                    return;
                }

                if (string.IsNullOrWhiteSpace(noteForm.Priority))
                {
                    NotificationService.ShowError("Please select a priority.");
                    return;
                }

                // Update existing note
                var updateRequest = new UpdateClinicalNoteRequest
                {
                    Title = noteForm.Title,
                    Content = noteForm.Content,
                    NoteType = noteForm.NoteType,
                    Priority = noteForm.Priority,
                    IsConfidential = noteForm.IsConfidential,
                    Tags = noteForm.Tags
                };

                await ClinicalNotesService.UpdateAsync(editingNote!.Id, updateRequest);
                showNoteDialog = false;
                if (_grid != null)
                {
                    await _grid.RefreshAsync();
                }
                NotificationService.ShowSuccess("Clinical note updated successfully!");
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to save clinical note: {ex.Message}");
        }
    }

    private async Task CloseNoteDialog()
    {
        showNoteDialog = false;
        editingNote = null;
        noteForm = new CreateClinicalNoteRequest { PatientId = 0 };
        showPatientRequiredError = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task CloseViewDialog()
    {
        showViewDialog = false;
        viewingNote = null;
        await InvokeAsync(StateHasChanged);
    }

    private string GetNoteTypeClass(string noteType)
    {
        if (string.IsNullOrWhiteSpace(noteType))
            return "bg-primary";
            
        var normalized = noteType.ToLower().Trim();
        
        // Remove any special characters that might interfere (except hyphen)
        normalized = normalized.Replace("_", "-").Replace("  ", " ").Trim();
        
        // Explicitly check for follow-up variations FIRST (before emergency check)
        // This ensures follow-up always gets blue, even if it contains the word "emergency" somehow
        if (normalized.Contains("follow"))
        {
            if (normalized == "follow-up" || normalized == "followup" || normalized == "follow up" || 
                normalized.StartsWith("follow-up") || normalized.StartsWith("followup") || normalized.StartsWith("follow up"))
            {
                return "bg-info";  // Blue for follow-up (using bg-info instead of bg-primary to ensure it's blue)
            }
        }
        
        // Explicitly check for emergency (most critical)
        if (normalized == "emergency" || normalized.StartsWith("emergency"))
            return "bg-danger";  // Red
        
        // Check other types
        return normalized switch
        {
            "treatment" => "bg-info",        // Blue for treatment
            "assessment" => "bg-warning",    // Yellow/orange for assessment
            "general" => "bg-success",       // Green for general (normal)
            _ => "bg-info"                   // Default to blue (info) for unknown types
        };
    }

    private string GetPriorityClass(string priority)
    {
        return priority.ToLower() switch
        {
            "low" => "bg-secondary",        // Gray for low
            "normal" => "bg-success",        // Green for normal (changed from bg-primary)
            "high" => "bg-warning",          // Yellow/orange for high
            "critical" => "bg-danger",       // Red for critical
            _ => "bg-secondary"              // Gray for unknown
        };
    }

    private async Task DeleteNoteAsync(ClinicalNoteDto note, CancellationToken ct)
    {
        var confirmed = await JSRuntime.ConfirmDestructiveAsync(
            "delete this clinical note",
            $"Note: {note.Title}\nPatient: {note.PatientName}",
            "clinical note");
        
        if (confirmed)
        {
            try
            {
                await ClinicalNotesService.DeleteAsync(note.Id, ct);
                if (_grid != null)
                {
                    await _grid.RefreshAsync();
                }
                NotificationService.ShowSuccess("Clinical note deleted successfully!");
            }
            catch (Exception ex)
            {
                NotificationService.ShowError($"Failed to delete clinical note: {ex.Message}");
            }
        }
    }

    private int GetCurrentUserId()
    {
        return AuthService.CurrentUser?.Id ?? 0;
    }

    private async Task ToggleIgnoreNoteAsync(ClinicalNoteDto note, CancellationToken ct)
    {
        try
        {
            var wasIgnored = note.IsIgnoredByDoctor;
            var isIgnored = await ClinicalNotesService.ToggleIgnoreAsync(note.Id, ct);
            
            // Update the note in the grid
            note.IsIgnoredByDoctor = isIgnored;
            note.IgnoredByDoctorId = isIgnored ? GetCurrentUserId() : null;
            note.IgnoredAt = isIgnored ? DateTime.UtcNow : null;
            
            NotificationService.ShowSuccess(isIgnored 
                ? "Clinical note ignored. It will be excluded from AI health check analysis." 
                : "Clinical note unignored. It will be included in AI health check analysis.");
            
            if (_grid != null)
            {
                await _grid.RefreshAsync();
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to toggle ignore status: {ex.Message}");
        }
    }
}

<style>
    .form-group {
        margin-bottom: 20px;
    }

    .form-row {
        display: flex;
        gap: 20px;
    }

    .form-row .form-group {
        flex: 1;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
    }

    .required-asterisk {
        color: #dc3545;
    }

    .note-details {
        max-width: 100%;
    }

    .note-meta {
        margin-bottom: 20px;
    }

    .meta-row {
        display: flex;
        margin-bottom: 10px;
    }

    .meta-label {
        font-weight: 500;
        color: #666;
        min-width: 80px;
    }

    .meta-value {
        color: #333;
        margin-left: 10px;
    }

    .note-content h5 {
        margin-bottom: 10px;
        color: #333;
    }

    .content-text {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        border-left: 4px solid #007bff;
        white-space: pre-wrap;
        word-wrap: break-word;
        line-height: 1.6;
        font-size: 0.95em;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .note-details h4 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #2c3e50;
        font-size: 1.3em;
    }

    .note-details h5 {
        margin-top: 15px;
        margin-bottom: 10px;
        color: #2c3e50;
        font-size: 1.1em;
    }

    .note-content-full {
        margin-top: 20px;
    }

    .note-content-full h6 {
        margin-bottom: 10px;
        color: #2c3e50;
        font-size: 1.1em;
    }
</style>
