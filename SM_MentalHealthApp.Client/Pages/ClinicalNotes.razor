@page "/clinical-notes"
@using SM_MentalHealthApp.Shared
@using SM_MentalHealthApp.Client.Services
@using SM_MentalHealthApp.Client.Components.Grid
@using SM_MentalHealthApp.Client.Components.Common
@using SM_MentalHealthApp.Client.Helpers
@using Radzen
@using Radzen.Blazor
@inject IClinicalNotesService ClinicalNotesService
@inject IAuthService AuthService
@inject IJSRuntime JSRuntime
@inject NotificationService NotificationService
@inject HttpClient Http

<PageTitle>Clinical Notes</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <SMPageHeader Title="Clinical Notes" 
                         Icon="fas fa-stethoscope">
                <ActionButton>
                    <RadzenButton Icon="add" Text="Add Note" ButtonStyle="ButtonStyle.Success"
                        Click="@(() => ShowAddNoteDialog())" />
                </ActionButton>
            </SMPageHeader>

            <SMDataGrid TItem="ClinicalNoteDto" 
                       Columns="_columns" 
                       Actions="_actions" 
                       ActionsWidth="150px"
                       LoadItems="LoadClinicalNotesAsync" 
                       @ref="_grid" 
                       PageSize="10"
                       OnRowExpandCallback="@OnRowExpand">
                <ExpansionTemplate Context="note">
                    @{
                        var expandedNote = expandedNotes.ContainsKey(note.Id) ? expandedNotes[note.Id] : note;
                    }
                    <div class="p-3">
                        <div class="row">
                            <div class="col-12">
                                <h6>Clinical Note Details</h6>
                                <div class="note-meta mb-3">
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Patient:</strong></span>
                                        <span class="meta-value">@expandedNote.PatientName (ID: @expandedNote.PatientId)</span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Doctor:</strong></span>
                                        <span class="meta-value">@expandedNote.DoctorName (ID: @expandedNote.DoctorId)</span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Type:</strong></span>
                                        <span class="meta-value">
                                            <span class="badge bg-primary">@expandedNote.NoteType</span>
                                        </span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Priority:</strong></span>
                                        <span class="meta-value">
                                            <span class="badge @GetPriorityClass(expandedNote.Priority)">@expandedNote.Priority</span>
                                        </span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label"><strong>Created:</strong></span>
                                        <span class="meta-value">@expandedNote.CreatedAt.ToString("MMM dd, yyyy HH:mm")</span>
                                    </div>
                                    @if (expandedNote.UpdatedAt.HasValue)
                                    {
                                        <div class="meta-row">
                                            <span class="meta-label"><strong>Updated:</strong></span>
                                            <span class="meta-value">@expandedNote.UpdatedAt.Value.ToString("MMM dd, yyyy HH:mm")</span>
                                        </div>
                                    }
                                    @if (expandedNote.IsConfidential)
                                    {
                                        <div class="meta-row">
                                            <span class="meta-label"><strong>Status:</strong></span>
                                            <span class="meta-value">
                                                <i class="fas fa-lock text-warning"></i> Confidential
                                            </span>
                                        </div>
                                    }
                                    @if (!string.IsNullOrEmpty(expandedNote.Tags))
                                    {
                                        <div class="meta-row">
                                            <span class="meta-label"><strong>Tags:</strong></span>
                                            <span class="meta-value">@expandedNote.Tags</span>
                                        </div>
                                    }
                                </div>
                                
                                <div class="note-content-full">
                                    <h6>Full Content:</h6>
                                    <div class="content-text">@expandedNote.Content</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </ExpansionTemplate>
            </SMDataGrid>
        </div>
    </div>
</div>

<!-- Add/Edit Note Dialog -->
@if (showNoteDialog)
{
    <div class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>@(editingNote?.Id == 0 ? "Add Clinical Note" : "Edit Clinical Note")</h3>
                <button @onclick="CloseNoteDialog" class="close-btn">✕</button>
            </div>

            <div class="modal-body">
                <form @onsubmit="@SaveNote" @onsubmit:preventDefault="true">
                    <div class="form-group">
                        <label class="form-label">Patient: <span class="required-asterisk">*</span></label>
                        <RadzenDropDown @bind-Value="noteForm.PatientId" Data="@patients" TextProperty="FullName"
                            ValueProperty="Id" Placeholder="Select Patient" Style="width: 100%;" />
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Note Type: <span class="required-asterisk">*</span></label>
                            <RadzenDropDown @bind-Value="noteForm.NoteType" Data="@noteTypes" Placeholder="Note Type"
                                Style="width: 100%;" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Priority: <span class="required-asterisk">*</span></label>
                            <RadzenDropDown @bind-Value="noteForm.Priority" Data="@priorities" Placeholder="Priority"
                                Style="width: 100%;" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Title: <span class="required-asterisk">*</span></label>
                        <RadzenTextBox @bind-Value="noteForm.Title" Placeholder="Note Title" Style="width: 100%;" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">Content: <span class="required-asterisk">*</span></label>
                        <RadzenTextArea @bind-Value="noteForm.Content" Placeholder="Note Content"
                            Style="width: 100%; min-height: 200px;" />
                    </div>

                    <div class="form-group">
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem">
                            <RadzenCheckBox @bind-Value="noteForm.IsConfidential" Name="IsConfidential" />
                            <RadzenText Text="Confidential" />
                        </RadzenStack>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Tags:</label>
                        <RadzenTextBox @bind-Value="noteForm.Tags" Placeholder="Tags (comma-separated)"
                            Style="width: 100%;" />
                    </div>

                    <div class="form-actions">
                        <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@CloseNoteDialog" />
                        <RadzenButton Text="Save" ButtonStyle="ButtonStyle.Success" ButtonType="ButtonType.Submit"
                            Click="@SaveNote" />
                    </div>
                </form>
            </div>
        </div>
    </div>
}

<!-- View Note Dialog -->
@if (showViewDialog)
{
    <div class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Clinical Note Details</h3>
                <button @onclick="CloseViewDialog" class="close-btn">✕</button>
            </div>

            <div class="modal-body">
                @if (viewingNote != null)
                {
                    <div class="note-details">
                        <h4>@viewingNote.Title</h4>
                        <div class="note-meta">
                            <div class="meta-row">
                                <span class="meta-label">Patient:</span>
                                <span class="meta-value">@viewingNote.PatientName</span>
                            </div>
                            <div class="meta-row">
                                <span class="meta-label">Doctor:</span>
                                <span class="meta-value">@viewingNote.DoctorName</span>
                            </div>
                            <div class="meta-row">
                                <span class="meta-label">Type:</span>
                                <span class="meta-value">@viewingNote.NoteType</span>
                            </div>
                            <div class="meta-row">
                                <span class="meta-label">Priority:</span>
                                <span class="meta-value">@viewingNote.Priority</span>
                            </div>
                            <div class="meta-row">
                                <span class="meta-label">Created:</span>
                                <span class="meta-value">@viewingNote.CreatedAt.ToString("MMM dd, yyyy HH:mm")</span>
                            </div>
                            @if (viewingNote.UpdatedAt.HasValue)
                            {
                                <div class="meta-row">
                                    <span class="meta-label">Updated:</span>
                                    <span class="meta-value">@viewingNote.UpdatedAt.Value.ToString("MMM dd, yyyy HH:mm")</span>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(viewingNote.Tags))
                            {
                                <div class="meta-row">
                                    <span class="meta-label">Tags:</span>
                                    <span class="meta-value">@viewingNote.Tags</span>
                                </div>
                            }
                        </div>
                        <div class="note-content">
                            <h5>Content:</h5>
                            <div class="content-text">@viewingNote.Content</div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    private SMDataGrid<ClinicalNoteDto>? _grid;
    private List<User> patients = new();
    private List<string> noteTypes = new();
    private List<string> priorities = new();

    private bool showNoteDialog = false;
    private bool showViewDialog = false;
    private ClinicalNoteDto? editingNote;
    private ClinicalNoteDto? viewingNote;
    private CreateClinicalNoteRequest noteForm = new();

    private List<SMDataGridColumn<ClinicalNoteDto>> _columns = new();
    private List<SMDataGridActionButton<ClinicalNoteDto>> _actions = new();
    private Dictionary<int, ClinicalNoteDto> expandedNotes = new Dictionary<int, ClinicalNoteDto>();

    protected override async Task OnInitializedAsync()
    {
        await LoadPatients();
        await LoadNoteTypes();
        await LoadPriorities();

        InitializeColumns();
        InitializeActions();
    }

    private void InitializeColumns()
    {
        _columns = new List<SMDataGridColumn<ClinicalNoteDto>>
        {
            new SMDataGridTemplateColumn<ClinicalNoteDto>
            {
                Property = nameof(ClinicalNoteDto.Title),
                Title = "Title",
                Width = "200px",
                Template = note => builder =>
                {
                    builder.OpenElement(0, "div");
                    builder.OpenElement(1, "strong");
                    builder.AddContent(2, note.Title);
                    builder.CloseElement();
                    if (note.IsConfidential)
                    {
                        builder.OpenElement(3, "i");
                        builder.AddAttribute(4, "class", "fas fa-lock text-warning ms-1");
                        builder.AddAttribute(5, "title", "Confidential");
                        builder.CloseElement();
                    }
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<ClinicalNoteDto>
            {
                Property = nameof(ClinicalNoteDto.PatientName),
                Title = "Patient",
                Width = "150px",
                Template = note => builder =>
                {
                    builder.OpenElement(0, "div");
                    builder.OpenElement(1, "strong");
                    builder.AddContent(2, note.PatientName);
                    builder.CloseElement();
                    builder.OpenElement(3, "br");
                    builder.CloseElement();
                    builder.OpenElement(4, "small");
                    builder.AddAttribute(5, "class", "text-muted");
                    builder.AddContent(6, $"ID: {note.PatientId}");
                    builder.CloseElement();
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<ClinicalNoteDto>
            {
                Property = nameof(ClinicalNoteDto.Content),
                Title = "Content",
                Width = "300px",
                Template = note => builder =>
                {
                    builder.OpenElement(0, "div");
                    builder.AddAttribute(1, "class", "note-content");
                    var content = note.Content.Length > 100 ? note.Content.Substring(0, 100) + "..." : note.Content;
                    builder.AddContent(2, content);
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<ClinicalNoteDto>
            {
                Property = nameof(ClinicalNoteDto.NoteType),
                Title = "Type",
                Width = "120px",
                Template = note => builder =>
                {
                    builder.OpenElement(0, "span");
                    builder.AddAttribute(1, "class", "badge bg-primary");
                    builder.AddContent(2, note.NoteType);
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<ClinicalNoteDto>
            {
                Property = nameof(ClinicalNoteDto.Priority),
                Title = "Priority",
                Width = "120px",
                Template = note => builder =>
                {
                    builder.OpenElement(0, "span");
                    builder.AddAttribute(1, "class", $"badge {GetPriorityClass(note.Priority)}");
                    builder.AddContent(2, note.Priority);
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<ClinicalNoteDto>
            {
                Property = nameof(ClinicalNoteDto.CreatedAt),
                Title = "Created",
                Width = "120px",
                Template = note => builder =>
                {
                    builder.AddContent(0, note.CreatedAt.ToString("MMM dd, yyyy"));
                    builder.OpenElement(1, "br");
                    builder.CloseElement();
                    builder.OpenElement(2, "small");
                    builder.AddAttribute(3, "class", "text-muted");
                    builder.AddContent(4, note.CreatedAt.ToString("HH:mm"));
                    builder.CloseElement();
                }
            },
            new SMDataGridTemplateColumn<ClinicalNoteDto>
            {
                Property = nameof(ClinicalNoteDto.DoctorName),
                Title = "Doctor",
                Width = "150px",
                Template = note => builder =>
                {
                    builder.OpenElement(0, "div");
                    builder.OpenElement(1, "strong");
                    builder.AddContent(2, note.DoctorName);
                    builder.CloseElement();
                    builder.OpenElement(3, "br");
                    builder.CloseElement();
                    builder.OpenElement(4, "small");
                    builder.AddAttribute(5, "class", "text-muted");
                    builder.AddContent(6, $"ID: {note.DoctorId}");
                    builder.CloseElement();
                    builder.CloseElement();
                }
            }
        };
    }

    private void InitializeActions()
    {
        _actions.Add(new SMDataGridActionButton<ClinicalNoteDto>
        {
            Icon = "visibility",
            ButtonStyle = ButtonStyle.Info,
            Variant = Variant.Flat,
            Size = ButtonSize.Small,
            OnClick = async (row, ct) => await ViewNoteAsync(row, ct)
        });

        _actions.Add(new SMDataGridActionButton<ClinicalNoteDto>
        {
            Icon = "edit",
            ButtonStyle = ButtonStyle.Success,
            Variant = Variant.Flat,
            Size = ButtonSize.Small,
            OnClick = async (row, ct) => await EditNoteAsync(row, ct)
        });

        _actions.Add(new SMDataGridActionButton<ClinicalNoteDto>
        {
            Icon = "delete",
            ButtonStyle = ButtonStyle.Danger,
            Variant = Variant.Flat,
            Size = ButtonSize.Small,
            OnClick = async (row, ct) => await DeleteNoteAsync(row, ct)
        });
    }

    private async Task<IEnumerable<ClinicalNoteDto>> LoadClinicalNotesAsync(CancellationToken ct)
    {
        try
        {
            var notes = await ClinicalNotesService.ListAsync(null, null, ct);
            return notes;
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to load clinical notes: {ex.Message}");
            return new List<ClinicalNoteDto>();
        }
    }

    private async Task LoadPatients()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<List<User>>("api/admin/patients");
            patients = response ?? new();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", "Error loading patients:", ex.Message);
        }
    }

    private async Task LoadNoteTypes()
    {
        try
        {
            noteTypes = await ClinicalNotesService.GetNoteTypesAsync();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", "Error loading note types:", ex.Message);
        }
    }

    private async Task LoadPriorities()
    {
        try
        {
            priorities = await ClinicalNotesService.GetPrioritiesAsync();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", "Error loading priorities:", ex.Message);
        }
    }

    private void ShowAddNoteDialog()
    {
        editingNote = new ClinicalNoteDto { Id = 0 };
        noteForm = new CreateClinicalNoteRequest();
        showNoteDialog = true;
    }

    private async Task EditNoteAsync(ClinicalNoteDto note, CancellationToken ct)
    {
        editingNote = note;
        noteForm = new CreateClinicalNoteRequest
        {
            PatientId = note.PatientId,
            Title = note.Title,
            Content = note.Content,
            NoteType = note.NoteType,
            Priority = note.Priority,
            IsConfidential = note.IsConfidential,
            Tags = note.Tags
        };
        showNoteDialog = true;
    }

    private async Task OnRowExpand(ClinicalNoteDto note)
    {
        try
        {
            if (!expandedNotes.ContainsKey(note.Id))
            {
                var fullNote = await ClinicalNotesService.GetAsync(note.Id);
                if (fullNote != null)
                {
                    expandedNotes[note.Id] = fullNote;
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to load note details: {ex.Message}");
        }
    }

    private async Task ViewNoteAsync(ClinicalNoteDto note, CancellationToken ct)
    {
        try
        {
            var fullNote = await ClinicalNotesService.GetAsync(note.Id, ct);
            viewingNote = fullNote ?? note;
            showViewDialog = true;
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to load note details: {ex.Message}");
        }
    }

    private async Task SaveNote()
    {
        try
        {
            if (editingNote?.Id == 0)
            {
                // Create new note
                await ClinicalNotesService.CreateAsync(noteForm);
                showNoteDialog = false;
                if (_grid != null)
                {
                    await _grid.RefreshAsync();
                }
                NotificationService.ShowSuccess("Clinical note created successfully!");
            }
            else
            {
                // Update existing note
                var updateRequest = new UpdateClinicalNoteRequest
                {
                    Title = noteForm.Title,
                    Content = noteForm.Content,
                    NoteType = noteForm.NoteType,
                    Priority = noteForm.Priority,
                    IsConfidential = noteForm.IsConfidential,
                    Tags = noteForm.Tags
                };

                await ClinicalNotesService.UpdateAsync(editingNote!.Id, updateRequest);
                showNoteDialog = false;
                if (_grid != null)
                {
                    await _grid.RefreshAsync();
                }
                NotificationService.ShowSuccess("Clinical note updated successfully!");
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to save clinical note: {ex.Message}");
        }
    }

    private void CloseNoteDialog()
    {
        showNoteDialog = false;
        editingNote = null;
        noteForm = new CreateClinicalNoteRequest();
    }

    private void CloseViewDialog()
    {
        showViewDialog = false;
        viewingNote = null;
    }

    private string GetPriorityClass(string priority)
    {
        return priority.ToLower() switch
        {
            "low" => "bg-secondary",
            "normal" => "bg-primary",
            "high" => "bg-warning",
            "critical" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private async Task DeleteNoteAsync(ClinicalNoteDto note, CancellationToken ct)
    {
        var confirmed = await JSRuntime.ConfirmDestructiveAsync(
            "delete this clinical note",
            $"Note: {note.Title}\nPatient: {note.PatientName}",
            "clinical note");
        
        if (confirmed)
        {
            try
            {
                await ClinicalNotesService.DeleteAsync(note.Id, ct);
                if (_grid != null)
                {
                    await _grid.RefreshAsync();
                }
                NotificationService.ShowSuccess("Clinical note deleted successfully!");
            }
            catch (Exception ex)
            {
                NotificationService.ShowError($"Failed to delete clinical note: {ex.Message}");
            }
        }
    }
}

<style>
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        max-width: 900px;
        width: 95%;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .modal-content>.modal-header {
        flex-shrink: 0;
    }

    .modal-content>.modal-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        min-height: 0;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        flex-shrink: 0;
    }

    .modal-header h3 {
        margin: 0;
        color: #333;
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #666;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .close-btn:hover {
        color: #333;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-row {
        display: flex;
        gap: 20px;
    }

    .form-row .form-group {
        flex: 1;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
    }

    .required-asterisk {
        color: #dc3545;
    }

    .form-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e0e0e0;
    }

    .note-details {
        max-width: 100%;
    }

    .note-meta {
        margin-bottom: 20px;
    }

    .meta-row {
        display: flex;
        margin-bottom: 10px;
    }

    .meta-label {
        font-weight: 500;
        color: #666;
        min-width: 80px;
    }

    .meta-value {
        color: #333;
        margin-left: 10px;
    }

    .note-content h5 {
        margin-bottom: 10px;
        color: #333;
    }

    .content-text {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        border-left: 4px solid #007bff;
        white-space: pre-wrap;
        word-wrap: break-word;
        line-height: 1.6;
        font-size: 0.95em;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .note-details h4 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #2c3e50;
        font-size: 1.3em;
    }

    .note-details h5 {
        margin-top: 15px;
        margin-bottom: 10px;
        color: #2c3e50;
        font-size: 1.1em;
    }

    .note-content-full {
        margin-top: 20px;
    }

    .note-content-full h6 {
        margin-bottom: 10px;
        color: #2c3e50;
        font-size: 1.1em;
    }
</style>
