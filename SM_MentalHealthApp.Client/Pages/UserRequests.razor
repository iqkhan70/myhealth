@page "/user-requests"
@inject HttpClient Http
@inject NotificationService NotificationService
@inject IAuthService AuthService
@inject IJSRuntime JSRuntime
@using SM_MentalHealthApp.Shared
@using SM_MentalHealthApp.Client.Services
@using SM_MentalHealthApp.Client.Components.Common
@using System.Net.Http
@implements IDisposable

<div class="user-requests-page">
    <div class="user-requests-header">
        @if (AuthService.CurrentUser?.RoleId == 3 || AuthService.CurrentUser?.RoleId == 4) // Admin or Coordinator
        {
            <h2>User Registration Requests</h2>
            <p>Review and manage guest registration requests</p>
        }
        else
        {
            <h2>Access Denied</h2>
            <p>You don't have permission to view this page.</p>
        }
    </div>

    @if (AuthService.CurrentUser?.RoleId == 3 || AuthService.CurrentUser?.RoleId == 4) // Admin or Coordinator
    {
        <!-- Controls -->
        <div class="controls-section mb-4">
            <div class="filters-section">
                <RadzenDropDown Data="@statusFilterOptions" TextProperty="Text" ValueProperty="Value"
                    @bind-Value="selectedStatusFilter" Placeholder="All Statuses"
                    Style="width: 200px" />
                <RadzenButton Text="Clear Filters" ButtonStyle="ButtonStyle.Light" Click="@ClearFilters" />
            </div>
            <div class="refresh-controls">
                <RadzenButton Text="ðŸ”„ Refresh" Icon="refresh" ButtonStyle="ButtonStyle.Light" 
                    Click="@RefreshRequests" Disabled="@isLoading" />
                <div class="auto-refresh-indicator">
                    <span class="refresh-icon">âš¡</span>
                    <span>Auto-refresh every 30s</span>
                </div>
            </div>
        </div>

        <!-- Requests Grid -->
        <div class="requests-content">
            @if (isLoading)
            {
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>Loading requests...</p>
                </div>
            }
            else
            {
                <RadzenDataGrid Data="@GetFilteredRequests()" 
                               TItem="UserRequest" 
                               AllowPaging="true" 
                               PageSize="20"
                               AllowSorting="true" 
                               ShowPagingSummary="true"
                               EmptyText="No user requests found"
                               AllowFiltering="true"
                               FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                               ShowFilterRow="true"
                               RowExpand="@(async (UserRequest request) => await OnRowExpand(request))"
                               @ref="dataGrid">
                    <Columns>
                        <RadzenDataGridColumn TItem="UserRequest" Property="RequestedAt" Title="Requested" Width="150px" Filterable="true">
                            <Template Context="request">
                                @request.RequestedAt.ToString("MM/dd/yyyy HH:mm")
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="UserRequest" Property="FirstName" Title="Name" Width="200px" Filterable="true">
                            <Template Context="request">
                                <strong>@request.FullName</strong>
                                <br />
                                <small class="text-muted">@request.Email</small>
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="UserRequest" Property="MobilePhone" Title="Phone" Width="150px" Filterable="true" />
                        <RadzenDataGridColumn TItem="UserRequest" Property="DateOfBirth" Title="Date of Birth" Width="120px" Filterable="true">
                            <Template Context="request">
                                @request.DateOfBirth.ToString("MM/dd/yyyy")
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="UserRequest" Property="Gender" Title="Gender" Width="100px" Filterable="true" />
                        <RadzenDataGridColumn TItem="UserRequest" Property="Reason" Title="Reason" Width="250px" Filterable="true">
                            <Template Context="request">
                                <div style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="@request.Reason">
                                    @(request.Reason.Length > 50 ? request.Reason.Substring(0, 50) + "..." : request.Reason)
                                </div>
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="UserRequest" Property="Status" Title="Status" Width="120px" Filterable="true">
                            <Template Context="request">
                                <span class="badge @GetStatusBadgeClass(request.Status)">
                                    @GetStatusText(request.Status)
                                </span>
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="UserRequest" Property="ReviewedByUser" Title="Reviewed By" Width="150px" Filterable="true">
                            <Template Context="request">
                                @if (request.ReviewedByUser != null)
                                {
                                    <div>
                                        <small>@request.ReviewedByUser.FullName</small>
                                        <br />
                                        <small class="text-muted">@(request.ReviewedAt?.ToString("MM/dd/yyyy") ?? "")</small>
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted">Not reviewed</span>
                                }
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="UserRequest" Title="Actions" Width="200px" Sortable="false" Filterable="false">
                            <Template Context="request">
                                <div class="action-buttons">
                                    <RadzenButton Icon="check" ButtonStyle="ButtonStyle.Success" 
                                                Variant="Variant.Flat" Size="ButtonSize.Small"
                                                Click="@(() => ShowApproveDialog(request))" 
                                                Title="Approve" />
                                    <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Danger" 
                                                Variant="Variant.Flat" Size="ButtonSize.Small"
                                                Click="@(() => ShowRejectDialog(request))" 
                                                Title="Reject"
                                                Disabled="@(request.Status == UserRequestStatus.Rejected)" />
                                    <RadzenButton Icon="schedule" ButtonStyle="ButtonStyle.Info" 
                                                Variant="Variant.Flat" Size="ButtonSize.Small"
                                                Click="@(() => ShowPendingDialog(request))" 
                                                Title="Mark Pending" />
                                    <RadzenButton Icon="info" ButtonStyle="ButtonStyle.Light" 
                                                Variant="Variant.Flat" Size="ButtonSize.Small"
                                                Click="@(() => ShowDetailsDialog(request))" 
                                                Title="View Details" />
                                </div>
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                    <Template Context="request">
                        @if (expandedRequests.ContainsKey(request.Id))
                        {
                            var expandedRequest = expandedRequests[request.Id];
                            <div class="p-4" style="background-color: #f8f9fa; border-top: 2px solid #dee2e6;">
                                <h6 class="mb-3">Accident Information</h6>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label"><strong>Age:</strong></label>
                                        <div>@(expandedRequest.Age?.ToString() ?? "Not provided")</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label"><strong>Race:</strong></label>
                                        <div>@(expandedRequest.Race ?? "Not provided")</div>
                                    </div>
                                    <div class="col-md-12 mb-3">
                                        <label class="form-label"><strong>Accident Address:</strong></label>
                                        <div>@(expandedRequest.AccidentAddress ?? "Not provided")</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label"><strong>Accident Date:</strong></label>
                                        <div>@(expandedRequest.AccidentDate?.ToString("MM/dd/yyyy") ?? "Not provided")</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label"><strong>Date Reported:</strong></label>
                                        <div>@(expandedRequest.DateReported?.ToString("MM/dd/yyyy") ?? "Not provided")</div>
                                    </div>
                                    <div class="col-md-12 mb-3">
                                        <label class="form-label"><strong>Vehicle Details:</strong></label>
                                        <div>@(expandedRequest.VehicleDetails ?? "Not provided")</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label"><strong>Police Case Number:</strong></label>
                                        <div>@(expandedRequest.PoliceCaseNumber ?? "Not provided")</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label"><strong>Road Conditions:</strong></label>
                                        <div>@(expandedRequest.RoadConditions ?? "Not provided")</div>
                                    </div>
                                    <div class="col-md-12 mb-3">
                                        <label class="form-label"><strong>Accident Details:</strong></label>
                                        <div style="white-space: pre-wrap;">@(expandedRequest.AccidentDetails ?? "Not provided")</div>
                                    </div>
                                    <div class="col-md-12 mb-3">
                                        <label class="form-label"><strong>Doctor's Information:</strong></label>
                                        <div style="white-space: pre-wrap;">@(expandedRequest.DoctorsInformation ?? "Not provided")</div>
                                    </div>
                                    <div class="col-md-12 mb-3">
                                        <label class="form-label"><strong>Lawyer's Information:</strong></label>
                                        <div style="white-space: pre-wrap;">@(expandedRequest.LawyersInformation ?? "Not provided")</div>
                                    </div>
                                    <div class="col-md-12 mb-3">
                                        <label class="form-label"><strong>Additional Notes:</strong></label>
                                        <div style="white-space: pre-wrap;">@(expandedRequest.AdditionalNotes ?? "Not provided")</div>
                                    </div>
                                    @if (AuthService.CurrentUser?.RoleId == 3 || AuthService.CurrentUser?.RoleId == 4) // Admin or Coordinator can edit
                                    {
                                        <div class="col-12 mt-3">
                                            <RadzenButton Text="Edit Accident Information" 
                                                         ButtonStyle="ButtonStyle.Primary" 
                                                         Size="ButtonSize.Small"
                                                         Click="@(() => ShowEditAccidentInfoDialog(expandedRequest))" />
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </Template>
                </RadzenDataGrid>
            }
        </div>
    }
</div>

<!-- Approve Dialog -->
@if (showApproveDialog && selectedRequest != null)
{
    <SMModal IsVisible="@showApproveDialog" 
             Title="Approve User Request" 
             OnClose="@(() => { showApproveDialog = false; approveNotes = ""; })"
             Size="Medium">
        <Body>
            <p><strong>Approve request for:</strong> @selectedRequest.FullName</p>
            <p><strong>Email:</strong> @selectedRequest.Email</p>
            <p><strong>Phone:</strong> @selectedRequest.MobilePhone</p>
            <div class="reason-display">
                <p><strong>Reason for Request:</strong></p>
                <p class="reason-text-small">@selectedRequest.Reason</p>
            </div>
            <p class="text-muted">This will create a patient account and send both SMS and email with login credentials. Both notifications will be sent to ensure delivery. Use the reason above to assign an appropriate doctor.</p>
            
            <RadzenFormField Text="Notes (required, min 10 characters)" class="w-100">
                <textarea @bind="approveNotes" 
                         @bind:event="oninput"
                         class="rz-inputtext rz-textarea-input"
                         rows="4" 
                         placeholder="Enter notes explaining why this request is being approved..."
                         style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; font-size: 14px;"></textarea>
            </RadzenFormField>
            
            <div class="dialog-actions">
                <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@(() => { showApproveDialog = false; approveNotes = ""; })" />
                <RadzenButton Text="Approve" ButtonStyle="ButtonStyle.Success" 
                            Click="@ApproveRequest" 
                            Disabled="@(string.IsNullOrWhiteSpace(approveNotes) || approveNotes.Length < 10 || isProcessing)" />
            </div>
        </Body>
    </SMModal>
}

<!-- Reject Dialog -->
@if (showRejectDialog && selectedRequest != null)
{
    <SMModal IsVisible="@showRejectDialog" 
             Title="Reject User Request" 
             OnClose="@(() => { showRejectDialog = false; rejectNotes = ""; })"
             Size="Medium">
        <Body>
            <p><strong>Reject request for:</strong> @selectedRequest.FullName</p>
            <p><strong>Email:</strong> @selectedRequest.Email</p>
            <p><strong>Reason:</strong> @selectedRequest.Reason</p>
            <p class="text-warning">This will reject the request. No user account will be created and no notification will be sent.</p>
            
            <RadzenFormField Text="Rejection Notes (required, min 10 characters)" class="w-100">
                <textarea @bind="rejectNotes" 
                         @bind:event="oninput"
                         class="rz-inputtext rz-textarea-input"
                         rows="4" 
                         placeholder="Enter notes explaining why this request is being rejected..."
                         style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; font-size: 14px;"></textarea>
            </RadzenFormField>
            
            <div class="dialog-actions">
                <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@(() => { showRejectDialog = false; rejectNotes = ""; })" />
                <RadzenButton Text="Reject" ButtonStyle="ButtonStyle.Danger" 
                            Click="@RejectRequest" 
                            Disabled="@(string.IsNullOrWhiteSpace(rejectNotes) || rejectNotes.Length < 10 || isProcessing)" />
            </div>
        </Body>
    </SMModal>
}

<!-- Pending Dialog -->
@if (showPendingDialog && selectedRequest != null)
{
    <SMModal IsVisible="@showPendingDialog" 
             Title="Mark Request as Pending" 
             OnClose="@(() => { showPendingDialog = false; pendingNotes = ""; })"
             Size="Medium">
        <Body>
            <p><strong>Mark as pending:</strong> @selectedRequest.FullName</p>
            <p><strong>Email:</strong> @selectedRequest.Email</p>
            <p><strong>Reason:</strong> @selectedRequest.Reason</p>
            <p class="text-info">This will mark the request for further review. No action will be taken.</p>
            
            <RadzenFormField Text="Notes (required, min 10 characters)" class="w-100">
                <textarea @bind="pendingNotes" 
                         @bind:event="oninput"
                         class="rz-inputtext rz-textarea-input"
                         rows="4" 
                         placeholder="Enter notes for your reference..."
                         style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; font-size: 14px;"></textarea>
            </RadzenFormField>
            
            <div class="dialog-actions">
                <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@(() => { showPendingDialog = false; pendingNotes = ""; })" />
                <RadzenButton Text="Mark Pending" ButtonStyle="ButtonStyle.Info" 
                            Click="@MarkPendingRequest" 
                            Disabled="@(string.IsNullOrWhiteSpace(pendingNotes) || pendingNotes.Length < 10 || isProcessing)" />
            </div>
        </Body>
    </SMModal>
}

<!-- Details Dialog -->
@if (showDetailsDialog && selectedRequest != null)
{
    <SMModal IsVisible="@showDetailsDialog" 
             Title="Request Details" 
             OnClose="@(() => showDetailsDialog = false)"
             Size="Large">
        <Body>
            <div class="details-section">
                <h4>Personal Information</h4>
                <p><strong>Name:</strong> @selectedRequest.FullName</p>
                <p><strong>Email:</strong> @selectedRequest.Email</p>
                <p><strong>Phone:</strong> @selectedRequest.MobilePhone</p>
                <p><strong>Date of Birth:</strong> @selectedRequest.DateOfBirth.ToString("MM/dd/yyyy")</p>
                <p><strong>Gender:</strong> @selectedRequest.Gender</p>
            </div>
            
            <div class="details-section">
                <h4>Reason for Request</h4>
                <p class="reason-text">@selectedRequest.Reason</p>
            </div>
            
            <div class="details-section">
                <h4>Request Information</h4>
                <p><strong>Status:</strong> <span class="badge @GetStatusBadgeClass(selectedRequest.Status)">@GetStatusText(selectedRequest.Status)</span></p>
                <p><strong>Requested At:</strong> @selectedRequest.RequestedAt.ToString("MM/dd/yyyy HH:mm")</p>
                @if (selectedRequest.ReviewedByUser != null)
                {
                    <p><strong>Reviewed By:</strong> @selectedRequest.ReviewedByUser.FullName</p>
                    <p><strong>Reviewed At:</strong> @selectedRequest.ReviewedAt?.ToString("MM/dd/yyyy HH:mm")</p>
                }
            </div>
            
            @if (!string.IsNullOrEmpty(selectedRequest.Notes))
            {
                <div class="details-section">
                    <h4>Notes</h4>
                    <p class="notes-text">@selectedRequest.Notes</p>
                </div>
            }
            
            <div class="dialog-actions">
                <RadzenButton Text="Close" ButtonStyle="ButtonStyle.Light" Click="@(() => showDetailsDialog = false)" />
            </div>
        </Body>
    </SMModal>
}

<!-- Edit Accident Information Dialog -->
@if (showEditAccidentInfoDialog && selectedRequest != null)
{
    <SMModal IsVisible="@showEditAccidentInfoDialog" 
             Title="Edit Accident Information" 
             OnClose="@(() => { showEditAccidentInfoDialog = false; selectedRequest = null; })"
             Size="Large">
        <Body>
            <div class="dialog-content">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <RadzenFormField Text="Age" class="w-100">
                            <RadzenNumeric @bind-Value="editAge" Min="0" Max="150" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-6 mb-3">
                        <RadzenFormField Text="Race" class="w-100">
                            <RadzenTextBox @bind-Value="editRace" MaxLength="100" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-12 mb-3">
                        <RadzenFormField Text="Accident Address" class="w-100">
                            <RadzenTextArea @bind-Value="editAccidentAddress" MaxLength="500" Rows="2" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-6 mb-3">
                        <RadzenFormField Text="Accident Date" class="w-100">
                            <RadzenDatePicker @bind-Value="editAccidentDate" DateFormat="MM/dd/yyyy" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-6 mb-3">
                        <RadzenFormField Text="Date Reported" class="w-100">
                            <RadzenDatePicker @bind-Value="editDateReported" DateFormat="MM/dd/yyyy" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-12 mb-3">
                        <RadzenFormField Text="Vehicle Details" class="w-100">
                            <RadzenTextArea @bind-Value="editVehicleDetails" MaxLength="1000" Rows="3" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-6 mb-3">
                        <RadzenFormField Text="Police Case Number" class="w-100">
                            <RadzenTextBox @bind-Value="editPoliceCaseNumber" MaxLength="100" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-6 mb-3">
                        <RadzenFormField Text="Road Conditions" class="w-100">
                            <RadzenTextBox @bind-Value="editRoadConditions" MaxLength="200" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-12 mb-3">
                        <RadzenFormField Text="Accident Details" class="w-100">
                            <RadzenTextArea @bind-Value="editAccidentDetails" MaxLength="2000" Rows="4" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-12 mb-3">
                        <RadzenFormField Text="Doctor's Information" class="w-100">
                            <RadzenTextArea @bind-Value="editDoctorsInformation" MaxLength="1000" Rows="3" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-12 mb-3">
                        <RadzenFormField Text="Lawyer's Information" class="w-100">
                            <RadzenTextArea @bind-Value="editLawyersInformation" MaxLength="1000" Rows="3" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                    <div class="col-md-12 mb-3">
                        <RadzenFormField Text="Additional Notes" class="w-100">
                            <RadzenTextArea @bind-Value="editAdditionalNotes" MaxLength="2000" Rows="4" Style="width: 100%" />
                        </RadzenFormField>
                    </div>
                </div>
                
                <div class="dialog-actions">
                    <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" 
                                 Click="@(() => { showEditAccidentInfoDialog = false; selectedRequest = null; })" 
                                 Disabled="@isProcessing" />
                    <RadzenButton Text="Save" ButtonStyle="ButtonStyle.Primary" 
                                 Click="@SaveAccidentInfo" 
                                 Disabled="@isProcessing" />
                </div>
            </div>
        </Body>
    </SMModal>
}

@code {
    private List<UserRequest> userRequests = new();
    private bool isLoading = true;
    private UserRequest? selectedRequest;
    private bool showApproveDialog = false;
    private bool showRejectDialog = false;
    private bool showPendingDialog = false;
    private bool showDetailsDialog = false;
    private bool showEditAccidentInfoDialog = false;
    private bool isProcessing = false;
    private string approveNotes = "";
    private string rejectNotes = "";
    private string pendingNotes = "";
    private UserRequestStatus? selectedStatusFilter = null;
    private System.Threading.Timer? _refreshTimer;
    private RadzenDataGrid<UserRequest>? dataGrid;
    private Dictionary<int, UserRequest> expandedRequests = new();
    
    // Accident information form
    private int? editAge;
    private string editRace = "";
    private string editAccidentAddress = "";
    private DateTime? editAccidentDate;
    private string editVehicleDetails = "";
    private DateTime? editDateReported;
    private string editPoliceCaseNumber = "";
    private string editAccidentDetails = "";
    private string editRoadConditions = "";
    private string editDoctorsInformation = "";
    private string editLawyersInformation = "";
    private string editAdditionalNotes = "";

    private class StatusFilterOption
    {
        public UserRequestStatus? Value { get; set; }
        public string Text { get; set; } = string.Empty;
    }

    private readonly List<StatusFilterOption> statusFilterOptions = new()
    {
        new StatusFilterOption { Value = null, Text = "All Statuses" },
        new StatusFilterOption { Value = UserRequestStatus.Pending, Text = "Pending" },
        new StatusFilterOption { Value = UserRequestStatus.Approved, Text = "Approved" },
        new StatusFilterOption { Value = UserRequestStatus.Rejected, Text = "Rejected" }
    };

    protected override async Task OnInitializedAsync()
    {
        await AuthService.InitializeAsync();
        await LoadUserRequests();
        StartAutoRefresh();
    }

    private async Task LoadUserRequests()
    {
        try
        {
            isLoading = true;
            
            var newRequests = await Http.GetFromJsonAsync<List<UserRequest>>("api/UserRequest") ?? new();
            
            // Update the list in place to avoid full re-render
            userRequests.Clear();
            userRequests.AddRange(newRequests);
            
            // Refresh the grid without full page reload
            if (dataGrid != null)
            {
                await dataGrid.Reload();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading user requests: {ex.Message}");
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load user requests: " + ex.Message);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private List<UserRequest> GetFilteredRequests()
    {
        var filtered = userRequests.AsEnumerable();
        
        if (selectedStatusFilter.HasValue)
        {
            filtered = filtered.Where(r => r.Status == selectedStatusFilter.Value);
        }
        
        return filtered.ToList();
    }

    private void ClearFilters()
    {
        selectedStatusFilter = null;
        StateHasChanged();
    }

    private string GetStatusText(UserRequestStatus status)
    {
        return status switch
        {
            UserRequestStatus.Pending => "Pending",
            UserRequestStatus.Approved => "Approved",
            UserRequestStatus.Rejected => "Rejected",
            _ => "Unknown"
        };
    }

    private string GetStatusBadgeClass(UserRequestStatus status)
    {
        return status switch
        {
            UserRequestStatus.Pending => "badge-warning",
            UserRequestStatus.Approved => "badge-success",
            UserRequestStatus.Rejected => "badge-danger",
            _ => "badge-secondary"
        };
    }

    private void ShowApproveDialog(UserRequest request)
    {
        selectedRequest = request;
        approveNotes = "";
        showApproveDialog = true;
    }

    private void ShowRejectDialog(UserRequest request)
    {
        selectedRequest = request;
        rejectNotes = "";
        showRejectDialog = true;
    }

    private void ShowPendingDialog(UserRequest request)
    {
        selectedRequest = request;
        pendingNotes = "";
        showPendingDialog = true;
    }

    private void ShowDetailsDialog(UserRequest request)
    {
        selectedRequest = request;
        showDetailsDialog = true;
    }
    
    private async Task OnRowExpand(UserRequest request)
    {
        if (!expandedRequests.ContainsKey(request.Id))
        {
            // Fetch full request details
            try
            {
                var fullRequest = await Http.GetFromJsonAsync<UserRequest>($"api/UserRequest/{request.Id}");
                if (fullRequest != null)
                {
                    expandedRequests[request.Id] = fullRequest;
                    StateHasChanged();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading request details: {ex.Message}");
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load request details: " + ex.Message);
            }
        }
    }
    
    private void ShowEditAccidentInfoDialog(UserRequest request)
    {
        selectedRequest = request;
        editAge = request.Age;
        editRace = request.Race ?? "";
        editAccidentAddress = request.AccidentAddress ?? "";
        editAccidentDate = request.AccidentDate;
        editVehicleDetails = request.VehicleDetails ?? "";
        editDateReported = request.DateReported;
        editPoliceCaseNumber = request.PoliceCaseNumber ?? "";
        editAccidentDetails = request.AccidentDetails ?? "";
        editRoadConditions = request.RoadConditions ?? "";
        editDoctorsInformation = request.DoctorsInformation ?? "";
        editLawyersInformation = request.LawyersInformation ?? "";
        editAdditionalNotes = request.AdditionalNotes ?? "";
        showEditAccidentInfoDialog = true;
    }
    
    private async Task SaveAccidentInfo()
    {
        if (selectedRequest == null) return;
        
        try
        {
            isProcessing = true;
            StateHasChanged();
            
            var updateRequest = new
            {
                Age = editAge,
                Race = editRace,
                AccidentAddress = editAccidentAddress,
                AccidentDate = editAccidentDate,
                VehicleDetails = editVehicleDetails,
                DateReported = editDateReported,
                PoliceCaseNumber = editPoliceCaseNumber,
                AccidentDetails = editAccidentDetails,
                RoadConditions = editRoadConditions,
                DoctorsInformation = editDoctorsInformation,
                LawyersInformation = editLawyersInformation,
                AdditionalNotes = editAdditionalNotes
            };
            
            var response = await Http.PutAsJsonAsync($"api/UserRequest/{selectedRequest.Id}/accident-info", updateRequest);
            
            if (response.IsSuccessStatusCode)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Accident information updated successfully");
                showEditAccidentInfoDialog = false;
                // Refresh the request
                await LoadUserRequests();
                // Clear expanded cache for this request
                if (expandedRequests.ContainsKey(selectedRequest.Id))
                {
                    expandedRequests.Remove(selectedRequest.Id);
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to update accident information: {errorContent}");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Error updating accident information: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task ApproveRequest()
    {
        if (selectedRequest == null || string.IsNullOrWhiteSpace(approveNotes) || approveNotes.Length < 10)
        {
            return;
        }

        try
        {
            isProcessing = true;
            var response = await Http.PostAsJsonAsync($"api/UserRequest/{selectedRequest.Id}/approve", 
                new { Notes = approveNotes });

            if (response.IsSuccessStatusCode)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", "User request approved successfully. Patient account created and SMS sent.");
                await LoadUserRequests();
                showApproveDialog = false;
                approveNotes = "";
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to approve request: " + error);
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"An error occurred: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task RejectRequest()
    {
        if (selectedRequest == null || string.IsNullOrWhiteSpace(rejectNotes) || rejectNotes.Length < 10)
        {
            return;
        }

        try
        {
            isProcessing = true;
            var response = await Http.PostAsJsonAsync($"api/UserRequest/{selectedRequest.Id}/reject", 
                new { Notes = rejectNotes });

            if (response.IsSuccessStatusCode)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", "User request rejected successfully.");
                await LoadUserRequests();
                showRejectDialog = false;
                rejectNotes = "";
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to reject request: " + error);
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"An error occurred: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task MarkPendingRequest()
    {
        if (selectedRequest == null || string.IsNullOrWhiteSpace(pendingNotes) || pendingNotes.Length < 10)
        {
            return;
        }

        try
        {
            isProcessing = true;
            var response = await Http.PostAsJsonAsync($"api/UserRequest/{selectedRequest.Id}/pending", 
                new { Notes = pendingNotes });

            if (response.IsSuccessStatusCode)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", "User request marked as pending for further review.");
                await LoadUserRequests();
                showPendingDialog = false;
                pendingNotes = "";
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to update request: " + error);
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"An error occurred: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task RefreshRequests()
    {
        await LoadUserRequests();
        StateHasChanged();
    }

    private void StartAutoRefresh()
    {
        _refreshTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                if (!isLoading && !isProcessing)
                {
                    try
                    {
                        // Silently refresh without showing loading state
                        var newRequests = await Http.GetFromJsonAsync<List<UserRequest>>("api/UserRequest") ?? new();
                        
                        // Update the list in place
                        userRequests.Clear();
                        userRequests.AddRange(newRequests);
                        
                        // Refresh only the grid
                        if (dataGrid != null)
                        {
                            await dataGrid.Reload();
                        }
                        
                        StateHasChanged();
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"Error during auto-refresh: {ex.Message}");
                    }
                }
            });
        }, null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
    }

    public void Dispose()
    {
        _refreshTimer?.Dispose();
    }
}

@using Radzen
@using Radzen.Blazor

<style>
    .user-requests-page {
        padding: 20px;
    }

    .user-requests-header {
        margin-bottom: 20px;
    }

    .controls-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .filters-section {
        display: flex;
        gap: 15px;
        align-items: center;
    }

    .refresh-controls {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .auto-refresh-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #27ae60;
        font-size: 0.9em;
        font-weight: 500;
    }

    .refresh-icon {
        animation: pulse 2s infinite;
    }

    @@keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }

    .action-buttons {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
    }

    .badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
    }

    .badge-success {
        background-color: #28a745;
        color: white;
    }

    .badge-warning {
        background-color: #ffc107;
        color: #333;
    }

    .badge-danger {
        background-color: #dc3545;
        color: white;
    }

    .badge-secondary {
        background-color: #6c757d;
        color: white;
    }

    .dialog-content {
        padding: 20px;
    }

    .dialog-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
    }

    .details-section {
        margin-bottom: 20px;
    }

    .details-section h4 {
        margin-bottom: 10px;
        color: #333;
    }

    .notes-text {
        background-color: #f5f5f5;
        padding: 10px;
        border-radius: 4px;
        white-space: pre-wrap;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        line-height: 1.6;
        max-height: 400px;
        overflow-y: auto;
    }

    .reason-text {
        background-color: #e3f2fd;
        padding: 12px;
        border-radius: 4px;
        border-left: 4px solid #2196f3;
        white-space: pre-wrap;
        line-height: 1.6;
    }

    .reason-display {
        margin: 15px 0;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 4px;
    }

    .reason-text-small {
        background-color: #e3f2fd;
        padding: 8px;
        border-radius: 4px;
        border-left: 3px solid #2196f3;
        margin-top: 5px;
        white-space: pre-wrap;
        font-size: 14px;
        line-height: 1.5;
    }

    .loading-state {
        text-align: center;
        padding: 40px;
    }

    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .text-muted {
        color: #6c757d;
    }

    .text-warning {
        color: #ffc107;
    }

    .text-info {
        color: #17a2b8;
    }
</style>

