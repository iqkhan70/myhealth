@page "/service-requests"
@using SM_MentalHealthApp.Shared
@using SM_MentalHealthApp.Client.Services
@using SM_MentalHealthApp.Client.Components
@using SM_MentalHealthApp.Client.Helpers
@using Radzen
@using Radzen.Blazor
@inject IServiceRequestService ServiceRequestService
@inject IPatientService PatientService
@inject IAuthService AuthService
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject ODataService ODataService

<PageTitle>Service Requests</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <SMPageHeader Title="Service Requests" Icon="fas fa-tasks">
            </SMPageHeader>

            @if (AuthService.CurrentUser?.RoleId == 2 || AuthService.CurrentUser?.RoleId == 5 || AuthService.CurrentUser?.RoleId == 6) // Doctor, Attorney, or SME
            {
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>My Service Requests:</strong> Below are the service requests assigned to you.
                    @if (mySmeScore.HasValue)
                    {
                        <span class="ms-3">
                            <strong>My SME Score:</strong> 
                            <span class="badge @GetScoreClass(mySmeScore.Value)">@mySmeScore</span>
                        </span>
                    }
                </div>
            }

            <!-- Filter and Create Button Row -->
            <div class="row mb-3" style="margin-bottom: 1rem; align-items: end;">
                <div class="col-md-3">
                    <label class="form-label"><strong>Filter by Status:</strong></label>
                    <RadzenDropDown Data="@statusFilterOptions" 
                                   TextProperty="Text" 
                                   ValueProperty="Value" 
                                   @bind-Value="selectedStatusFilter"
                                   @bind-Value:after="OnStatusFilterChanged"
                                   Placeholder="All Statuses"
                                   AllowClear="true"
                                   Style="width: 100%" />
                </div>
                <div class="col-md-9" style="display: flex; justify-content: flex-end; align-items: end;">
                    @if (AuthService.CurrentUser?.RoleId == 1 || AuthService.CurrentUser?.RoleId == 3 || AuthService.CurrentUser?.RoleId == 4) // Patient, Admin, or Coordinator
                    {
                        <button class="btn btn-success" @onclick="ShowCreateDialog" style="height: 38px;">
                            <i class="fas fa-plus"></i> Create Service Request
                        </button>
                    }
                </div>
            </div>

            <RadzenDataGrid @ref="grid" TItem="ServiceRequestDto" 
                Data="@serviceRequests"
                Count="@totalCount"
                LoadData="@LoadServiceRequestsData"
                AllowPaging="true" PageSize="20" AllowSorting="true" AllowFiltering="true"
                FilterMode="FilterMode.Advanced" ShowPagingSummary="true">
                    <Columns>
                        <RadzenDataGridColumn TItem="ServiceRequestDto" Property="Id" Title="ID" Width="80px" />
                        <RadzenDataGridColumn TItem="ServiceRequestDto" Property="ClientName" Title="Client" Width="200px" />
                        <RadzenDataGridColumn TItem="ServiceRequestDto" Property="Title" Title="Title" Width="250px" />
                        <RadzenDataGridColumn TItem="ServiceRequestDto" Property="Type" Title="Type" Width="120px" />
                        <RadzenDataGridColumn TItem="ServiceRequestDto" Property="Status" Title="Status" Width="120px" Filterable="false">
                            <Template Context="sr">
                                <span class="badge @GetStatusClass(sr.Status)">@sr.Status</span>
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="ServiceRequestDto" Property="CreatedAt" Title="Created" Width="150px">
                            <Template Context="sr">
                                @sr.CreatedAt.ToString("MMM dd, yyyy")
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="ServiceRequestDto" Property="AssignedSmeNames" Title="Assigned SMEs" Width="300px" Filterable="true">
                            <Template Context="sr">
                                @if (sr.Assignments != null && sr.Assignments.Any(a => a.IsActive))
                                {
                                    <div style="display: flex; flex-direction: column; gap: 4px;">
                                        @foreach (var assignment in sr.Assignments.Where(a => a.IsActive))
                                        {
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="badge @GetAssignmentStatusClass(assignment.Status)" style="white-space: nowrap;">
                                                    @assignment.SmeUserName
                                                </span>
                                                <span class="badge bg-secondary" style="font-size: 0.75em;">
                                                    @assignment.Status
                                                </span>
                                                @if (assignment.SmeScore.HasValue)
                                                {
                                                    <span class="badge @GetScoreClass(assignment.SmeScore.Value)" style="font-size: 0.7em;" title="SME Score">
                                                        ‚≠ê @assignment.SmeScore
                                                    </span>
                                                }
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted">No assignments</span>
                                }
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="ServiceRequestDto" Title="Actions" Width="250px" Sortable="false" Filterable="false">
                            <Template Context="sr">
                                <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                    <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.ExtraSmall"
                                        Click="@(async () => await ShowEditDialog(sr))" Title="Edit" />
                                    @if (AuthService.CurrentUser?.RoleId == 3 || AuthService.CurrentUser?.RoleId == 4)
                                    {
                                        <RadzenButton Icon="person_add" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.ExtraSmall"
                                            Click="@(async () => await ShowAssignDialog(sr))" Title="Assign SME" />
                                        <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.ExtraSmall"
                                            Click="@(async () => await ShowDeleteDialog(sr))" Title="Delete" />
                                    }
                                    @if (AuthService.CurrentUser?.RoleId == 3) // Admin only
                                    {
                                        @* Show admin override button for assignments *@
                                        @foreach (var assignment in sr.Assignments?.Where(a => a.IsActive) ?? Enumerable.Empty<ServiceRequestAssignmentDto>())
                                        {
                                            @if (assignment.Status == "Completed" || assignment.Status == "InProgress")
                                            {
                                                <RadzenButton Icon="settings" ButtonStyle="ButtonStyle.Warning" Size="ButtonSize.ExtraSmall"
                                                    Click="@(async () => await ShowAdminOverrideDialog(assignment, sr))" 
                                                    Title="Admin Override Status" />
                                                break; // Only show one button per SR
                                            }
                                        }
                                    }
                                    @if (AuthService.CurrentUser?.RoleId == 2 || AuthService.CurrentUser?.RoleId == 5 || AuthService.CurrentUser?.RoleId == 6)
                                    {
                                        @* Show assignment actions for SMEs *@
                                        @foreach (var assignment in sr.Assignments?.Where(a => a.IsActive && a.SmeUserId == AuthService.CurrentUser?.Id) ?? Enumerable.Empty<ServiceRequestAssignmentDto>())
                                        {
                                            @if (assignment.Status == "Assigned")
                                            {
                                                <RadzenButton Icon="check" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.ExtraSmall"
                                                    Click="@(async () => await AcceptAssignment(assignment.Id))" Title="Accept" />
                                                <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.ExtraSmall"
                                                    Click="@(async () => await ShowRejectDialog(assignment.Id, sr))" Title="Reject" />
                                            }
                                            else if (assignment.Status == "Accepted")
                                            {
                                                <RadzenButton Icon="play_arrow" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.ExtraSmall"
                                                    Click="@(async () => await StartAssignment(assignment.Id))" Title="Start Work" />
                                            }
                                            else if (assignment.Status == "InProgress")
                                            {
                                                <RadzenButton Icon="done" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.ExtraSmall"
                                                    Click="@(async () => await CompleteAssignment(assignment.Id))" Title="Complete" />
                                            }
                                        }
                                    }
                                </div>
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
        </div>
    </div>
</div>

@code {
    private RadzenDataGrid<ServiceRequestDto>? grid;
    private List<ServiceRequestDto> serviceRequests = new();
    private int totalCount = 0;
    private List<User>? clients;
    private List<User>? smes;
    private int? mySmeScore;
    private List<int>? _filterSmeIds; // For filtering by AssignedSmeNames
    
    // Status filter - default to "Active"
    private string? selectedStatusFilter = "Active";
    
    // Status filter options for dropdown
    private List<StatusOption> statusFilterOptions = new()
    {
        new StatusOption { Value = "Active", Text = "Active" },
        new StatusOption { Value = "Completed", Text = "Completed" },
        new StatusOption { Value = "Cancelled", Text = "Cancelled" },
        new StatusOption { Value = "OnHold", Text = "On Hold" }
    };
    
    private class StatusOption
    {
        public string Value { get; set; } = string.Empty;
        public string Text { get; set; } = string.Empty;
    }
    
    private async Task OnStatusFilterChanged()
    {
        // Reload data when status filter changes
        if (grid != null)
        {
            await grid.Reload();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await AuthService.InitializeAsync();
        if (AuthService.CurrentUser?.RoleId == 3 || AuthService.CurrentUser?.RoleId == 4)
        {
            await LoadClients();
            await LoadSMEs();
        }
        else if (AuthService.CurrentUser?.RoleId == 2 || AuthService.CurrentUser?.RoleId == 5 || AuthService.CurrentUser?.RoleId == 6)
        {
            await LoadMySmeScore();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Trigger initial load for server-side pagination
        if (firstRender && grid != null)
        {
            await Task.Delay(100); // Small delay to ensure grid is fully rendered
            if (grid != null)
            {
                await grid.Reload();
            }
        }
    }

    private async Task LoadServiceRequestsData(LoadDataArgs args)
    {
        try
        {
            // Decode URL-encoded filter from Radzen
            var decodedFilter = args.Filter != null ? System.Net.WebUtility.UrlDecode(args.Filter) : null;
            
            // Handle ClientName and AssignedSmeNames filters (DTO-only properties, need special handling)
            var hasClientName = !string.IsNullOrEmpty(decodedFilter) && decodedFilter.Contains("ClientName", StringComparison.OrdinalIgnoreCase);
            var hasAssignedSmeNames = !string.IsNullOrEmpty(decodedFilter) && decodedFilter.Contains("AssignedSmeNames", StringComparison.OrdinalIgnoreCase);
            string? odataFilter = null;
            
            if (hasClientName)
            {
                var clientNameFilter = ExtractNameFilter(decodedFilter!, "ClientName");
                if (!string.IsNullOrEmpty(clientNameFilter))
                {
                    // Find matching client IDs (patients, RoleId = 1)
                    var clientIds = await FindUserIdsByName(clientNameFilter, 1, CancellationToken.None);
                    if (clientIds.Any())
                    {
                        var clientIdFilter = string.Join(" or ", clientIds.Select(id => $"ClientId eq {id}"));
                        if (!string.IsNullOrEmpty(odataFilter))
                            odataFilter = $"{odataFilter} and ({clientIdFilter})";
                        else
                            odataFilter = $"({clientIdFilter})";
                    }
                    else
                    {
                        // No matching clients, return empty result
                        serviceRequests = new();
                        totalCount = 0;
                        await InvokeAsync(StateHasChanged);
                        return;
                    }
                    // Remove ClientName filter from the rest
                    decodedFilter = RemoveNameFilter(decodedFilter!, "ClientName");
                }
                else
                {
                    // Extraction failed, but filter contains ClientName - remove it
                    decodedFilter = RemoveNameFilter(decodedFilter!, "ClientName");
                }
            }
            
            if (hasAssignedSmeNames)
            {
                var smeNameFilter = ExtractNameFilter(decodedFilter!, "AssignedSmeNames");
                if (!string.IsNullOrEmpty(smeNameFilter))
                {
                    // Find matching SME IDs (doctors RoleId = 2, attorneys RoleId = 5, SMEs RoleId = 6)
                    var doctorIds = await FindUserIdsByName(smeNameFilter, 2, CancellationToken.None);
                    var attorneyIds = await FindUserIdsByName(smeNameFilter, 5, CancellationToken.None);
                    var smeRoleIds = await FindUserIdsByName(smeNameFilter, 6, CancellationToken.None);
                    var smeIds = doctorIds.Concat(attorneyIds).Concat(smeRoleIds).Distinct().ToList();
                    
                    if (smeIds.Any())
                    {
                        // Filter by ServiceRequests that have assignments to these SMEs
                        // We need to check if any assignment has these SME IDs
                        // This is complex - we'll need to filter after loading or use a subquery
                        // For now, we'll filter client-side after loading
                        // Store the SME IDs for post-filtering
                        _filterSmeIds = smeIds;
                    }
                    else
                    {
                        // No matching SMEs, return empty result
                        serviceRequests = new();
                        totalCount = 0;
                        await InvokeAsync(StateHasChanged);
                        return;
                    }
                    // Remove AssignedSmeNames filter from the rest
                    decodedFilter = RemoveNameFilter(decodedFilter!, "AssignedSmeNames");
                }
                else
                {
                    // Extraction failed, but filter contains AssignedSmeNames - remove it
                    decodedFilter = RemoveNameFilter(decodedFilter!, "AssignedSmeNames");
                }
            }
            
            // Add status filter if selected
            if (!string.IsNullOrEmpty(selectedStatusFilter))
            {
                var statusFilter = $"Status eq '{selectedStatusFilter}'";
                if (!string.IsNullOrEmpty(odataFilter))
                    odataFilter = $"{odataFilter} and ({statusFilter})";
                else
                    odataFilter = statusFilter;
            }
            
            // Transform remaining filter from Radzen C# syntax to OData syntax
            if (!string.IsNullOrEmpty(decodedFilter))
            {
                decodedFilter = CleanupFilterOperators(decodedFilter);
                
                if (!string.IsNullOrWhiteSpace(decodedFilter) && !IsOnlyOperators(decodedFilter))
                {
                    var transformedFilter = ODataFilterHelper.TransformToOData(decodedFilter);
                    
                    if (!string.IsNullOrEmpty(transformedFilter))
                    {
                        if (!string.IsNullOrEmpty(odataFilter))
                            odataFilter = $"{odataFilter} and ({transformedFilter})";
                        else
                            odataFilter = transformedFilter;
                    }
                }
            }

            // Transform orderBy to use entity properties instead of DTO properties
            string? transformedOrderBy = null;
            if (!string.IsNullOrEmpty(args.OrderBy))
            {
                transformedOrderBy = TransformOrderBy(args.OrderBy);
            }
            
            // Query OData endpoint
            // Note: Assignments navigation property is not expandable in OData EDM model
            // We'll load assignments separately after getting ServiceRequests
            var result = await ODataService.QueryAsync<ServiceRequest>(
                "ServiceRequests",
                args.Skip ?? 0,
                args.Top ?? 20,
                transformedOrderBy,
                odataFilter,
                CancellationToken.None);

            // Map ServiceRequest entities to ServiceRequestDto
            // IMPORTANT: Create a new list reference so Radzen detects the change
            var mappedItems = result.Items.Select(MapToDto).ToList();
            
            // Apply AssignedSmeNames filter if needed (client-side filtering)
            if (_filterSmeIds != null && _filterSmeIds.Any())
            {
                mappedItems = mappedItems.Where(sr => 
                    sr.Assignments != null && 
                    sr.Assignments.Any(a => a.IsActive && _filterSmeIds.Contains(a.SmeUserId))
                ).ToList();
                // Note: totalCount might be inaccurate after client-side filtering, but it's acceptable for this use case
            }
            
            // If we sorted by ClientName or AssignedSmeNames, we need to sort the results client-side
            // because OData can't sort by computed DTO properties
            if (!string.IsNullOrEmpty(args.OrderBy) && (args.OrderBy.Contains("ClientName", StringComparison.OrdinalIgnoreCase) || 
                                                         args.OrderBy.Contains("AssignedSmeNames", StringComparison.OrdinalIgnoreCase)))
            {
                var sortedResult = SortResultsByComputedProperty(new PagedResult<ServiceRequestDto>
                {
                    Items = mappedItems,
                    TotalCount = result.TotalCount,
                    PageNumber = result.PageNumber,
                    PageSize = result.PageSize
                }, args.OrderBy);
                mappedItems = sortedResult.Items.ToList();
            }
            
            serviceRequests = mappedItems;
            totalCount = result.TotalCount;
            _filterSmeIds = null; // Reset after use

            // Load assignments separately since OData doesn't support $expand for Assignments
            await LoadAssignmentsForServiceRequests();

            // Fetch users for assignments if needed
            await LoadAssignmentUsers();

            // Update the list reference again after loading users to trigger UI update
            serviceRequests = new List<ServiceRequestDto>(serviceRequests);

            // Force UI update
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load service requests: {ex.Message}");
            serviceRequests = new();
            totalCount = 0;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task LoadAssignmentsForServiceRequests()
    {
        if (!serviceRequests.Any())
            return;

        try
        {
            var serviceRequestIds = serviceRequests.Select(sr => sr.Id).ToList();
            
            // Load assignments for all service requests in parallel (batch)
            var assignmentTasks = serviceRequestIds.Select(async srId =>
            {
                try
                {
                    // Get the full service request with assignments via the regular API
                    var fullSr = await ServiceRequestService.GetServiceRequestByIdAsync(srId);
                    return new { SrId = srId, Assignments = fullSr?.Assignments?.Where(a => a.IsActive).ToList() ?? new List<ServiceRequestAssignmentDto>() };
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Failed to load assignments for SR {srId}: {ex.Message}");
                    return new { SrId = srId, Assignments = new List<ServiceRequestAssignmentDto>() };
                }
            });
            
            var assignmentResults = await Task.WhenAll(assignmentTasks);
            var assignmentsBySrId = assignmentResults.ToDictionary(r => r.SrId, r => r.Assignments);
            
            // Assign assignments to each service request
            foreach (var sr in serviceRequests)
            {
                if (assignmentsBySrId.TryGetValue(sr.Id, out var assignments))
                {
                    sr.Assignments = assignments;
                }
                else
                {
                    sr.Assignments = new List<ServiceRequestAssignmentDto>();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load assignments: {ex.Message}");
        }
    }

    private async Task LoadAssignmentUsers()
    {
        // Get all unique user IDs (clients and SMEs) from service requests
        var clientIds = serviceRequests
            .Where(sr => sr.ClientId > 0)
            .Select(sr => sr.ClientId)
            .Distinct()
            .ToList();

        var smeUserIds = serviceRequests
            .SelectMany(sr => sr.Assignments ?? Enumerable.Empty<ServiceRequestAssignmentDto>())
            .Where(a => a.SmeUserId > 0)
            .Select(a => a.SmeUserId)
            .Distinct()
            .ToList();

        var allUserIds = clientIds.Concat(smeUserIds).Distinct().ToList();

        if (!allUserIds.Any())
            return;

        try
        {
            // Build filter for multiple user IDs
            var userIdFilters = allUserIds.Select(id => $"Id eq {id}");
            var userFilter = string.Join(" or ", userIdFilters);

            // Query users via OData
            var userResult = await ODataService.QueryAsync<User>(
                "Users",
                0,
                allUserIds.Count,
                null,
                userFilter,
                CancellationToken.None);

            var userCache = userResult.Items.ToDictionary(u => u.Id, u => u);

            // Update client names and assignment user names
            foreach (var sr in serviceRequests)
            {
                // Update client name
                if (userCache.TryGetValue(sr.ClientId, out var client))
                {
                    sr.ClientName = $"{client.FirstName} {client.LastName}";
                }

                // Update assignment user names
                if (sr.Assignments != null)
                {
                    foreach (var assignment in sr.Assignments)
                    {
                        if (userCache.TryGetValue(assignment.SmeUserId, out var smeUser))
                        {
                            assignment.SmeUserName = $"{smeUser.FirstName} {smeUser.LastName}";
                            assignment.SmeScore = smeUser.SmeScore;
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            // Log but don't fail the whole operation
            Console.WriteLine($"Failed to load assignment users: {ex.Message}");
        }
    }

    private ServiceRequestDto MapToDto(ServiceRequest sr)
    {
        // Handle case where navigation properties might not be loaded (OData might not serialize them)
        string clientName = "Unknown";
        if (sr.Client != null)
        {
            clientName = $"{sr.Client.FirstName} {sr.Client.LastName}";
        }
        else if (sr.ClientId > 0)
        {
            // Navigation property not loaded, will be populated by LoadAssignmentUsers if needed
            clientName = $"Client {sr.ClientId}";
        }

        var assignments = new List<ServiceRequestAssignmentDto>();
        if (sr.Assignments != null && sr.Assignments.Any())
        {
            assignments = sr.Assignments
                .Where(a => a.IsActive)
                .Select(a => new ServiceRequestAssignmentDto
                {
                    Id = a.Id,
                    ServiceRequestId = a.ServiceRequestId,
                    SmeUserId = a.SmeUserId,
                    SmeUserName = a.SmeUser != null ? $"{a.SmeUser.FirstName} {a.SmeUser.LastName}" : $"SME {a.SmeUserId}",
                    SmeScore = a.SmeUser?.SmeScore,
                    AssignedAt = a.AssignedAt,
                    AcceptedAt = a.AcceptedAt,
                    StartedAt = a.StartedAt,
                    CompletedAt = a.CompletedAt,
                    IsActive = a.IsActive,
                    Status = a.Status ?? "Assigned",
                    OutcomeReason = a.OutcomeReason,
                    ResponsibilityParty = a.ResponsibilityParty,
                    IsBillable = a.IsBillable
                })
                .ToList();
        }

        return new ServiceRequestDto
        {
            Id = sr.Id,
            ClientId = sr.ClientId,
            ClientName = clientName,
            Title = sr.Title,
            Type = sr.Type,
            Status = sr.Status,
            CreatedAt = sr.CreatedAt,
            UpdatedAt = sr.UpdatedAt,
            Description = sr.Description,
            Assignments = assignments
        };
    }

    private async Task LoadClients()
    {
        try
        {
            clients = await PatientService.ListAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load clients: {ex.Message}");
        }
    }

    private async Task LoadSMEs()
    {
        try
        {
            // Load doctors and attorneys
            AddAuthorizationHeader();
            var doctors = await Http.GetFromJsonAsync<List<User>>("api/admin/doctors") ?? new List<User>();
            var attorneys = await Http.GetFromJsonAsync<List<User>>("api/admin/attorneys") ?? new List<User>();
            smes = doctors.Concat(attorneys).ToList();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load SMEs: {ex.Message}");
        }
    }

    private async Task ShowCreateDialog(Microsoft.AspNetCore.Components.Web.MouseEventArgs e)
    {
        // First, test if the method is being called
        try
        {
            var isPatient = AuthService.CurrentUser?.RoleId == 1;
            
            // Only load clients and SMEs for non-patients
            if (!isPatient)
            {
                // Ensure clients and SMEs are loaded before opening dialog
                if (clients == null || !clients.Any())
                {
                    await LoadClients();
                }
                if (smes == null || !smes.Any())
                {
                    await LoadSMEs();
                }

                if (clients == null || !clients.Any())
                {
                    NotificationService.Notify(NotificationSeverity.Warning, "Warning", "No clients available. Please ensure clients exist in the system.");
                    return;
                }
            }

            // Try opening the dialog with full namespace
            var result = await DialogService.OpenAsync<SM_MentalHealthApp.Client.Components.CreateServiceRequestDialog>(
                "Create Service Request",
                new Dictionary<string, object> 
                { 
                    { "Clients", clients ?? new List<User>() }, 
                    { "SMEs", smes ?? new List<User>() } 
                },
                new DialogOptions 
                { 
                    Width = "800px", 
                    Height = "85vh", 
                    Resizable = true, 
                    Draggable = true 
                });

            if (result == true)
            {
                if (grid != null)
                {
                    await grid.Reload();
                }
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to open create dialog: {ex.Message}");
        }
    }

    private async Task ShowEditDialog(ServiceRequestDto sr)
    {
        try
        {
            var result = await DialogService.OpenAsync<SM_MentalHealthApp.Client.Components.EditServiceRequestDialog>(
                "Edit Service Request",
                new Dictionary<string, object> 
                { 
                    { "ServiceRequest", sr }
                },
                new DialogOptions 
                { 
                    Width = "800px", 
                    Height = "85vh", 
                    Resizable = true, 
                    Draggable = true 
                });

            if (result == true)
            {
                if (grid != null)
                {
                    await grid.Reload();
                }
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to open edit dialog: {ex.Message}");
        }
    }

    private async Task ShowAssignDialog(ServiceRequestDto sr)
    {
        try
        {
            // Ensure SMEs are loaded
            if (smes == null || !smes.Any())
            {
                await LoadSMEs();
            }

            var result = await DialogService.OpenAsync<SM_MentalHealthApp.Client.Components.AssignSmeDialog>(
                "Assign SME to Service Request",
                new Dictionary<string, object> 
                { 
                    { "ServiceRequest", sr },
                    { "SMEs", smes ?? new List<User>() }
                },
                new DialogOptions 
                { 
                    Width = "500px", 
                    Height = "auto", 
                    Resizable = true, 
                    Draggable = true 
                });

            if (result == true)
            {
                if (grid != null)
                {
                    await grid.Reload();
                }
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to open assign dialog: {ex.Message}");
        }
    }

    private async Task ShowDeleteDialog(ServiceRequestDto sr)
    {
        var result = await DialogService.Confirm("Are you sure you want to delete this service request?",
            "Delete Service Request", new ConfirmOptions { OkButtonText = "Yes", CancelButtonText = "No" });

        if (result == true)
        {
            try
            {
                var deleted = await ServiceRequestService.DeleteServiceRequestAsync(sr.Id);
                if (deleted)
                {
                    NotificationService.Notify(NotificationSeverity.Success, "Success", "Service request deleted successfully");
                    if (grid != null)
                    {
                        await grid.Reload();
                    }
                    StateHasChanged();
                }
                else
                {
                    NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to delete service request");
                }
            }
            catch (Exception ex)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to delete service request: {ex.Message}");
            }
        }
    }

    private string GetStatusClass(string status)
    {
        return status?.ToLower() switch
        {
            "active" => "bg-success",
            "completed" => "bg-secondary",
            "cancelled" => "bg-danger",
            "onhold" => "bg-warning",
            _ => "bg-info"
        };
    }

    private string GetAssignmentStatusClass(string status)
    {
        return status?.ToLower() switch
        {
            "assigned" => "bg-info",
            "accepted" => "bg-primary",
            "inprogress" => "bg-warning",
            "completed" => "bg-success",
            "rejected" => "bg-danger",
            "abandoned" => "bg-secondary",
            _ => "bg-secondary"
        };
    }

    private string GetScoreClass(int score)
    {
        if (score >= 120) return "bg-success";
        if (score >= 100) return "bg-primary";
        if (score >= 80) return "bg-warning";
        return "bg-danger";
    }

    private async Task LoadMySmeScore()
    {
        try
        {
            mySmeScore = await ServiceRequestService.GetMySmeScoreAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Warning", $"Could not load SME score: {ex.Message}");
        }
    }

    private async Task AcceptAssignment(int assignmentId)
    {
        try
        {
            var success = await ServiceRequestService.AcceptAssignmentAsync(assignmentId);
            if (success)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Assignment accepted successfully");
                if (grid != null)
                {
                    await grid.Reload();
                }
                await LoadMySmeScore();
                StateHasChanged();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to accept assignment");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to accept assignment: {ex.Message}");
        }
    }

    private async Task ShowRejectDialog(int assignmentId, ServiceRequestDto sr)
    {
        var reasons = new Dictionary<OutcomeReason, string>
        {
            { OutcomeReason.SME_Overloaded, "Overloaded - Too many active assignments" },
            { OutcomeReason.SME_Conflict, "Conflict of Interest" },
            { OutcomeReason.SME_OutOfScope, "Out of Scope - Not my expertise" },
            { OutcomeReason.Other, "Other" }
        };

        var result = await DialogService.OpenAsync<RejectAssignmentDialog>(
            "Reject Assignment",
            new Dictionary<string, object>
            {
                { "AssignmentId", assignmentId },
                { "ServiceRequestTitle", sr.Title },
                { "Reasons", reasons }
            },
            new DialogOptions { Width = "500px", Height = "auto" });

        if (result == true)
        {
            if (grid != null)
            {
                await grid.Reload();
            }
            await LoadMySmeScore();
            StateHasChanged();
        }
    }

    private async Task StartAssignment(int assignmentId)
    {
        try
        {
            var success = await ServiceRequestService.StartAssignmentAsync(assignmentId);
            if (success)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Assignment started. This assignment is now billable.");
                if (grid != null)
                {
                    await grid.Reload();
                }
                StateHasChanged();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to start assignment");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to start assignment: {ex.Message}");
        }
    }

    private async Task CompleteAssignment(int assignmentId)
    {
        try
        {
            var success = await ServiceRequestService.CompleteAssignmentAsync(assignmentId);
            if (success)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Assignment completed successfully");
                if (grid != null)
                {
                    await grid.Reload();
                }
                await LoadMySmeScore();
                StateHasChanged();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to complete assignment");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to complete assignment: {ex.Message}");
        }
    }

    private async Task ShowAdminOverrideDialog(ServiceRequestAssignmentDto assignment, ServiceRequestDto sr)
    {
        try
        {
            var result = await DialogService.OpenAsync<SM_MentalHealthApp.Client.Components.AdminOverrideStatusDialog>(
                "Admin Override Assignment Status",
                new Dictionary<string, object>
                {
                    { "Assignment", assignment },
                    { "ServiceRequest", sr }
                },
                new DialogOptions { Width = "600px", Height = "auto", Resizable = true, Draggable = true });

            if (result == true)
            {
                if (grid != null)
                {
                    await grid.Reload();
                }
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to open admin override dialog: {ex.Message}");
        }
    }

    private void AddAuthorizationHeader()
    {
        var token = AuthService.Token;
        if (!string.IsNullOrEmpty(token))
        {
            Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
        }
    }

    [Inject] private HttpClient Http { get; set; } = null!;

    // Helper methods for filtering DTO-only properties
    private string? ExtractNameFilter(string filter, string propertyName)
    {
        // Extract search term from Radzen-generated filters
        var patterns = new[]
        {
            // Radzen C#-style: (ClientName == null ? "" : ClientName).ToLower().Contains("value".ToLower())
            $@"\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\(\)\.Contains\(""([^""]+)""\.ToLower\(\)\)",
            // Radzen C#-style with single quotes
            $@"\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\(\)\.Contains\('([^']+)'\.ToLower\(\)\)",
            // Radzen C#-style WITHOUT ToLower: (ClientName == null ? "" : ClientName).Contains("value")
            $@"\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.Contains\(""([^""]+)""\)",
            // Radzen C#-style WITHOUT ToLower with single quotes
            $@"\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.Contains\('([^']+)'\)",
            // OData-style: contains(ClientName, 'john')
            $@"contains\({propertyName},\s*'([^']+)'\)",
            // OData-style: ClientName contains 'john'
            $@"{propertyName}\s+contains\s+'([^']+)'",
            // OData-style with tolower
            $@"contains\(tolower\({propertyName}\),\s*tolower\('([^']+)'\)\)",
            $@"tolower\({propertyName}\)\s+contains\s+'([^']+)'"
        };
        
        foreach (var pattern in patterns)
        {
            var match = System.Text.RegularExpressions.Regex.Match(filter, pattern, System.Text.RegularExpressions.RegexOptions.IgnoreCase);
            if (match.Success && match.Groups.Count > 1)
            {
                return match.Groups[1].Value;
            }
        }
        
        return null;
    }
    
    private string RemoveNameFilter(string filter, string propertyName)
    {
        // Remove the filter clause for the given property name
        var patterns = new[]
        {
            // Radzen C#-style with double quotes and ToLower
            $@"\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\(\)\.Contains\(""[^""]+""\.ToLower\(\)\)",
            // Radzen C#-style with single quotes and ToLower
            $@"\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\(\)\.Contains\('[^']+'\.ToLower\(\)\)",
            // Radzen C#-style WITHOUT ToLower: (ClientName == null ? "" : ClientName).Contains("value")
            $@"\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.Contains\(""[^""]+""\)",
            // Radzen C#-style WITHOUT ToLower with single quotes
            $@"\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.Contains\('[^']+'\)",
            // OData-style patterns
            $@"contains\({propertyName},\s*'[^']+'\)",
            $@"{propertyName}\s+contains\s+'[^']+'",
            $@"contains\(tolower\({propertyName}\),\s*tolower\('[^']+'\)\)",
            $@"tolower\({propertyName}\)\s+contains\s+'[^']+'",
            // With "and" operators (with ToLower)
            $@"and\s+\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\(\)\.Contains\(""[^""]+""\.ToLower\(\)\)",
            $@"and\s+\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\(\)\.Contains\('[^']+'\.ToLower\(\)\)",
            // With "and" operators (without ToLower)
            $@"and\s+\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.Contains\(""[^""]+""\)",
            $@"and\s+\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.Contains\('[^']+'\)",
            $@"and\s+contains\({propertyName},\s*'[^']+'\)",
            $@"and\s+{propertyName}\s+contains\s+'[^']+'",
            // With trailing "and" (with ToLower)
            $@"\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\(\)\.Contains\(""[^""]+""\.ToLower\(\)\)\s+and",
            $@"\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.ToLower\(\)\.Contains\('[^']+'\.ToLower\(\)\)\s+and",
            // With trailing "and" (without ToLower)
            $@"\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.Contains\(""[^""]+""\)\s+and",
            $@"\({propertyName}\s*==\s*null\s*\?\s*""""\s*:\s*{propertyName}\)\.Contains\('[^']+'\)\s+and",
            $@"contains\({propertyName},\s*'[^']+'\)\s+and",
            $@"{propertyName}\s+contains\s+'[^']+'\s+and"
        };
        
        var result = filter;
        foreach (var pattern in patterns)
        {
            result = System.Text.RegularExpressions.Regex.Replace(result, pattern, "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        }
        
        // Clean up extra "and" or "or" operators
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\s+and\s+and\s+", " and ", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\s+or\s+or\s+", " or ", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @"^\s*and\s+", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\s+and\s+$", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @"^\s*or\s+", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\s+or\s+$", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = result.Trim();
        
        return result;
    }
    
    private string CleanupFilterOperators(string filter)
    {
        if (string.IsNullOrWhiteSpace(filter))
            return string.Empty;
            
        var result = filter;
        
        // Remove standalone operators at the start
        result = System.Text.RegularExpressions.Regex.Replace(result, @"^\s*(and|or)\s+", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        
        // Remove standalone operators at the end
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\s+(and|or)\s+$", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        
        // Remove empty parentheses: () or ( ) or (and) or (or)
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\(\s*(and|or)?\s*\)", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        
        // Remove duplicate operators
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\s+(and|or)\s+(and|or)\s+", " $1 ", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        
        // Remove operators before/after parentheses
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\s+(and|or)\s+\(", " (", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\)\s+(and|or)\s+", ") ", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        
        result = result.Trim();
        return result;
    }
    
    private bool IsOnlyOperators(string filter)
    {
        if (string.IsNullOrWhiteSpace(filter))
            return true;
            
        // Remove all whitespace and check if only operators remain
        var cleaned = System.Text.RegularExpressions.Regex.Replace(filter, @"\s+", "");
        var onlyOperators = System.Text.RegularExpressions.Regex.IsMatch(cleaned, @"^(and|or|\(|\)|\s)+$", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        return onlyOperators;
    }
    
    private async Task<List<int>> FindUserIdsByName(string searchTerm, int? roleId, CancellationToken ct)
    {
        try
        {
            // Query Users OData to find matching users by name
            string nameFilter;
            if (roleId.HasValue)
            {
                nameFilter = $"(RoleId eq {roleId.Value}) and (contains(FirstName, '{searchTerm}') or contains(LastName, '{searchTerm}'))";
            }
            else
            {
                // Search across all roles
                nameFilter = $"(contains(FirstName, '{searchTerm}') or contains(LastName, '{searchTerm}'))";
            }
            var result = await ODataService.QueryAsync<Shared.User>("Users", 0, 1000, null, nameFilter, ct);
            
            return result.Items.Select(u => u.Id).ToList();
        }
        catch (Exception ex)
        {
            return new List<int>();
        }
    }
    
    private string? TransformOrderBy(string? orderBy)
    {
        if (string.IsNullOrEmpty(orderBy))
            return orderBy;
            
        // Transform DTO property names to entity property names
        // ClientName and AssignedSmeNames are DTO-only, so we can't sort by them in OData
        // We'll sort client-side instead, but we need to remove them from the OData orderBy
        var result = orderBy;
        
        // Remove ClientName and AssignedSmeNames from orderBy (we'll sort client-side)
        // Pattern: "ClientName asc" or "AssignedSmeNames desc" or "ClientName, Title asc"
        result = System.Text.RegularExpressions.Regex.Replace(result, @"ClientName\s+(asc|desc),?\s*", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @"AssignedSmeNames\s+(asc|desc),?\s*", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @",\s*ClientName\s+(asc|desc)", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @",\s*AssignedSmeNames\s+(asc|desc)", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        
        // Remove @ prefix from reserved keywords like Type (e.g., "@Type asc" -> "Type asc")
        result = System.Text.RegularExpressions.Regex.Replace(result, @"@(\w+)\s+(asc|desc)", "$1 $2", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = System.Text.RegularExpressions.Regex.Replace(result, @",\s*@(\w+)\s+(asc|desc)", ", $1 $2", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        
        // Clean up extra commas
        result = System.Text.RegularExpressions.Regex.Replace(result, @",\s*,", ",", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        result = result.Trim().TrimStart(',').TrimEnd(',');
        
        // If result is empty, return null (no OData sorting)
        if (string.IsNullOrWhiteSpace(result))
            return null;
            
        return result;
    }
    
    private PagedResult<ServiceRequestDto> SortResultsByComputedProperty(PagedResult<ServiceRequestDto> result, string orderBy)
    {
        if (string.IsNullOrEmpty(orderBy) || result.Items == null || !result.Items.Any())
            return result;
            
        var items = result.Items.ToList();
        var isDescending = orderBy.Contains("desc", StringComparison.OrdinalIgnoreCase);
        
        if (orderBy.Contains("ClientName", StringComparison.OrdinalIgnoreCase))
        {
            items = isDescending 
                ? items.OrderByDescending(x => x.ClientName).ToList()
                : items.OrderBy(x => x.ClientName).ToList();
        }
        else if (orderBy.Contains("AssignedSmeNames", StringComparison.OrdinalIgnoreCase))
        {
            items = isDescending 
                ? items.OrderByDescending(x => x.AssignedSmeNames).ToList()
                : items.OrderBy(x => x.AssignedSmeNames).ToList();
        }
        
        return new PagedResult<ServiceRequestDto>
        {
            Items = items,
            TotalCount = result.TotalCount,
            PageNumber = result.PageNumber,
            PageSize = result.PageSize
        };
    }
}

