@page "/chat"
@page "/chat/{PatientId:int}"
@using System.Net.Http.Json
@using Microsoft.JSInterop
@using SM_MentalHealthApp.Client.Services
@using SM_MentalHealthApp.Shared
@using Radzen
@using Radzen.Blazor
@inject HttpClient Http
@inject IJSRuntime JS
@inject IAuthService AuthService
@inject IPatientService PatientService
@inject IServiceRequestService ServiceRequestService
@inject DialogService DialogService
@inject NavigationManager Navigation

<div class="chat-container">
    <!-- Chat Mode Header (Only for Doctors and Admins) -->
    @if (AuthService.CurrentUser?.RoleId == 2 || AuthService.CurrentUser?.RoleId == 3) // Doctor or Admin
    {
        <div class="chat-header">
            <div class="mode-selector">
                <label style="white-space: nowrap; margin-bottom: 8px; display: block;">ü§ñ Chat Mode:</label>
                <div class="mode-buttons">
                    <button class="mode-button @(IsGenericMode ? "" : "active")" @onclick="() => SetMode(false)">
                        üë§ Client Chat
                    </button>
                    <button class="mode-button @(IsGenericMode ? "active" : "")" @onclick="() => SetMode(true)">
                        üåê Generic AI
                    </button>
                </div>
            </div>
            
            @if (!IsGenericMode)
            {
                <div class="patient-selector">
                    <label style="white-space: nowrap; margin-bottom: 8px; display: block;">üë§ Select Client:</label>
                    <RadzenDropDown @bind-Value="SelectedUserId" 
                                   Data="@Users" 
                                   ValueProperty="Id" 
                                   TextProperty="FullName"
                                   Placeholder="Search clients..." 
                                   AllowClear="true"
                                   AllowFiltering="true"
                                   FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                   Change="@OnUserChanged"
                                   Style="width: 100%; min-width: 350px; max-width: 500px;"
                                   TValue="int">
                        <Template Context="user">
                            <div style="padding: 6px 8px; line-height: 1.2;">
                                <div style="font-weight: 500; font-size: 14px; margin-bottom: 2px;">@user.FirstName @user.LastName</div>
                                <div style="font-size: 12px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">@user.Email ‚Ä¢ ID: @user.Id</div>
                            </div>
                        </Template>
                    </RadzenDropDown>
                </div>
            }
            else
            {
                <div class="generic-info">
                    <div class="generic-details">
                        <span class="generic-title">üåê Generic AI Assistant</span>
                        <span class="generic-description">Ask me anything - medical research, general knowledge, or any topic you need help with</span>
                    </div>
                </div>
            }
        </div>
    }
    else if (AuthService.CurrentUser?.RoleId == 1) // Patient/Client
    {
        <!-- Mode selector for clients -->
        <div class="chat-header">
            <div class="mode-selector">
                <label style="white-space: nowrap; margin-bottom: 8px; display: block;">ü§ñ Chat Mode:</label>
                <div class="mode-buttons">
                    <button class="mode-button @(ClientChatMode == ClientChatModeType.ServiceRequest ? "active" : "")" @onclick="() => SetClientMode(ClientChatModeType.ServiceRequest)" disabled="@(!HasActiveServiceRequests)">
                        üîß Service Request Chat
                    </button>
                    <button class="mode-button @(ClientChatMode == ClientChatModeType.Generic ? "active" : "")" @onclick="() => SetClientMode(ClientChatModeType.Generic)">
                        üåê Generic AI
                    </button>
                    <button class="mode-button @(ClientChatMode == ClientChatModeType.Medical ? "active" : "")" @onclick="() => SetClientMode(ClientChatModeType.Medical)">
                        üè• Medical Chat
                    </button>
                </div>
            </div>
            
            @if (ClientChatMode == ClientChatModeType.ServiceRequest && !HasActiveServiceRequests)
            {
                <div style="margin-top: 8px; padding: 8px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; font-size: 12px; color: #856404;">
                    ‚ÑπÔ∏è No active service requests. This mode is for chatting about your service requests (plumbing, car repair, etc.).
                </div>
            }
            else if (ClientChatMode == ClientChatModeType.ServiceRequest)
            {
                <div class="patient-selector" style="margin-top: 12px; display: flex; flex-direction: column;">
                    <label style="white-space: nowrap; margin-bottom: 8px; display: block;">üìã Select Service Request:</label>
                    <div style="display: flex; gap: 8px; align-items: flex-end; margin-bottom: 12px;">
                        <RadzenDropDown @bind-Value="SelectedServiceRequestId" 
                                       Data="@ActiveServiceRequests" 
                                       ValueProperty="Id" 
                                       TextProperty="Title"
                                       Placeholder="Select a service request..." 
                                       AllowClear="true"
                                       AllowFiltering="true"
                                       FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                       Change="@OnServiceRequestChanged"
                                       Style="flex: 1; min-width: 300px; max-width: 500px;"
                                       TValue="int?">
                            <Template Context="sr">
                                <div style="padding: 6px 8px; line-height: 1.3;">
                                    <div style="font-weight: 500; font-size: 14px; margin-bottom: 2px;">@sr.Title</div>
                                    <div style="font-size: 12px; color: #666;">
                                        <span class="badge @GetStatusClass(sr.Status)">@sr.Status</span>
                                        <span style="margin-left: 8px;">@sr.Type</span>
                                    </div>
                                </div>
                            </Template>
                        </RadzenDropDown>
                        <button class="btn btn-sm btn-success" @onclick="ShowCreateServiceRequestDialog" style="font-size: 12px; padding: 6px 12px; white-space: nowrap;">
                            <i class="fas fa-plus"></i> New
                        </button>
                        @if (SelectedServiceRequestId.HasValue)
                        {
                            <button class="btn btn-sm btn-info" @onclick="NavigateToServiceRequestsList" style="font-size: 12px; padding: 6px 12px; white-space: nowrap;">
                                <i class="fas fa-info-circle"></i> Details
                            </button>
                        }
                    </div>
                    <div style="margin-top: 0; padding: 8px; background-color: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; font-size: 12px; color: #0c5460; width: 100%;">
                        ‚ÑπÔ∏è Service Request Chat: Get help with your service requests (plumbing, car repair, legal, etc.). The AI will learn your preferences and personalize responses.
                    </div>
                </div>
            }
            else if (ClientChatMode == ClientChatModeType.Medical)
            {
                <div style="margin-top: 8px; padding: 8px; background-color: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; font-size: 12px; color: #0c5460;">
                    ‚ÑπÔ∏è Medical Chat: Ask questions about your health, symptoms, medications, or medical concerns.
                </div>
            }
        </div>
    }
    else
    {
        <!-- Simple header for other roles -->
        <div class="chat-header">
            <div class="chat-title">
                <h2>üí¨ Health Chat</h2>
                <p>Your personal AI companion for health support</p>
            </div>
        </div>
    }
    <!-- <div class="nav-links">
        <a href="/chat" class="nav-link active">WonderWorld Chat</a>
        <a href="/regularchat" class="nav-link">Regular Chat</a>
        <a href="/piichat" class="nav-link">PII Chat</a>
        <a href="/reviews" class="nav-link">Reviews</a>
    </div> -->
    
    <div class="chat-messages" id="chatMessages">
        @if (Messages.Any())
        {
            @foreach (var message in Messages)
            {
                @if (message.StartsWith("You:"))
                {
                    <div class="message-container user-container">
                        <div class="message user-message">
                            <div class="message-content">
                                @message.Substring(4)
                            </div>
                        </div>
                    </div>
                }
                else if (message.StartsWith("Bot:"))
                {
                    <div class="message-container bot-container">
                        <div class="message bot-message">
                            <div class="message-content">
                                @message.Substring(4)
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="message-container system-container">
                        <div class="message system-message">
                            <div class="message-content">
                                @message
                            </div>
                        </div>
                    </div>
                }
            }
        }
        else
        {
            <div class="welcome-message">
                <p>Welcome to the Health Chat! Start a conversation by typing a message below.</p>
            </div>
        }
        
        @if (IsLoading)
        {
            <div class="message-container bot-container">
                <div class="message bot-message">
                    <div class="message-content">
                        <div style="display: flex; flex-direction: row; gap: 6px;">
                            <div class="dot-container">
                                <div class="dot-base"></div>
                                <div class="dot-overlay"></div>
                            </div>
                            <div class="dot-container">
                                <div class="dot-base"></div>
                                <div class="dot-overlay" style="animation-delay: 0.2s;"></div>
                            </div>
                            <div class="dot-container">
                                <div class="dot-base"></div>
                                <div class="dot-overlay" style="animation-delay: 0.4s;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
    <div class="chat-input-container">
        <div class="input-wrapper">
            @if (!IsGenericMode && (AuthService.CurrentUser?.RoleId == 2 || AuthService.CurrentUser?.RoleId == 3) && SelectedUserId <= 0)
            {
                <div style="padding: 12px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; margin-bottom: 8px; color: #856404;">
                    <strong>‚ö†Ô∏è Client Selection Required</strong>
                    <p style="margin: 4px 0 0 0; font-size: 14px;">Please select a patient from the dropdown above to enable Client Chat mode.</p>
                </div>
            }
            <input 
                @ref="chatInputRef"
                @bind="UserInput" 
                @bind:event="oninput" 
                @onkeydown="HandleKeyDown" 
                placeholder="@(GetInputPlaceholder())" 
                class="chat-input" 
                disabled="@(IsLoading || IsInputDisabled())"
                maxlength="1000"
            />
            <button 
                @onclick="ToggleSound" 
                class="sound-toggle @(SoundEnabled ? "enabled" : "disabled")"
                title="@(SoundEnabled ? "Disable sounds" : "Enable sounds")"
            >
                @if (SoundEnabled)
                {
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="11,5 6,9 2,9 2,15 6,15 11,19"></polygon>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                    </svg>
                }
                else
                {
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="11,5 6,9 2,9 2,15 6,15 11,19"></polygon>
                        <line x1="23" y1="9" x2="17" y2="15"></line>
                        <line x1="17" y1="9" x2="23" y2="15"></line>
                    </svg>
                }
            </button>
            <button type="button" 
                    @onclick="SendMessage" 
                    class="send-button"
                    disabled="@(IsLoading || IsInputDisabled())"
                    title="@(IsInputDisabled() ? "Please select a patient first" : "Send message")"
                    style="background: #007bff; color: white; border: none; border-radius: 6px; padding: 10px 20px; cursor: pointer; font-size: 14px; font-weight: 500; min-width: 80px; @(IsInputDisabled() ? "opacity: 0.5; cursor: not-allowed;" : "")"
            >
                Send
            </button>
        </div>
    </div>
</div>

@code {
    [Parameter] public int? PatientId { get; set; }
    [Parameter] public int? UserId { get; set; }
    
    private string UserInput { get; set; } = string.Empty;
    private List<string> Messages = new();
    private bool IsLoading = false;
    private bool SoundEnabled { get; set; } = true;
    private ElementReference chatInputRef;
    
    // User management
    private List<User> Users = new();
    private int SelectedUserId = 0; // Default to no patient selected
    private User? SelectedUser = null;
    
    // Chat mode management
    private bool IsGenericMode = false;
    
    // Client chat mode (for patients/clients)
    private enum ClientChatModeType
    {
        Medical,          // Medical questions - uses content analysis
        ServiceRequest,  // Service requests - uses agentic AI
        Generic          // Generic AI - no personalization
    }
    private ClientChatModeType ClientChatMode = ClientChatModeType.ServiceRequest; // Default to service request
    private bool HasActiveServiceRequests = false;
    
    // Service Request management for clients
    private List<ServiceRequestDto> ActiveServiceRequests = new();
    private int? SelectedServiceRequestId = null;
    
    // Helper class for dropdown display
    private class ServiceRequestDisplayItem
    {
        public int Id { get; set; }
        public string DisplayText { get; set; } = string.Empty;
        public string Title { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
        public string Type { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        if (AuthService.CurrentUser?.RoleId == 2) // Doctor
        {
            await LoadUsers();
            
            // If PatientId is provided in the URL, use it as UserId
            if (PatientId.HasValue)
            {
                SelectedUserId = PatientId.Value;
            }
            // If UserId is provided in the URL, use it
            else if (UserId.HasValue)
            {
                SelectedUserId = UserId.Value;
            }
            
            await LoadSelectedUser();
        }
        else if (AuthService.CurrentUser?.RoleId == 1) // Patient
        {
            // For patients, they chat as themselves
            SelectedUserId = AuthService.CurrentUser.Id;
            await LoadSelectedUser();
            await CheckActiveServiceRequests();
            if (ClientChatMode == ClientChatModeType.ServiceRequest)
            {
                await LoadServiceRequests();
            }
        }
        
        // Add welcome message based on mode
        UpdateWelcomeMessage();
        
        // Initialize sound setting
        await InitializeSound();
    }
    
    protected override async Task OnParametersSetAsync()
    {
        // Reload active SR when navigating back to the page
        // This ensures the dropdown reflects the persistent state
        if (AuthService.CurrentUser?.RoleId == 1 && ClientChatMode == ClientChatModeType.ServiceRequest)
        {
            if (ActiveServiceRequests.Any())
            {
                await LoadActiveServiceRequestFromBackend();
            }
            else
            {
                // Reload service requests if list is empty
                await LoadServiceRequests();
            }
        }
        
        await base.OnParametersSetAsync();
    }
    
    private async Task CheckActiveServiceRequests()
    {
        try
        {
            if (AuthService.CurrentUser?.RoleId == 1 && AuthService.CurrentUser?.Id > 0)
            {
                var serviceRequests = await ServiceRequestService.GetServiceRequestsAsync(clientId: AuthService.CurrentUser.Id);
                HasActiveServiceRequests = serviceRequests.Any(sr => sr.Status == "Active" || sr.Status == "Pending");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error checking service requests: {ex.Message}");
            HasActiveServiceRequests = false;
        }
    }
    
    private async Task SetClientMode(ClientChatModeType mode)
    {
        ClientChatMode = mode;
        IsGenericMode = (mode == ClientChatModeType.Generic);
        Messages.Clear();
        
        // Load service requests when switching to Service Request mode
        if (mode == ClientChatModeType.ServiceRequest && AuthService.CurrentUser?.RoleId == 1)
        {
            await LoadServiceRequests();
            // Load active SR from backend to restore persistent state
            await LoadActiveServiceRequestFromBackend();
        }
        else
        {
            SelectedServiceRequestId = null;
            ActiveServiceRequests.Clear();
        }
        
        UpdateWelcomeMessage();
        StateHasChanged();
    }
    
    private async Task LoadServiceRequests()
    {
        try
        {
            if (AuthService.CurrentUser?.RoleId == 1 && AuthService.CurrentUser?.Id > 0)
            {
                var serviceRequests = await ServiceRequestService.GetServiceRequestsAsync(clientId: AuthService.CurrentUser.Id);
                ActiveServiceRequests = serviceRequests
                    .Where(sr => sr.Status == "Active" || sr.Status == "Pending" || sr.Status == "OnHold")
                    .OrderByDescending(sr => sr.CreatedAt)
                    .ToList();
                
                // Load active SR from backend (persistent state)
                await LoadActiveServiceRequestFromBackend();
                
                // If no SR is selected but there's only one active, auto-select it
                if (!SelectedServiceRequestId.HasValue && ActiveServiceRequests.Count == 1)
                {
                    SelectedServiceRequestId = ActiveServiceRequests[0].Id;
                    // Update ClientAgentSession on backend
                    await SetActiveServiceRequestOnBackend(SelectedServiceRequestId.Value);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading service requests: {ex.Message}");
        }
    }
    
    private async Task LoadActiveServiceRequestFromBackend()
    {
        try
        {
            if (AuthService.CurrentUser?.RoleId == 1 && AuthService.CurrentUser?.Id > 0)
            {
                var response = await Http.GetFromJsonAsync<GetActiveServiceRequestResponse>("api/agenticai/get-active-sr");
                if (response?.Success == true && response.ServiceRequestId.HasValue)
                {
                    // Verify the SR exists in the active list
                    if (ActiveServiceRequests.Any(sr => sr.Id == response.ServiceRequestId.Value))
                    {
                        SelectedServiceRequestId = response.ServiceRequestId.Value;
                        Console.WriteLine($"Loaded active SR {SelectedServiceRequestId} from backend");
                    }
                    else
                    {
                        // SR from backend doesn't exist in active list - clear it
                        Console.WriteLine($"Active SR {response.ServiceRequestId} from backend not found in active list, clearing");
                        await ClearActiveServiceRequestOnBackend();
                        SelectedServiceRequestId = null;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading active SR from backend: {ex.Message}");
        }
    }
    
    private async Task OnServiceRequestChanged()
    {
        if (SelectedServiceRequestId.HasValue)
        {
            // Update ClientAgentSession on backend
            await SetActiveServiceRequestOnBackend(SelectedServiceRequestId.Value);
            Messages.Clear();
            UpdateWelcomeMessage();
            StateHasChanged();
        }
        else
        {
            // Clear SR context
            await ClearActiveServiceRequestOnBackend();
        }
    }
    
    private async Task SetActiveServiceRequestOnBackend(int serviceRequestId)
    {
        try
        {
            if (AuthService.CurrentUser?.RoleId == 1 && AuthService.CurrentUser?.Id > 0)
            {
                var request = new { 
                    clientId = AuthService.CurrentUser.Id, 
                    serviceRequestId = serviceRequestId 
                };
                var response = await Http.PostAsJsonAsync("api/agenticai/set-active-sr", request);
                if (!response.IsSuccessStatusCode)
                {
                    Console.WriteLine($"Failed to set active SR on backend: {response.StatusCode}");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error setting active SR on backend: {ex.Message}");
        }
    }
    
    private async Task ClearActiveServiceRequestOnBackend()
    {
        try
        {
            var response = await Http.PostAsync("api/agenticai/clear-active-sr", null);
            if (!response.IsSuccessStatusCode)
            {
                Console.WriteLine($"Failed to clear active SR on backend: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error clearing active SR on backend: {ex.Message}");
        }
    }
    
    private async Task ShowCreateServiceRequestDialog()
    {
        // Navigate to service requests page in the same tab
        Navigation.NavigateTo("/service-requests");
    }
    
    private void NavigateToServiceRequestsList()
    {
        // Navigate to service requests list page in the same tab
        Navigation.NavigateTo("/service-requests");
    }
    
    private string GetStatusClass(string status)
    {
        return status?.ToLower() switch
        {
            "active" => "badge-success",
            "pending" => "badge-warning",
            "completed" => "badge-secondary",
            "cancelled" => "badge-danger",
            "onhold" => "badge-info",
            _ => "badge-secondary"
        };
    }
    
    private void UpdateWelcomeMessage()
    {
        if (AuthService.CurrentUser?.RoleId == 1) // Patient
        {
            switch (ClientChatMode)
            {
                case ClientChatModeType.ServiceRequest:
                    Messages.Add("Bot: Hello! I'm here to help with your service requests. I'll learn your preferences and provide personalized guidance for your needs (plumbing, car repair, legal, etc.). What can I help you with?");
                    break;
                case ClientChatModeType.Generic:
                    Messages.Add("Bot: Hello! I'm your generic AI assistant. I can help you with any topic - medical research, general knowledge, or any questions you have. How can I assist you today?");
                    break;
                case ClientChatModeType.Medical:
                    Messages.Add("Bot: Hello! I'm your medical AI assistant. I can help you with health questions, symptoms, medications, and medical concerns. How can I help you today?");
                    break;
            }
        }
        else
        {
            Messages.Add("Bot: Hello! I'm your health companion. How can I help you today?");
        }
    }

    private async Task LoadUsers()
    {
        try
        {
            // Only load users for doctors (their assigned patients)
            if (AuthService.CurrentUser?.RoleId == 2)
            {
                Users = await Http.GetFromJsonAsync<List<User>>($"api/admin/doctor/{AuthService.CurrentUser.Id}/patients") ?? new();
            }
            else
            {
                Users = new();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading users: {ex.Message}");
            Messages.Add($"System: Error loading users - {ex.Message}");
        }
    }

    private void SetMode(bool isGeneric)
    {
        IsGenericMode = isGeneric;
        if (isGeneric)
        {
            // Clear patient selection when switching to generic mode
            SelectedUserId = 0;
            SelectedUser = null;
            Messages.Clear();
            Messages.Add("Bot: Hello! I'm your generic AI assistant. I can help you with any topic - medical research, general knowledge, or any questions you have. How can I assist you today?");
        }
        else
        {
            // Clear messages when switching to patient mode
            Messages.Clear();
            Messages.Add("Bot: Hello! I'm your health AI assistant. Select a client to get personalized clinical insights and recommendations.");
        }
        StateHasChanged();
    }

    private async Task LoadSelectedUser()
    {
        try
        {
            if (SelectedUserId > 0)
            {
                // Use PatientService to get patient data (uses correct endpoint: api/patient/{id})
                SelectedUser = await PatientService.GetAsync(SelectedUserId);
                if (SelectedUser != null)
                {
                    Messages.Add($"System: üë§ Now chatting as {SelectedUser.FirstName} {SelectedUser.LastName} (User ID: {SelectedUser.Id})");
                    Messages.Add($"System: üìä AI will provide personalized responses based on {SelectedUser.FirstName}'s journal entries and journalentry patterns");
                }
            }
            else
            {
                SelectedUser = null;
                Messages.Add($"System: üåê No client selected  - AI will provide generic responses");
                Messages.Add($"System: üí° Select a client from the dropdown above to get personalized insights");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading selected user: {ex.Message}");
            Messages.Add($"System: Error loading user data - {ex.Message}");
        }
    }

    private async Task OnUserChanged()
    {
        Messages.Clear();
        await LoadSelectedUser();
        StateHasChanged();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(UserInput) && !IsLoading && !IsInputDisabled())
        {
            await Send();
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(UserInput) || IsLoading || IsInputDisabled())
        {
            return;
        }
        
        await Send();
    }
    
    private bool IsInputDisabled()
    {
        // Disable input if in Client Chat mode but no patient is selected (for doctors/admins)
        if (!IsGenericMode && (AuthService.CurrentUser?.RoleId == 2 || AuthService.CurrentUser?.RoleId == 3))
        {
            return SelectedUserId <= 0;
        }
        return false;
    }
    
    private string GetInputPlaceholder()
    {
        if (IsInputDisabled())
        {
            return "Please select a patient first...";
        }
        return "Ask me anything about health...";
    }

    private async Task Send()
    {
        if (string.IsNullOrWhiteSpace(UserInput) || IsLoading) return;
        
        try
        {
            // Determine patientId based on mode and user role
            int patientId = 0;
            if (IsGenericMode)
            {
                patientId = 0; // Generic mode
            }
            else if (AuthService.CurrentUser?.RoleId == 2) // Doctor
            {
                patientId = SelectedUserId; // Use selected patient
                // Require patient selection for Client Chat mode
                if (patientId <= 0)
                {
                    Messages.Add($"System: ‚ö†Ô∏è Please select a patient before sending a message in Client Chat mode.");
                    return;
                }
            }
            else if (AuthService.CurrentUser?.RoleId == 1) // Patient
            {
                patientId = AuthService.CurrentUser?.Id ?? 0; // Use current user as patient
            }
            else if (AuthService.CurrentUser?.RoleId == 3) // Admin
            {
                patientId = SelectedUserId; // Use selected patient
                // Require patient selection for Client Chat mode
                if (patientId <= 0)
                {
                    Messages.Add($"System: ‚ö†Ô∏è Please select a patient before sending a message in Client Chat mode.");
                    return;
                }
            }
            
            
            IsLoading = true;
            StateHasChanged();
            
            // Scroll to bottom to show loading indicator immediately
            await Task.Delay(50); // Small delay to ensure DOM is updated
            await JS.InvokeVoidAsync("scrollToBottom");
            
            // Play send sound
            if (SoundEnabled)
            {
                await JS.InvokeVoidAsync("playSound", "send");
            }
            
            // For clients, determine if we should force service request mode
            bool forceServiceRequestMode = false;
            if (AuthService.CurrentUser?.RoleId == 1 && ClientChatMode == ClientChatModeType.ServiceRequest)
            {
                forceServiceRequestMode = true;
            }
            
            var request = new { 
                prompt = UserInput, 
                conversationId = Guid.NewGuid().ToString(), 
                provider = 3, 
                patientId = patientId,
                userId = AuthService.CurrentUser?.Id ?? 0,
                userRoleId = AuthService.CurrentUser?.RoleId ?? 0,
                isGenericMode = IsGenericMode,
                forceServiceRequestMode = forceServiceRequestMode, // New flag to explicitly use agentic AI
                selectedServiceRequestId = (forceServiceRequestMode && AuthService.CurrentUser?.RoleId == 1) ? SelectedServiceRequestId : null // Pass selected SR from UI
            };
            var response = await Http.PostAsJsonAsync("api/chat/send", request);
            var data = await response.Content.ReadFromJsonAsync<ChatResponse>();
            
            Messages.Add($"You: {UserInput}");
            UserInput = string.Empty;
            
            // Simple delay to show typing animation
            await Task.Delay(1500);
            
            if (data?.Message != null)
            {
                Messages.Add($"Bot: {data.Message}");
                // Play receive sound
                if (SoundEnabled)
                {
                    await JS.InvokeVoidAsync("playSound", "receive");
                }
                
                // Sync active SR from backend after agentic AI response
                // This ensures dropdown reflects if agentic AI switched SRs
                if (forceServiceRequestMode && AuthService.CurrentUser?.RoleId == 1)
                {
                    await LoadActiveServiceRequestFromBackend();
                    StateHasChanged();
                }
            }
            else
            {
                Messages.Add($"Bot: Sorry, I couldn't process your request.");
                // Play error sound for failed requests
                if (SoundEnabled)
                {
                    await JS.InvokeVoidAsync("playSound", "error");
                }
            }
        }
        catch (Exception ex)
        {
            Messages.Add($"Error: {ex.Message}");
            // Play error sound
            if (SoundEnabled)
            {
                await JS.InvokeVoidAsync("playSound", "error");
            }
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
            
            // Scroll to bottom after sending message
            await Task.Delay(100);
            await JS.InvokeVoidAsync("scrollToBottom");
            
            // Focus the input field after response is received
            try
            {
                await chatInputRef.FocusAsync();
            }
            catch
            {
                // Ignore focus errors (e.g., if input is disabled)
            }
        }
    }


    private async Task ToggleSound()
    {
        SoundEnabled = !SoundEnabled;
        await JS.InvokeVoidAsync("setSoundEnabled", SoundEnabled);
        StateHasChanged();
    }

    // Initialize sound setting
    private async Task InitializeSound()
    {
        await JS.InvokeVoidAsync("setSoundEnabled", SoundEnabled);
    }
    
    // Response class for getting active SR
    private class GetActiveServiceRequestResponse
    {
        public bool Success { get; set; }
        public int? ServiceRequestId { get; set; }
    }
}
