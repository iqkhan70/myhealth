@page "/chat-history"
@using SM_MentalHealthApp.Shared
@using SM_MentalHealthApp.Client.Services
@using SM_MentalHealthApp.Client.Components.Grid
@using SM_MentalHealthApp.Client.Components.Common
@using SM_MentalHealthApp.Client.Helpers
@using Radzen
@using Radzen.Blazor
@using System.Text.Json
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@inject IAuthService AuthService
@inject IChatHistoryService ChatHistoryService
@inject NotificationService NotificationService

<PageTitle>Chat History</PageTitle>

<style>
    .conversation-messages {
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .message-content {
        word-wrap: break-word;
        white-space: pre-wrap;
        overflow-wrap: break-word;
        max-width: 100%;
    }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <SMPageHeader Title="Chat History" 
                         Icon="fas fa-comments" 
                         Description="View and search your conversation history with the AI assistant" />

            @if ((currentUserRole == "Doctor" || currentUserRole == "Attorney") && patients != null && patients.Any())
            {
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="patientFilter" class="form-label">Filter by Patient:</label>
                        <div class="input-group">
                            <select id="patientFilter" class="form-select" @onchange="OnPatientFilterChanged">
                                <option value="">All Patients (@patients.Count total)</option>
                                @foreach (var patient in patients.OrderBy(p => p.FullName))
                                {
                                    <option value="@patient.Id" selected="@(selectedPatientId == patient.Id)">
                                        @patient.FullName (@patient.Email)
                                    </option>
                                }
                            </select>
                            @if (selectedPatientId.HasValue)
                            {
                                <button class="btn btn-outline-secondary" type="button" @onclick="ClearPatientFilter">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            }
                        </div>
                    </div>
                </div>
            }

            <SMDataGrid TItem="ChatSession" Columns="_columns" Actions="_actions" ActionsWidth="120px"
                LoadItems="ct => ChatHistoryService.ListAsync(selectedPatientId, ct)" @ref="_grid" PageSize="10"
                OnRowExpandCallback="@OnRowExpand">
        <ExpansionTemplate Context="session">
            @{
                var expandedSession = expandedSessions.ContainsKey(session.Id) ? expandedSessions[session.Id] : session;
            }
            <div class="p-3">
                <div class="row">
                    <div class="col-12">
                        <h6>Session Information</h6>
                        <p>
                            <strong>Created:</strong> @expandedSession.CreatedAt.ToString("MM/dd/yyyy HH:mm:ss") |
                            <strong>Last Activity:</strong> @expandedSession.LastActivityAt.ToString("MM/dd/yyyy HH:mm:ss") |
                            <strong>Messages:</strong> @expandedSession.MessageCount
                        </p>

                        @if (expandedSession.PatientId.HasValue)
                        {
                            <p><strong>About Patient:</strong> @(expandedSession.Patient?.FullName ?? $"Patient {expandedSession.PatientId}")</p>
                        }

                        @{
                            var concernLevel = GetConcernLevel(expandedSession);
                        }
                        
                        @if (concernLevel != "None")
                        {
                            <div class="alert @(concernLevel == "High" ? "alert-danger" : concernLevel == "Medium" ? "alert-warning" : "alert-info") mb-3">
                                <h6>
                                    @(concernLevel == "High" ? "‚ö†Ô∏è High Concern" : concernLevel == "Medium" ? "‚ö° Medium Concern" : "‚ÑπÔ∏è Low Concern")
                                </h6>
                                <p>
                                    This chat session contains @(concernLevel.ToLower()) concern indicators based on:
                                    <ul class="mb-0">
                                        @if (expandedSession.Messages?.Any(m => m.IsMedicalData) == true)
                                        {
                                            <li>Medical data present in messages</li>
                                        }
                                        @if (!string.IsNullOrEmpty(expandedSession.Summary) && (expandedSession.Summary.ToLower().Contains("critical") || expandedSession.Summary.ToLower().Contains("urgent") || expandedSession.Summary.ToLower().Contains("concerning")))
                                        {
                                            <li>Concerning keywords in AI summary</li>
                                        }
                                        @if (expandedSession.Messages?.Any(m => !string.IsNullOrEmpty(m.Content) && (m.Content.ToLower().Contains("suicide") || m.Content.ToLower().Contains("self-harm") || m.Content.ToLower().Contains("emergency"))) == true)
                                        {
                                            <li>High-severity keywords detected</li>
                                        }
                                    </ul>
                                </p>
                            </div>
                        }

                        @if (expandedSession.IsIgnoredByDoctor)
                        {
                            <div class="alert alert-warning mb-3">
                                <h6>üö´ Ignored for AI Analysis</h6>
                                <p>
                                    This chat session has been marked as ignored and will be excluded from AI health check analysis.
                                    @if (expandedSession.IgnoredAt.HasValue)
                                    {
                                        <br /><small>Ignored on: @expandedSession.IgnoredAt.Value.ToString("MM/dd/yyyy HH:mm")</small>
                                    }
                                </p>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(expandedSession.Summary))
                        {
                            <div class="alert alert-light mb-3">
                                <h6>üìù AI Summary</h6>
                                <p>@expandedSession.Summary</p>
                            </div>
                        }

                        <div class="conversation-messages" style="max-height: 400px; overflow-y: auto;">
                            @if (expandedSession.Messages != null && expandedSession.Messages.Any())
                            {
                                @foreach (var message in expandedSession.Messages.OrderBy(m => m.Timestamp))
                                {
                                    <div class="message mb-3 p-3 rounded @(message.Role == MessageRole.User ? "bg-light border" : "bg-light border-start border-4 border-info")">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <strong>
                                                @(message.Role == MessageRole.User ? "üë§ You" : message.Role == MessageRole.Assistant ? "ü§ñ AI Assistant" : "‚öôÔ∏è System")
                                            </strong>
                                            <small class="text-muted">@message.Timestamp.ToString("HH:mm:ss")</small>
                                        </div>
                                        <div class="message-content" style="word-wrap: break-word; white-space: pre-wrap; overflow-wrap: break-word;">
                                            @message.Content
                                        </div>
                                        <div class="message-metadata mt-2">
                                            @if (message.IsMedicalData)
                                            {
                                                <span class="badge bg-danger">Medical Data</span>
                                            }
                                            <span class="badge bg-secondary">@message.MessageType</span>
                                            @if (!string.IsNullOrEmpty(message.Metadata))
                                            {
                                                <button class="btn btn-sm btn-outline-secondary" @onclick="() => ShowMetadata(message.Metadata)">
                                                    View Metadata
                                                </button>
                                            }
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="text-muted text-center">
                                    <p>No messages found in this session.</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
            </ExpansionTemplate>
            </SMDataGrid>
        </div>
    </div>
</div>

@code {
    private SMDataGrid<ChatSession>? _grid;
    private int? selectedPatientId = null;
    private List<User>? patients;
    private string? currentUserRole;
    private Dictionary<int, ChatSession> expandedSessions = new Dictionary<int, ChatSession>();

    private List<SMDataGridColumn<ChatSession>> _columns = new();

    private readonly List<SMDataGridActionButton<ChatSession>> _actions = [];

    protected override async Task OnInitializedAsync()
    {
        // Initialize columns (must be done here to access instance methods)
        _columns = new List<SMDataGridColumn<ChatSession>>
        {
            new() { Property = nameof(ChatSession.PatientDisplayName), Title = "About Patient", Width = "200px" },
            new() { Property = nameof(ChatSession.UserDisplayName), Title = "Conducted By", Width = "150px" },
            new SMDataGridBadgeColumn<ChatSession>
            {
                Property = nameof(ChatSession.MessageCount),
                Title = "Messages",
                Width = "100px",
                TextAlign = TextAlign.Center,
                GetBadgeData = (session) => (session.MessageCount.ToString(), NotificationSeverity.Success, true)
            },
            new SMDataGridBadgeColumn<ChatSession>
            {
                Property = nameof(ChatSession.IsIgnoredByDoctor),
                Title = "AI Status",
                Width = "120px",
                TextAlign = TextAlign.Center,
                GetBadgeData = (session) => session.IsIgnoredByDoctor 
                    ? ("üö´ Ignored", NotificationSeverity.Warning, true)
                    : ("‚úÖ Active", NotificationSeverity.Success, true)
            },
            new SMDataGridBadgeColumn<ChatSession>
            {
                Property = nameof(ChatSession.Summary),
                Title = "Concern Level",
                Width = "130px",
                TextAlign = TextAlign.Center,
                GetBadgeData = (session) => {
                    var concernLevel = GetConcernLevel(session);
                    return concernLevel switch
                    {
                        "High" => ("‚ö†Ô∏è High", NotificationSeverity.Error, true),
                        "Medium" => ("‚ö° Medium", NotificationSeverity.Warning, true),
                        "Low" => ("‚ÑπÔ∏è Low", NotificationSeverity.Info, true),
                        _ => ("‚úÖ None", NotificationSeverity.Success, true)
                    };
                }
            },
            new() { Property = nameof(ChatSession.CreatedAt), Title = "Created", Width = "150px" },
            new() { Property = nameof(ChatSession.LastActivityAt), Title = "Last Activity", Width = "150px" }
        };
        
        await LoadUserInfo();

        // Add ignore/unignore button for doctors
        if (AuthService.CurrentUser?.RoleId == 2) // Doctor
        {
            _actions.Add(new SMDataGridActionButton<ChatSession>
            {
                IconFunc = (session) => session.IsIgnoredByDoctor ? "undo" : "block", // Use "undo" for unignore (distinct from "visibility" used for view)
                ButtonStyleFunc = (session) => session.IsIgnoredByDoctor ? ButtonStyle.Info : ButtonStyle.Warning,
                Variant = Variant.Flat,
                Size = ButtonSize.Small,
                TooltipFunc = (session) => session.IsIgnoredByDoctor 
                    ? $"Unignore for AI analysis (Ignored on: {session.IgnoredAt?.ToString("MM/dd/yyyy HH:mm") ?? "Unknown"})" 
                    : "Ignore for AI analysis - This will exclude this session from AI health check",
                OnClick = async (row, ct) => await ToggleIgnoreSessionAsync(row, ct),
                Disabled = (session) => session.UserId != GetCurrentUserId() // Only allow ignoring own sessions
            });
        }

        _actions.Add(new SMDataGridActionButton<ChatSession>
        {
            Icon = "delete",
            ButtonStyle = ButtonStyle.Danger,
            Variant = Variant.Flat,
            Size = ButtonSize.Small,
            Tooltip = "Delete chat session",
            OnClick = async (row, ct) => await DeleteSessionAsync(row, ct),
            Disabled = (session) => !CanDeleteSession(session)
        });
    }

    protected override void OnParametersSet()
    {
        // Refresh grid when patient filter changes
        if (_grid != null)
        {
            _ = _grid.RefreshAsync();
        }
    }

    private async Task LoadUserInfo()
    {
        try
        {
            var userResponse = await Http.GetFromJsonAsync<AuthUser>("api/auth/me");
            currentUserRole = userResponse?.RoleName;

            if (userResponse?.RoleId == 2 || userResponse?.RoleId == 5) // Doctor or Attorney
            {
                if (userResponse?.RoleId == 2)
                {
                    var patientsResponse = await Http.GetFromJsonAsync<List<User>>("api/doctor/patients");
                    patients = patientsResponse ?? new List<User>();
                }
                else if (userResponse?.RoleId == 5) // Attorney
                {
                    // For Attorney, get patients assigned to them
                    var patientsResponse = await Http.GetFromJsonAsync<List<User>>($"api/admin/doctor/{userResponse.Id}/patients");
                    patients = patientsResponse ?? new List<User>();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading user info: {ex.Message}");
        }
    }

    private async Task OnRowExpand(ChatSession session)
    {
        try
        {
            if (!expandedSessions.ContainsKey(session.Id))
            {
                var sessionDetails = await ChatHistoryService.GetAsync(session.Id);
                if (sessionDetails != null)
                {
                    expandedSessions[session.Id] = sessionDetails;
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to load session details: {ex.Message}");
        }
    }

    private async Task DeleteSessionAsync(ChatSession session, CancellationToken ct)
    {
        try
        {
            var details = $"Session: {(session.PatientId.HasValue ? session.Patient?.FullName ?? $"Patient {session.PatientId}" : "General Chat")}\n" +
                         $"Messages: {session.MessageCount}\n" +
                         $"Created: {session.CreatedAt:MM/dd/yyyy HH:mm}";
            
            var confirmed = await JSRuntime.ConfirmDestructiveAsync("delete this chat session", details, "chat session");

            if (confirmed)
            {
                await ChatHistoryService.DeleteAsync(session.Id, ct);
                
                NotificationService.ShowSuccess("Chat session deleted successfully!");

                if (expandedSessions.ContainsKey(session.Id))
                {
                    expandedSessions.Remove(session.Id);
                }

                if (_grid != null)
                {
                    await _grid.RefreshAsync();
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to delete session: {ex.Message}");
        }
    }

    private async Task OnPatientFilterChanged(ChangeEventArgs e)
    {
        selectedPatientId = string.IsNullOrEmpty(e.Value?.ToString()) ? null : int.Parse(e.Value.ToString()!);
        if (_grid != null)
        {
            await _grid.RefreshAsync();
        }
    }

    private async Task ClearPatientFilter()
    {
        selectedPatientId = null;
        if (_grid != null)
        {
            await _grid.RefreshAsync();
        }
    }

    private int GetCurrentUserId()
    {
        return AuthService.CurrentUser?.Id ?? 0;
    }

    /// <summary>
    /// Determines the concern level of a chat session based on summary and messages
    /// </summary>
    private string GetConcernLevel(ChatSession session)
    {
        if (session == null) return "None";

        // Generic chat (no patient) should never be marked as high concern
        // Generic chat is for general medical information queries, not patient-specific concerns
        bool isGenericChat = !session.PatientId.HasValue;

        var concernScore = 0;
        var textToAnalyze = string.Empty;

        // Check summary for concerning keywords (always available in list view)
        if (!string.IsNullOrEmpty(session.Summary))
        {
            textToAnalyze += session.Summary.ToLower() + " ";
        }

        // Check messages if available (only loaded when row is expanded)
        var hasMessages = session.Messages != null && session.Messages.Any();
        if (hasMessages)
        {
            foreach (var message in session.Messages)
            {
                // Only count medical data as a concern for patient-specific chats
                // Generic chat queries about medical information should not be flagged
                if (message.IsMedicalData && !isGenericChat)
                {
                    concernScore += 2; // Medical data is a concern only for patient-specific chats
                }
                
                if (!string.IsNullOrEmpty(message.Content))
                {
                    textToAnalyze += message.Content.ToLower() + " ";
                }
            }
        }

        // High severity keywords
        var highSeverityKeywords = new[]
        {
            "critical", "urgent", "immediate", "emergency", "severe", "concerning",
            "high risk", "dangerous", "alarming", "serious", "crisis", "acute",
            "suicide", "self-harm", "overdose", "chest pain", "difficulty breathing",
            "heart attack", "stroke", "unacknowledged"
        };

        // Medium severity keywords
        var mediumSeverityKeywords = new[]
        {
            "worry", "worried", "concerned", "anxious", "depressed", "stress",
            "pain", "ache", "fever", "nausea", "dizziness", "fatigue",
            "abnormal", "elevated", "high", "low", "irregular"
        };

        // Critical safety keywords that should still be flagged even in generic chat
        var criticalSafetyKeywords = new[] { "suicide", "self-harm", "kill myself", "want to die", "emergency", "crisis" };

        // Check for high severity keywords in the text (summary or messages)
        foreach (var keyword in highSeverityKeywords)
        {
            if (textToAnalyze.Contains(keyword))
            {
                // For generic chat, only count critical safety keywords
                // General medical queries like "normal values" should not trigger concern
                if (isGenericChat && !criticalSafetyKeywords.Contains(keyword))
                {
                    continue; // Skip non-critical keywords for generic chat
                }
                concernScore += 3;
            }
        }

        // Check for medium severity keywords
        // For generic chat, don't count these as concerns
        if (!isGenericChat)
        {
            foreach (var keyword in mediumSeverityKeywords)
            {
                if (textToAnalyze.Contains(keyword))
                {
                    concernScore += 1;
                }
            }
        }

        // For generic chat, only return concern if there are critical safety keywords
        // General medical queries should return "None"
        if (isGenericChat)
        {
            // Only flag if there are critical safety keywords
            if (concernScore >= 3)
                return "High"; // Only for critical safety issues
            else
                return "None"; // Generic medical queries are not concerns
        }

        // Determine concern level for patient-specific chats
        if (concernScore >= 5)
            return "High";
        else if (concernScore >= 2)
            return "Medium";
        else if (concernScore >= 1)
            return "Low";
        else
            return "None";
    }

    private async Task ToggleIgnoreSessionAsync(ChatSession session, CancellationToken ct)
    {
        try
        {
            var wasIgnored = session.IsIgnoredByDoctor;
            var isIgnored = await ChatHistoryService.ToggleIgnoreAsync(session.Id, ct);
            
            // Update the session in the grid
            session.IsIgnoredByDoctor = isIgnored;
            session.IgnoredByDoctorId = isIgnored ? GetCurrentUserId() : null;
            session.IgnoredAt = isIgnored ? DateTime.UtcNow : null;
            
            NotificationService.ShowSuccess(isIgnored 
                ? "Chat session ignored. It will be excluded from AI health check analysis." 
                : "Chat session unignored. It will be included in AI health check analysis.");
            
            if (_grid != null)
            {
                await _grid.RefreshAsync();
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Failed to toggle ignore status: {ex.Message}");
        }
    }

    private bool CanDeleteSession(ChatSession session)
    {
        var currentUserId = GetCurrentUserId();
        var currentUserRole = AuthService.CurrentUser?.RoleId ?? 0;

        if (currentUserRole == 1) // Patient
        {
            return session.UserId == currentUserId;
        }

        if (currentUserRole == 2) // Doctor
        {
            return session.UserId == currentUserId;
        }

        if (currentUserRole == 3) // Admin
        {
            return true;
        }

        return false;
    }

    private async Task ShowMetadata(string? metadata)
    {
        try
        {
            if (string.IsNullOrEmpty(metadata)) return;
            
            var jsonObject = JsonSerializer.Deserialize<JsonElement>(metadata);
            var formattedJson = JsonSerializer.Serialize(jsonObject, new JsonSerializerOptions { WriteIndented = true });
            await JSRuntime.InvokeVoidAsync("alert", $"Metadata:\n\n{formattedJson}");
        }
        catch
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Metadata:\n\n{metadata}");
        }
    }
}
