@page "/chat-history"
@using SM_MentalHealthApp.Shared
@using SM_MentalHealthApp.Client.Services
@using SM_MentalHealthApp.Client.Components.Grid
@using Radzen
@using Radzen.Blazor
@using System.Text.Json
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@inject IAuthService AuthService
@inject IChatHistoryService ChatHistoryService
@inject NotificationService NotificationService

<PageTitle>Chat History</PageTitle>

<style>
    .conversation-messages {
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .message-content {
        word-wrap: break-word;
        white-space: pre-wrap;
        overflow-wrap: break-word;
        max-width: 100%;
    }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-comments me-2"></i>Chat History</h2>
                    <p class="text-muted mb-0">View and search your conversation history with the AI assistant</p>
                </div>
            </div>

            @if (currentUserRole == "Doctor" && patients != null && patients.Any())
            {
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="patientFilter" class="form-label">Filter by Patient:</label>
                        <div class="input-group">
                            <select id="patientFilter" class="form-select" @onchange="OnPatientFilterChanged">
                                <option value="">All Patients (@patients.Count total)</option>
                                @foreach (var patient in patients.OrderBy(p => p.FullName))
                                {
                                    <option value="@patient.Id" selected="@(selectedPatientId == patient.Id)">
                                        @patient.FullName (@patient.Email)
                                    </option>
                                }
                            </select>
                            @if (selectedPatientId.HasValue)
                            {
                                <button class="btn btn-outline-secondary" type="button" @onclick="ClearPatientFilter">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            }
                        </div>
                    </div>
                </div>
            }

            <SMDataGrid TItem="ChatSession" Columns="_columns" Actions="_actions" ActionsWidth="120px"
                LoadItems="ct => ChatHistoryService.ListAsync(selectedPatientId, ct)" @ref="_grid" PageSize="10"
                OnRowExpandCallback="@OnRowExpand">
        <ExpansionTemplate Context="session">
            @{
                var expandedSession = expandedSessions.ContainsKey(session.Id) ? expandedSessions[session.Id] : session;
            }
            <div class="p-3">
                <div class="row">
                    <div class="col-12">
                        <h6>Session Information</h6>
                        <p>
                            <strong>Created:</strong> @expandedSession.CreatedAt.ToString("MM/dd/yyyy HH:mm:ss") |
                            <strong>Last Activity:</strong> @expandedSession.LastActivityAt.ToString("MM/dd/yyyy HH:mm:ss") |
                            <strong>Messages:</strong> @expandedSession.MessageCount
                        </p>

                        @if (expandedSession.PatientId.HasValue)
                        {
                            <p><strong>About Patient:</strong> @(expandedSession.Patient?.FullName ?? $"Patient {expandedSession.PatientId}")</p>
                        }

                        @if (!string.IsNullOrEmpty(expandedSession.Summary))
                        {
                            <div class="alert alert-light mb-3">
                                <h6>üìù AI Summary</h6>
                                <p>@expandedSession.Summary</p>
                            </div>
                        }

                        <div class="conversation-messages" style="max-height: 400px; overflow-y: auto;">
                            @if (expandedSession.Messages != null && expandedSession.Messages.Any())
                            {
                                @foreach (var message in expandedSession.Messages.OrderBy(m => m.Timestamp))
                                {
                                    <div class="message mb-3 p-3 rounded @(message.Role == MessageRole.User ? "bg-light border" : "bg-light border-start border-4 border-info")">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <strong>
                                                @(message.Role == MessageRole.User ? "üë§ You" : message.Role == MessageRole.Assistant ? "ü§ñ AI Assistant" : "‚öôÔ∏è System")
                                            </strong>
                                            <small class="text-muted">@message.Timestamp.ToString("HH:mm:ss")</small>
                                        </div>
                                        <div class="message-content" style="word-wrap: break-word; white-space: pre-wrap; overflow-wrap: break-word;">
                                            @message.Content
                                        </div>
                                        <div class="message-metadata mt-2">
                                            @if (message.IsMedicalData)
                                            {
                                                <span class="badge bg-danger">Medical Data</span>
                                            }
                                            <span class="badge bg-secondary">@message.MessageType</span>
                                            @if (!string.IsNullOrEmpty(message.Metadata))
                                            {
                                                <button class="btn btn-sm btn-outline-secondary" @onclick="() => ShowMetadata(message.Metadata)">
                                                    View Metadata
                                                </button>
                                            }
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="text-muted text-center">
                                    <p>No messages found in this session.</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
            </ExpansionTemplate>
            </SMDataGrid>
        </div>
    </div>
</div>

@code {
    private SMDataGrid<ChatSession>? _grid;
    private int? selectedPatientId = null;
    private List<User>? patients;
    private string? currentUserRole;
    private Dictionary<int, ChatSession> expandedSessions = new Dictionary<int, ChatSession>();

    private readonly List<SMDataGridColumn<ChatSession>> _columns =
    [
    new() { Property = nameof(ChatSession.PatientDisplayName), Title = "About Patient", Width = "200px" },
new() { Property = nameof(ChatSession.UserDisplayName), Title = "Conducted By", Width = "150px" },
new SMDataGridBadgeColumn<ChatSession>
{
Property = nameof(ChatSession.MessageCount),
Title = "Messages",
Width = "100px",
TextAlign = TextAlign.Center,
GetBadgeData = (session) => (session.MessageCount.ToString(), NotificationSeverity.Success, true)
},
new() { Property = nameof(ChatSession.CreatedAt), Title = "Created", Width = "150px" },
new() { Property = nameof(ChatSession.LastActivityAt), Title = "Last Activity", Width = "150px" },
new() { Property = nameof(ChatSession.Summary), Title = "Summary", Width = "300px" }
    ];

    private readonly List<SMDataGridActionButton<ChatSession>> _actions = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadUserInfo();

        _actions.Add(new SMDataGridActionButton<ChatSession>
        {
            Icon = "delete",
            ButtonStyle = ButtonStyle.Danger,
            Variant = Variant.Flat,
            Size = ButtonSize.Small,
            OnClick = async (row, ct) => await DeleteSessionAsync(row, ct),
            Disabled = (session) => !CanDeleteSession(session)
        });
    }

    protected override void OnParametersSet()
    {
        // Refresh grid when patient filter changes
        if (_grid != null)
        {
            _ = _grid.RefreshAsync();
        }
    }

    private async Task LoadUserInfo()
    {
        try
        {
            var userResponse = await Http.GetFromJsonAsync<AuthUser>("api/auth/me");
            currentUserRole = userResponse?.RoleName;

            if (userResponse?.RoleId == 2)
            {
                var patientsResponse = await Http.GetFromJsonAsync<List<User>>("api/doctor/patients");
                patients = patientsResponse ?? new List<User>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading user info: {ex.Message}");
        }
    }

    private async Task OnRowExpand(ChatSession session)
    {
        try
        {
            if (!expandedSessions.ContainsKey(session.Id))
            {
                var sessionDetails = await ChatHistoryService.GetAsync(session.Id);
                if (sessionDetails != null)
                {
                    expandedSessions[session.Id] = sessionDetails;
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Failed to load session details: {ex.Message}",
                Duration = 4000
            });
        }
    }

    private async Task DeleteSessionAsync(ChatSession session, CancellationToken ct)
    {
        try
        {
            var confirmed = await JSRuntime.InvokeAsync<bool>("confirm",
            $"Are you sure you want to delete this chat session?\n\n" +
            $"Session: {(session.PatientId.HasValue ? session.Patient?.FullName ?? $"Patient {session.PatientId}" : "General Chat")}\n" +
                $"Messages: {session.MessageCount}\n" +
                $"Created: {session.CreatedAt:MM/dd/yyyy HH:mm}\n\n" +
                $"‚ö†Ô∏è This action cannot be undone!");

            if (confirmed)
            {
                await ChatHistoryService.DeleteAsync(session.Id, ct);
                
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Success",
                    Detail = "Chat session deleted successfully!",
                    Duration = 4000
                });

                if (expandedSessions.ContainsKey(session.Id))
                {
                    expandedSessions.Remove(session.Id);
                }

                if (_grid != null)
                {
                    await _grid.RefreshAsync();
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Failed to delete session: {ex.Message}",
                Duration = 6000
            });
        }
    }

    private async Task OnPatientFilterChanged(ChangeEventArgs e)
    {
        selectedPatientId = string.IsNullOrEmpty(e.Value?.ToString()) ? null : int.Parse(e.Value.ToString()!);
        if (_grid != null)
        {
            await _grid.RefreshAsync();
        }
    }

    private async Task ClearPatientFilter()
    {
        selectedPatientId = null;
        if (_grid != null)
        {
            await _grid.RefreshAsync();
        }
    }

    private int GetCurrentUserId()
    {
        return AuthService.CurrentUser?.Id ?? 0;
    }

    private bool CanDeleteSession(ChatSession session)
    {
        var currentUserId = GetCurrentUserId();
        var currentUserRole = AuthService.CurrentUser?.RoleId ?? 0;

        if (currentUserRole == 1) // Patient
        {
            return session.UserId == currentUserId;
        }

        if (currentUserRole == 2) // Doctor
        {
            return session.UserId == currentUserId;
        }

        if (currentUserRole == 3) // Admin
        {
            return true;
        }

        return false;
    }

    private async Task ShowMetadata(string? metadata)
    {
        try
        {
            if (string.IsNullOrEmpty(metadata)) return;
            
            var jsonObject = JsonSerializer.Deserialize<JsonElement>(metadata);
            var formattedJson = JsonSerializer.Serialize(jsonObject, new JsonSerializerOptions { WriteIndented = true });
            await JSRuntime.InvokeVoidAsync("alert", $"Metadata:\n\n{formattedJson}");
        }
        catch
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Metadata:\n\n{metadata}");
        }
    }
}
